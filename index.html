<!DOCTYPE html>
<html lang="pt-BR" class="light"> <!-- Classe inicial 'light' - JS alterna para 'dark' -->
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Organizador Financeiro — Completo</title>

<!-- Tailwind + icons -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Config Tailwind para Dark Mode -->
<script>
  tailwind.config = {
    darkMode: 'class', // Usa classe 'dark' no <html> para alternar
  }
</script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

<!-- Manifest PWA -->
<link rel="manifest" href="manifest.json" />
<script>
  (function preloadFirebaseConfig() {
    if (window.__FIREBASE_CONFIG__) {
      return;
    }
    if (window.__APP_CONFIG__ && window.__APP_CONFIG__.firebase && window.__APP_CONFIG__.firebase.client) {
      window.__FIREBASE_CONFIG__ = window.__APP_CONFIG__.firebase.client;
      return;
    }

    try {
      var request = new XMLHttpRequest();
      request.open('GET', '/app-config.js?format=json', false);
      request.setRequestHeader('Accept', 'application/json');
      request.send(null);

      if (request.status >= 200 && request.status < 300 && request.responseText) {
        try {
          var parsed = JSON.parse(request.responseText);
          if (parsed && typeof parsed === 'object') {
            window.__FIREBASE_CONFIG__ = parsed;
            return;
          }
        } catch (jsonError) {
          console.warn('Falha ao interpretar configuração Firebase como JSON.', jsonError);
        }
      }

      // Se não veio JSON válido, tenta carregar o script tradicional
      request = new XMLHttpRequest();
      request.open('GET', '/app-config.js', false);
      request.send(null);
      if (request.status >= 200 && request.status < 300 && request.responseText) {
        try {
          new Function(request.responseText)();
          if (window.__FIREBASE_CONFIG__) {
            return;
          }
        } catch (scriptError) {
          console.warn('Falha ao executar app-config.js padrão.', scriptError);
        }
      }
    } catch (networkError) {
      console.warn('Não foi possível carregar app-config.js do servidor.', networkError);
    }
  })();
</script>
<!-- Theme-color para Light e Dark Mode -->
<meta name="theme-color" content="#4ade80" media="(prefers-color-scheme: light)" />
<meta name="theme-color" content="#1f2937" media="(prefers-color-scheme: dark)" />

<!-- Adicione no <head> para incluir Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- NOVO: Modal de Gráficos Interativos com filtros -->
<div id="modal-graficos" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-11/12 max-w-3xl mx-auto relative shadow-lg modal-content max-h-[90vh] overflow-y-auto">
    <button id="modal-graficos-close" class="absolute top-3 right-3 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-2xl font-bold" aria-label="Fechar modal">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Gráficos Interativos</h2>

    <!-- NOVO: Resumo de Totais no Modal -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-4 bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
      <div>
        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-1">Total de Gastos Filtrados</h4>
        <div class="text-xl font-bold text-blue-600 dark:text-blue-400" id="graficos-total-filtrado">R$ 0,00</div>
      </div>
      <div>
        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-1">Média Mensal (Período)</h4>
        <div class="text-xl font-bold text-blue-600 dark:text-blue-400" id="graficos-media-mensal">R$ 0,00</div>
      </div>
      <div>
        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-1">Transações analisadas</h4>
        <div class="text-xl font-bold text-blue-600 dark:text-blue-400" id="graficos-total-transacoes">0</div>
      </div>
      <div>
        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-1">Ticket médio</h4>
        <div class="text-xl font-bold text-blue-600 dark:text-blue-400" id="graficos-ticket-medio">R$ 0,00</div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-sm">
      <div class="p-3 rounded-lg bg-white dark:bg-gray-700/60 border border-blue-100 dark:border-blue-900/40">
        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-1">Categoria que mais pesa</h4>
        <p class="text-gray-600 dark:text-gray-300" id="graficos-top-categoria">Nenhuma categoria filtrada.</p>
      </div>
      <div class="p-3 rounded-lg bg-white dark:bg-gray-700/60 border border-blue-100 dark:border-blue-900/40">
        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-1">Cartão/PIX com maior gasto</h4>
        <p class="text-gray-600 dark:text-gray-300" id="graficos-top-cartao">Nenhum cartão filtrado.</p>
      </div>
    </div>

    <div class="mb-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold text-gray-800 dark:text-gray-100">Resumo mensal do histórico</h3>
        <span class="text-xs text-gray-500 dark:text-gray-400">Últimos meses considerados pelo filtro</span>
      </div>
      <div class="relative h-56">
        <canvas id="grafico-historico-mensal" class="w-full h-full"></canvas>
        <div id="historico-mensal-empty" class="absolute inset-0 flex items-center justify-center text-xs text-gray-500 dark:text-gray-400">Selecione um período com gastos para visualizar o resumo.</div>
      </div>
    </div>

    <div class="mb-4">
      <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Filtrar por Cartões</h3>
      <div id="filtro-cartoes-container" class="flex flex-wrap gap-3">
        <!-- Checkboxes serão inseridos via JS -->
      </div>
    </div>

    <div class="mb-4">
      <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Filtrar por Categorias</h3>
      <div id="filtro-categorias-container" class="flex flex-wrap gap-3">
        <!-- Checkboxes serão inseridos via JS -->
      </div>
    </div>

    <!-- NOVO: Filtro por Período -->
    <div class="mb-4">
      <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Filtrar por Período</h3>
      <div class="flex flex-wrap gap-3 items-center">
        <select id="filtro-periodo-graficos" class="px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
          <option value="current_month">Mês Atual</option>
          <option value="last_3_months">Últimos 3 Meses</option>
          <option value="last_6_months">Últimos 6 Meses</option>
          <option value="current_year">Ano Atual</option>
          <option value="custom">Personalizado</option>
        </select>
        <input type="month" id="filtro-periodo-start" class="px-3 py-2 border rounded-lg hidden bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
        <input type="month" id="filtro-periodo-end" class="px-3 py-2 border rounded-lg hidden bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
      </div>
    </div>

    <div class="flex gap-4 mb-4">
      <button id="btn-aplicar-filtros" class="bg-blue-600 dark:bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-700 dark:hover:bg-blue-800 transition">Aplicar Filtros</button>
      <button id="btn-limpar-filtros" class="bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-100 px-4 py-2 rounded hover:bg-gray-400 dark:hover:bg-gray-700 transition">Limpar Filtros</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Gastos por Categoria</h3>
        <canvas id="grafico-categorias" width="400" height="300"></canvas>
      </div>
      <div>
        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Gastos por Cartão</h3>
        <canvas id="grafico-cartoes" width="400" height="300"></canvas>
      </div>
      <!-- MELHORADO: Canvas para gráfico de tendência com controles -->
      <div class="md:col-span-2">
        <div class="flex justify-between items-center mb-3">
          <h3 class="font-semibold text-gray-800 dark:text-gray-100">📈 Tendência de Gastos por Categoria</h3>
          <div class="flex gap-2">
            <select id="tendencia-tipo-grafico" class="px-2 py-1 border rounded text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
              <option value="line">Linha</option>
              <option value="bar">Barras</option>
              <option value="area">Área</option>
            </select>
            <button id="btn-toggle-todas-categorias" class="px-2 py-1 bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-200 rounded text-sm hover:bg-blue-200 dark:hover:bg-blue-900/40">
              Mostrar Todas
            </button>
          </div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg mb-3">
          <div class="text-xs text-gray-600 dark:text-gray-400 mb-2">💡 Dica: Clique nas categorias da legenda para mostrar/ocultar</div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-gray-800 dark:text-gray-100">
            <div>📊 <strong>Total período:</strong> <span id="tendencia-total">R$ 0,00</span></div>
            <div>📈 <strong>Maior mês:</strong> <span id="tendencia-maior-mes">-</span></div>
            <div>📉 <strong>Menor mês:</strong> <span id="tendencia-menor-mes">-</span></div>
            <div>🎯 <strong>Média:</strong> <span id="tendencia-media">R$ 0,00</span></div>
          </div>
        </div>
        <div class="relative">
          <canvas id="grafico-tendencia-categorias" width="800" height="400"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NOVO: Modal de Gráficos dos Fixos -->
<div id="modal-graficos-fixos" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-11/12 max-w-2xl mx-auto relative shadow-lg modal-content max-h-[90vh] overflow-y-auto">
    <button id="modal-graficos-fixos-close" class="absolute top-3 right-3 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-2xl font-bold" aria-label="Fechar modal">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Análise dos Gastos Fixos</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Total Fixos Ativos</h4>
        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="total-fixos-ativos">R$ 0,00</div>
      </div>
      <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
        <h4 class="font-semibold text-gray-800 dark:text-gray-100 mb-2">Total Fixos Inativos</h4>
        <div class="text-2xl font-bold text-gray-600 dark:text-gray-400" id="total-fixos-inativos">R$ 0,00</div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Distribuição por Categoria</h3>
        <canvas id="grafico-fixos-categoria" width="400" height="300"></canvas>
      </div>
      <div>
        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Impacto no Orçamento</h3>
        <canvas id="grafico-fixos-impacto" width="400" height="300"></canvas>
      </div>
    </div>

    <div class="mt-6">
      <h3 class="font-semibold mb-3 text-gray-800 dark:text-gray-100">Detalhamento por Item</h3>
      <div id="detalhes-fixos" class="space-y-2">
        <!-- Detalhes serão inseridos via JS -->
      </div>
    </div>
  </div>
</div>

<!-- NOVO: Modal de planejamento das metas dos envelopes -->
<div id="modal-planejamento-envelopes" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-11/12 max-w-xl mx-auto relative shadow-2xl modal-content space-y-5">
    <button id="modal-planejamento-envelopes-close" class="absolute top-3 right-3 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-2xl font-bold" aria-label="Fechar modal">&times;</button>
    <div>
      <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 flex items-center gap-2">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-emerald-100 text-emerald-600 dark:bg-emerald-900/50 dark:text-emerald-300">
          <i class="fa fa-bullseye"></i>
        </span>
        Planejar margem do mês
      </h2>
      <p class="text-sm text-slate-600 dark:text-slate-300 mt-1">Visualize suas metas, quanto já foi reservado e direcione a folga restante para onde fizer mais sentido.</p>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
      <div class="rounded-xl border border-emerald-100 dark:border-emerald-800/50 bg-emerald-50/60 dark:bg-emerald-900/20 p-3">
        <span class="text-[0.65rem] uppercase tracking-wide text-emerald-600 dark:text-emerald-300">Meta total</span>
        <div class="text-lg font-semibold text-emerald-800 dark:text-emerald-100">R$ <span id="overview-modal-meta">0,00</span></div>
      </div>
      <div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-800/40 p-3">
        <span class="text-[0.65rem] uppercase tracking-wide text-slate-500 dark:text-slate-300">Gasto no mês</span>
        <div class="text-lg font-semibold text-slate-800 dark:text-slate-100">R$ <span id="overview-modal-gasto">0,00</span></div>
      </div>
      <div class="rounded-xl border border-sky-200 dark:border-sky-800/50 bg-sky-50/70 dark:bg-sky-900/20 p-3">
        <span class="text-[0.65rem] uppercase tracking-wide text-sky-600 dark:text-sky-300">Reservado para metas</span>
        <div class="text-lg font-semibold text-sky-700 dark:text-sky-200">R$ <span id="overview-modal-reservado">0,00</span></div>
      </div>
      <div class="rounded-xl border border-amber-200 dark:border-amber-800/60 bg-amber-50/70 dark:bg-amber-900/20 p-3">
        <span class="text-[0.65rem] uppercase tracking-wide text-amber-600 dark:text-amber-300">Folga direcionável</span>
        <div class="text-lg font-semibold text-amber-700 dark:text-amber-200">R$ <span id="overview-modal-margem">0,00</span></div>
      </div>
    </div>
    <div class="space-y-3 text-sm">
      <div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/40 p-3">
        <p class="text-slate-600 dark:text-slate-300">A folga representa o que sobrou após gastos e reservas planejadas. Escolha uma ação rápida para não deixar esse valor parado.</p>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
        <button id="btn-planejamento-reservar" type="button" class="flex flex-col gap-1 rounded-xl border border-emerald-200 dark:border-emerald-800/60 bg-emerald-600 text-white px-3 py-3 text-left shadow hover:bg-emerald-700 dark:hover:bg-emerald-700 transition">
          <span class="text-xs uppercase tracking-wide">Ajustar metas</span>
          <span class="text-sm font-semibold">Reservar nos envelopes</span>
          <span class="text-[0.7rem] opacity-80">Distribui automaticamente a folga</span>
        </button>
        <button id="btn-planejamento-investir" type="button" class="flex flex-col gap-1 rounded-xl border border-sky-200 dark:border-sky-800/60 bg-sky-600 text-white px-3 py-3 text-left shadow hover:bg-sky-700 dark:hover:bg-sky-700 transition">
          <span class="text-xs uppercase tracking-wide">Fazer render</span>
          <span class="text-sm font-semibold">Enviar para investimentos</span>
          <span class="text-[0.7rem] opacity-80">Leva você ao painel de investimentos</span>
        </button>
        <button id="btn-planejamento-entrada" type="button" class="flex flex-col gap-1 rounded-xl border border-amber-200 dark:border-amber-700/60 bg-amber-500 text-white px-3 py-3 text-left shadow hover:bg-amber-600 dark:hover:bg-amber-600 transition">
          <span class="text-xs uppercase tracking-wide">Guardar</span>
          <span class="text-sm font-semibold">Adicionar como entrada extra</span>
          <span class="text-[0.7rem] opacity-80">Registra como aporte ou reserva</span>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  :root {
    --app-header-height: 3.25rem;
  }

  #mobile-quickbar {
    top: var(--app-header-height);
  }

  .progress-bar{transition:width .4s ease}
  .badge-alert{color:#b91c1c;font-weight:700;margin-left:.4rem}
  .section-card{background:white;border-radius:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.06);padding:1rem}
  .resumo-slider{position:relative;overflow:hidden;touch-action:pan-y}
  .resumo-slider-track{display:flex;gap:0;transition:transform .4s ease}
  .resumo-slide{flex:0 0 100%;min-width:100%}
  .resumo-slider-nav{display:flex;align-items:center;gap:.5rem;margin-bottom:1rem}
  .resumo-slider-dot{padding:.4rem .9rem;border-radius:9999px;background:#f3f4f6;color:#4b5563;font-weight:600;font-size:.85rem;transition:all .25s ease}
  .resumo-slider-dot.is-active{background:#2563eb;color:white;box-shadow:0 8px 16px rgba(37,99,235,.25)}
  .dark .resumo-slider-dot{background:rgba(148,163,184,0.18);color:#e2e8f0;border:1px solid rgba(148,163,184,0.2)}
  .dark .resumo-slider-dot.is-active{background:linear-gradient(135deg,#2563eb,#7c3aed);color:#ffffff;box-shadow:0 12px 32px rgba(124,58,237,0.35);border-color:transparent}
  .resumo-slide-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:1rem}
  .resumo-slide-grid .resumo-item{padding:.75rem;border-radius:.75rem;background:#f9fafb;display:flex;flex-direction:column;gap:.35rem}
  .resumo-item .label{font-size:.8rem;color:#6b7280;text-transform:uppercase;letter-spacing:.05em}
  .resumo-item .value{font-size:1.5rem;font-weight:700;color:#111827}
  .resumo-item .hint{font-size:.75rem;color:#9ca3af}
  .resumo-item.positivo{background:rgba(16,185,129,.1);color:#047857}
  .resumo-item.positivo .value{color:#047857}
  .resumo-item.alerta{background:rgba(248,113,113,.12);color:#b91c1c}
  .resumo-item.alerta .value{color:#b91c1c}
  .resumo-item.neutro{background:rgba(59,130,246,.08);color:#1d4ed8}
  .resumo-item.neutro .value{color:#1d4ed8}
  .dark .resumo-slide-grid .resumo-item {
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.88));
    border: 1px solid rgba(148, 163, 184, 0.2);
    color: #e2e8f0;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.55);
  }
  .dark .resumo-item .value {
    color: #f8fafc;
  }
  .dark .resumo-item .label {
    color: #cbd5f5;
  }
  .dark .resumo-item .hint {
    color: #94a3b8;
  }
  .dark .resumo-item.positivo {
    background: linear-gradient(150deg, rgba(16, 185, 129, 0.35), rgba(5, 150, 105, 0.4));
    border-color: rgba(45, 212, 191, 0.4);
    color: #d1fae5;
  }
  .dark .resumo-item.positivo .value {
    color: #6ee7b7;
  }
  .dark .resumo-item.alerta {
    background: linear-gradient(150deg, rgba(248, 113, 113, 0.35), rgba(185, 28, 28, 0.45));
    border-color: rgba(248, 150, 150, 0.4);
    color: #fee2e2;
  }
  .dark .resumo-item.alerta .value {
    color: #fca5a5;
  }
  .dark .resumo-item.neutro {
    background: linear-gradient(150deg, rgba(59, 130, 246, 0.35), rgba(49, 46, 129, 0.5));
    border-color: rgba(147, 197, 253, 0.35);
    color: #dbeafe;
  }
  .dark .resumo-item.neutro .value {
    color: #bfdbfe;
  }
  .resumo-slider-dots{display:flex;gap:.4rem}
  .resumo-slider-dots button{width:.5rem;height:.5rem;border-radius:9999px;background:#e5e7eb;border:none;padding:0;transition:transform .25s ease,background .25s ease}
  .resumo-slider-dots button.is-active{background:#2563eb;transform:scale(1.1)}
  .gradient-shadow{position:relative}
  .gradient-shadow::after{content:"";position:absolute;inset:0;border-radius:.75rem;pointer-events:none;box-shadow:0 10px 35px rgba(15,23,42,.1)}
  .dark .gradient-shadow{background:linear-gradient(160deg,rgba(30,41,59,0.95),rgba(17,24,39,0.92));border:1px solid rgba(148,163,184,0.2);box-shadow:0 20px 45px rgba(15,23,42,0.6)}
  .compact-resumo{padding:1rem 1.2rem 1.25rem}
  .compact-resumo .resumo-slider-nav{margin-bottom:.75rem}
  .compact-resumo .resumo-slide-grid{gap:.75rem}
  .compact-resumo .resumo-slide-grid .resumo-item{padding:.6rem}
  .compact-resumo .resumo-item .label{font-size:.72rem}
  .compact-resumo .resumo-item .value{font-size:1.25rem}
  .compact-resumo .resumo-item .hint{font-size:.68rem}
  @media (max-width:767px){
    .resumo-slide-grid{grid-template-columns:repeat(1,minmax(0,1fr))}
  }
  @media (min-width:1024px){
    .resumo-slide-grid{grid-template-columns:repeat(4,minmax(0,1fr))}
  }
  .th{font-weight:600;color:#374151;font-size:.85rem;text-align:left;padding:.5rem .75rem;border-bottom:1px solid #e5e7eb}
  .td{padding:.45rem .75rem;border-bottom:1px solid #f3f4f6;font-size:.95rem;vertical-align:middle}
  .pill{font-size:.75rem;border-radius:9999px;padding:.15rem .5rem;background:#f3f4f6}
   .danger-banner{background:#fee2e2;border:1px solid #fca5a5;color:#991b1b;padding:1rem;border-radius:.5rem;margin-bottom:1rem;border-left:4px solid #dc2626}
  
  /* Transições suaves para o botão flutuante */
  body {
    padding-bottom: 4.5rem;
  }
  @media (min-width: 768px) {
    body {
      padding-bottom: 5.25rem;
    }
  }

  .floating-btn-transition {
    transition: transform 0.3s ease, opacity 0.3s ease, bottom 0.3s ease; /* Adicionado bottom */
  }

  #floating-menu {
    transition: transform 0.3s ease, opacity 0.3s ease;
  }

  #floating-menu nav {
    pointer-events: auto;
  }
  
  /* Melhorias visuais para o modal */
  .modal-content {
    animation: modalFadeIn 0.3s ease-out;
  }
  
  @keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Contêineres com scroll refinado para listas/tabelas longas */
  .scroll-shell {
    max-height: 32rem;
    overflow-y: auto;
    border: 1px solid rgba(148, 163, 184, 0.25);
    border-radius: 0.75rem;
    padding: 0.5rem 0.5rem;
    background-color: transparent;
    box-shadow: none;
  }

  .scroll-shell::-webkit-scrollbar {
    width: 10px;
  }

  .scroll-shell::-webkit-scrollbar-track {
    background: transparent;
  }

  .scroll-shell::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.35);
    border-radius: 9999px;
  }

  .scroll-shell::-webkit-scrollbar-thumb:hover {
    background: rgba(100, 116, 139, 0.5);
  }

  /* NOVO: Estilo para o histórico de variáveis com scroll */
  #historico-variavel-scroll-container {
    margin-top: 1rem;
  }
  /* Ajuste para a tabela dentro do container de scroll */
  #historico-variavel-scroll-container table {
    width: 100%; /* Garante que a tabela ocupe a largura total do container */
    border-collapse: collapse; /* Remove espaçamento entre as bordas das células */
  }
  #historico-variavel-scroll-container .th,
  #historico-variavel-scroll-container .td {
    white-space: nowrap; /* Evita que o texto quebre em várias linhas */
  }
  /* Estilo para o spinner de carregamento */
  .loading-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280; /* gray-500 */
    font-size: 0.9rem;
    padding: 1rem;
  }
  .loading-spinner i {
    margin-right: 0.5rem;
  }
  /* Classe específica para ocultar spinners, para evitar conflito com o 'hidden' do Tailwind */
  .spinner-hidden {
    display: none !important;
  }

  .import-filter-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.45rem 0.9rem;
    border-radius: 9999px;
    border: 1px solid rgba(148, 163, 184, 0.6);
    background: rgba(248, 250, 252, 0.85);
    color: #475569;
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    transition: all 0.2s ease;
  }

  .import-filter-btn:hover {
    background: rgba(226, 232, 240, 0.85);
  }

  .import-filter-btn[aria-selected="true"] {
    border-color: #f59e0b;
    background: #fef3c7;
    color: #92400e;
    box-shadow: 0 4px 12px rgba(251, 191, 36, 0.25);
  }

  .dark .import-filter-btn {
    border-color: rgba(71, 85, 105, 0.65);
    background: rgba(15, 23, 42, 0.7);
    color: #cbd5f5;
  }

  .dark .import-filter-btn:hover {
    background: rgba(30, 41, 59, 0.75);
  }

  .dark .import-filter-btn[aria-selected="true"] {
    border-color: rgba(251, 191, 36, 0.55);
    background: rgba(251, 191, 36, 0.16);
    color: #fcd34d;
    box-shadow: 0 6px 18px rgba(251, 191, 36, 0.2);
  }

  .import-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.2rem 0.55rem;
    border-radius: 9999px;
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .import-status-new {
    background: rgba(16, 185, 129, 0.18);
    color: #047857;
  }

  .import-status-duplicate {
    background: rgba(245, 158, 11, 0.18);
    color: #92400e;
  }

  .import-status-conflict {
    background: rgba(248, 113, 113, 0.2);
    color: #b91c1c;
  }

  .dark .import-status-new {
    background: rgba(16, 185, 129, 0.15);
    color: #34d399;
  }

  .dark .import-status-duplicate {
    background: rgba(245, 158, 11, 0.12);
    color: #fbbf24;
  }

  .dark .import-status-conflict {
    background: rgba(248, 113, 113, 0.15);
    color: #fca5a5;
  }

  .import-tag-chip {
    display: inline-flex;
    align-items: center;
    padding: 0.2rem 0.55rem;
    border-radius: 9999px;
    background: rgba(226, 232, 240, 0.8);
    color: #475569;
    font-size: 0.7rem;
    font-weight: 600;
  }

  .dark .import-tag-chip {
    background: rgba(51, 65, 85, 0.75);
    color: #e2e8f0;
  }

  /* NOVO: Estilo para o Toast de feedback */
  #toast-message {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    z-index: 1000;
    font-size: 0.9rem;
  
  }
  #toast-message.show {
    opacity: 1;
  }

  /* NOVO: Estilos para cards de fixos melhorados */
  .fixo-card {
    border-left: 4px solid;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .fixo-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 18px -12px rgba(15, 23, 42, 0.35);
  }
  .fixo-card.ativo {
    border-left-color: #10b981; /* green-500 */
  }
  .fixo-card.inativo {
    border-left-color: #64748b; /* slate-500 */
  }

  .fixo-title {
    font-size: 0.85rem;
  }
  @media (min-width: 768px) {
    .fixo-title {
      font-size: 0.98rem;
    }
  }

  .fixo-meta {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }

  .fixo-category-pill {
    align-self: flex-start;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.18rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.68rem;
    font-weight: 600;
    background-color: rgba(148, 163, 184, 0.15);
    color: #475569;
  }
  .dark .fixo-category-pill {
    background-color: rgba(148, 163, 184, 0.18);
    color: #cbd5f5;
  }

  .fixo-subcategoria {
    font-size: 0.65rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #94a3b8;
  }
  .dark .fixo-subcategoria {
    color: #64748b;
  }

  .fixo-amount {
    font-size: 1rem;
    white-space: nowrap;
  }
  @media (min-width: 640px) {
    .fixo-amount {
      font-size: 1.125rem;
    }
  }

  .fixo-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 600;
  }
  .fixo-status-ativo {
    background-color: #dcfce7;
    color: #047857;
  }
  .fixo-status-inativo {
    background-color: #e2e8f0;
    color: #475569;
  }

  .fixo-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    justify-content: flex-end;
    align-items: center;
  }

  .fixo-action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.85rem;
    height: 1.85rem;
    border-radius: 9999px;
    font-size: 0.76rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .fixo-action-btn i {
    font-size: 0.82rem;
    line-height: 1;
  }
  .fixo-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 14px -12px rgba(15, 23, 42, 0.45);
  }
  .fixo-action-edit {
    background-color: #dbeafe;
    color: #1d4ed8;
  }
  .fixo-action-delete {
    background-color: #fee2e2;
    color: #b91c1c;
  }
  .fixo-action-toggle {
    background-color: #fef3c7;
    color: #b45309;
  }
  .fixo-action-resume {
    background-color: #dcfce7;
    color: #047857;
  }

  .week-chip {
    min-width: 8.5rem;
    border-radius: 1rem;
    padding: 0.6rem 0.85rem;
    border: 1px solid rgba(148, 163, 184, 0.45);
    background: rgba(255, 255, 255, 0.92);
    box-shadow: 0 10px 18px -12px rgba(15, 23, 42, 0.25);
  }
  .week-chip strong {
    font-size: 0.85rem;
  }
  .week-chip span {
    font-size: 0.75rem;
  }
  .dark .week-chip {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(71, 85, 105, 0.6);
    box-shadow: 0 10px 22px -14px rgba(15, 23, 42, 0.6);
  }

  /* NOVO: Melhorias visuais para parcelados */
  .parcelado-status {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .parcelado-ativo {
    background-color: #dbeafe; /* blue-100 */
    color: #1e40af; /* blue-800 */
  }
  .parcelado-finalizado {
    background-color: #d1fae5; /* green-100 */
    color: #065f46; /* green-800 */
  }
  .parcelado-futuro {
    background-color: #f3f4f6; /* gray-100 */
    color: #374151; /* gray-700 */
  }

  /* Melhoria na barra de progresso dos parcelados */
  .progress-parcelado {
    height: 6px;
    background-color: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 4px;
  }
  .progress-parcelado-fill {
    height: 100%;
    transition: width 0.4s ease;
    border-radius: 3px;
  }
  .progress-ativo {
    background-color: #3b82f6; /* blue-500 */
  }
  .progress-finalizado {
    background-color: #10b981; /* green-500 */
  }

  #parcelados-table-wrapper {
    max-height: none;
    overflow-y: visible;
    transition: box-shadow 0.25s ease, border-color 0.25s ease, background 0.25s ease;
  }

  #parcelados-table-wrapper.parcelados-scroll {
    max-height: 32rem;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 0.75rem 0.5rem;
    background-color: #ffffff;
    box-shadow: inset 0 -10px 16px -14px rgba(15, 23, 42, 0.22);
  }

  #parcelados-table-wrapper.parcelados-scroll table {
    min-width: 44rem;
    width: 100%;
  }

  #parcelados-table-wrapper.parcelados-scroll::-webkit-scrollbar {
    width: 10px;
  }

  #parcelados-table-wrapper.parcelados-scroll::-webkit-scrollbar-track {
    background: transparent;
  }

  #parcelados-table-wrapper.parcelados-scroll::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.35);
    border-radius: 9999px;
  }

  #parcelados-table-wrapper.parcelados-scroll::-webkit-scrollbar-thumb:hover {
    background: rgba(100, 116, 139, 0.5);
  }

  /* NOVO: Estilos para sistema de tags */
.tag-pill {
  display: inline-block;
  background-color: #3b82f6;
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  margin: 0.125rem;
  cursor: pointer;
  transition: all 0.2s ease;
}
.tag-pill:hover {
  background-color: #2563eb;
  transform: scale(1.05);
}
.tag-pill.removable {
  padding-right: 1.5rem;
  position: relative;
}
.tag-pill .remove-tag {
  position: absolute;
  right: 0.25rem;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  font-weight: bold;
}
.tag-suggestion {
  padding: 0.5rem;
  cursor: pointer;
  border-bottom: 1px solid #e5e7eb;
  transition: background-color 0.2s ease;
}
.tag-suggestion:hover {
  background-color: #f3f4f6;
}
.tag-suggestion:last-child {
  border-bottom: none;
}
/* Dark mode para tag suggestions */
html.dark .tag-suggestion {
  border-bottom-color: #374151; /* dark:border-b-gray-600 */
}
html.dark .tag-suggestion:hover {
  background-color: #374151; /* dark:bg-gray-600 */
}

.mobile-tab-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.55rem 1rem;
  border-radius: 9999px;
  font-weight: 600;
  font-size: 0.85rem;
  border: 1px solid rgba(148, 163, 184, 0.45);
  color: #1f2937;
  background: rgba(255, 255, 255, 0.78);
  transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, color 0.2s ease;
  white-space: nowrap;
}

html.dark .mobile-tab-button {
  border-color: rgba(148, 163, 184, 0.35);
  background: rgba(15, 23, 42, 0.82);
  color: #e2e8f0;
}

.mobile-tab-button.active {
  background: linear-gradient(135deg, #2563eb, #4f46e5);
  color: #ffffff;
  border-color: transparent;
  box-shadow: 0 12px 22px rgba(37, 99, 235, 0.35);
  transform: translateY(-1px);
}

.mobile-tab-button:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
}

.no-scrollbar::-webkit-scrollbar {
  display: none;
}

.no-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

/* NOVO: Estilos para filtro de busca no histórico */
.search-highlight {
  background-color: #fef3c7;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
  }

  /* NOVO: Estilos para modo escuro (mantendo padrão original) */
  .dark {
    background-color: #1f2937;
    color: #f9fafb;
  }
  .dark .section-card {
    background-color: #374151;
    color: #f9fafb;
  }
  .dark .section-card.gradient-shadow {
    background-color: #374151;
    border: none;
    box-shadow: 0 1px 2px rgba(15, 23, 42, 0.45);
  }
  .dark .bg-white {
    background-color: #374151 !important;
  }
  .dark .text-gray-800 {
    color: #f9fafb !important;
  }
  .dark .text-gray-600 {
    color: #d1d5db !important;
  }
  .dark .text-gray-500 {
    color: #9ca3af !important;
  }
  .dark .border-gray-300 {
    border-color: #4b5563 !important;
  }
  .dark .bg-gray-50 {
    background-color: #1f2937 !important;
  }
  .dark .bg-gray-100 {
    background-color: #374151 !important;
  }

  /* Dark mode para elementos específicos (mantendo padrão original) */
  html.dark .th {
    color: #d1d5db; /* dark:text-gray-300 */
    border-bottom-color: #374151; /* dark:border-b-gray-700 */
  }
  html.dark .td {
    border-bottom-color: #374151; /* dark:border-b-gray-700 */
  }
  html.dark .danger-banner {
    background-color: #1f2937; /* dark:bg-red-900/20 (aprox) */
    border-color: #7f1d1d; /* dark:border-red-700 */
    color: #f3e8e8; /* dark:text-red-300 */
    border-left-color: #b91c1c; /* dark:border-left-red-600 */
  }
  html.dark .loading-spinner {
    color: #9ca3af; /* dark:gray-400 */
  }
  html.dark #toast-message {
    background-color: #f3f4f6; /* dark:bg-gray-200 */
    color: #111827; /* dark:text-gray-900 */
  }
  html.dark .pill {
    background-color: #374151; /* dark:bg-gray-700 */
  }
  html.dark .search-highlight {
    background-color: #92400e; /* dark:bg-yellow-700 (aprox) para legibilidade */
  }
  html.dark .tag-suggestion {
    border-bottom-color: #374151; /* dark:border-b-gray-600 */
  }
  html.dark .tag-suggestion:hover {
    background-color: #374151; /* dark:bg-gray-600 */
  }
  html.dark .scroll-shell {
    border-color: rgba(148, 163, 184, 0.35);
    background-color: transparent;
    box-shadow: none;
  }
  html.dark .scroll-shell::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.45);
  }
  html.dark .scroll-shell::-webkit-scrollbar-thumb:hover {
    background: rgba(226, 232, 240, 0.6);
  }
  html.dark .fixo-status-ativo {
    background-color: rgba(34, 197, 94, 0.2);
    color: #bbf7d0;
  }
  html.dark .fixo-status-inativo {
    background-color: rgba(148, 163, 184, 0.2);
    color: #e2e8f0;
  }
  html.dark .fixo-action-edit {
    background-color: rgba(59, 130, 246, 0.18);
    color: #bfdbfe;
  }
  html.dark .fixo-action-delete {
    background-color: rgba(248, 113, 113, 0.18);
    color: #fecaca;
  }
  html.dark .fixo-action-toggle {
    background-color: rgba(251, 191, 36, 0.18);
    color: #facc15;
  }
  html.dark .fixo-action-resume {
    background-color: rgba(34, 197, 94, 0.22);
    color: #bbf7d0;
  }
  html.dark .progress-parcelado {
    background-color: #374151; /* dark:gray-700 */
  }
  html.dark .parcelado-ativo {
    background-color: #1e3a8a; /* dark:bg-blue-900/20 (aprox) */
    color: #bfdbfe; /* dark:text-blue-200 */
  }
  html.dark .parcelado-finalizado {
    background-color: #064e3b; /* dark:bg-green-900/20 (aprox) */
    color: #86efac; /* dark:text-green-200 */
  }
  html.dark .parcelado-futuro {
    background-color: #374151; /* dark:bg-gray-700 */
    color: #d1d5db; /* dark:text-gray-300 */
  }

  html.dark #parcelados-table-wrapper.parcelados-scroll {
    border-color: #475569;
    background-color: #374151;
    box-shadow: inset 0 -10px 18px -16px rgba(15, 23, 42, 0.5);
  }

  html.dark #parcelados-table-wrapper.parcelados-scroll::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.45);
  }

  html.dark #parcelados-table-wrapper.parcelados-scroll::-webkit-scrollbar-thumb:hover {
    background: rgba(148, 163, 184, 0.65);
  }

/* NOVO: Estilo para o botão flutuante quando invisível */
#floating-menu.invisible {
  pointer-events: none;
  display: none; /* Adicionado para garantir que não ocupe espaço nem receba cliques */
}

</style>


</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-900 dark:to-gray-800 min-h-screen text-gray-800 dark:text-gray-100 transition-colors duration-300">

<!-- FIREBASE CONFIG ALERT -->
<div id="firebase-config-overlay" class="hidden fixed inset-0 z-[11000] bg-slate-900/95 backdrop-blur-md flex items-center justify-center px-6 py-8">
  <div class="w-full max-w-md space-y-4 rounded-2xl border border-red-300/60 dark:border-red-500/40 bg-white/95 dark:bg-slate-900/95 p-6 shadow-2xl">
    <div class="flex items-start gap-3">
      <span class="mt-1 inline-flex h-9 w-9 items-center justify-center rounded-full bg-red-100 text-red-600 dark:bg-red-900/40 dark:text-red-300">
        <i class="fa-solid fa-triangle-exclamation"></i>
      </span>
      <div class="space-y-2">
        <h2 class="text-lg font-semibold text-red-700 dark:text-red-200">Configuração do Firebase ausente</h2>
        <p class="text-sm leading-relaxed text-gray-600 dark:text-gray-300">Crie um arquivo <code class="rounded bg-gray-100 px-1 py-0.5 text-xs text-gray-800 dark:bg-gray-800 dark:text-gray-200">app-config.js</code> no mesmo diretório do <code class="rounded bg-gray-100 px-1 py-0.5 text-xs text-gray-800 dark:bg-gray-800 dark:text-gray-200">index.html</code> e defina <code class="rounded bg-gray-100 px-1 py-0.5 text-xs text-gray-800 dark:bg-gray-800 dark:text-gray-200">window.__FIREBASE_CONFIG__</code> com as chaves do seu projeto.</p>
        <p class="text-sm leading-relaxed text-gray-600 dark:text-gray-300">Em produção (por exemplo, na Vercel), adicione as variáveis <code class="rounded bg-gray-100 px-1 py-0.5 text-xs text-gray-800 dark:bg-gray-800 dark:text-gray-200">FIREBASE_API_KEY</code>, <code class="rounded bg-gray-100 px-1 py-0.5 text-xs text-gray-800 dark:bg-gray-800 dark:text-gray-200">FIREBASE_AUTH_DOMAIN</code>, <code class="rounded bg-gray-100 px-1 py-0.5 text-xs text-gray-800 dark:bg-gray-800 dark:text-gray-200">FIREBASE_PROJECT_ID</code> e demais chaves do Firebase no painel de Environment Variables para que <code class="rounded bg-gray-100 px-1 py-0.5 text-xs text-gray-800 dark:bg-gray-800 dark:text-gray-200">/app-config.js</code> seja servido automaticamente.</p>
        <p class="text-sm leading-relaxed text-gray-600 dark:text-gray-300">Para desenvolvimento local, copie <strong>app-config.example.js</strong>, renomeie para <strong>app-config.js</strong> e substitua os valores de exemplo antes de iniciar o app.</p>
      </div>
    </div>
    <p class="text-xs text-gray-500 dark:text-gray-400">As credenciais do Firebase são públicas por padrão em apps web. Garanta a segurança aplicando regras no Firestore e restrições de API no Console do Google Cloud.</p>
  </div>
</div>

<!-- AUTH OVERLAY -->
<div id="auth-overlay" class="hidden fixed inset-0 z-[10000] bg-slate-900/90 backdrop-blur flex items-center justify-center px-4 py-8">
  <div class="w-full max-w-sm bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-emerald-200/60 dark:border-emerald-900/40 p-6 space-y-6">
    <div class="text-center space-y-2">
      <h2 id="auth-title" class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">Acessar sua conta</h2>
      <p id="auth-description" class="text-sm text-gray-500 dark:text-gray-400">Faça login para carregar seus dados financeiros salvos.</p>
    </div>
    <div id="auth-form-block" class="space-y-6">
      <form id="auth-form" class="space-y-4">
        <div class="space-y-1">
          <label for="auth-email" class="text-sm font-medium text-gray-700 dark:text-gray-300">E-mail</label>
          <input id="auth-email" type="email" autocomplete="email" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-emerald-500" />
        </div>
        <div class="space-y-1">
          <label for="auth-password" class="text-sm font-medium text-gray-700 dark:text-gray-300">Senha</label>
          <input id="auth-password" type="password" autocomplete="current-password" required minlength="6" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-emerald-500" />
        </div>
        <div class="space-y-2">
          <button type="submit" id="auth-submit" class="w-full py-2.5 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-semibold transition-colors">Entrar</button>
          <button type="button" id="auth-toggle-mode" class="w-full py-2.5 rounded-lg border border-emerald-200 dark:border-emerald-800 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 transition-colors">Criar uma nova conta</button>
        </div>
        <p id="auth-error" class="text-sm text-red-500 hidden"></p>
      </form>
      <div id="auth-social-block" class="space-y-3">
        <div class="flex items-center gap-3 text-xs uppercase tracking-[0.3em] text-gray-400 dark:text-gray-500">
          <span class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></span>
          <span>ou</span>
          <span class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></span>
        </div>
        <button type="button" id="auth-google" class="w-full flex items-center justify-center gap-3 py-2.5 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/80 transition-colors">
          <i class="fab fa-google text-lg"></i>
          <span data-label>Entrar com Google</span>
        </button>
        <p id="auth-google-helper" class="hidden text-xs leading-relaxed text-amber-600 dark:text-amber-400 bg-amber-50/80 dark:bg-amber-400/10 border border-amber-200/80 dark:border-amber-500/40 rounded-lg px-3 py-2">
          Para usar o Google em desenvolvimento, abra o app por <strong>http://localhost</strong> ou adicione <strong data-google-host></strong> à lista de domínios autorizados no Console do Firebase (Authentication → Settings → Authorized domains).
        </p>
      </div>
    </div>
    <div id="auth-verify-block" class="hidden space-y-4">
      <div class="space-y-2 text-sm text-left">
        <p class="text-gray-600 dark:text-gray-300">Enviamos um link de confirmação para <strong id="auth-verify-email" class="break-all"></strong>.</p>
        <p class="text-gray-500 dark:text-gray-400">Confirme o endereço para liberar seu ambiente financeiro. Depois de clicar no link, volte aqui e toque em “Já confirmei”.</p>
      </div>
      <div class="space-y-2">
        <button type="button" id="auth-verify-refresh" class="w-full py-2.5 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-semibold transition-colors">Já confirmei</button>
        <button type="button" id="auth-verify-resend" class="w-full py-2.5 rounded-lg border border-emerald-200 dark:border-emerald-800 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 transition-colors">Reenviar e-mail de verificação</button>
        <button type="button" id="auth-verify-change" class="w-full py-2 rounded-lg text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">Entrar com outro e-mail</button>
      </div>
      <p id="auth-verify-feedback" class="hidden text-sm"></p>
    </div>
    <div id="auth-verse" class="hidden text-xs leading-relaxed text-gray-600 dark:text-gray-300 bg-emerald-50/60 dark:bg-emerald-500/10 border border-emerald-100/70 dark:border-emerald-500/30 rounded-xl px-4 py-3 text-center italic"></div>
  </div>
</div>

<!-- ACCESS GUARD OVERLAY -->
<div id="access-guard-overlay" class="hidden fixed inset-0 z-[9999] bg-slate-900/95 backdrop-blur-sm flex items-center justify-center px-4 py-8">
  <div class="w-full max-w-md bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-emerald-200/60 dark:border-emerald-900/40 p-6 space-y-4 text-center">
    <div class="flex items-center justify-center w-14 h-14 rounded-full mx-auto bg-emerald-100 dark:bg-emerald-500/10 text-emerald-600 dark:text-emerald-300">
      <i id="access-guard-icon" class="fa-solid fa-shield-halved text-2xl"></i>
    </div>
    <div class="space-y-2">
      <h2 id="access-guard-title" class="text-xl font-semibold text-gray-800 dark:text-gray-100">Acesso em análise</h2>
      <p id="access-guard-message" class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed">
        Aguarde a liberação do administrador. Assim que sua conta for aprovada, o painel será carregado automaticamente.
      </p>
    </div>
    <div id="access-guard-extra" class="hidden text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 rounded-xl px-4 py-3 leading-relaxed"></div>
    <div class="flex flex-col sm:flex-row gap-3 pt-2">
      <button id="access-guard-refresh" type="button" class="flex-1 py-2.5 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-semibold transition-colors">Verificar status</button>
      <button id="access-guard-signout" type="button" class="flex-1 py-2.5 rounded-lg border border-emerald-200 dark:border-emerald-800 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 transition-colors">Trocar de conta</button>
    </div>
  </div>
</div>

<!-- MODAL: Compartilhamento do espaço financeiro -->
<div id="modal-workspace-share" class="fixed inset-0 z-[9500] hidden items-center justify-center bg-slate-900/80 backdrop-blur px-4 py-8">
  <div class="relative w-full max-w-xl bg-white dark:bg-gray-900 border border-gray-200/80 dark:border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8">
    <button id="workspace-share-close" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl leading-none" aria-label="Fechar modal">&times;</button>
    <div class="space-y-6 text-sm">
      <div>
        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100 flex items-center gap-2">
          <i class="fa-solid fa-people-roof text-emerald-500"></i>
          Espaço familiar
        </h2>
        <p id="workspace-owner-hint" class="mt-2 text-gray-500 dark:text-gray-400 text-sm leading-relaxed"></p>
      </div>
      <div class="rounded-xl border border-emerald-200/70 dark:border-emerald-500/30 bg-emerald-50/60 dark:bg-emerald-500/10 p-4 space-y-3">
        <div class="text-xs font-semibold uppercase tracking-wide text-emerald-700 dark:text-emerald-300">Código do seu espaço</div>
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
          <code id="workspace-share-code" class="flex-1 text-lg sm:text-xl font-semibold text-emerald-700 dark:text-emerald-300 break-all bg-white dark:bg-gray-900 px-3 py-1.5 rounded-lg border border-emerald-200/60 dark:border-emerald-500/40 shadow-inner">—</code>
          <button id="workspace-copy-code" type="button" class="self-start sm:self-auto px-3 py-1.5 text-xs font-semibold rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white transition-colors">Copiar</button>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed">Compartilhe este código com quem também precisa enxergar e editar esses dados. Após inserir o código, a outra conta passará a usar o mesmo ambiente financeiro.</p>
      </div>
      <div class="space-y-3">
        <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-200 uppercase tracking-wide">Quem tem acesso</h3>
        <ul id="workspace-members-list" class="space-y-2 text-sm"></ul>
      </div>
      <form id="workspace-join-form" class="space-y-3">
        <div class="space-y-2">
          <label for="workspace-join-code" class="text-sm font-medium text-gray-700 dark:text-gray-200">Recebeu um código familiar?</label>
          <input id="workspace-join-code" type="text" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-3 py-2 text-gray-800 dark:text-gray-100 placeholder-gray-400" placeholder="Cole o código ou e-mail da conta administradora" autocomplete="off" />
          <p id="workspace-join-helper" class="hidden text-xs text-gray-500 dark:text-gray-400 leading-relaxed">Essa área aparece para quem entra com outra conta. Peça para o familiar acessar o app com o login dele(a) e colar o código acima.</p>
        </div>
        <button id="workspace-join-submit" type="submit" class="w-full py-2.5 rounded-lg font-semibold bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white transition-colors">Usar esse espaço</button>
      </form>
      <button id="workspace-leave-button" type="button" class="hidden w-full py-2.5 rounded-lg font-semibold border border-red-200 dark:border-red-500/40 text-red-600 dark:text-red-300 hover:bg-red-50 dark:hover:bg-red-500/10 transition-colors">Voltar para meu espaço individual</button>
      <p id="workspace-share-feedback" class="hidden text-sm"></p>
    </div>
  </div>
</div>

<!-- MODAL: Controle de acesso -->
<div id="modal-access-manager" class="fixed inset-0 z-[9400] hidden items-center justify-center bg-slate-900/80 backdrop-blur px-4 py-8 overflow-y-auto">
  <div class="relative w-full max-w-3xl bg-white dark:bg-gray-900 border border-gray-200/80 dark:border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8 max-h-[88vh] overflow-y-auto">
    <button id="access-manager-close" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl leading-none" aria-label="Fechar modal">&times;</button>
    <div class="space-y-6 text-sm">
      <div>
        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100 flex items-center gap-2">
          <i class="fa-solid fa-user-shield text-emerald-500"></i>
          Controle de acesso
        </h2>
        <p class="mt-2 text-gray-500 dark:text-gray-400 text-sm leading-relaxed">
          Aprove ou bloqueie contas antes de liberar o painel. Convide clientes apenas depois de validar e-mails e permissões.
        </p>
      </div>
      <div class="space-y-4">
        <section class="rounded-2xl border border-emerald-100 dark:border-emerald-900/40 bg-emerald-50/40 dark:bg-emerald-500/5 overflow-hidden">
          <button type="button" class="flex w-full items-center justify-between gap-3 px-4 py-3 text-left transition-colors hover:bg-emerald-100/60 dark:hover:bg-emerald-500/10" data-access-section-toggle="pending" aria-expanded="true" aria-controls="access-manager-pending-body">
            <span class="flex items-center gap-2 text-sm font-semibold text-emerald-700 dark:text-emerald-200 uppercase tracking-wide">
              <i class="fa-solid fa-hourglass-half"></i>
              Pendentes
            </span>
            <span class="flex items-center gap-2 text-xs text-emerald-700 dark:text-emerald-200">
              <span id="access-manager-pending-count"></span>
              <i class="fa-solid fa-chevron-down transition-transform duration-200 transform" data-access-section-caret="pending"></i>
            </span>
          </button>
          <div id="access-manager-pending-body" class="space-y-3 border-t border-emerald-100 dark:border-emerald-900/40 px-4 pb-4 pt-3" data-access-section-body="pending">
            <ul id="access-manager-pending" class="space-y-3"></ul>
            <p id="access-manager-pending-empty" class="hidden text-xs text-emerald-800/80 dark:text-emerald-200/80 leading-relaxed">Nenhuma conta aguardando aprovação no momento.</p>
          </div>
        </section>
        <section class="rounded-2xl border border-emerald-100 dark:border-emerald-900/40 bg-white dark:bg-gray-900/40 overflow-hidden" data-access-default="collapsed">
          <button type="button" class="flex w-full items-center justify-between gap-3 px-4 py-3 text-left transition-colors hover:bg-emerald-50/70 dark:hover:bg-gray-800/70" data-access-section-toggle="approved" aria-expanded="false" aria-controls="access-manager-approved-body">
            <span class="flex items-center gap-2 text-sm font-semibold text-emerald-700 dark:text-emerald-200 uppercase tracking-wide">
              <i class="fa-solid fa-user-check"></i>
              Ativos
            </span>
            <span class="flex items-center gap-2 text-xs text-emerald-700 dark:text-emerald-200">
              <span id="access-manager-approved-count"></span>
              <i class="fa-solid fa-chevron-down transition-transform duration-200 transform" data-access-section-caret="approved"></i>
            </span>
          </button>
          <div id="access-manager-approved-body" class="hidden space-y-3 border-t border-emerald-100 dark:border-emerald-900/40 px-4 pb-4 pt-3" data-access-section-body="approved">
            <ul id="access-manager-approved" class="space-y-3"></ul>
            <p id="access-manager-approved-empty" class="hidden text-xs text-gray-500 dark:text-gray-400 leading-relaxed">Nenhuma conta liberada além da sua.</p>
          </div>
        </section>
        <section class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900/40 overflow-hidden" data-access-default="collapsed">
          <button type="button" class="flex w-full items-center justify-between gap-3 px-4 py-3 text-left transition-colors hover:bg-gray-100 dark:hover:bg-gray-800" data-access-section-toggle="blocked" aria-expanded="false" aria-controls="access-manager-blocked-body">
            <span class="flex items-center gap-2 text-sm font-semibold text-gray-700 dark:text-gray-200 uppercase tracking-wide">
              <i class="fa-solid fa-user-lock"></i>
              Bloqueadas
            </span>
            <span class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-300">
              <span id="access-manager-blocked-count"></span>
              <i class="fa-solid fa-chevron-down transition-transform duration-200 transform" data-access-section-caret="blocked"></i>
            </span>
          </button>
          <div id="access-manager-blocked-body" class="hidden space-y-3 border-t border-gray-200 dark:border-gray-700 px-4 pb-4 pt-3" data-access-section-body="blocked">
            <ul id="access-manager-blocked" class="space-y-3"></ul>
            <p id="access-manager-blocked-empty" class="hidden text-xs text-gray-500 dark:text-gray-400 leading-relaxed">Nenhuma conta bloqueada.</p>
          </div>
        </section>
      </div>
      <footer class="rounded-xl bg-emerald-50/70 dark:bg-emerald-500/10 border border-emerald-200/60 dark:border-emerald-500/30 px-4 py-3 text-xs text-gray-600 dark:text-gray-300 leading-relaxed">
        <p>💡 Contas aprovadas passam a acessar o mesmo espaço financeiro definido no compartilhamento familiar. Use o bloqueio para suspender o acesso sem excluir dados.</p>
      </footer>
    </div>
  </div>
</div>

<!-- HEADER: filtro mês + menu do usuário -->
<header id="app-header" class="bg-white dark:bg-gray-900 shadow sticky top-0 z-40 px-3 py-1 relative">
  <div class="flex items-center gap-2">
    <select id="filtro-mes" class="flex-1 min-w-0 px-3 py-1.5 border rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-xs sm:text-sm md:flex-none md:w-auto md:min-w-[13rem] md:max-w-[16rem] lg:max-w-xs">
      <option value="all">Todos</option>
    </select>
    <div id="user-session" class="relative hidden shrink-0">
      <button id="user-menu-trigger" type="button" class="relative flex items-center gap-1.5 rounded-full border border-gray-200 dark:border-gray-700 bg-white/90 dark:bg-gray-800/70 px-2 py-1 shadow-sm text-xs sm:text-sm text-gray-700 dark:text-gray-100 transition-colors hover:border-emerald-200 dark:hover:border-emerald-500"
        aria-haspopup="true" aria-expanded="false">
        <span id="user-avatar-badge" class="flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500 text-white text-xs font-semibold">U</span>
        <span id="user-badge-label" class="max-w-[6rem] sm:max-w-[8rem] truncate text-left text-[0.7rem] sm:text-sm"></span>
        <i class="fa fa-chevron-down text-[0.6rem] text-gray-500 dark:text-gray-400 transition-transform duration-200 transform" data-user-menu-caret></i>
        <span id="user-plan-reminder-dot" class="hidden absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full shadow-md" aria-hidden="true"></span>
      </button>
      <div id="user-menu-dropdown" class="absolute right-0 mt-2 w-60 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-xl overflow-hidden hidden">
        <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-700 space-y-1 text-[0.72rem] leading-relaxed text-gray-500 dark:text-gray-400">
          <div class="uppercase tracking-wide text-[0.65rem] text-gray-400 dark:text-gray-500">Conectado como</div>
          <div id="user-email-badge" class="font-medium text-gray-700 dark:text-gray-100 break-words"></div>
          <span id="workspace-context-badge" class="hidden inline-flex items-center gap-1 rounded-full bg-emerald-100/80 dark:bg-emerald-500/10 text-emerald-700 dark:text-emerald-200 px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-wide"></span>
        </div>
        <div id="user-plan-reminder" class="hidden border-b border-gray-100 dark:border-gray-700">
          <div class="px-4 py-3 text-xs flex items-start gap-2">
            <i id="user-plan-reminder-icon" class="fa-solid fa-bell text-[0.7rem] mt-0.5" aria-hidden="true"></i>
            <div class="space-y-1">
              <p id="user-plan-reminder-label" class="text-xs font-semibold"></p>
              <p id="user-plan-reminder-desc" class="text-[0.65rem] leading-4"></p>
            </div>
          </div>
        </div>
        <button id="toggleDark" type="button" aria-label="Alternar tema" class="w-full flex items-center justify-between px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          <span class="flex items-center gap-2">
            <i class="fa-solid fa-moon text-xs" data-dark-icon></i>
            <i class="fa-solid fa-sun text-xs hidden" data-light-icon></i>
            <span>Tema</span>
          </span>
          <span id="toggleDarkStatus" class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400"></span>
        </button>
        <button id="btn-open-access-manager" type="button" class="hidden w-full flex items-center gap-2 px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          <i class="fa-solid fa-user-check text-emerald-500"></i>
          <span>Controle de acesso</span>
        </button>
        <button id="btn-open-workspace-sharing" type="button" class="w-full flex items-center gap-2 px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          <i class="fa fa-people-group text-emerald-500"></i>
          <span>Família</span>
        </button>
        <button id="btn-signout" type="button" class="w-full flex items-center gap-2 px-4 py-2 text-left text-sm text-red-600 dark:text-red-300 hover:bg-red-50 dark:hover:bg-red-500/10 transition-colors">
          <i class="fa fa-arrow-right-from-bracket"></i>
          <span>Sair</span>
        </button>
      </div>
    </div>
  </div>
</header>

<!-- MOBILE QUICK SUMMARY + NAV -->
<section id="mobile-quickbar" class="lg:hidden sticky z-30 px-3 py-2 space-y-1.5 bg-white/90 dark:bg-gray-900/90 backdrop-blur border-b border-gray-200/70 dark:border-gray-700/60 shadow-sm">
  <div class="flex items-center justify-between text-[0.7rem] uppercase tracking-[0.18em] text-gray-500 dark:text-gray-400">
    <span>Visão geral</span>
    <span class="font-semibold text-blue-600 dark:text-blue-300">Mobile</span>
  </div>
  <nav id="mobile-panels-nav" class="text-sm font-medium">
    <div class="flex gap-2 overflow-x-auto no-scrollbar">
      <button type="button" class="mobile-tab-button" data-panel-target="painel-gastos">Gastos</button>
      <button type="button" class="mobile-tab-button" data-panel-target="painel-saidas">Saídas</button>
      <button type="button" class="mobile-tab-button" data-panel-target="painel-entradas">Entradas</button>
      <button type="button" class="mobile-tab-button" data-panel-target="painel-investimentos">Invest.</button>
      <button type="button" class="mobile-tab-button" data-panel-target="painel-saude-financeira">Saúde</button>
      <button type="button" class="mobile-tab-button" data-panel-target="painel-fixos">Fixos</button>
      <button type="button" class="mobile-tab-button" data-panel-target="painel-cartoes">Cartões</button>
    </div>
  </nav>
</section>

<!-- LOADING SCREEN -->
<div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-900 dark:to-gray-800 z-[9999]">
  <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400 mb-8">Organizador Financeiro</h1>
  
  <!-- Animação de gráfico -->
  <div class="flex space-x-2 mb-6">
    <div class="w-3 h-8 bg-green-500 rounded animate-bounce" style="animation-delay: -0.3s"></div>
    <div class="w-3 h-12 bg-green-400 rounded animate-bounce" style="animation-delay: -0.15s"></div>
    <div class="w-3 h-6 bg-green-600 rounded animate-bounce"></div>
  </div>

  <p class="text-gray-600 dark:text-gray-300">Organizando suas finanças…</p>
</div>


<!-- Modal para adicionar/editar parcelado -->
<div id="modal-parcelado" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-96 p-6 relative">
    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100" id="modal-parcelado-title">Editar Parcelado</h2>
    <form id="form-parcelado" class="space-y-4">
      <div>
        <label for="parcelado-desc" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Descrição</label>
        <input type="text" id="parcelado-desc" name="descricao" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600"/>
      </div>
      <div>
        <label for="parcelado-valor" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Valor da Parcela (R$)</label>
        <input type="number" id="parcelado-valor" name="valorParcela" min="0" step="0.01" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600"/>
      </div>
      <div>
        <label for="parcelado-num" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Número de Parcelas</label>
        <input type="number" id="parcelado-num" name="numParcelas" min="1" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600"/>
      </div>
      <div>
        <label for="parcelado-cartao" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Cartão</label>
        <select id="parcelado-cartao" name="cartao" class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
          <option value="">Nenhum</option>
          <option value="nubank">Nubank</option>
          <option value="itau">Itaú</option>
          <option value="univ">Univ</option>
          <option value="amazon">Amazon</option>
          <option value="mercado">Mercado Pago</option>
          <option value="pix">PIX</option>
        </select>
      </div>
      <div>
        <label for="parcelado-inicio" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Data de Início</label>
        <input type="month" id="parcelado-inicio" name="dataInicio" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600"/>
      </div>
      <div class="flex justify-end space-x-2 mt-4">
        <button type="button" id="btn-cancelar-parcelado" class="px-4 py-2 rounded bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-100 hover:bg-gray-400 dark:hover:bg-gray-700">Cancelar</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 dark:bg-blue-700 text-white hover:bg-blue-700 dark:hover:bg-blue-800">Salvar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de importação de extratos -->
<div id="modal-importar" class="fixed inset-0 z-[9700] hidden bg-slate-900/80 backdrop-blur flex items-center justify-center px-4 py-8" role="dialog" aria-modal="true" aria-labelledby="modal-importar-title">
  <div class="relative mx-auto w-full max-w-6xl max-h-[90vh] overflow-hidden rounded-3xl border border-slate-200/70 dark:border-slate-700/60 bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-100 shadow-2xl">
    <div class="flex items-start justify-between gap-3 border-b border-slate-200/70 dark:border-slate-800 px-6 py-4">
      <div>
        <h2 id="modal-importar-title" class="text-xl font-semibold">Importar extrato bancário</h2>
        <p id="modal-importar-subtitle" class="text-sm text-slate-500 dark:text-slate-400">Selecione um arquivo CSV ou OFX e revise os lançamentos antes de confirmar.</p>
      </div>
      <button id="btn-close-importar" type="button" class="text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-200 text-2xl leading-none" aria-label="Fechar importação">&times;</button>
    </div>
    <div class="relative h-full">
      <div id="import-loading-overlay" class="hidden absolute inset-0 z-20 flex flex-col items-center justify-center gap-3 bg-white/80 dark:bg-slate-950/90">
        <i class="fa fa-spinner fa-spin text-2xl text-amber-500"></i>
        <p id="import-loading-text" class="text-sm font-medium text-slate-600 dark:text-slate-200">Processando arquivo…</p>
      </div>
      <div id="import-scroll-area" class="overflow-y-auto px-6 py-5 space-y-5 max-h-[65vh]">
        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-2">
            <label for="import-file-input" class="text-sm font-semibold text-slate-700 dark:text-slate-200">Arquivo</label>
            <input id="import-file-input" type="file" accept=".csv,.ofx" class="block w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500" />
            <p id="import-file-name" class="text-xs text-slate-500 dark:text-slate-400">Nenhum arquivo selecionado.</p>
          </div>
          <div class="grid gap-4 sm:grid-cols-2">
            <div class="space-y-2">
              <label for="import-account-select" class="text-sm font-semibold text-slate-700 dark:text-slate-200">Conta</label>
              <select id="import-account-select" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500">
                <option value="nubank_cartao">Nubank (cartão)</option>
                <option value="nubank_cc">Nubank (conta)</option>
                <option value="itau_cc">Itaú (conta)</option>
              </select>
            </div>
            <div class="space-y-2">
              <span class="text-sm font-semibold text-slate-700 dark:text-slate-200">Detecção</span>
              <div id="import-detected-hint" class="rounded-xl border border-dashed border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/40 px-3 py-2 text-xs text-slate-500 dark:text-slate-400">Aguardando arquivo…</div>
            </div>
          </div>
        </div>

        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex flex-wrap items-center gap-2" role="tablist" aria-label="Filtrar pré-visualização">
            <button type="button" class="import-filter-btn" data-import-filter="all" aria-selected="true">Todos</button>
            <button type="button" class="import-filter-btn" data-import-filter="new">Novos</button>
            <button type="button" class="import-filter-btn" data-import-filter="duplicates">Possíveis duplicados</button>
            <button type="button" class="import-filter-btn" data-import-filter="edited">Editados</button>
          </div>
          <button id="btn-import-apply-category" type="button" class="inline-flex items-center gap-2 rounded-lg border border-amber-200 dark:border-amber-700/60 bg-amber-50 dark:bg-amber-500/10 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-amber-700 dark:text-amber-300 disabled:opacity-40 disabled:cursor-not-allowed">
            <i class="fa fa-tag"></i>
            Aplicar categoria a iguais
          </button>
        </div>

        <div id="import-progress" class="text-sm text-slate-500 dark:text-slate-400"></div>

        <div class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/70 shadow-inner">
          <div id="import-preview-empty" class="px-6 py-12 text-center text-sm text-slate-500 dark:text-slate-400">
            Nenhum lançamento carregado. Escolha um arquivo CSV ou OFX para visualizar as movimentações.
          </div>
          <div id="import-preview-wrapper" class="hidden max-h-[38vh] overflow-auto rounded-2xl">
            <table class="min-w-full text-sm">
              <thead class="sticky top-0 z-10 bg-white dark:bg-slate-950 text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
                <tr>
                  <th class="px-4 py-3 text-left w-10">✓</th>
                  <th class="px-4 py-3 text-left w-28">Data</th>
                  <th class="px-4 py-3 text-left">Descrição</th>
                  <th class="px-4 py-3 text-right w-32">Valor</th>
                  <th class="px-4 py-3 text-left w-44">Categoria</th>
                  <th class="px-4 py-3 text-left w-40">Tags</th>
                  <th class="px-4 py-3 text-left w-28">Status</th>
                </tr>
              </thead>
              <tbody id="import-preview-tbody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
            </table>
          </div>
        </div>

        <div class="flex flex-wrap items-center justify-between gap-3 text-xs text-slate-500 dark:text-slate-400">
          <div class="flex items-center gap-2" id="import-pagination" aria-live="polite">
            <button id="btn-import-prev" type="button" class="rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-1 font-semibold text-slate-600 dark:text-slate-300 disabled:opacity-40 disabled:cursor-not-allowed">Anterior</button>
            <span id="import-page-indicator" class="font-semibold text-slate-600 dark:text-slate-300">Página 1/1</span>
            <button id="btn-import-next" type="button" class="rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-1 font-semibold text-slate-600 dark:text-slate-300 disabled:opacity-40 disabled:cursor-not-allowed">Próxima</button>
          </div>
          <div class="flex-1 text-right">Mostrando até 500 linhas por vez.</div>
        </div>

        <div id="import-summary" class="hidden rounded-2xl border border-emerald-200/70 dark:border-emerald-700/50 bg-emerald-50/70 dark:bg-emerald-900/20 px-4 py-3 text-sm text-emerald-700 dark:text-emerald-200">
          <div class="font-semibold">Resumo da última importação</div>
          <p id="import-summary-text" class="text-xs mt-1"></p>
        </div>
      </div>
      <div class="flex flex-col gap-3 border-t border-slate-200/70 dark:border-slate-800 bg-slate-50/80 dark:bg-slate-900/70 px-6 py-4 md:flex-row md:items-center md:justify-between">
        <div id="import-last-session" class="text-xs text-slate-500 dark:text-slate-400"></div>
        <div class="flex flex-wrap gap-3">
          <button id="btn-import-undo" type="button" class="rounded-lg border border-slate-300 dark:border-slate-700 px-4 py-2 text-sm font-semibold text-slate-600 dark:text-slate-200 disabled:opacity-40 disabled:cursor-not-allowed">Desfazer última importação</button>
          <button id="btn-import-cancel" type="button" class="rounded-lg border border-slate-300 dark:border-slate-700 px-4 py-2 text-sm font-semibold text-slate-600 dark:text-slate-200">Cancelar</button>
          <button id="btn-import-confirm" type="button" class="rounded-lg bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 text-sm font-semibold disabled:opacity-40 disabled:cursor-not-allowed">Importar 0 registros</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NOVO: Modal de Confirmação Customizado -->
<div id="modal-confirmacao" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 w-11/12 max-w-sm mx-auto relative shadow-lg modal-content">
    <h2 class="text-xl font-bold mb-4 text-gray-800" id="modal-confirmacao-title">Confirmar Ação</h2>
    <p class="text-gray-700 mb-6" id="modal-confirmacao-message">Você tem certeza que deseja realizar esta ação?</p>
    <div class="flex justify-end gap-3">
      <button type="button" id="btn-cancelar-confirmacao" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors">Cancelar</button>
      <button type="button" id="btn-confirmar-acao" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">Confirmar</button>
    </div>
  </div>
</div>


<!-- Modal para adicionar/editar gasto fixo -->
<div id="modal-fixo" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-96 p-6 relative">
    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100" id="modal-fixo-title">Adicionar Gasto Fixo</h2>
    <form id="form-fixo" class="space-y-4">
      <div>
        <label for="fixo-nome" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Nome</label>
        <input type="text" id="fixo-nome" name="nome" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600"/>
      </div>
      <div>
        <label for="fixo-categoria" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Categoria</label>
        <select id="fixo-categoria" name="categoria" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
          <option value="">Selecione uma categoria</option>
          <option value="Assinaturas">Assinaturas</option>
          <option value="Contas">Contas</option>
          <option value="Seguros">Seguros</option>
          <option value="Outros">Outros</option>
        </select>
      </div>
      <div>
        <label for="fixo-subcategoria" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Subcategoria</label>
        <select id="fixo-subcategoria" name="subcategoria" class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" disabled>
          <option value="">Selecione uma categoria primeiro</option>
        </select>
      </div>
      <div>
        <label for="fixo-valor" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Valor (R$)</label>
        <input type="number" id="fixo-valor" name="valor" min="0" step="0.01" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600"/>
      </div>
      <div class="flex items-center space-x-2">
        <input type="checkbox" id="fixo-ativo" name="ativo" checked class="form-checkbox h-4 w-4 text-blue-600 dark:text-blue-400 border-gray-300 dark:border-gray-600 rounded"/>
        <label for="fixo-ativo" class="font-medium text-gray-800 dark:text-gray-100">Ativo</label>
      </div>
      <div class="flex justify-end space-x-2 mt-4">
        <button type="button" id="btn-cancelar-fixo" class="px-4 py-2 rounded bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-100 hover:bg-gray-400 dark:hover:bg-gray-700">Cancelar</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 dark:bg-blue-700 text-white hover:bg-blue-700 dark:hover:bg-blue-800">Salvar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para adicionar gasto -->
<div id="modal-add-gasto" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-11/12 max-w-md mx-auto relative shadow-lg modal-content">
    <button id="modal-close" class="absolute top-3 right-3 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-2xl font-bold" aria-label="Fechar modal">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Adicionar Gasto Variável</h2>
    <form id="form-add-gasto-modal" class="space-y-4">
      <select id="modal-cartao" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
        <option value="pix" selected>PIX</option>
        <option value="nubank">Nubank</option>
        <option value="itau">Itaú</option>
        <option value="univ">Univ</option>
        <option value="amazon">Amazon</option>
        <option value="mercado">Mercado Pago</option>
        <option value="">Nenhum</option>
      </select>
      <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="mes-fatura-estimado">Mês de Pagamento Estimado: <span class="font-semibold">Mês Atual</span></div>
      <select id="modal-categoria" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
        <option value="" disabled selected>Categoria (opcional)</option>
        <option value="alimentacao">Alimentação</option>
        <option value="transporte">Transporte</option>
        <option value="moradia">Moradia</option>
        <option value="lazer">Lazer</option>
        <option value="saude">Saúde</option>
        <option value="educacao">Educação</option>
        <option value="contas">Contas</option>
        <option value="outros">Outros</option>
      </select>
      <input id="modal-valor" type="number" step="0.01" min="0.01" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Valor (R$)" required />
      <p id="error-modal-valor" class="text-red-500 dark:text-red-400 text-xs mt-1 hidden">Por favor, insira um valor válido maior que zero.</p>
      <input id="modal-desc" type="text" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Descrição (opcional)" />
      
      <!-- NOVO: Sistema de Tags Inteligente -->
      <div class="relative">
        <input id="modal-tags" type="text" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Tags (ex: padaria, supermercado)" />
        <div id="tags-suggestions" class="absolute z-10 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg mt-1 hidden max-h-32 overflow-y-auto"></div>
        <div id="selected-tags" class="flex flex-wrap gap-1 mt-2"></div>
      </div>
      <div class="flex justify-end gap-3">
        <button type="button" id="modal-cancel" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-700 dark:text-gray-100">Cancelar</button>
        <button type="submit" class="bg-blue-600 dark:bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-800 transition-colors">Adicionar</button>
      </div>
    </form>
  </div>
</div>

<main class="container mx-auto px-4 py-4 pb-24 md:pb-16 grid grid-cols-1 lg:grid-cols-[minmax(0,1.7fr)_minmax(0,0.7fr)] gap-6">

  <div id="main-stream" class="flex flex-col gap-6 lg:col-span-1">

  <!-- LEFT: main (resumo + histórico + parcelados) -->
  <section id="painel-gastos" class="mobile-panel hidden lg:block space-y-6">

    <!-- danger banner (strong visual alert) -->
    <div id="danger-banner" class="hidden danger-banner">⚠️ Atenção — fixos + parcelas do mês ultrapassam o limite! Verifique.</div>

    <!-- RESUMO COM SLIDER -->
    <div class="section-card gradient-shadow compact-resumo">
      <div class="resumo-slider-nav">
        <button type="button" class="resumo-slider-dot is-active" data-slide="0">Gastos</button>
        <button type="button" class="resumo-slider-dot" data-slide="1">Fluxo</button>
        <div class="flex-1"></div>
        <div class="resumo-slider-dots md:hidden">
          <button type="button" class="is-active" data-slide="0" aria-label="Ver indicadores de gastos"></button>
          <button type="button" data-slide="1" aria-label="Ver indicadores de fluxo"></button>
        </div>
      </div>
      <div class="resumo-slider" id="resumo-slider">
        <div class="resumo-slider-track" id="resumo-slider-track">
          <section class="resumo-slide" data-key="gastos">
            <div class="resumo-slide-grid">
              <div class="resumo-item alerta">
                <span class="label">Total previsto (mês)</span>
                <span class="value">R$ <span id="resumo-total-mes">0,00</span></span>
                <span class="hint">Histórico + Parcelas + Fixos</span>
              </div>
              <div class="resumo-item neutro">
                <span class="label">Cartões</span>
                <span class="value">R$ <span id="resumo-cartoes">0,00</span></span>
                <span class="hint">Inclui parcelas do mês</span>
              </div>
              <div class="resumo-item">
                <span class="label">PIX</span>
                <span class="value">R$ <span id="resumo-pix">0,00</span></span>
                <span class="hint">Pagamentos instantâneos</span>
              </div>
              <div class="resumo-item">
                <span class="label">Parcelas (mês)</span>
                <span class="value">R$ <span id="resumo-parcelas-mes">0,00</span></span>
                <span class="hint">Compromissos do mês atual</span>
              </div>
            </div>
          </section>
          <section class="resumo-slide" data-key="fluxo">
            <div class="resumo-slide-grid">
              <div class="resumo-item positivo">
                <span class="label">Entradas do mês</span>
                <span class="value">R$ <span id="resumo-entradas-mes">0,00</span></span>
                <span class="hint">Salários, vendas e extras</span>
              </div>
              <div class="resumo-item alerta">
                <span class="label">Saídas totais</span>
                <span class="value">R$ <span id="resumo-saidas-mes">0,00</span></span>
                <span class="hint">Todos os gastos do mês</span>
              </div>
              <div class="resumo-item neutro">
                <span class="label">Saldo projetado</span>
                <span class="value">R$ <span id="resumo-saldo-projetado">0,00</span></span>
                <span class="hint">Após rendimento de 1% a.m.</span>
              </div>
              <div class="resumo-item">
                <span class="label">Ganho em investimentos</span>
                <span class="value">R$ <span id="resumo-ganho-invest">0,00</span></span>
                <span class="hint">Comparado ao aporte total</span>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- NOVO: Envelopes orçamentários -->
    <div class="section-card space-y-4" id="painel-envelopes">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h3 class="text-lg font-bold flex items-center gap-2">🎯 Envelopes do Mês</h3>
          <p class="text-xs text-gray-500 dark:text-gray-400">Defina limites mensais de gastos, acompanhe a margem disponível e direcione sobras para reservas futuras.</p>
        </div>
        <div class="flex flex-col gap-2 text-xs sm:flex-row sm:items-center sm:gap-3">
          <button id="btn-envelopes-overview" type="button" class="flex flex-col sm:flex-row sm:items-center sm:gap-3 rounded-full border border-emerald-200 dark:border-emerald-800/60 bg-white/70 dark:bg-emerald-900/30 px-3 py-2 text-left shadow-sm transition hover:border-emerald-400 dark:hover:border-emerald-600">
            <span class="text-[0.65rem] uppercase tracking-wide text-emerald-700 dark:text-emerald-300">Resumo das metas</span>
            <span class="text-sm font-semibold text-slate-900 dark:text-slate-100">Meta: R$ <span id="overview-meta-total">0,00</span></span>
            <span class="text-sm text-slate-700 dark:text-slate-200">Reservado: R$ <span id="overview-reservado-total">0,00</span></span>
            <span class="text-xs text-emerald-600 dark:text-emerald-300">Margem livre: R$ <span id="overview-margem-total">0,00</span></span>
          </button>
          <div class="flex items-center gap-2">
            <button id="btn-envelopes-reservar-todos" type="button" class="px-3 py-1 rounded bg-emerald-600 dark:bg-emerald-700 text-white hover:bg-emerald-700 dark:hover:bg-emerald-800 transition">Reservar nos envelopes</button>
            <button id="btn-envelopes-limpar-reservas" type="button" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">Limpar reservas</button>
          </div>
        </div>
      </div>
      <div class="envelopes-carousel flex gap-4 overflow-x-auto snap-x snap-mandatory pb-2 -mx-4 px-4" id="envelopes-grid">
        <div class="envelope-card border-l-4 border-blue-500 bg-blue-50/70 dark:bg-slate-800/60 rounded-lg p-4 flex flex-col gap-3 shrink-0 basis-[85%] sm:basis-[70%] lg:basis-[45%] xl:basis-[32%] min-w-[18rem] snap-start" data-envelope-card="fixo">
          <div class="flex flex-col gap-3">
            <div class="flex items-start justify-between gap-3">
              <div class="space-y-1">
                <div class="font-semibold text-blue-700 dark:text-blue-200 flex items-center gap-2"><i class="fa fa-house"></i><span>Custo Fixo</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Limite mensal: R$ <span id="meta-fixo">0,00</span></div>
                <div class="text-lg font-bold text-slate-900 dark:text-slate-100">Gasto no mês: R$ <span id="gasto-fixo">0,00</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Margem disponível: R$ <span id="limite-livre-fixo">0,00</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Reserva planejada: R$ <span id="reserva-fixo">0,00</span></div>
                <div class="text-xs text-red-600 dark:text-red-300 hidden" id="excedente-fixo-wrapper">Acima do limite: R$ <span id="excedente-fixo">0,00</span></div>
              </div>
              <div class="space-y-2 text-xs w-32">
                <label class="block font-semibold text-slate-600 dark:text-slate-300">Limite mensal
                  <input id="envelope-fixo-meta" type="number" min="0" step="0.01" class="mt-1 w-full border px-2 py-1 rounded text-right bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
                </label>
                <label class="block font-semibold text-slate-600 dark:text-slate-300">Reserva planejada
                  <input id="envelope-fixo-reserva" type="number" min="0" step="0.01" class="mt-1 w-full border px-2 py-1 rounded text-right bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
                </label>
              </div>
            </div>
            <div>
              <div class="w-full bg-white/60 dark:bg-gray-700 rounded-full h-2 shadow-inner">
                <div id="progress-fixo" class="progress-bar h-2 rounded-full bg-blue-500" style="width:0%"></div>
              </div>
              <div class="flex justify-between text-[0.7rem] text-slate-500 dark:text-slate-400 mt-1">
                <span>Comprometido: <strong id="percentual-fixo">0%</strong></span>
                <span>Margem disponível: R$ <span id="disponivel-fixo">0,00</span></span>
              </div>
            </div>
            <div class="flex flex-wrap gap-2 text-xs">
              <button data-envelope-action="liberar" data-envelope="fixo" type="button" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">Liberar reserva</button>
            </div>
          </div>
        </div>

        <div class="envelope-card border-l-4 border-green-500 bg-emerald-50/70 dark:bg-emerald-900/30 rounded-lg p-4 flex flex-col gap-3 shrink-0 basis-[85%] sm:basis-[70%] lg:basis-[45%] xl:basis-[32%] min-w-[18rem] snap-start" data-envelope-card="parcelado">
          <div class="flex flex-col gap-3">
            <div class="flex items-start justify-between gap-3">
              <div class="space-y-1">
                <div class="font-semibold text-emerald-700 dark:text-emerald-200 flex items-center gap-2"><i class="fa fa-receipt"></i><span>Parcelados do mês</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Limite mensal: R$ <span id="meta-parcelado">0,00</span></div>
                <div class="text-lg font-bold text-slate-900 dark:text-slate-100">Gasto no mês: R$ <span id="gasto-parcelado">0,00</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Margem disponível: R$ <span id="limite-livre-parcelado">0,00</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Reserva planejada: R$ <span id="reserva-parcelado">0,00</span></div>
                <div class="text-xs text-red-600 dark:text-red-300 hidden" id="excedente-parcelado-wrapper">Acima do limite: R$ <span id="excedente-parcelado">0,00</span></div>
              </div>
              <div class="space-y-2 text-xs w-32">
                <label class="block font-semibold text-slate-600 dark:text-slate-300">Limite mensal
                  <input id="envelope-parcelado-meta" type="number" min="0" step="0.01" class="mt-1 w-full border px-2 py-1 rounded text-right bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
                </label>
                <label class="block font-semibold text-slate-600 dark:text-slate-300">Reserva planejada
                  <input id="envelope-parcelado-reserva" type="number" min="0" step="0.01" class="mt-1 w-full border px-2 py-1 rounded text-right bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
                </label>
              </div>
            </div>
            <div>
              <div class="w-full bg-white/60 dark:bg-gray-700 rounded-full h-2 shadow-inner">
                <div id="progress-parcelado" class="progress-bar h-2 rounded-full bg-green-500" style="width:0%"></div>
              </div>
              <div class="flex justify-between text-[0.7rem] text-slate-500 dark:text-slate-400 mt-1">
                <span>Comprometido: <strong id="percentual-parcelado">0%</strong></span>
                <span>Margem disponível: R$ <span id="disponivel-parcelado">0,00</span></span>
              </div>
            </div>
            <div class="flex flex-wrap gap-2 text-xs">
              <button data-envelope-action="liberar" data-envelope="parcelado" type="button" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">Liberar reserva</button>
            </div>
          </div>
        </div>

        <div class="envelope-card border-l-4 border-orange-500 bg-amber-50/80 dark:bg-amber-900/30 rounded-lg p-4 flex flex-col gap-3 shrink-0 basis-[85%] sm:basis-[70%] lg:basis-[45%] xl:basis-[32%] min-w-[18rem] snap-start" data-envelope-card="variavel">
          <div class="flex flex-col gap-3">
            <div class="flex items-start justify-between gap-3">
              <div class="space-y-1">
                <div class="font-semibold text-amber-700 dark:text-amber-200 flex items-center gap-2"><i class="fa fa-basket-shopping"></i><span>Variáveis</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Limite mensal: R$ <span id="meta-variavel">0,00</span></div>
                <div class="text-lg font-bold text-slate-900 dark:text-slate-100">Gasto no mês: R$ <span id="gasto-variavel">0,00</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Margem disponível: R$ <span id="limite-livre-variavel">0,00</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Reserva planejada: R$ <span id="reserva-variavel">0,00</span></div>
                <div class="text-xs text-red-600 dark:text-red-300 hidden" id="excedente-variavel-wrapper">Acima do limite: R$ <span id="excedente-variavel">0,00</span></div>
              </div>
              <div class="space-y-2 text-xs w-32">
                <label class="block font-semibold text-slate-600 dark:text-slate-300">Limite mensal
                  <input id="envelope-variavel-meta" type="number" min="0" step="0.01" class="mt-1 w-full border px-2 py-1 rounded text-right bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
                </label>
                <label class="block font-semibold text-slate-600 dark:text-slate-300">Reserva planejada
                  <input id="envelope-variavel-reserva" type="number" min="0" step="0.01" class="mt-1 w-full border px-2 py-1 rounded text-right bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
                </label>
              </div>
            </div>
            <div>
              <div class="w-full bg-white/60 dark:bg-gray-700 rounded-full h-2 shadow-inner">
                <div id="progress-variavel" class="progress-bar h-2 rounded-full bg-orange-500" style="width:0%"></div>
              </div>
              <div class="flex justify-between text-[0.7rem] text-slate-500 dark:text-slate-400 mt-1">
                <span>Comprometido: <strong id="percentual-variavel">0%</strong></span>
                <span>Margem disponível: R$ <span id="disponivel-variavel">0,00</span></span>
              </div>
            </div>
            <div class="flex flex-wrap gap-2 text-xs">
              <button data-envelope-action="liberar" data-envelope="variavel" type="button" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">Liberar reserva</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- HISTÓRICO (variáveis + fixos avulsos) -->
      <div class="section-card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Histórico (mês)</h3>
        <div class="flex items-center gap-2 text-[0.7rem] font-semibold uppercase tracking-wide">
          <button id="btn-historico-graficos" class="inline-flex items-center gap-1 rounded-full border border-blue-200/80 dark:border-blue-900/50 bg-blue-50/80 dark:bg-blue-900/10 px-3 py-1 text-blue-700 dark:text-blue-200 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors">
            <i class="fa fa-chart-pie text-[0.65rem]"></i>
            Gráficos
          </button>
          <button id="exportar-csv" class="inline-flex items-center gap-1 rounded-full border border-emerald-200/70 dark:border-emerald-700/60 bg-emerald-50/80 dark:bg-emerald-500/10 px-3 py-1 text-emerald-700 dark:text-emerald-200 hover:bg-emerald-100 dark:hover:bg-emerald-500/20 transition-colors">
            <i class="fa fa-file-arrow-down text-[0.65rem]"></i>
            CSV (mês)
          </button>
        </div>
      </div>

      <div id="historico-insights" class="grid gap-3 md:grid-cols-3 mb-4">
        <div class="rounded-2xl bg-emerald-50/80 dark:bg-emerald-900/20 border border-emerald-200/60 dark:border-emerald-800/60 p-3 sm:p-4 shadow-sm max-w-full sm:max-w-[15rem] md:max-w-[13rem]">
          <div class="text-[11px] uppercase tracking-wide text-emerald-700 dark:text-emerald-200">Média diária estimada</div>
          <div class="text-lg font-semibold text-emerald-900 dark:text-emerald-200 mt-1" id="historico-media-diaria">R$ 0,00</div>
          <p class="text-[10px] sm:text-[11px] text-emerald-700/80 dark:text-emerald-200/70 mt-2" id="historico-media-hint">Selecione um mês para ver a média diária.</p>
        </div>
        <div class="md:col-span-2 rounded-2xl bg-slate-100/80 dark:bg-slate-800/60 border border-slate-200/70 dark:border-slate-700/60 p-4 shadow-sm">
          <div class="flex items-center justify-between gap-3 mb-3">
            <div>
              <h4 class="text-sm font-semibold text-slate-800 dark:text-slate-100">Gastos semanais</h4>
              <p class="text-[11px] text-slate-500 dark:text-slate-400 mt-1">Visualize o peso de cada semana e identifique picos rapidamente.</p>
            </div>
            <select id="historico-semanas-modo" class="text-[11px] font-semibold uppercase tracking-wide border border-slate-200 dark:border-slate-600 rounded-lg bg-white/80 dark:bg-slate-900/40 px-2 py-1 text-slate-600 dark:text-slate-200">
              <option value="selected">Mês selecionado</option>
              <option value="rolling">Últimas 8 semanas</option>
            </select>
          </div>
          <button type="button" id="toggle-historico-semanas" class="w-full flex items-center justify-between text-sm font-semibold text-indigo-700 dark:text-indigo-200 bg-indigo-50/80 dark:bg-indigo-900/20 px-3 py-2 rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-900/30 transition" aria-expanded="true" aria-controls="historico-semanas-container">
            <span class="flex items-center gap-2"><i class="fa fa-chart-column text-indigo-500"></i><span>Resumo semanal</span></span>
            <span class="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">
              <span id="historico-semanas-janela">Mês selecionado</span>
              <i id="historico-semanas-toggle-icon" class="fa fa-chevron-down transition-transform duration-200"></i>
            </span>
          </button>
          <div id="historico-semanas-container" class="mt-3 space-y-2" role="region" aria-live="polite" aria-hidden="false">
            <div class="relative h-48">
              <canvas id="grafico-historico-semanal" class="w-full h-full"></canvas>
              <div id="historico-semanas-empty" class="absolute inset-0 flex items-center justify-center text-xs text-slate-500 dark:text-slate-400 px-4 text-center">Selecione um mês específico para destravar o resumo semanal.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- NOVO: Filtro de busca no histórico -->
      <div class="mb-3 flex flex-wrap gap-2 items-center">
        <input id="search-historico" type="text" placeholder="Buscar na descrição ou tags..." class="flex-1 min-w-48 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
        <select id="group-by-historico" class="px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
          <option value="">Sem agrupamento</option>
          <option value="categoria">Agrupar por Categoria</option>
          <option value="cartao">Agrupar por Cartão</option>
          <option value="tag">Agrupar por Tag</option>
        </select>
        <button id="clear-search" class="px-3 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-100 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
          <i class="fa fa-times"></i>
        </button>
      </div>

      <!-- NOVO: Container com scroll para o histórico de variáveis -->
      <div id="historico-variavel-scroll-container" class="scroll-shell overflow-x-auto">
        <div id="historico-loading-spinner" class="loading-spinner spinner-hidden">
          <i class="fa fa-spinner fa-spin"></i> Carregando histórico...
        </div>
        <table class="w-full">
          <thead>
            <tr>
              <th class="th">Cartão/PIX</th><th class="th">Descrição</th><th class="th">Valor</th><th class="th">Data Transação</th><th class="th">Mês Fatura</th><th class="th">Tipo</th><th class="th">Tags</th><th class="th">Ações</th>
            </tr>
          </thead>
            </tr>
          </thead>
          <tbody id="transactions-list">
            <tr><td class="td" colspan="8">Nenhum gasto registrado no mês</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- PARCELADOS (painel dedicado) - MELHORADO -->
    <div class="section-card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Parcelados (seção dedicada)</h3>
      </div>

      <!-- add parcelado -->
      <form id="parcelado-form" class="grid grid-cols-1 md:grid-cols-6 gap-2 mb-3">
        <input id="p-desc" class="px-2 py-1 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Descrição (ex: Guarda-roupa)" required/>
        <input id="p-valor" type="number" step="0.01" class="px-2 py-1 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Valor da parcela (R$)" required/>
        <input id="p-num" type="number" min="1" class="px-2 py-1 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Nº parcelas" required/>
        <select id="p-cartao" class="px-2 py-1 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
          <option value="">Nenhum</option>
          <option value="nubank">Nubank</option>
          <option value="itau">Itaú</option>
          <option value="univ">Univ</option>
          <option value="amazon">Amazon</option>
          <option value="mercado">Mercado Pago</option>
          <option value="pix">PIX</option>
        </select>
        <input id="p-inicio" type="month" class="px-2 py-1 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" required/>
        <button class="bg-purple-600 dark:bg-purple-700 text-white px-3 py-1 rounded hover:bg-purple-700 dark:hover:bg-purple-800 transition-colors">Adicionar Parcelado</button>
      </form>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
        <div class="section-card">
          <div class="text-sm text-gray-500 dark:text-gray-400">Parcelas no mês</div>
          <div class="text-2xl font-bold">R$ <span id="p-total-mes">0,00</span></div>
        </div>
        <div class="section-card">
          <div class="text-sm text-gray-500 dark:text-gray-400">Comprometido total</div>
          <div class="text-2xl font-bold">R$ <span id="p-total-restante">0,00</span></div>
        </div>
        <div class="section-card">
          <div class="text-sm text-gray-500 dark:text-gray-400">Parcelados ativos</div>
          <div class="text-2xl font-bold"><span id="p-ativos">0</span></div>
        </div>
      </div>

      <div class="mt-6">
        <button type="button" id="toggle-parcelados-projecao" class="w-full flex items-center justify-between text-sm font-semibold text-purple-700 dark:text-purple-200 bg-purple-50 dark:bg-purple-900/20 px-3 py-2 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/30 transition" aria-expanded="true" aria-controls="parcelados-projecao-container">
          <span class="flex items-center gap-2"><i class="fa fa-chart-column text-purple-500"></i><span>Projeção de parcelas</span></span>
          <span class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
            <span id="parcelados-projecao-janela">Próximos meses</span>
            <i id="parcelados-projecao-toggle-icon" class="fa fa-chevron-down transition-transform duration-200"></i>
          </span>
        </button>
        <div id="parcelados-projecao-container" class="mt-3 space-y-2" role="region" aria-live="polite" aria-hidden="false">
          <div class="relative h-48">
            <canvas id="grafico-parcelados-projecao" class="w-full h-full"></canvas>
            <div id="parcelados-projecao-empty" class="absolute inset-0 flex items-center justify-center text-xs text-gray-500 dark:text-gray-400">Cadastre parcelados ativos para visualizar a projeção.</div>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <div id="parcelados-loading-spinner" class="loading-spinner spinner-hidden">
          <i class="fa fa-spinner fa-spin"></i> Carregando parcelados...
        </div>
        <div id="parcelados-table-wrapper">
          <table class="w-full">
            <thead>
              <tr><th class="th">Descrição</th><th class="th">Parcela (R$)</th><th class="th">Progresso</th><th class="th">Status</th><th class="th">Cartão</th><th class="th">Início</th><th class="th">Fim</th><th class="th">Ações</th></tr>
            </thead>
            <tbody id="parcelados-list">
              <tr><td class="td" colspan="8">Nenhum parcelado para o mês selecionado</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </section>

  <!-- FIXOS posicionados após parcelados no desktop e disponíveis via abas no mobile -->
    <section class="mobile-panel hidden lg:block" id="painel-fixos">
    <div class="section-card space-y-5">
      <div class="flex flex-wrap items-start justify-between gap-4">
        <div class="space-y-1 max-w-2xl">
          <h3 class="text-lg font-semibold flex items-center gap-2 text-slate-900 dark:text-slate-100">
            <i class="fa-solid fa-repeat text-blue-500"></i>
            Fixos recorrentes
          </h3>
          <p class="text-xs text-gray-500 dark:text-gray-400">Centralize assinaturas, contas e demais despesas automáticas para acompanhar o impacto mensal e decidir onde ajustar.</p>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <button id="btn-graficos-fixos" class="inline-flex items-center gap-2 rounded-full border border-blue-200/70 dark:border-blue-900/50 bg-blue-50/70 dark:bg-blue-900/20 px-3 py-1.5 text-xs font-semibold text-blue-700 dark:text-blue-200 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors">
            <i class="fa-solid fa-chart-pie text-sm"></i>
            <span>Visão gráfica</span>
          </button>
          <button id="add-fixo-open" class="inline-flex items-center gap-2 rounded-full border border-purple-200/70 dark:border-purple-900/50 bg-purple-50/80 dark:bg-purple-900/20 px-3 py-1.5 text-xs font-semibold text-purple-700 dark:text-purple-200 hover:bg-purple-100 dark:hover:bg-purple-900/40 transition-colors">
            <i class="fa-solid fa-plus text-sm"></i>
            <span>Novo fixo</span>
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="rounded-2xl bg-emerald-50 dark:bg-emerald-900/25 p-4 shadow-sm">
          <div class="text-[0.65rem] uppercase tracking-wide text-emerald-700 dark:text-emerald-300">Ativos no mês</div>
          <div class="text-xl font-semibold text-emerald-900 dark:text-emerald-200" id="resumo-fixos-ativos">R$ 0,00</div>
          <p class="text-[0.7rem] text-emerald-700/80 dark:text-emerald-200/80 mt-1">Somatório das cobranças que continuam em execução.</p>
        </div>
        <div class="rounded-2xl bg-slate-100 dark:bg-slate-800/70 p-4 shadow-sm">
          <div class="text-[0.65rem] uppercase tracking-wide text-slate-600 dark:text-slate-300">Pausados</div>
          <div class="text-xl font-semibold text-slate-900 dark:text-slate-100" id="resumo-fixos-inativos">R$ 0,00</div>
          <p class="text-[0.7rem] text-slate-600/90 dark:text-slate-300/80 mt-1">Valores congelados que não impactam o caixa atual.</p>
        </div>
      </div>

      <div class="relative">
        <div id="fixos-loading-spinner" class="loading-spinner spinner-hidden">
          <i class="fa fa-spinner fa-spin"></i> Carregando fixos...
        </div>
        <div id="fixos-scroll-wrapper" class="scroll-shell space-y-3">
          <div id="fixos-cards-container" class="space-y-2">
            <!-- Cards de fixos serão inseridos aqui -->
          </div>
        </div>
      </div>
    </div>
  </section>

    <section class="mobile-panel hidden lg:block space-y-6" id="painel-gastos-analises" data-panel-alias="painel-gastos">
    <!-- NOVA SEÇÃO: GASTOS POR CATEGORIA -->
    <div class="section-card">
      <h3 class="text-lg font-bold mb-3">Gastos por Categoria (mês)</h3>
      <div id="categorias-list" class="space-y-3">
        <!-- Categorias serão renderizadas aqui pelo JS -->
        <div class="text-gray-500 dark:text-gray-400">Nenhum gasto categorizado no mês.</div>
      </div>
    </div>

    <!-- NOVO: Dashboard de Insights Inteligentes -->
    <div class="section-card">
      <h3 class="text-lg font-bold mb-3">💡 Insights Financeiros</h3>
      <div id="insights-container" class="space-y-3">
        <!-- Insights serão gerados automaticamente aqui -->
        <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg text-green-800 dark:text-green-200">Carregando insights...</div>
      </div>
    </div>
  </section>

  </div>

  <!-- RIGHT: sidebar (entradas + resumos + ações) -->
  <aside class="space-y-6 lg:col-span-1 lg:self-start">

    <!-- NOVO: Entradas de dinheiro -->
    <div class="mobile-panel hidden lg:block section-card space-y-4" id="painel-entradas">
      <div>
        <h3 class="font-semibold text-lg flex items-center gap-2"><i class="fa fa-arrow-down text-green-500"></i>Entradas de Dinheiro</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400">Registre salários, vendas e rendas extras e acompanhe o fluxo mensal.</p>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
        <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
          <div class="text-xs text-green-700 dark:text-green-200 uppercase tracking-wide">Mês selecionado</div>
          <div class="text-lg font-bold text-green-800 dark:text-green-300">R$ <span id="entradas-total-mes">0,00</span></div>
        </div>
        <div class="p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg">
          <div class="text-xs text-emerald-700 dark:text-emerald-200 uppercase tracking-wide">Saldo líquido do mês</div>
          <div class="text-lg font-bold text-emerald-800 dark:text-emerald-300">R$ <span id="entradas-saldo-mes">0,00</span></div>
          <div id="entradas-saldo-hint" class="text-[11px] text-emerald-700/80 dark:text-emerald-200/80 mt-1">Entradas menos saídas previstas do período selecionado.</div>
        </div>
        <div class="p-3 bg-green-100 dark:bg-green-900/10 rounded-lg sm:col-span-2">
          <div class="text-xs text-green-700 dark:text-green-200 uppercase tracking-wide">Entradas registradas</div>
          <div class="text-lg font-bold text-green-900 dark:text-green-200">R$ <span id="entradas-total-geral">0,00</span></div>
          <div class="text-[11px] text-green-700/80 dark:text-green-200/80 mt-1">Total acumulado de receitas cadastradas no sistema.</div>
        </div>
      </div>
      <form id="form-entrada" class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
        <select id="entrada-tipo" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" required>
          <option value="salario">Salário</option>
          <option value="venda">Venda</option>
          <option value="renda_extra">Renda extra</option>
          <option value="outros">Outros</option>
        </select>
        <input id="entrada-valor" type="number" step="0.01" min="0.01" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Valor (R$)" required />
        <input id="entrada-data" type="date" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" required />
        <input id="entrada-desc" type="text" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Descrição (opcional)" />
        <button type="submit" class="sm:col-span-2 bg-green-600 dark:bg-green-700 text-white px-3 py-2 rounded hover:bg-green-700 dark:hover:bg-green-800 transition">Adicionar entrada</button>
      </form>
      <div>
        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-200">Distribuição por tipo</h4>
        <div id="entradas-tipos-resumo" class="grid grid-cols-2 gap-2 text-xs text-gray-500 dark:text-gray-400">
          <div class="col-span-2 text-gray-500 dark:text-gray-400">Cadastre entradas para ver a distribuição.</div>
        </div>
      </div>
      <div>
        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-200">Entradas recentes</h4>
        <div id="entradas-lista" class="space-y-2 max-h-48 overflow-y-auto text-sm">
          <div class="text-gray-500 dark:text-gray-400">Nenhuma entrada registrada.</div>
        </div>
      </div>
    </div>

    <!-- NOVO: Resumo das saídas -->
    <div class="mobile-panel hidden lg:block section-card space-y-3" id="painel-saidas">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-lg flex items-center gap-2"><i class="fa fa-arrow-up text-red-500"></i>Saídas do Mês</h3>
        <span class="text-sm font-semibold text-gray-700 dark:text-gray-200">R$ <span id="saidas-total-card">0,00</span></span>
      </div>
      <p class="text-xs text-gray-500 dark:text-gray-400">Acompanhe o total previsto para o mês selecionado considerando gastos fixos, variáveis e parcelas.</p>
      <div class="space-y-3 text-sm">
        <div>
          <div class="flex justify-between mb-1">
            <span>Gastos fixos</span>
            <span>R$ <span id="saidas-fixos">0,00</span></span>
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
            <div id="saidas-fixos-bar" class="h-2 rounded-full bg-blue-500" style="width:0%"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-1">
            <span>Variáveis</span>
            <span>R$ <span id="saidas-variavel">0,00</span></span>
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
            <div id="saidas-variavel-bar" class="h-2 rounded-full bg-orange-500" style="width:0%"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-1">
            <span>Parcelas</span>
            <span>R$ <span id="saidas-parcelado">0,00</span></span>
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
            <div id="saidas-parcelado-bar" class="h-2 rounded-full bg-green-500" style="width:0%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- NOVO: Investimentos -->
    <div class="mobile-panel hidden lg:block section-card space-y-4" id="painel-investimentos">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-lg flex items-center gap-2"><i class="fa fa-chart-line text-indigo-500"></i>Investimentos</h3>
        <span class="text-xs text-gray-500 dark:text-gray-400">Projeção com 1% ao mês</span>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm">
        <div class="p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg">
          <div class="text-xs text-indigo-700 dark:text-indigo-200 uppercase tracking-wide">Investido no mês</div>
          <div class="text-lg font-bold text-indigo-800 dark:text-indigo-200">R$ <span id="investimento-total-mes">0,00</span></div>
        </div>
        <div class="p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg">
          <div class="text-xs text-indigo-700 dark:text-indigo-200 uppercase tracking-wide">Total investido</div>
          <div class="text-lg font-bold text-indigo-800 dark:text-indigo-200">R$ <span id="investimento-total-geral">0,00</span></div>
        </div>
        <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
          <div class="text-xs text-purple-700 dark:text-purple-200 uppercase tracking-wide">Projeção futura</div>
          <div class="text-lg font-bold text-purple-800 dark:text-purple-200">R$ <span id="investimento-projecao">0,00</span></div>
        </div>
      </div>
      <div class="pt-3 border-t border-indigo-100 dark:border-indigo-900/40">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-sm font-semibold text-indigo-800 dark:text-indigo-200 flex items-center gap-2"><i class="fa fa-chart-area"></i>Evolução dos aportes</h4>
          <span class="text-xs text-gray-500 dark:text-gray-400">Últimos 12 meses</span>
        </div>
        <div class="relative h-48">
          <canvas id="grafico-investimentos" class="w-full h-full"></canvas>
          <div id="investimentos-grafico-empty" class="absolute inset-0 flex items-center justify-center text-xs text-gray-500 dark:text-gray-400">Cadastre investimentos para visualizar o gráfico.</div>
        </div>
      </div>
      <div id="simulador-juros-compostos" class="bg-white/70 dark:bg-gray-800/60 border border-indigo-100 dark:border-indigo-900 rounded-lg p-5 space-y-4 text-base md:text-sm">
        <button type="button" class="w-full flex items-center justify-between text-left font-semibold text-indigo-700 dark:text-indigo-200 px-3 py-3 md:py-2.5 rounded-md bg-indigo-50/80 dark:bg-indigo-900/30 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition text-base md:text-sm" data-simulador-toggle aria-expanded="false">
          <span class="flex items-center gap-2"><i class="fa fa-calculator"></i><span>Simulador de juros compostos</span></span>
          <i class="fa fa-chevron-down text-xs" data-simulador-icon></i>
        </button>
        <p class="text-sm md:text-xs text-gray-500 dark:text-gray-400 px-3">Atualizado automaticamente com o resumo rápido.</p>
        <div data-simulador-content class="space-y-5 hidden px-3 pb-1">
          <p class="text-sm md:text-xs text-gray-500 dark:text-gray-400">Reaproveite os totais atuais para projetar rendimentos e compare com um cenário alternativo de aportes ou taxas diferentes.</p>
          <div class="flex flex-col gap-5">
            <div class="space-y-4 border-l-4 border-indigo-100 dark:border-indigo-900/40 pl-4">
              <h5 class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-200 uppercase tracking-wide">Cenário atual</h5>
              <div class="grid grid-cols-1 gap-4">
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Valor inicial (R$)
                  <input id="simulador-valor-inicial" data-simulador="base" type="number" step="0.01" min="0" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Aporte mensal (R$)
                  <input id="simulador-aporte-mensal" data-simulador="base" type="number" step="0.01" min="0" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Taxa mensal (%)
                  <input id="simulador-taxa" data-simulador="base" type="number" step="0.01" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Período (meses)
                  <input id="simulador-periodo" data-simulador="base" type="number" step="1" min="1" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
              </div>
            </div>
            <div class="space-y-4 border-l-4 border-indigo-100 dark:border-indigo-900/40 pl-4">
              <h5 class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-200 uppercase tracking-wide">Comparar cenário</h5>
              <div class="grid grid-cols-1 gap-4">
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Aporte mensal alternativo (R$)
                  <input id="simulador-aporte-alternativo" data-simulador="alternativo" type="number" step="0.01" min="0" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Taxa mensal alternativa (%)
                  <input id="simulador-taxa-alternativa" data-simulador="alternativo" type="number" step="0.01" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Aporte único extra (R$)
                  <input id="simulador-aporte-extra" data-simulador="alternativo" type="number" step="0.01" min="0" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Meses adicionais
                  <input id="simulador-periodo-alternativo" data-simulador="alternativo" type="number" step="1" min="0" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-4 text-sm md:text-xs">
            <div class="rounded-lg bg-indigo-100/80 dark:bg-indigo-900/30 p-4 border-l-4 border-indigo-300 dark:border-indigo-700/60">
              <h6 class="font-semibold text-indigo-800 dark:text-indigo-200 mb-1 text-base md:text-sm">Resultado cenário atual</h6>
              <p class="text-gray-600 dark:text-gray-300">Valor projetado: <strong id="simulador-base-total">R$ 0,00</strong></p>
              <p class="text-gray-600 dark:text-gray-300">Ganho sobre aportes: <strong id="simulador-base-ganho">R$ 0,00</strong></p>
            </div>
            <div class="rounded-lg bg-purple-100/80 dark:bg-purple-900/30 p-4 border-l-4 border-purple-300 dark:border-purple-700/60">
              <h6 class="font-semibold text-purple-800 dark:text-purple-200 mb-1 text-base md:text-sm">Resultado cenário alternativo</h6>
              <p class="text-gray-600 dark:text-gray-300">Valor projetado: <strong id="simulador-alt-total">R$ 0,00</strong></p>
              <p class="text-gray-600 dark:text-gray-300">Ganho sobre aportes: <strong id="simulador-alt-ganho">R$ 0,00</strong></p>
            </div>
          </div>
          <div class="text-xs text-indigo-700 dark:text-indigo-300">
            Diferença entre cenários: <strong id="simulador-diferenca-valor">R$ 0,00</strong> em valor acumulado e <strong id="simulador-diferenca-ganho">R$ 0,00</strong> em ganhos.
          </div>
        </div>
      </div>
      <form id="form-investimento" class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
        <select id="investimento-tipo" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" required>
          <option value="reserva">Reserva de emergência</option>
          <option value="renda_fixa">Renda fixa</option>
          <option value="acoes">Ações/Fundos</option>
          <option value="cripto">Cripto</option>
          <option value="outros">Outros</option>
        </select>
        <input id="investimento-valor" type="number" step="0.01" min="0.01" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Valor aplicado (R$)" required />
        <input id="investimento-data" type="date" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" required />
        <input id="investimento-desc" type="text" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Observação (opcional)" />
        <button type="submit" class="sm:col-span-2 bg-indigo-600 dark:bg-indigo-700 text-white px-3 py-2 rounded hover:bg-indigo-700 dark:hover:bg-indigo-800 transition">Adicionar investimento</button>
      </form>
      <div>
        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Aplicações recentes</h4>
        <div id="investimentos-lista" class="space-y-2 max-h-48 overflow-y-auto text-sm">
          <div class="text-gray-500 dark:text-gray-400">Nenhum investimento registrado.</div>
        </div>
      </div>
    </div>

    <!-- Cartões -->
    <section class="mobile-panel hidden lg:block section-card space-y-4" id="painel-cartoes">
      <div class="flex items-center justify-between gap-3">
        <h3 class="font-semibold text-lg">Cartões</h3>
        <button id="btn-gerenciar-cartoes" class="inline-flex items-center gap-1 rounded-full border border-blue-200/70 dark:border-blue-900/40 bg-blue-50/70 dark:bg-blue-900/10 px-3 py-1 text-blue-700 dark:text-blue-200 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors">
          <i class="fa fa-pen-to-square text-[0.7rem]"></i>
          Gerenciar
        </button>
      </div>
      <div id="cartoes-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div id="cartoes-loading-spinner" class="loading-spinner spinner-hidden col-span-full">
          <i class="fa fa-spinner fa-spin"></i> Carregando cartões...
        </div>
        <!-- Cards de cartão serão inseridos aqui -->
      </div>
    </section>

    <!-- NOVO: Indicador de saúde financeira -->
    <div class="mobile-panel hidden lg:block section-card space-y-4" id="painel-saude-financeira">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-lg flex items-center gap-2"><i class="fa fa-heartbeat text-rose-500"></i>Saúde Financeira</h3>
        <span class="text-sm font-semibold text-rose-600 dark:text-rose-300" id="saude-score">--</span>
      </div>
      <div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
          <div id="saude-progress" class="h-3 rounded-full bg-rose-500 transition-all duration-300" style="width:0%"></div>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="saude-status">Cadastre entradas e gastos para calcular sua saúde financeira.</p>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm">
        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
          <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Saldo projetado</div>
          <div class="text-lg font-bold text-gray-800 dark:text-gray-100" id="saude-detalhes-saldo">R$ 0,00</div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
          <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Entradas do mês</div>
          <div class="text-lg font-bold text-gray-800 dark:text-gray-100" id="saude-detalhes-renda">R$ 0,00</div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
          <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Projeção investimentos</div>
          <div class="text-lg font-bold text-gray-800 dark:text-gray-100" id="saude-investimento-extra">R$ 0,00</div>
        </div>
      </div>
    </div>

    <!-- NOVO: Modal para Gerenciar Cartões -->
<div id="modal-gerenciar-cartoes" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-11/12 max-w-md mx-auto relative shadow-lg modal-content max-h-[90vh] overflow-y-auto">
    <button id="modal-gerenciar-cartoes-close" class="absolute top-3 right-3 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-2xl font-bold" aria-label="Fechar modal">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Gerenciar Cartões</h2>

    <!-- Formulário para Adicionar Novo Cartão -->
    <div class="mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
      <h3 class="font-semibold mb-3 text-gray-800 dark:text-gray-100">Adicionar Novo Cartão</h3>
      <form id="form-add-cartao" class="space-y-3">
        <div>
          <label for="novo-cartao-label" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Nome de Exibição (ex: Nubank, Itaú)</label>
          <input type="text" id="novo-cartao-label" name="label" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Nome amigável"/>
        </div>
        <div>
          <label for="novo-cartao-fechamento" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Dia de Fechamento (1-31, opcional)</label>
          <input type="number" id="novo-cartao-fechamento" name="fechamento" min="1" max="31" class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Ex: 15"/>
        </div>
        <button type="submit" class="w-full bg-blue-600 dark:bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-700 dark:hover:bg-blue-800 transition">Adicionar Cartão</button>
         <div>
    <label for="novo-cartao-offset" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Offset de Vencimento</label>
    <select id="novo-cartao-offset" name="offset" class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
      <option value="0">Mesmo Mês (ex: Itaú, Nubank)</option>
      <option value="1" selected>Próximo Mês (ex: Univ, Amazon)</option>
    </select>
    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">0: Vencimento no mesmo mês da fatura. 1: Vencimento no mês seguinte.</p>
  </div>
  
      </form>
    </div>

    <!-- Lista de Cartões Existentes -->
    <div class="mb-4">
      <h3 class="font-semibold mb-3 text-gray-800 dark:text-gray-100">Cartões Existentes</h3>
      <div id="lista-cartoes-existentes" class="space-y-2">
        <!-- Cartões serão inseridos aqui via JS -->
        <div class="text-gray-500 dark:text-gray-400">Nenhum cartão adicionado ainda.</div>
      </div>
    </div>
  </div>
</div>


    <!-- ações rápidas - MOVIDO PARA O FINAL DA ASIDE -->
    <div class="section-card text-sm">
      <div class="font-semibold mb-2">Ações rápidas</div>
      <button id="exportar-tudo" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 px-3 py-2 rounded mb-2 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">Exportar tudo (CSV)</button>
      <div class="text-xs text-gray-500 dark:text-gray-400">Notas: exportar mês filtra só o mês selecionado; exportar tudo pega tudo.</div>
    </div>

  </aside>


  </section>
</main>

<!-- Barra de ações inferior com atalhos diretos -->
<div id="floating-menu" class="fixed inset-x-0 bottom-0 z-50 flex justify-center">
  <div class="relative w-full max-w-md px-4 pb-4">
    <nav class="floating-btn-transition relative bg-white/95 dark:bg-gray-900/90 border border-gray-200 dark:border-gray-700 shadow-2xl rounded-full px-4 py-3 flex items-end justify-between gap-2 pointer-events-auto backdrop-blur">
      <div class="pointer-events-none absolute inset-x-12 top-2 mx-auto h-1 rounded-full bg-gradient-to-r from-blue-200 via-blue-400 to-blue-200 opacity-60 dark:from-blue-900 dark:via-blue-600 dark:to-blue-900"></div>
      <button id="btn-add-gasto-variavel"
        class="group flex-1 flex flex-col items-center gap-1 text-[0.7rem] font-semibold text-blue-700 dark:text-blue-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 dark:focus-visible:ring-blue-700"
        type="button" aria-label="Adicionar gasto variável">
        <span class="flex h-11 w-11 items-center justify-center rounded-full bg-blue-600 text-white shadow-lg transition-transform group-hover:-translate-y-0.5 dark:bg-blue-700">
          <i class="fa fa-shopping-cart text-lg"></i>
        </span>
        Variável
      </button>
      <button id="btn-add-gasto-fixo"
        class="group flex-1 flex flex-col items-center gap-1 text-[0.7rem] font-semibold text-purple-700 dark:text-purple-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-purple-400 dark:focus-visible:ring-purple-600"
        type="button" aria-label="Adicionar gasto fixo">
        <span class="flex h-11 w-11 items-center justify-center rounded-full bg-purple-600 text-white shadow-lg transition-transform group-hover:-translate-y-0.5 dark:bg-purple-700">
          <i class="fa fa-calendar text-lg"></i>
        </span>
        Fixo
      </button>
      <button id="btn-add-gasto-parcelado"
        class="group flex-1 flex flex-col items-center gap-1 text-[0.7rem] font-semibold text-indigo-700 dark:text-indigo-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 dark:focus-visible:ring-indigo-600"
        type="button" aria-label="Adicionar gasto parcelado">
        <span class="flex h-11 w-11 items-center justify-center rounded-full bg-indigo-600 text-white shadow-lg transition-transform group-hover:-translate-y-0.5 dark:bg-indigo-700">
          <i class="fa fa-file-invoice-dollar text-lg"></i>
        </span>
        Parcelado
      </button>
      <button id="btn-open-importar"
        class="group flex-1 flex flex-col items-center gap-1 text-[0.7rem] font-semibold text-amber-700 dark:text-amber-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-amber-400 dark:focus-visible:ring-amber-600"
        type="button" aria-label="Importar extrato bancário">
        <span class="flex h-11 w-11 items-center justify-center rounded-full bg-amber-500 text-white shadow-lg transition-transform group-hover:-translate-y-0.5 dark:bg-amber-600">
          <i class="fa fa-file-import text-lg"></i>
        </span>
        Importar
      </button>
      <div class="relative flex-1 flex justify-center" data-quick-income-container>
        <button id="btn-quick-entradas" type="button"
          class="group flex flex-col items-center gap-1 text-[0.7rem] font-semibold text-emerald-700 dark:text-emerald-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400 dark:focus-visible:ring-emerald-700"
          aria-label="Ações de entrada e investimento" aria-haspopup="true" aria-expanded="false">
          <span class="flex h-10 w-10 items-center justify-center rounded-full bg-emerald-50 dark:bg-emerald-900/40 text-emerald-600 dark:text-emerald-300 shadow-sm transition-transform group-hover:-translate-y-0.5">
            <i class="fa fa-piggy-bank text-lg"></i>
          </span>
          Entr./Inv.
        </button>
        <div id="quick-income-menu" class="hidden absolute bottom-16 left-1/2 w-44 -translate-x-1/2 rounded-2xl border border-emerald-100 dark:border-emerald-900/40 bg-white/95 dark:bg-gray-900/95 shadow-2xl backdrop-blur p-2 text-[0.72rem] font-semibold text-emerald-700 dark:text-emerald-200 z-10">
          <span class="pointer-events-none absolute -bottom-2 left-1/2 block h-3 w-3 -translate-x-1/2 rotate-45 bg-white dark:bg-gray-900 border-r border-b border-emerald-100 dark:border-emerald-900/40"></span>
          <button type="button" data-income-action="entrada" class="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-left transition hover:bg-emerald-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400 dark:hover:bg-emerald-900/30">
            <i class="fa fa-circle-plus text-sm"></i>
            Nova entrada
          </button>
          <button type="button" data-income-action="investimento" class="mt-1 flex w-full items-center gap-2 rounded-lg px-3 py-2 text-left transition hover:bg-emerald-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400 dark:hover:bg-emerald-900/30">
            <i class="fa fa-arrow-trend-up text-sm"></i>
            Novo investimento
          </button>
        </div>
      </div>
    </nav>
    <div class="mt-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 pointer-events-none select-none">
      Ferramentas rápidas
    </div>
  </div>
</div>

<script>
// Dark Mode Toggle (Detecta sistema + salva preferência)
const html = document.documentElement;
const toggleBtn = document.getElementById('toggleDark');
const toggleStatus = document.getElementById('toggleDarkStatus');
const toggleDarkIcon = toggleBtn ? toggleBtn.querySelector('[data-dark-icon]') : null;
const toggleLightIcon = toggleBtn ? toggleBtn.querySelector('[data-light-icon]') : null;

function syncDarkToggleUI() {
  if (!toggleBtn) return;
  const isDark = html.classList.contains('dark');
  toggleBtn.setAttribute('aria-pressed', isDark ? 'true' : 'false');
  if (toggleStatus) {
    toggleStatus.textContent = isDark ? 'Escuro' : 'Claro';
  }
  if (toggleDarkIcon) {
    toggleDarkIcon.classList.toggle('hidden', !isDark);
  }
  if (toggleLightIcon) {
    toggleLightIcon.classList.toggle('hidden', isDark);
  }
}

function initDarkMode() {
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  if (localStorage.theme === 'dark' || (!('theme' in localStorage) && prefersDark)) {
    html.classList.add('dark');
  } else {
    html.classList.remove('dark');
  }
  syncDarkToggleUI();
}

if (toggleBtn) {
  toggleBtn.addEventListener('click', () => {
    html.classList.toggle('dark');
    localStorage.theme = html.classList.contains('dark') ? 'dark' : 'light';
    syncDarkToggleUI();
  });
}

initDarkMode(); // Inicializa ao carregar

try {
  const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
  const mediaListener = (event) => {
    if (!('theme' in localStorage)) {
      if (event.matches) {
        html.classList.add('dark');
      } else {
        html.classList.remove('dark');
      }
      syncDarkToggleUI();
    }
  };
  if (typeof mediaQuery.addEventListener === 'function') {
    mediaQuery.addEventListener('change', mediaListener);
  } else if (typeof mediaQuery.addListener === 'function') {
    mediaQuery.addListener(mediaListener);
  }
} catch (error) {
  console.debug('Não foi possível observar mudanças de tema do sistema.', error);
}

// Registro SW (limpo, como antes)
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js")
    .then((registration) => {
      console.log("✅ Service Worker registrado com sucesso:", registration.scope);
    })
    .catch((err) => {
      console.error("❌ Erro ao registrar SW:", err);
    });
} else {
  console.log("❌ Service Workers não suportados neste navegador.");
}
</script>

<!-- NOVO: Toast Message para feedback -->
<div id="toast-message" class="hidden"></div>

<footer class="text-center text-xs sm:text-sm text-gray-500 dark:text-gray-400 py-6 space-y-3">
  <div id="footer-verse" class="max-w-2xl mx-auto text-[0.75rem] sm:text-sm text-gray-600 dark:text-gray-300 italic leading-relaxed"></div>
  <div class="text-[0.7rem] sm:text-xs text-gray-400 dark:text-gray-500">© 2025 Organizador Financeiro <br> Vitor Barbosa</div>
</footer>

<!-- Firebase compat scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/* ===========================
   CONFIG FIREBASE (externa)
   =========================== */
const resolveFirebaseConfig = () => {
  const config = window.__FIREBASE_CONFIG__ || (window.__APP_CONFIG__ && window.__APP_CONFIG__.firebase && window.__APP_CONFIG__.firebase.client);
  if (config && typeof config === 'object' && Object.keys(config).length) {
    return config;
  }

  const overlay = document.getElementById('firebase-config-overlay');
  if (overlay) {
    overlay.classList.remove('hidden');
  }
  throw new Error('Firebase config ausente. Defina window.__FIREBASE_CONFIG__ em app-config.js.');
};

const firebaseConfig = resolveFirebaseConfig();
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const googleAuthProvider = new firebase.auth.GoogleAuthProvider();
googleAuthProvider.setCustomParameters({ prompt: 'select_account' });
const authEnvironment = {
  isFileProtocol: window.location.protocol === 'file:',
  host: window.location.host,
};
const messaging = firebase.messaging(); // Inicializa o Messaging
const FieldValue = firebase.firestore.FieldValue;
const FieldPath = firebase.firestore.FieldPath;

firebase.firestore().enablePersistence({ synchronizeTabs: true }).catch((error) => {
  if (error?.code === 'failed-precondition') {
    console.warn('Persistência offline não habilitada: múltiplas abas abertas do app.');
  } else if (error?.code === 'unimplemented') {
    console.warn('Persistência offline não é suportada neste navegador.');
  } else if (error) {
    console.error('Falha ao habilitar persistência offline:', error);
  }
});

let currentUser = null;
let appBootstrapped = false;
let workspaceInitialized = false;
let activeWorkspace = { workspaceId: null, ownerUid: null, memberUids: [], isOwner: false };
const workspaceProfilesCache = new Map();
let currentUserProfile = null;
let appReadyForCurrentUser = false;
let appStartInProgress = false;
let accessProfileUnsubscribe = null;
let accessGuardMode = null;
let workspaceMetadataNormalizationExecuted = false;
let serviceWorkerRegistrationRef = null;
let swControllerChangeHandled = false;

const NOTIFICATION_PROMPT_KEY = 'of-notification-prompted';
let notificationPrompted = false;

try {
  notificationPrompted = localStorage.getItem(NOTIFICATION_PROMPT_KEY) === '1';
} catch (error) {
  notificationPrompted = false;
}

function requireAuthContext() {
  if (!currentUser) {
    throw new Error('Ação requer usuário autenticado.');
  }
}

function getWorkspaceOwnerUid() {
  if (activeWorkspace && activeWorkspace.ownerUid) {
    return activeWorkspace.ownerUid;
  }
  return currentUser?.uid || null;
}

function getActiveWorkspaceId() {
  if (activeWorkspace && activeWorkspace.workspaceId) {
    return activeWorkspace.workspaceId;
  }
  return getWorkspaceOwnerUid() || currentUser?.uid || null;
}

function stampWorkspaceCreation(data = {}) {
  const base = { ...data };
  const now = firebase.firestore.Timestamp.now();
  const ownerUid = getWorkspaceOwnerUid() || currentUser?.uid || null;
  const workspaceId = getActiveWorkspaceId();

  if (ownerUid && base.ownerUid !== ownerUid) {
    base.ownerUid = ownerUid;
  }

  if (workspaceId && base.workspaceId !== workspaceId) {
    base.workspaceId = workspaceId;
  }

  if (!('createdAt' in base)) {
    base.createdAt = now;
  }

  if (!('updatedAt' in base)) {
    base.updatedAt = now;
  }

  if (!('createdByUid' in base)) {
    base.createdByUid = currentUser?.uid || null;
  }

  if (!('createdByEmail' in base)) {
    base.createdByEmail = currentUser?.email || null;
  }

  return base;
}

function stampWorkspaceUpdate(data = {}) {
  const base = { ...data };
  const now = firebase.firestore.Timestamp.now();
  const ownerUid = getWorkspaceOwnerUid() || currentUser?.uid || null;
  const workspaceId = getActiveWorkspaceId();

  if (ownerUid && base.ownerUid !== ownerUid) {
    base.ownerUid = ownerUid;
  }

  if (workspaceId && base.workspaceId !== workspaceId) {
    base.workspaceId = workspaceId;
  }

  base.updatedAt = now;

  return base;
}

async function ensureWorkspaceMetadataForCollections(force = false) {
  if (workspaceMetadataNormalizationExecuted && !force) {
    return;
  }

  const ownerUid = getWorkspaceOwnerUid();
  const workspaceId = getActiveWorkspaceId();

  if (!ownerUid || !workspaceId) {
    return;
  }

  workspaceMetadataNormalizationExecuted = true;

  const collections = ['gastos', 'parcelados', 'entradas', 'investimentos', 'fixos'];
  const batchSize = 200;

  try {
    for (const name of collections) {
      let lastDoc = null;
      let more = true;

      while (more) {
        let query = userCollectionRef(name).orderBy(FieldPath.documentId()).limit(batchSize);
        if (lastDoc) {
          query = query.startAfter(lastDoc);
        }

        const snapshot = await query.get();
        if (snapshot.empty) {
          break;
        }

        const batch = db.batch();
        let updates = 0;

        snapshot.docs.forEach(docSnap => {
          const data = docSnap.data() || {};
          const patch = {};

          if (!data.ownerUid || data.ownerUid !== ownerUid) {
            patch.ownerUid = ownerUid;
          }

          if (!data.workspaceId || data.workspaceId !== workspaceId) {
            patch.workspaceId = workspaceId;
          }

          if (!data.createdAt) {
            if (data.data instanceof firebase.firestore.Timestamp) {
              patch.createdAt = data.data;
            } else if (data.dataInicio instanceof firebase.firestore.Timestamp) {
              patch.createdAt = data.dataInicio;
            } else {
              patch.createdAt = firebase.firestore.Timestamp.now();
            }
          }

          if (!data.updatedAt) {
            patch.updatedAt = firebase.firestore.Timestamp.now();
          }

          if (Object.keys(patch).length > 0) {
            batch.set(docSnap.ref, stampWorkspaceUpdate(patch), { merge: true });
            updates += 1;
          }
        });

        if (updates > 0) {
          await batch.commit();
        }

        if (snapshot.size < batchSize) {
          break;
        }

        lastDoc = snapshot.docs[snapshot.docs.length - 1];
      }
    }

    await normalizeImporterWorkspaceMetadata({ ownerUid, workspaceId, batchSize });
  } catch (err) {
    console.error('Erro ao normalizar metadados de workspace:', err);
    workspaceMetadataNormalizationExecuted = false;
  }
}

async function normalizeImporterWorkspaceMetadata({ ownerUid, workspaceId, batchSize = 200 }) {
  if (!ownerUid) {
    return;
  }

  const collections = [
    { name: 'transactions', ensureUser: true },
    { name: 'importSessions', ensureUser: true },
    { name: 'categoryRules', ensureUser: true },
    { name: 'merchantAliases', ensureUser: true },
  ];

  const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp();

  for (const { name, ensureUser } of collections) {
    const collectionRef = db.collection(name);
    const seen = new Set();

    const filters = [
      workspaceId ? { field: 'workspaceId', value: workspaceId } : null,
      { field: 'ownerUid', value: ownerUid },
      ensureUser ? { field: 'userId', value: ownerUid } : null,
    ].filter(Boolean);

    for (const filter of filters) {
      let lastDoc = null;
      let more = true;

      while (more) {
        let query = collectionRef.orderBy(FieldPath.documentId()).limit(batchSize);
        if (filter?.field && filter.value != null) {
          try {
            query = collectionRef.where(filter.field, '==', filter.value).orderBy(FieldPath.documentId()).limit(batchSize);
          } catch (error) {
            console.warn(`Ignorando filtro ${filter.field} em ${name}:`, error);
            break;
          }
        }
        if (lastDoc) {
          query = query.startAfter(lastDoc);
        }

        let snapshot;
        try {
          snapshot = await query.get();
        } catch (error) {
          console.warn(`Falha ao normalizar ${name} (${filter?.field || 'sem filtro'}):`, error);
          break;
        }

        if (snapshot.empty) {
          break;
        }

        const batch = db.batch();
        let updates = 0;

        snapshot.docs.forEach((docSnap) => {
          if (seen.has(docSnap.id)) {
            return;
          }
          seen.add(docSnap.id);

          const data = docSnap.data() || {};
          const patch = {};

          if (!data.ownerUid || data.ownerUid !== ownerUid) {
            patch.ownerUid = ownerUid;
          }

          if (ensureUser && (!data.userId || data.userId !== ownerUid)) {
            patch.userId = ownerUid;
          }

          if (!data.workspaceId || data.workspaceId !== workspaceId) {
            patch.workspaceId = workspaceId || ownerUid;
          }

          if (!data.createdAt) {
            patch.createdAt = serverTimestamp;
          }

          if (name === 'transactions') {
            if (!data.meta) {
              patch.meta = {};
            }
            if (!data.importSessionId) {
              patch.importSessionId = null;
            }
          }

          if (Object.keys(patch).length > 0) {
            patch.updatedAt = serverTimestamp;
            batch.set(docSnap.ref, patch, { merge: true });
            updates += 1;
          }
        });

        if (updates > 0) {
          try {
            await batch.commit();
          } catch (error) {
            console.error(`Erro ao aplicar metadados em ${name}:`, error);
          }
        }

        if (snapshot.size < batchSize) {
          break;
        }

        lastDoc = snapshot.docs[snapshot.docs.length - 1];
      }
    }
  }
}

function userRootRef() {
  requireAuthContext();
  const ownerUid = getWorkspaceOwnerUid();
  if (!ownerUid) {
    throw new Error('Espaço financeiro não definido.');
  }
  return db.collection('users').doc(ownerUid);
}

function userCollectionRef(name) {
  return userRootRef().collection(name);
}

function userDocRef(collectionName, docId) {
  return userCollectionRef(collectionName).doc(docId);
}

function normalizeEmail(email = '') {
  return (email || '').trim().toLowerCase();
}

async function detectLegacyData() {
  const [gastosSnap, parceladosSnap, entradasSnap, investimentosSnap, fixosSnap, limitesSnap] = await Promise.all([
    db.collection('gastos').limit(1).get().catch(() => null),
    db.collection('parcelados').limit(1).get().catch(() => null),
    db.collection('entradas').limit(1).get().catch(() => null),
    db.collection('investimentos').limit(1).get().catch(() => null),
    db.collection('fixos').limit(1).get().catch(() => null),
    db.collection('limites').doc('conta_unica').get().catch(() => null),
  ]);

  return Boolean(
    (gastosSnap && !gastosSnap.empty) ||
    (parceladosSnap && !parceladosSnap.empty) ||
    (entradasSnap && !entradasSnap.empty) ||
    (investimentosSnap && !investimentosSnap.empty) ||
    (fixosSnap && !fixosSnap.empty) ||
    (limitesSnap && limitesSnap.exists)
  );
}

async function syncUserProfile(user) {
  if (!user) return null;
  try {
    const normalized = normalizeEmail(user.email);
    const profileRef = db.collection('profiles').doc(user.uid);
    const snapshot = await profileRef.get();
    const existingProfile = snapshot.exists ? (snapshot.data() || {}) : {};
    const now = firebase.firestore.Timestamp.now();
    const updates = {
      email: user.email || existingProfile.email || null,
      normalizedEmail: normalized || existingProfile.normalizedEmail || null,
      displayName: user.displayName || existingProfile.displayName || null,
      photoURL: user.photoURL || existingProfile.photoURL || null,
      lastLoginAt: now,
      updatedAt: now,
    };

    if (!existingProfile.createdAt) {
      updates.createdAt = now;
    }

    const emailAllowed = isEmailAllowedForRegistration(normalized);
    let status = existingProfile.status || null;
    let role = existingProfile.role || null;
    let forcedFirstApproval = false;

    const shouldApprove = shouldAutoApproveUser(user, existingProfile);

    if (!status) {
      if (!ACCESS_CONTROL_CFG.requireApproval || shouldApprove) {
        status = 'approved';
        updates.status = 'approved';
        updates.approvedAt = now;
        updates.approvedBy = user.uid;
      } else {
        status = 'pending';
        updates.status = 'pending';
        updates.pendingAt = now;
      }
    } else if (status !== 'approved' && shouldApprove) {
      status = 'approved';
      updates.status = 'approved';
      updates.approvedAt = now;
      updates.approvedBy = user.uid;
      updates.pendingAt = FieldValue.delete();
      updates.blockedAt = FieldValue.delete();
      updates.blockedBy = FieldValue.delete();
      updates.blockedReason = FieldValue.delete();
    }

    if (ACCESS_CONTROL_CFG.autoApproveFirstUser && status !== 'approved') {
      try {
        const approvedSnap = await db.collection('profiles').where('status', '==', 'approved').limit(1).get();
        if (approvedSnap.empty) {
          status = 'approved';
          forcedFirstApproval = true;
          updates.status = 'approved';
          updates.approvedAt = now;
          updates.approvedBy = user.uid;
          updates.pendingAt = FieldValue.delete();
          updates.blockedAt = FieldValue.delete();
          updates.blockedBy = FieldValue.delete();
          updates.blockedReason = FieldValue.delete();
        }
      } catch (checkError) {
        console.error('Erro ao verificar aprovados existentes:', checkError);
      }
    }

    if (status === 'approved' && !updates.approvedAt && !existingProfile.approvedAt) {
      updates.approvedAt = now;
      updates.approvedBy = existingProfile.approvedBy || user.uid;
    }

    if (status === 'approved' && existingProfile.pendingAt && updates.pendingAt === undefined) {
      updates.pendingAt = FieldValue.delete();
    }

    if (!emailAllowed) {
      status = 'blocked';
      updates.status = 'blocked';
      updates.blockedAt = now;
      updates.blockedReason = 'not_allowlisted';
    } else if (existingProfile.blockedReason && status !== 'blocked') {
      updates.blockedReason = FieldValue.delete();
    }

    if (status === 'pending' && !existingProfile.pendingAt && !updates.pendingAt) {
      updates.pendingAt = now;
    }

    const shouldGrantAdmin = userMatchesAdminConfig(user, existingProfile) || forcedFirstApproval;
    if (!role && shouldGrantAdmin) {
      role = 'admin';
      updates.role = 'admin';
    }

    if (role) {
      updates.role = role;
    }

    updates.status = status;

    await profileRef.set(updates, { merge: true });
    const mergedProfile = { ...existingProfile, ...updates, status, role };
    workspaceProfilesCache.set(user.uid, mergedProfile);
    return { uid: user.uid, ...mergedProfile };
  } catch (error) {
    console.error('Erro ao sincronizar perfil do usuário:', error);
    return null;
  }
}

async function migrateLegacyData(user) {
  const ownerUid = getWorkspaceOwnerUid() || user?.uid || null;
  const collectionNames = ['gastos', 'parcelados', 'entradas', 'investimentos', 'fixos'];

  for (const name of collectionNames) {
    try {
      const snapshot = await db.collection(name).get();
      if (snapshot.empty) continue;
      const targetCollection = userCollectionRef(name);
      for (const doc of snapshot.docs) {
        const data = doc.data() || {};
        if (ownerUid && data.ownerUid && data.ownerUid !== ownerUid) continue;
        const merged = { ...data, ownerUid: ownerUid || data.ownerUid || null };
        if (!merged.workspaceId) {
          merged.workspaceId = activeWorkspace?.workspaceId || ownerUid || currentUser?.uid || null;
        }
        if (!merged.createdAt) {
          if (merged.data instanceof firebase.firestore.Timestamp) {
            merged.createdAt = merged.data;
          } else if (merged.dataInicio instanceof firebase.firestore.Timestamp) {
            merged.createdAt = merged.dataInicio;
          } else {
            merged.createdAt = firebase.firestore.Timestamp.now();
          }
        }
        const stamped = stampWorkspaceUpdate(merged);
        await targetCollection.doc(doc.id).set(stamped, { merge: true });
      }
    } catch (err) {
      console.error(`Erro ao migrar coleção legacy ${name}:`, err);
    }
  }

  try {
    const limitesSnap = await db.collection('limites').doc('conta_unica').get();
    if (limitesSnap.exists) {
      await userDocRef('limites', 'conta_unica').set(stampWorkspaceUpdate(limitesSnap.data() || {}), { merge: true });
    }
  } catch (err) {
    console.error('Erro ao migrar limites legacy:', err);
  }

  try {
    const cartoesSnap = await db.collection('config').doc('cartoes').get();
    if (cartoesSnap.exists) {
      await userDocRef('config', 'cartoes').set(cartoesSnap.data(), { merge: true });
    }
  } catch (err) {
    console.error('Erro ao migrar configuração de cartões legacy:', err);
  }
}

async function maybeMigrateLegacyData(user) {
  if (!user || !activeWorkspace?.isOwner) {
    return false;
  }

  const legacyMarkerRef = db.collection('metadata').doc('legacy_migration');
  const ownerUid = getWorkspaceOwnerUid();
  let shouldMigrate = false;

  try {
    const markerSnap = await legacyMarkerRef.get().catch(() => null);
    if (markerSnap && markerSnap.exists) {
      const markerData = markerSnap.data() || {};
      if (markerData.completed && markerData.migratedBy === ownerUid) {
        return true;
      }
      if (markerData.migratedBy === ownerUid && !markerData.completed) {
        shouldMigrate = true;
      }
    } else {
      const hasLegacyData = await detectLegacyData();
      if (hasLegacyData) {
        shouldMigrate = window.confirm('Encontramos dados existentes antes da autenticação. Deseja vinculá-los ao seu espaço familiar?');
        if (shouldMigrate) {
          await legacyMarkerRef.set({
            migratedBy: ownerUid,
            workspaceId: activeWorkspace.workspaceId,
            startedAt: firebase.firestore.Timestamp.now(),
          }, { merge: true });
        }
      }
    }

    if (!shouldMigrate) {
      return false;
    }

    await migrateLegacyData(user);
    await legacyMarkerRef.set({
      migratedBy: ownerUid,
      workspaceId: activeWorkspace.workspaceId,
      migratedAt: firebase.firestore.Timestamp.now(),
      completed: true,
    }, { merge: true });
    return true;
  } catch (error) {
    console.error('Erro ao verificar migração legada:', error);
    return false;
  }
}

async function ensureUserWorkspace(user) {
  if (!user) return;

  try {
    const baseUserDocRef = db.collection('users').doc(user.uid);
    const workspaceDocRef = baseUserDocRef.collection('metadata').doc('workspace');
    const workspaceSnap = await workspaceDocRef.get().catch(() => null);
    const workspaceData = workspaceSnap && workspaceSnap.exists ? (workspaceSnap.data() || {}) : {};

    let workspaceId = workspaceData.sharedWorkspaceId || workspaceData.linkedOwnerUid || user.uid;
    let ownerUid = workspaceData.sharedOwnerUid || workspaceData.linkedOwnerUid || workspaceData.ownerUid || workspaceId || user.uid;

    if (!workspaceId) workspaceId = user.uid;
    if (!ownerUid) ownerUid = user.uid;

    const sharedWorkspaceRef = db.collection('sharedWorkspaces').doc(workspaceId);
    const sharedSnap = await sharedWorkspaceRef.get().catch(() => null);
    let sharedData = sharedSnap && sharedSnap.exists ? (sharedSnap.data() || {}) : {};

    if (!sharedSnap || !sharedSnap.exists) {
      sharedData = {
        workspaceId,
        ownerUid,
        memberUids: [ownerUid],
      };
      await sharedWorkspaceRef.set({
        ...sharedData,
        createdAt: firebase.firestore.Timestamp.now(),
      }, { merge: true });
    } else {
      if (sharedData.ownerUid && sharedData.ownerUid !== ownerUid) {
        ownerUid = sharedData.ownerUid;
      }
      if (sharedData.workspaceId) {
        workspaceId = sharedData.workspaceId;
      } else {
        await sharedWorkspaceRef.set({ workspaceId }, { merge: true });
      }
    }

    const memberSet = new Set(Array.isArray(sharedData.memberUids) ? sharedData.memberUids : []);
    memberSet.add(ownerUid);
    memberSet.add(user.uid);

    if (!sharedData.memberUids || !sharedData.memberUids.includes(ownerUid)) {
      await sharedWorkspaceRef.set({
        memberUids: FieldValue.arrayUnion(ownerUid),
        updatedAt: firebase.firestore.Timestamp.now(),
      }, { merge: true });
    }

    if (!sharedData.memberUids || !sharedData.memberUids.includes(user.uid)) {
      await sharedWorkspaceRef.set({
        memberUids: FieldValue.arrayUnion(user.uid),
        updatedAt: firebase.firestore.Timestamp.now(),
      }, { merge: true });
    }

    if (!sharedData.ownerUid && ownerUid) {
      await sharedWorkspaceRef.set({ ownerUid }, { merge: true });
    }

    workspaceMetadataNormalizationExecuted = false;
    activeWorkspace = {
      workspaceId,
      ownerUid,
      memberUids: Array.from(memberSet),
      isOwner: ownerUid === user.uid,
    };

    const migratedFlag = workspaceData.migrated || await maybeMigrateLegacyData(user);

    await workspaceDocRef.set({
      initialized: true,
      sharedWorkspaceId: workspaceId,
      sharedOwnerUid: ownerUid,
      updatedAt: firebase.firestore.Timestamp.now(),
      migrated: Boolean(migratedFlag),
    }, { merge: true });

    workspaceInitialized = true;
    updateWorkspaceContextUI();
    ensureWorkspaceMetadataForCollections().catch(err => console.error('Falha ao garantir metadados de workspace:', err));
  } catch (err) {
    console.error('Erro ao preparar workspace do usuário:', err);
  }
}

const authOverlay = document.getElementById('auth-overlay');
const authForm = document.getElementById('auth-form');
const authToggleMode = document.getElementById('auth-toggle-mode');
const authError = document.getElementById('auth-error');
const authSubmit = document.getElementById('auth-submit');
const authTitle = document.getElementById('auth-title');
const authDescription = document.getElementById('auth-description');
const authEmailInput = document.getElementById('auth-email');
const authPasswordInput = document.getElementById('auth-password');
const authGoogleButton = document.getElementById('auth-google');
const authGoogleLabel = authGoogleButton?.querySelector('[data-label]') || null;
const authGoogleHelper = document.getElementById('auth-google-helper');
const authGoogleHostTarget = authGoogleHelper?.querySelector('[data-google-host]') || null;
if (authGoogleHostTarget) {
  const hostLabel = authEnvironment.host || window.location.host || window.location.hostname || 'seu domínio';
  authGoogleHostTarget.textContent = hostLabel;
}
const authFormBlock = document.getElementById('auth-form-block');
const authSocialBlock = document.getElementById('auth-social-block');
const authVerifyBlock = document.getElementById('auth-verify-block');
const authVerifyEmail = document.getElementById('auth-verify-email');
const authVerifyResend = document.getElementById('auth-verify-resend');
const authVerse = document.getElementById('auth-verse');
const authVerifyRefresh = document.getElementById('auth-verify-refresh');
const authVerifyChange = document.getElementById('auth-verify-change');
const authVerifyFeedback = document.getElementById('auth-verify-feedback');
const defaultGoogleHelperHtml = authGoogleHelper ? authGoogleHelper.innerHTML : '';
const userSession = document.getElementById('user-session');
const userEmailBadge = document.getElementById('user-email-badge');
const userBadgeLabel = document.getElementById('user-badge-label');
const userAvatarBadge = document.getElementById('user-avatar-badge');
const userMenuTrigger = document.getElementById('user-menu-trigger');
const userMenuDropdown = document.getElementById('user-menu-dropdown');
const userMenuCaret = document.querySelector('[data-user-menu-caret]');
const userPlanReminder = document.getElementById('user-plan-reminder');
const userPlanReminderLabel = document.getElementById('user-plan-reminder-label');
const userPlanReminderDesc = document.getElementById('user-plan-reminder-desc');
const userPlanReminderIcon = document.getElementById('user-plan-reminder-icon');
const userPlanReminderDot = document.getElementById('user-plan-reminder-dot');
const signOutButton = document.getElementById('btn-signout');
const workspaceContextBadge = document.getElementById('workspace-context-badge');
const workspaceShareButton = document.getElementById('btn-open-workspace-sharing');
const workspaceShareModal = document.getElementById('modal-workspace-share');
const workspaceShareClose = document.getElementById('workspace-share-close');
const workspaceShareCode = document.getElementById('workspace-share-code');
const workspaceCopyCode = document.getElementById('workspace-copy-code');
const workspaceMembersList = document.getElementById('workspace-members-list');
const workspaceJoinForm = document.getElementById('workspace-join-form');
const workspaceJoinCodeInput = document.getElementById('workspace-join-code');
const workspaceJoinSubmit = document.getElementById('workspace-join-submit');
const workspaceJoinHelper = document.getElementById('workspace-join-helper');
const workspaceLeaveButton = document.getElementById('workspace-leave-button');
const workspaceShareFeedback = document.getElementById('workspace-share-feedback');
const workspaceOwnerHint = document.getElementById('workspace-owner-hint');
const footerVerse = document.getElementById('footer-verse');
const accessGuardOverlay = document.getElementById('access-guard-overlay');
const accessGuardTitle = document.getElementById('access-guard-title');
const accessGuardMessage = document.getElementById('access-guard-message');
const accessGuardExtra = document.getElementById('access-guard-extra');
const accessGuardRefresh = document.getElementById('access-guard-refresh');
const accessGuardSignout = document.getElementById('access-guard-signout');
const accessGuardIcon = document.getElementById('access-guard-icon');
const accessManagerButton = document.getElementById('btn-open-access-manager');
const accessManagerModal = document.getElementById('modal-access-manager');
const accessManagerClose = document.getElementById('access-manager-close');
const accessManagerPendingList = document.getElementById('access-manager-pending');
const accessManagerApprovedList = document.getElementById('access-manager-approved');
const accessManagerBlockedList = document.getElementById('access-manager-blocked');
const accessManagerPendingEmpty = document.getElementById('access-manager-pending-empty');
const accessManagerApprovedEmpty = document.getElementById('access-manager-approved-empty');
const accessManagerBlockedEmpty = document.getElementById('access-manager-blocked-empty');
const accessManagerPendingCount = document.getElementById('access-manager-pending-count');
const accessManagerApprovedCount = document.getElementById('access-manager-approved-count');
const accessManagerBlockedCount = document.getElementById('access-manager-blocked-count');
const accessManagerSectionToggles = Array.from(document.querySelectorAll('[data-access-section-toggle]'));
const accessManagerSectionBodies = {};
const accessManagerSectionCarets = {};
const accessManagerSectionState = {};
initAccessManagerSectionControls();
const FIRESTORE_RULES_SNIPPET = String.raw`rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/profiles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
    }

    function workspaceAllowed(workspaceId) {
      return isSignedIn() &&
        (workspaceId == request.auth.uid ||
         (workspaceId != null &&
          exists(/databases/$(database)/documents/sharedWorkspaces/$(workspaceId)) &&
          request.auth.uid in
            get(/databases/$(database)/documents/sharedWorkspaces/$(workspaceId)).data.memberUids));
    }

    function ownerFromData(data) {
      return data == null
        ? null
        : (data.ownerUid != null && data.ownerUid != ''
          ? data.ownerUid
          : data.userId);
    }

    function workspaceFromData(data) {
      return data == null
        ? null
        : (data.workspaceId != null && data.workspaceId != ''
          ? data.workspaceId
          : ownerFromData(data));
    }

    function canAccessData(data) {
      return workspaceAllowed(workspaceFromData(data)) || workspaceAllowed(ownerFromData(data));
    }

    // 👤 Perfis de acesso (aprovação, bloqueio, etc.)
    match /profiles/{uid} {
      allow create: if isSignedIn() && uid == request.auth.uid;

      allow read: if isSignedIn() && (uid == request.auth.uid || isAdmin());

      allow update: if isSignedIn() && (
        isAdmin() ||
        (uid == request.auth.uid &&
         (resource.data.status == 'pending' || (
           request.resource.data.role == resource.data.role &&
           request.resource.data.status == resource.data.status &&
           request.resource.data.approvedAt == resource.data.approvedAt &&
           request.resource.data.approvedBy == resource.data.approvedBy &&
           request.resource.data.blockedAt == resource.data.blockedAt &&
           request.resource.data.blockedBy == resource.data.blockedBy &&
           request.resource.data.blockedReason == resource.data.blockedReason
         )))
      );

      allow delete: if false;
    }

    // 👨‍👩‍👧‍👦 Workspaces compartilhados
    match /sharedWorkspaces/{workspaceId} {
      allow read, write: if workspaceAllowed(workspaceId);
    }

    // 💳 Transações importadas
    match /transactions/{id} {
      allow read: if isSignedIn() && canAccessData(resource.data);
      allow create: if isSignedIn() && canAccessData(request.resource.data);
      allow update: if isSignedIn() &&
        canAccessData(resource.data) &&
        request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(['category', 'tags', 'updatedAt', 'deletedAt', 'meta', 'importSessionId']);
    }

    // 🗂️ Sessões de importação
    match /importSessions/{id} {
      allow read: if isSignedIn() && canAccessData(resource.data);
      allow create: if isSignedIn() && canAccessData(request.resource.data);
      allow update: if isSignedIn() &&
        canAccessData(resource.data) &&
        request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(['undoneAt', 'stats']);
    }

    // 🏷️ Regras de categoria
    match /categoryRules/{id} {
      allow read: if isSignedIn() && canAccessData(resource.data);
      allow create: if isSignedIn() && canAccessData(request.resource.data);
      allow update: if isSignedIn() && canAccessData(resource.data);
    }

    // 🛍️ Aliases de lojista
    match /merchantAliases/{id} {
      allow read: if isSignedIn() && canAccessData(resource.data);
      allow create: if isSignedIn() && canAccessData(request.resource.data);
      allow update: if isSignedIn() && canAccessData(resource.data);
    }

    // 💼 Dados financeiros do workspace legado
    match /users/{ownerUid}/{collection}/{docId} {
      allow read, write: if workspaceAllowed(ownerUid);
    }

    // 🚫 Tudo que não foi mapeado permanece bloqueado
    match /{document=**} {
      allow read, write: if false;
    }
  }
}`;

function showFirestoreRulesHelp(targetElement) {
  if (!targetElement) return;
  targetElement.classList.remove('hidden');
  targetElement.innerHTML = '';

  const wrapper = document.createElement('div');
  wrapper.className = 'space-y-2 text-xs text-gray-600 dark:text-gray-300';

  const intro = document.createElement('p');
  intro.innerHTML = 'Sem permissão para listar solicitações. Atualize as <strong>regras do Firestore</strong> com o bloco abaixo ' +
    'e tente novamente. Copie tudo, incluindo as duas chaves "}" finais, e publique as regras no console.';
  wrapper.appendChild(intro);

  const details = document.createElement('details');
  details.className = 'bg-gray-50 dark:bg-gray-800/60 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-3';

  const summary = document.createElement('summary');
  summary.className = 'font-semibold text-gray-700 dark:text-gray-200 cursor-pointer';
  summary.textContent = 'Ver regras recomendadas';
  details.appendChild(summary);

  const pre = document.createElement('pre');
  pre.className = 'mt-2 whitespace-pre-wrap break-words text-[10px] leading-4 text-gray-700 dark:text-gray-100';
  pre.textContent = FIRESTORE_RULES_SNIPPET;
  details.appendChild(pre);

  wrapper.appendChild(details);
  targetElement.appendChild(wrapper);
}

let authMode = 'signIn';
let googleLoading = false;
let pendingVerificationUser = null;
let isUserMenuOpen = false;

const bibleVerses = [
  { text: 'As mãos diligentes trazem riqueza.', reference: 'Provérbios 10:4' },
  { text: 'O mordomo fiel e prudente.', reference: 'Lucas 12:42' },
  { text: 'Confia ao Senhor as tuas obras.', reference: 'Provérbios 16:3' },
  { text: 'O que se requer dos despenseiros é que cada um seja encontrado fiel.', reference: '1 Coríntios 4:2' },
  {
    text: 'De fato, a piedade com contentamento é grande fonte de lucro. Porque nada trouxemos para este mundo e nada podemos levar dele.',
    reference: '1 Timóteo 6:6-7'
  },
  {
    text: 'Com sabedoria se constrói a casa, e com discernimento ela se consolida; pelo conhecimento os seus cômodos se enchem do que é precioso e agradável.',
    reference: 'Provérbios 24:3-4'
  },
  {
    text: 'Os planos bem elaborados levam à fartura; mas o apressado sempre acaba na miséria.',
    reference: 'Provérbios 21:5'
  },
  {
    text: 'Honra o Senhor com todos os teus recursos e com os primeiros frutos de todas as tuas plantações; e os teus celeiros ficarão plenamente cheios.',
    reference: 'Provérbios 3:9-10'
  },
  {
    text: 'Pois onde estiver o seu tesouro, aí também estará o seu coração.',
    reference: 'Mateus 6:21'
  },
  {
    text: 'Aprende com a formiga, preguiçoso; ela prepara sua comida no verão e ajunta o seu suprimento na colheita.',
    reference: 'Provérbios 6:6-8'
  },
  {
    text: 'O homem bom deixa herança para os filhos dos seus filhos.',
    reference: 'Provérbios 13:22'
  }
];

const PLAN_REMINDER_CLASS_SETS = {
  warning: {
    container: ['bg-amber-50', 'dark:bg-amber-500/10'],
    icon: ['text-amber-500', 'dark:text-amber-300'],
    label: ['text-amber-700', 'dark:text-amber-200'],
    desc: ['text-amber-600', 'dark:text-amber-200'],
    dot: ['bg-amber-400'],
  },
  expired: {
    container: ['bg-rose-50', 'dark:bg-rose-500/10'],
    icon: ['text-rose-500', 'dark:text-rose-300'],
    label: ['text-rose-600', 'dark:text-rose-200'],
    desc: ['text-rose-600', 'dark:text-rose-200'],
    dot: ['bg-rose-500'],
  },
};

const PLAN_REMINDER_ALL_CLASSES = Object.keys(PLAN_REMINDER_CLASS_SETS.warning).reduce((acc, key) => {
  const combined = new Set();
  Object.values(PLAN_REMINDER_CLASS_SETS).forEach((variant) => {
    (variant[key] || []).forEach((className) => combined.add(className));
  });
  acc[key] = Array.from(combined);
  return acc;
}, {});

const PLAN_REMINDER_ICON_VARIANTS = {
  warning: 'fa-hourglass-half',
  expired: 'fa-circle-exclamation',
};

const PLAN_REMINDER_ICON_DEFAULT = 'fa-bell';

const ACCESS_PLAN_OPTIONS = [
  { value: 'monthly', label: 'Mensal • 30 dias', months: 1 },
  { value: 'semiannual', label: 'Semestral • 6 meses', months: 6 },
  { value: 'annual', label: 'Anual • 12 meses', months: 12 },
];

const lastVerseReferences = {
  footer: null,
  auth: null,
};

function showGoogleHelper(messageHtml = defaultGoogleHelperHtml) {
  if (!authGoogleHelper) return;
  authGoogleHelper.innerHTML = messageHtml || defaultGoogleHelperHtml;
  authGoogleHelper.classList.remove('hidden');
}

function hideGoogleHelper() {
  if (!authGoogleHelper) return;
  authGoogleHelper.innerHTML = defaultGoogleHelperHtml;
  authGoogleHelper.classList.add('hidden');
}

function updateAuthModeUI() {
  const isVerification = authMode === 'verify';
  if (isVerification) {
    const verificationEmail = pendingVerificationUser?.email || authEmailInput.value.trim();
    authTitle.textContent = 'Confirme seu e-mail';
    authDescription.textContent = verificationEmail
      ? `Abra o e-mail enviado para ${verificationEmail} e clique no link de confirmação.`
      : 'Abra o e-mail de confirmação que enviamos e clique no link para liberar sua conta.';
  } else if (authMode === 'signIn') {
    authTitle.textContent = 'Acessar sua conta';
    authDescription.textContent = 'Faça login para carregar seus dados financeiros salvos.';
    authSubmit.textContent = 'Entrar';
    authToggleMode.textContent = 'Criar uma nova conta';
    authPasswordInput.autocomplete = 'current-password';
  } else {
    authTitle.textContent = 'Criar uma nova conta';
    authDescription.textContent = 'Cadastre-se para ter seu espaço financeiro protegido.';
    authSubmit.textContent = 'Cadastrar e acessar';
    authToggleMode.textContent = 'Já tenho conta';
    authPasswordInput.autocomplete = 'new-password';
  }

  if (authFormBlock) authFormBlock.classList.toggle('hidden', isVerification);
  if (authSocialBlock) authSocialBlock.classList.toggle('hidden', isVerification);
  if (authVerifyBlock) authVerifyBlock.classList.toggle('hidden', !isVerification);
  if (authToggleMode) authToggleMode.classList.toggle('hidden', isVerification);
}

function resetVerificationFeedback() {
  if (!authVerifyFeedback) return;
  authVerifyFeedback.classList.add('hidden');
  authVerifyFeedback.textContent = '';
  authVerifyFeedback.classList.remove('text-emerald-500', 'dark:text-emerald-300', 'text-red-500', 'dark:text-red-400');
}

function showVerificationFeedback(message, isSuccess = true) {
  if (!authVerifyFeedback) return;
  authVerifyFeedback.textContent = message;
  authVerifyFeedback.classList.remove('hidden');
  authVerifyFeedback.classList.toggle('text-emerald-500', isSuccess);
  authVerifyFeedback.classList.toggle('dark:text-emerald-300', isSuccess);
  authVerifyFeedback.classList.toggle('text-red-500', !isSuccess);
  authVerifyFeedback.classList.toggle('dark:text-red-400', !isSuccess);
}

function setVerificationButtonsDisabled(isDisabled) {
  [authVerifyResend, authVerifyRefresh, authVerifyChange].forEach((button) => {
    if (!button) return;
    button.disabled = isDisabled;
    button.classList.toggle('opacity-60', isDisabled);
    button.classList.toggle('cursor-not-allowed', isDisabled);
  });
}

function resetWorkspaceFeedback() {
  if (!workspaceShareFeedback) return;
  workspaceShareFeedback.classList.add('hidden');
  workspaceShareFeedback.textContent = '';
  workspaceShareFeedback.classList.remove(
    'text-emerald-600',
    'dark:text-emerald-300',
    'text-red-500',
    'dark:text-red-400'
  );
}

function showWorkspaceFeedback(message, isSuccess = true) {
  if (!workspaceShareFeedback) return;
  workspaceShareFeedback.textContent = message;
  workspaceShareFeedback.classList.remove('hidden');
  workspaceShareFeedback.classList.toggle('text-emerald-600', isSuccess);
  workspaceShareFeedback.classList.toggle('dark:text-emerald-300', isSuccess);
  workspaceShareFeedback.classList.toggle('text-red-500', !isSuccess);
  workspaceShareFeedback.classList.toggle('dark:text-red-400', !isSuccess);
}

function lockBodyScroll() {
  document.body.classList.add('overflow-hidden');
}

function unlockBodyScrollIfAllowed() {
  const authVisible = authOverlay && !authOverlay.classList.contains('hidden');
  const accessVisible = accessGuardOverlay && !accessGuardOverlay.classList.contains('hidden');
  const workspaceVisible = workspaceShareModal && !workspaceShareModal.classList.contains('hidden');
  const accessManagerVisible = accessManagerModal && !accessManagerModal.classList.contains('hidden');
  if (!authVisible && !accessVisible && !workspaceVisible && !accessManagerVisible) {
    document.body.classList.remove('overflow-hidden');
  }
}

function showAccessGuardOverlay(mode = 'pending', profile = {}) {
  if (!accessGuardOverlay) return;
  accessGuardMode = mode;
  let title = 'Acesso em análise';
  let message = 'Aguarde a liberação do administrador. Assim que sua conta for aprovada, o painel será carregado automaticamente.';
  let extra = '';
  let iconClass = 'fa-shield-halved';
  let refreshLabel = 'Verificar status';

  if (mode === 'blocked') {
    title = 'Acesso bloqueado';
    message = 'Esta conta foi bloqueada pelo administrador. Solicite a liberação antes de tentar novamente.';
    iconClass = 'fa-user-lock';
    refreshLabel = 'Tentar novamente';
    if (profile.blockedReason === 'not_allowlisted') {
      extra = 'O e-mail informado não está na lista de clientes autorizados. Entre em contato com o administrador para liberar o acesso.';
    } else if (profile.blockedReason) {
      extra = profile.blockedReason;
    }
  } else if (mode === 'pending') {
    iconClass = 'fa-hourglass-half';
    refreshLabel = 'Verificar status';
    if (profile.pendingAt) {
      extra = 'Assim que o administrador aprovar sua conta, recarregaremos os dados automaticamente. Você pode verificar novamente sempre que quiser.';
    }
  }

  if (accessGuardTitle) {
    accessGuardTitle.textContent = title;
  }
  if (accessGuardMessage) {
    accessGuardMessage.textContent = message;
  }
  if (accessGuardExtra) {
    if (extra) {
      accessGuardExtra.textContent = extra;
      accessGuardExtra.classList.remove('hidden');
    } else {
      accessGuardExtra.textContent = '';
      accessGuardExtra.classList.add('hidden');
    }
  }
  if (accessGuardIcon) {
    accessGuardIcon.className = `fa-solid ${iconClass} text-2xl`;
  }
  if (accessGuardRefresh) {
    accessGuardRefresh.textContent = refreshLabel;
    accessGuardRefresh.disabled = false;
    accessGuardRefresh.classList.remove('opacity-60', 'cursor-not-allowed');
  }

  accessGuardOverlay.classList.remove('hidden');
  lockBodyScroll();
}

function hideAccessGuardOverlay() {
  if (!accessGuardOverlay) return;
  accessGuardOverlay.classList.add('hidden');
  accessGuardMode = null;
  unlockBodyScrollIfAllowed();
}

const workspaceJoinSubmitDefault = workspaceJoinSubmit ? workspaceJoinSubmit.textContent : '';
const workspaceLeaveDefault = workspaceLeaveButton ? workspaceLeaveButton.textContent : '';

function setWorkspaceJoinLoading(isLoading) {
  if (workspaceJoinSubmit) {
    workspaceJoinSubmit.disabled = isLoading;
    workspaceJoinSubmit.textContent = isLoading
      ? 'Conectando...'
      : (workspaceJoinSubmitDefault || 'Usar esse espaço');
    workspaceJoinSubmit.classList.toggle('opacity-60', isLoading);
    workspaceJoinSubmit.classList.toggle('cursor-not-allowed', isLoading);
  }
  if (workspaceJoinCodeInput) {
    workspaceJoinCodeInput.disabled = isLoading;
  }
}

function setWorkspaceLeaveLoading(isLoading) {
  if (!workspaceLeaveButton) return;
  workspaceLeaveButton.disabled = isLoading;
  workspaceLeaveButton.textContent = isLoading
    ? 'Saindo...'
    : (workspaceLeaveDefault || 'Voltar para meu espaço individual');
  workspaceLeaveButton.classList.toggle('opacity-60', isLoading);
  workspaceLeaveButton.classList.toggle('cursor-not-allowed', isLoading);
}

function formatUid(uid = '') {
  if (!uid) return '';
  return uid.length <= 12 ? uid : `${uid.slice(0, 4)}…${uid.slice(-4)}`;
}

async function fetchWorkspaceProfile(uid) {
  if (!uid) return null;
  if (workspaceProfilesCache.has(uid)) {
    const cached = workspaceProfilesCache.get(uid) || {};
    return { uid, ...cached };
  }
  try {
    const snap = await db.collection('profiles').doc(uid).get();
    if (snap.exists) {
      const data = snap.data() || {};
      workspaceProfilesCache.set(uid, data);
      return { uid, ...data };
    }
  } catch (error) {
    console.error('Erro ao carregar perfil do workspace:', error);
  }
  return { uid };
}

async function loadWorkspaceMemberProfiles() {
  if (!activeWorkspace || !Array.isArray(activeWorkspace.memberUids)) {
    return [];
  }
  const uniqueUids = Array.from(new Set(activeWorkspace.memberUids));
  const profiles = await Promise.all(uniqueUids.map(fetchWorkspaceProfile));
  return profiles.filter(Boolean);
}

function createWorkspaceBadge(label, classes) {
  const span = document.createElement('span');
  span.className = `text-[0.65rem] uppercase tracking-wide font-semibold px-2 py-1 rounded-full ${classes}`;
  span.textContent = label;
  return span;
}

async function renderWorkspaceSharingDetails() {
  if (!workspaceShareModal || !currentUser) {
    return;
  }

  const workspaceId = activeWorkspace?.workspaceId || currentUser.uid;
  if (workspaceShareCode) {
    workspaceShareCode.textContent = workspaceId || '—';
  }

  const isOwnerOfPersonalWorkspace = Boolean(activeWorkspace?.isOwner && activeWorkspace.workspaceId === currentUser.uid);

  if (workspaceJoinCodeInput) {
    workspaceJoinCodeInput.value = '';
    workspaceJoinCodeInput.placeholder = isOwnerOfPersonalWorkspace
      ? 'Esse campo aparecerá para quem entrar com outra conta'
      : 'Cole o código ou e-mail da conta administradora';
  }

  if (workspaceOwnerHint) {
    if (activeWorkspace?.isOwner) {
      workspaceOwnerHint.textContent = 'Você administra este espaço familiar. Compartilhe o código acima com outras contas de confiança para que enxerguem os mesmos dados.';
    } else {
      const ownerProfile = await fetchWorkspaceProfile(activeWorkspace?.ownerUid);
      const ownerLabel = ownerProfile?.email || ownerProfile?.displayName || formatUid(activeWorkspace?.ownerUid || '');
      workspaceOwnerHint.innerHTML = `Este espaço pertence a <strong>${ownerLabel || 'seu parceiro(a)'}</strong>. Todas as contas listadas abaixo enxergam e editam os mesmos lançamentos.`;
    }
  }

  if (workspaceJoinForm) {
    workspaceJoinForm.classList.toggle('opacity-60', isOwnerOfPersonalWorkspace);
  }

  if (workspaceJoinHelper) {
    workspaceJoinHelper.classList.toggle('hidden', !isOwnerOfPersonalWorkspace);
  }

  if (workspaceJoinSubmit) {
    workspaceJoinSubmit.classList.toggle('opacity-60', isOwnerOfPersonalWorkspace);
  }

  if (!isOwnerOfPersonalWorkspace && workspaceJoinCodeInput) {
    setTimeout(() => workspaceJoinCodeInput.focus(), 60);
  }

  if (workspaceLeaveButton) {
    const shouldHideLeave = !activeWorkspace || activeWorkspace.isOwner || activeWorkspace.workspaceId === currentUser.uid;
    workspaceLeaveButton.classList.toggle('hidden', Boolean(shouldHideLeave));
  }

  if (workspaceMembersList) {
    workspaceMembersList.innerHTML = '<li class="text-sm text-gray-500 dark:text-gray-400">Carregando integrantes...</li>';
    const profiles = await loadWorkspaceMemberProfiles();
    workspaceMembersList.innerHTML = '';

    if (!profiles.length) {
      const li = document.createElement('li');
      li.className = 'text-sm text-gray-500 dark:text-gray-400';
      li.textContent = 'Somente você tem acesso a este espaço no momento.';
      workspaceMembersList.appendChild(li);
    } else {
      profiles.forEach(profile => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between gap-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-800/50 px-3 py-2';

        const info = document.createElement('div');
        info.className = 'min-w-0';
        const name = document.createElement('div');
        name.className = 'font-semibold text-gray-700 dark:text-gray-200 truncate';
        name.textContent = profile.displayName || profile.email || formatUid(profile.uid);
        const email = document.createElement('div');
        email.className = 'text-xs text-gray-500 dark:text-gray-400 truncate';
        email.textContent = profile.email || formatUid(profile.uid);
        info.appendChild(name);
        info.appendChild(email);

        const badgesWrap = document.createElement('div');
        badgesWrap.className = 'flex items-center gap-2 shrink-0';
        if (profile.uid === activeWorkspace?.ownerUid) {
          badgesWrap.appendChild(createWorkspaceBadge('Admin', 'bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-200'));
        }
        if (profile.uid === currentUser.uid) {
          badgesWrap.appendChild(createWorkspaceBadge('Você', 'bg-blue-100 text-blue-700 dark:bg-blue-500/20 dark:text-blue-200'));
        }

        li.appendChild(info);
        if (badgesWrap.childNodes.length > 0) {
          li.appendChild(badgesWrap);
        }
        workspaceMembersList.appendChild(li);
      });
    }
  }
}

async function openWorkspaceShareModal() {
  if (!workspaceShareModal) return;
  if (!currentUser) {
    showAuthOverlay();
    return;
  }
  resetWorkspaceFeedback();
  await renderWorkspaceSharingDetails();
  workspaceShareModal.classList.remove('hidden');
  lockBodyScroll();
  document.body.classList.add('workspace-share-open');
}

function closeWorkspaceShareModal() {
  if (!workspaceShareModal) return;
  workspaceShareModal.classList.add('hidden');
  document.body.classList.remove('workspace-share-open');
  unlockBodyScrollIfAllowed();
  resetWorkspaceFeedback();
}

async function resolveWorkspaceIdentifier(identifier) {
  const raw = (identifier || '').trim();
  if (!raw) {
    throw new Error('Informe um código ou e-mail válido.');
  }

  if (raw.includes('@')) {
    const normalized = normalizeEmail(raw);
    if (!normalized) {
      throw new Error('Informe um e-mail válido.');
    }
    const querySnap = await db.collection('profiles').where('normalizedEmail', '==', normalized).limit(1).get();
    if (querySnap.empty) {
      throw new Error('Não encontramos nenhuma conta com esse e-mail.');
    }
    const ownerUid = querySnap.docs[0].id;
    const ownerWorkspaceSnap = await db.collection('users').doc(ownerUid).collection('metadata').doc('workspace').get();
    const ownerWorkspaceData = ownerWorkspaceSnap.exists ? (ownerWorkspaceSnap.data() || {}) : {};
    return ownerWorkspaceData.sharedWorkspaceId || ownerWorkspaceData.linkedOwnerUid || ownerUid;
  }

  return raw;
}

async function joinWorkspaceById(workspaceId) {
  if (!currentUser) {
    throw new Error('Faça login para conectar-se a um espaço compartilhado.');
  }

  const trimmed = (workspaceId || '').trim();
  if (!trimmed) {
    throw new Error('Informe um código válido.');
  }

  if (activeWorkspace?.workspaceId && trimmed === activeWorkspace.workspaceId) {
    throw new Error('Você já está usando esse espaço.');
  }

  const sharedRef = db.collection('sharedWorkspaces').doc(trimmed);
  const sharedSnap = await sharedRef.get();
  if (!sharedSnap.exists) {
    throw new Error('Nenhum espaço compartilhado encontrado com esse código.');
  }

  const sharedData = sharedSnap.data() || {};
  const ownerUid = sharedData.ownerUid || trimmed;
  if (ownerUid === currentUser.uid) {
    throw new Error('Este código corresponde ao seu próprio espaço.');
  }

  await sharedRef.set({
    ownerUid,
    workspaceId: trimmed,
    memberUids: FieldValue.arrayUnion(currentUser.uid),
    updatedAt: firebase.firestore.Timestamp.now(),
  }, { merge: true });

  await db.collection('users').doc(currentUser.uid).collection('metadata').doc('workspace').set({
    sharedWorkspaceId: trimmed,
    sharedOwnerUid: ownerUid,
    initialized: true,
    linkedAt: firebase.firestore.Timestamp.now(),
  }, { merge: true });

  await ensureUserWorkspace(currentUser);
  carregarEnvelopes();
  startObservers();
  await renderWorkspaceSharingDetails();
  updateWorkspaceContextUI();
  showToast('Ambiente compartilhado conectado!');
}

async function joinWorkspaceByIdentifier(identifier) {
  const workspaceId = await resolveWorkspaceIdentifier(identifier);
  await joinWorkspaceById(workspaceId);
  return workspaceId;
}

async function leaveSharedWorkspace() {
  if (!currentUser) {
    throw new Error('Faça login para sair de um espaço compartilhado.');
  }
  if (!activeWorkspace || !activeWorkspace.workspaceId) {
    throw new Error('Nenhum espaço compartilhado ativo para sair.');
  }
  if (activeWorkspace.ownerUid === currentUser.uid) {
    throw new Error('O administrador não pode sair do próprio espaço.');
  }

  const previousWorkspaceId = activeWorkspace.workspaceId;

  await db.collection('users').doc(currentUser.uid).collection('metadata').doc('workspace').set({
    sharedWorkspaceId: currentUser.uid,
    sharedOwnerUid: currentUser.uid,
    updatedAt: firebase.firestore.Timestamp.now(),
  }, { merge: true });

  await db.collection('sharedWorkspaces').doc(previousWorkspaceId).set({
    memberUids: FieldValue.arrayRemove(currentUser.uid),
    updatedAt: firebase.firestore.Timestamp.now(),
  }, { merge: true });

  await ensureUserWorkspace(currentUser);
  carregarEnvelopes();
  startObservers();
  await renderWorkspaceSharingDetails();
  updateWorkspaceContextUI();
  showToast('Você voltou para o seu espaço individual.');
}
function exitVerificationMode(nextMode = 'signIn') {
  pendingVerificationUser = null;
  authMode = nextMode;
  resetVerificationFeedback();
  updateAuthModeUI();
}

function requiresEmailVerification(user) {
  if (!user) return false;
  const providerIds = (user.providerData || []).map((provider) => provider?.providerId).filter(Boolean);
  const usesPassword = providerIds.includes('password');
  const hasTrustedProvider = providerIds.some((providerId) => providerId && providerId !== 'password');
  if (hasTrustedProvider) {
    return false;
  }
  return usesPassword && !user.emailVerified;
}

async function handlePendingEmailVerification(user) {
  pendingVerificationUser = user;
  authMode = 'verify';
  resetVerificationFeedback();
  if (authVerifyEmail) {
    authVerifyEmail.textContent = user.email || '';
  }
  updateAuthModeUI();
  showAuthOverlay();

  const metadata = user.metadata || {};
  const creationTime = metadata.creationTime || null;
  const lastSignInTime = metadata.lastSignInTime || null;
  const firstSession = creationTime && creationTime === lastSignInTime;

  if (firstSession) {
    try {
      await user.sendEmailVerification();
      showVerificationFeedback('E-mail de verificação enviado. Confira sua caixa de entrada.', true);
    } catch (error) {
      console.error('Erro ao enviar verificação automática:', error);
      showVerificationFeedback('Não foi possível enviar o e-mail automaticamente. Use o botão de reenviar abaixo.', false);
    }
  }
}

function showAuthOverlay() {
  updateAuthModeUI();
  authError.classList.add('hidden');
  authError.textContent = '';
  updateAuthVerse();
  authOverlay.classList.remove('hidden');
  lockBodyScroll();
}

function hideAuthOverlay() {
  authOverlay.classList.add('hidden');
  unlockBodyScrollIfAllowed();
  authError.classList.add('hidden');
  authError.textContent = '';
}

function setAuthLoading(isLoading) {
  if (authMode === 'verify') {
    return;
  }
  authSubmit.disabled = isLoading;
  authToggleMode.disabled = isLoading;
  authEmailInput.disabled = isLoading;
  authPasswordInput.disabled = isLoading;
  if (authGoogleButton && !googleLoading) {
    authGoogleButton.disabled = isLoading;
    authGoogleButton.classList.toggle('opacity-60', isLoading);
    authGoogleButton.classList.toggle('cursor-not-allowed', isLoading);
  }
  authSubmit.textContent = isLoading
    ? (authMode === 'signIn' ? 'Entrando...' : 'Criando conta...')
    : (authMode === 'signIn' ? 'Entrar' : 'Cadastrar e acessar');
}

function setGoogleLoading(isLoading) {
  if (!authGoogleButton) return;
  googleLoading = isLoading;
  authGoogleButton.disabled = isLoading;
  authGoogleButton.classList.toggle('opacity-60', isLoading);
  authGoogleButton.classList.toggle('cursor-not-allowed', isLoading);
  if (authGoogleLabel) {
    authGoogleLabel.textContent = isLoading ? 'Conectando...' : 'Entrar com Google';
  }
}

function mapAuthErrorMessage(error) {
  if (!error || !error.code) return 'Não foi possível concluir a operação. Tente novamente.';
  switch (error.code) {
    case 'auth/email-already-in-use':
      return 'Este e-mail já está cadastrado.';
    case 'auth/invalid-email':
      return 'Informe um e-mail válido.';
    case 'auth/weak-password':
      return 'A senha precisa ter ao menos 6 caracteres.';
    case 'auth/user-not-found':
    case 'auth/wrong-password':
      return 'E-mail ou senha inválidos.';
    case 'auth/too-many-requests':
      return 'Muitas tentativas. Aguarde alguns instantes e tente novamente.';
    case 'auth/popup-closed-by-user':
    case 'auth/cancelled-popup-request':
      return 'Login com Google cancelado. Tente novamente.';
    case 'auth/popup-blocked':
      return 'Seu navegador bloqueou a janela do Google. Permita pop-ups e tente novamente.';
    case 'auth/operation-not-supported-in-this-environment':
      return 'Este navegador não suporta o login com Google nesta janela. Tente novamente em outra guia ou dispositivo.';
    case 'auth/unauthorized-domain': {
      const host = authEnvironment.host || window.location.hostname || 'este domínio';
      return `Autorize "${host || 'este domínio'}" em Authentication → Settings → Authorized domains no Console do Firebase.`;
    }
    case 'auth/account-exists-with-different-credential':
      return 'Já existe uma conta com este e-mail usando outro método de acesso. Entre com ele e vincule o Google nas configurações.';
    default:
      return 'Erro inesperado. Verifique seus dados e tente novamente.';
  }
}

function computeUserInitials(email) {
  if (!email) return 'U';
  const [localPart] = email.split('@');
  const base = localPart || email;
  const cleaned = base.replace(/[^a-zA-Z0-9]+/g, ' ').trim();
  if (!cleaned) return 'U';
  const parts = cleaned.split(/\s+/).filter(Boolean);
  if (parts.length >= 2) {
    return (parts[0][0] + parts[1][0]).toUpperCase();
  }
  return cleaned.slice(0, 2).toUpperCase();
}

function updateUserBadge(email) {
  const displayEmail = email || 'Conta';
  const [localPart] = displayEmail.split('@');
  const compactLabel = localPart || displayEmail;
  if (userBadgeLabel) {
    userBadgeLabel.textContent = compactLabel;
    userBadgeLabel.title = displayEmail;
  }
  if (userAvatarBadge) {
    userAvatarBadge.textContent = computeUserInitials(email);
  }
}

function setUserMenuState(open) {
  if (!userMenuDropdown || !userMenuTrigger) return;
  isUserMenuOpen = !!open;
  userMenuTrigger.setAttribute('aria-expanded', isUserMenuOpen ? 'true' : 'false');
  userMenuDropdown.classList.toggle('hidden', !isUserMenuOpen);
  if (userMenuCaret) {
    userMenuCaret.classList.toggle('rotate-180', isUserMenuOpen);
  }
}

function toggleUserMenu(force) {
  const shouldOpen = typeof force === 'boolean' ? force : !isUserMenuOpen;
  setUserMenuState(shouldOpen);
}

function closeUserMenu() {
  setUserMenuState(false);
}

function pickRandomBibleVerse(excludeReference = null) {
  if (!Array.isArray(bibleVerses) || bibleVerses.length === 0) {
    return null;
  }
  const pool = excludeReference
    ? bibleVerses.filter(verse => verse.reference !== excludeReference)
    : bibleVerses;
  const versesPool = pool.length ? pool : bibleVerses;
  const randomIndex = Math.floor(Math.random() * versesPool.length);
  return versesPool[randomIndex] || null;
}

function updateFooterVerse() {
  if (!footerVerse) return;
  const verse = pickRandomBibleVerse(lastVerseReferences.auth);
  if (!verse) {
    footerVerse.textContent = '';
    return;
  }
  footerVerse.innerHTML = `
    <span class="block">“${verse.text}”</span>
    <span class="block not-italic text-[0.65rem] sm:text-xs text-gray-500 dark:text-gray-400 mt-1">— ${verse.reference}</span>
  `;
  lastVerseReferences.footer = verse.reference;
}

function updateAuthVerse() {
  if (!authVerse) return;
  const verse = pickRandomBibleVerse(lastVerseReferences.footer);
  if (!verse) {
    authVerse.classList.add('hidden');
    authVerse.textContent = '';
    return;
  }
  authVerse.innerHTML = `
    <span class="block">“${verse.text}”</span>
    <span class="block not-italic text-[0.65rem] text-emerald-700 dark:text-emerald-300 mt-2">— ${verse.reference}</span>
  `;
  authVerse.classList.remove('hidden');
  lastVerseReferences.auth = verse.reference;
}

function mapVerificationErrorMessage(error) {
  if (!error || !error.code) {
    return 'Não foi possível enviar o e-mail. Tente novamente em instantes.';
  }
  switch (error.code) {
    case 'auth/too-many-requests':
      return 'Muitas solicitações seguidas. Aguarde alguns minutos e tente reenviar.';
    case 'auth/quota-exceeded':
      return 'Limite temporário de envios atingido. Tente novamente daqui a pouco.';
    default:
      return mapAuthErrorMessage(error);
  }
}

function updateHeaderOffset() {
  window.requestAnimationFrame(() => {
    const header = document.getElementById('app-header') || document.querySelector('header.sticky');
    const measuredHeight = header ? Math.ceil(header.getBoundingClientRect().height) : 0;
    const fallback = window.innerWidth < 768 ? 52 : 48; // fallback enxuto quando o cabeçalho não estiver disponível
    const finalHeight = measuredHeight > 0 ? measuredHeight : fallback;
    document.documentElement.style.setProperty('--app-header-height', `${finalHeight}px`);
  });
}

function updateWorkspaceContextUI() {
  const hasUser = Boolean(currentUser);
  if (workspaceShareButton) {
    workspaceShareButton.disabled = !hasUser;
    workspaceShareButton.classList.toggle('opacity-60', !hasUser);
    workspaceShareButton.classList.toggle('cursor-not-allowed', !hasUser);
  }

  if (!workspaceContextBadge) {
    return;
  }

  const shared = Boolean(
    hasUser && activeWorkspace?.workspaceId && (
      (Array.isArray(activeWorkspace.memberUids) && activeWorkspace.memberUids.length > 1) ||
      (activeWorkspace.ownerUid && activeWorkspace.ownerUid !== currentUser?.uid)
    )
  );

  workspaceContextBadge.classList.toggle('hidden', !shared);
  if (shared) {
    workspaceContextBadge.textContent = activeWorkspace?.isOwner ? 'Família (admin)' : 'Família';
  } else {
    workspaceContextBadge.textContent = '';
  }
}

function updateUserPlanReminder(profile) {
  if (!userPlanReminder || !userPlanReminderLabel || !userPlanReminderDesc || !userPlanReminderIcon || !userPlanReminderDot) {
    return;
  }

  const targets = {
    container: userPlanReminder,
    icon: userPlanReminderIcon,
    label: userPlanReminderLabel,
    desc: userPlanReminderDesc,
    dot: userPlanReminderDot,
  };

  Object.entries(targets).forEach(([key, element]) => {
    if (!element) return;
    const classes = PLAN_REMINDER_ALL_CLASSES[key] || [];
    if (classes.length) {
      element.classList.remove(...classes);
    }
  });

  if (userPlanReminderIcon) {
    userPlanReminderIcon.classList.remove(PLAN_REMINDER_ICON_VARIANTS.warning, PLAN_REMINDER_ICON_VARIANTS.expired, PLAN_REMINDER_ICON_DEFAULT);
    userPlanReminderIcon.classList.add(PLAN_REMINDER_ICON_DEFAULT);
  }

  userPlanReminder.classList.add('hidden');
  userPlanReminderDot.classList.add('hidden');
  userPlanReminderLabel.textContent = '';
  userPlanReminderDesc.textContent = '';

  if (!profile) {
    return;
  }

  const planEndsAt = parseFirestoreDate(profile.planEndsAt);
  if (!planEndsAt) {
    return;
  }

  const now = new Date();
  const diffMs = planEndsAt.getTime() - now.getTime();
  const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
  const planStatus = profile.planStatus || (diffMs >= 0 ? 'active' : 'expired');

  let variant = null;
  let labelText = '';
  let descText = '';

  if (diffMs < 0 || planStatus === 'expired') {
    variant = 'expired';
    labelText = `Seu acesso expirou em ${formatDate(planEndsAt)}.`;
    descText = 'Entre em contato com o responsável para renovar e recuperar o acesso.';
  } else if (diffDays <= 7) {
    variant = 'warning';
    if (diffDays <= 0) {
      labelText = 'Seu acesso expira hoje.';
    } else {
      const daysLabel = diffDays === 1 ? 'dia' : 'dias';
      labelText = `Seu acesso expira em ${diffDays} ${daysLabel}.`;
    }
    descText = 'Combine a renovação com o responsável para evitar interrupções.';
  }

  if (!variant) {
    return;
  }

  userPlanReminderLabel.textContent = labelText;
  userPlanReminderDesc.textContent = descText;

  const variantClasses = PLAN_REMINDER_CLASS_SETS[variant];
  Object.entries(targets).forEach(([key, element]) => {
    if (!element) return;
    const classesToAdd = variantClasses[key] || [];
    if (classesToAdd.length) {
      element.classList.add(...classesToAdd);
    }
  });

  if (userPlanReminderIcon) {
    userPlanReminderIcon.classList.remove(PLAN_REMINDER_ICON_DEFAULT);
    userPlanReminderIcon.classList.add(PLAN_REMINDER_ICON_VARIANTS[variant]);
  }

  userPlanReminder.classList.remove('hidden');
  userPlanReminderDot.classList.remove('hidden');
}

function updateUserSessionUI(user) {
  if (!userSession) return;
  closeUserMenu();
  if (user) {
    const email = user.email || 'Conta';
    if (userEmailBadge) {
      userEmailBadge.textContent = email;
      userEmailBadge.title = email;
    }
    updateUserBadge(email);
    userSession.classList.remove('hidden');
  } else {
    closeUserMenu();
    userSession.classList.add('hidden');
    if (userEmailBadge) {
      userEmailBadge.textContent = '';
      userEmailBadge.removeAttribute('title');
    }
    updateUserBadge('');
  }
  updateUserPlanReminder(user ? currentUserProfile : null);
  updateWorkspaceContextUI();
  updateHeaderOffset();
}

function isCurrentUserAdmin() {
  if (!currentUser) return false;
  if (userMatchesAdminConfig(currentUser, currentUserProfile)) {
    return true;
  }
  return Boolean(currentUserProfile?.role === 'admin');
}

function updateAdminControlsVisibility() {
  if (!accessManagerButton) return;
  const visible = isCurrentUserAdmin();
  accessManagerButton.classList.toggle('hidden', !visible);
}

async function startAppForCurrentUser(forceReload = false) {
  if (!currentUser) return;
  if (appStartInProgress) return;
  if (appReadyForCurrentUser && !forceReload) {
    return;
  }
  appStartInProgress = true;
  try {
    await ensureUserWorkspace(currentUser);
    if (!appBootstrapped) {
      boot();
      appBootstrapped = true;
    } else if (forceReload || !appReadyForCurrentUser) {
      carregarEnvelopes();
      startObservers();
    }
    if (workspaceShareModal && !workspaceShareModal.classList.contains('hidden')) {
      await renderWorkspaceSharingDetails();
    }
    appReadyForCurrentUser = true;
  } catch (error) {
    console.error('Erro ao preparar dados do usuário:', error);
  } finally {
    appStartInProgress = false;
  }
}

function applyAccessPolicy(profile, options = {}) {
  const { allowAppStart = true, forceReload = false } = options;
  const requireApproval = ACCESS_CONTROL_CFG.requireApproval !== false;
  const status = profile?.status || (requireApproval ? 'pending' : 'approved');
  currentUserProfile = profile || currentUserProfile;
  updateAdminControlsVisibility();
  if (!profile) {
    showAccessGuardOverlay('pending');
    appReadyForCurrentUser = false;
    return false;
  }

  if (status === 'blocked') {
    showAccessGuardOverlay('blocked', profile);
    appReadyForCurrentUser = false;
    return false;
  }

  if (requireApproval && status !== 'approved') {
    showAccessGuardOverlay('pending', profile);
    appReadyForCurrentUser = false;
    return false;
  }

  hideAccessGuardOverlay();
  if (allowAppStart) {
    startAppForCurrentUser(forceReload);
  }
  return true;
}

function subscribeToAccessProfile(uid) {
  if (accessProfileUnsubscribe) {
    accessProfileUnsubscribe();
    accessProfileUnsubscribe = null;
  }
  if (!uid) return;
  accessProfileUnsubscribe = db.collection('profiles').doc(uid).onSnapshot(
    (snapshot) => {
      if (!snapshot.exists) return;
      const data = snapshot.data() || {};
      const profile = { uid, ...data };
      workspaceProfilesCache.set(uid, data);
      currentUserProfile = profile;
      updateUserSessionUI(currentUser);
      updateAdminControlsVisibility();
      applyAccessPolicy(profile, { allowAppStart: true });
    },
    (error) => {
      console.error('Erro ao acompanhar status de acesso:', error);
    }
  );
}

async function refreshAccessProfile() {
  if (!currentUser) return null;
  try {
    const snapshot = await db.collection('profiles').doc(currentUser.uid).get();
    if (!snapshot.exists) {
      return null;
    }
    const data = snapshot.data() || {};
    const profile = { uid: currentUser.uid, ...data };
    workspaceProfilesCache.set(currentUser.uid, data);
    currentUserProfile = profile;
    updateAdminControlsVisibility();
    updateUserPlanReminder(profile);
    return profile;
  } catch (error) {
    console.error('Erro ao atualizar o perfil de acesso:', error);
    return null;
  }
}

function closeAccessManagerModal() {
  if (!accessManagerModal) return;
  accessManagerModal.classList.add('hidden');
  unlockBodyScrollIfAllowed();
}

function createAccessManagerListItem(entry, type) {
  const li = document.createElement('li');
  li.className = 'rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800/70 px-4 py-4 shadow-sm';
  const email = entry.email || '—';

  const statusMeta = {
    pending: {
      label: 'Aguardando aprovação',
      classes: 'text-amber-600 dark:text-amber-300',
    },
    blocked: {
      label: 'Bloqueada',
      classes: 'text-red-500 dark:text-red-300',
    },
    approved: {
      label: 'Acesso liberado',
      classes: 'text-emerald-600 dark:text-emerald-300',
    },
  }[type] || {
    label: entry.status || 'Status indefinido',
    classes: 'text-gray-500 dark:text-gray-400',
  };

  const lastLogin = formatDateTime(entry.lastLoginAt);
  const createdAt = formatDateTime(entry.createdAt);
  const approvedAt = formatDateTime(entry.approvedAt);
  const blockedAt = formatDateTime(entry.blockedAt);
  const pendingAt = formatDateTime(entry.pendingAt);
  const blockedReason = entry.blockedReason && type === 'blocked' ? entry.blockedReason : '';
  const roleBadge = (() => {
    if (entry.role === 'admin') {
      return '<span class="inline-flex items-center gap-1 rounded-full bg-emerald-100/80 dark:bg-emerald-500/10 text-emerald-700 dark:text-emerald-200 px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-wide">Admin</span>';
    }
    if (entry.role && entry.role !== 'user') {
      return `<span class="inline-flex items-center gap-1 rounded-full bg-gray-100 dark:bg-gray-700/60 text-gray-600 dark:text-gray-300 px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-wide">${entry.role}</span>`;
    }
    return '';
  })();

  const timelineRows = [
    `Cadastro: <strong class="text-gray-700 dark:text-gray-200">${createdAt}</strong>`,
    `Último acesso: <strong class="text-gray-700 dark:text-gray-200">${lastLogin}</strong>`,
  ];

  if (type === 'pending' && pendingAt) {
    timelineRows.push(`Solicitado: <strong class="text-gray-700 dark:text-gray-200">${pendingAt}</strong>`);
  }
  if (type === 'approved' && approvedAt) {
    timelineRows.push(`Liberado: <strong class="text-gray-700 dark:text-gray-200">${approvedAt}</strong>`);
  }
  if (type === 'blocked' && blockedAt) {
    timelineRows.push(`Bloqueado: <strong class="text-gray-700 dark:text-gray-200">${blockedAt}</strong>`);
  }

  const planInfo = resolveAccessPlanInfo(entry);
  const planSummaryHtml = `
      <div class="rounded-xl border border-emerald-100 dark:border-emerald-900/30 bg-emerald-50/40 dark:bg-emerald-500/5 px-3 py-3 text-xs space-y-2">
        <div class="flex items-center justify-between gap-2">
          <span class="font-semibold text-gray-700 dark:text-gray-200 uppercase tracking-wide">Plano de acesso</span>
          <span class="font-semibold ${planInfo.statusClass}">${planInfo.statusLabel}</span>
        </div>
        <ul class="list-disc list-inside space-y-1 text-[0.7rem] text-gray-600 dark:text-gray-300">
          ${planInfo.details.map((detail) => `<li>${detail}</li>`).join('')}
        </ul>
      </div>`;

  let planControlsHtml = '';
  if (type === 'approved') {
    const defaultSelection = getDefaultPlanSelection(entry);
    const optionsHtml = ACCESS_PLAN_OPTIONS.map((option) => `<option value="${option.value}" ${defaultSelection === option.value ? 'selected' : ''}>${option.label}</option>`).join('');
    const customSelected = defaultSelection === 'custom';
    const planEndsDate = parseFirestoreDate(entry.planEndsAt);
    const customValue = customSelected && planEndsDate ? formatDateInputValue(planEndsDate) : '';
    const minDate = formatDateInputValue(new Date());

    planControlsHtml = `
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50/60 dark:bg-gray-900/40 px-3 py-3 text-xs space-y-3">
        <div class="flex flex-col gap-1 sm:flex-row sm:items-start sm:justify-between">
          <span class="font-semibold text-gray-700 dark:text-gray-200 uppercase tracking-wide">Renovar ou definir validade</span>
          <span class="text-[0.68rem] text-gray-500 dark:text-gray-400">Escolha um período para manter o acesso liberado.</span>
        </div>
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
          <div class="flex-1 flex flex-col gap-2 sm:flex-row sm:items-center">
            <select data-plan-select class="w-full sm:w-auto flex-1 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-2.5 py-2 text-sm text-gray-700 dark:text-gray-100">
              ${optionsHtml}
              <option value="custom" ${customSelected ? 'selected' : ''}>Personalizado</option>
            </select>
            <input type="date" data-plan-custom class="flex-1 rounded-lg border border-emerald-200 dark:border-emerald-700 bg-white dark:bg-gray-800 px-2.5 py-2 text-sm text-gray-700 dark:text-gray-100 ${customSelected ? '' : 'hidden'}" value="${customValue}" min="${minDate}" />
          </div>
          <div class="flex gap-2 sm:justify-end">
            <button data-action="apply-plan" class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white transition-colors">Aplicar</button>
            ${planInfo.planEndsAt ? '<button data-action="clear-plan" class="px-3 py-1.5 text-xs font-semibold rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">Remover</button>' : ''}
          </div>
        </div>
        <p class="text-[0.68rem] text-gray-500 dark:text-gray-400">Ao aplicar, o vencimento é calculado a partir de hoje. Planos personalizados usam a data escolhida.</p>
      </div>`;
  }

  li.innerHTML = `
    <div class="flex flex-col gap-2">
      <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2">
        <div class="space-y-1">
          <p class="text-sm font-semibold text-gray-800 dark:text-gray-100">${email}</p>
          <p class="text-xs text-gray-500 dark:text-gray-400 break-all">${entry.uid}</p>
          ${roleBadge ? `<div>${roleBadge}</div>` : ''}
        </div>
        <span class="text-xs uppercase tracking-wide font-semibold ${statusMeta.classes}">${statusMeta.label}</span>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-1 text-[0.7rem] text-gray-500 dark:text-gray-400">
        ${timelineRows.map((row) => `<span>${row}</span>`).join('')}
      </div>
      ${blockedReason ? `<p class="text-xs text-red-500 dark:text-red-300 leading-relaxed">Motivo: ${blockedReason}</p>` : ''}
      ${planSummaryHtml}
      ${planControlsHtml}
      <div class="flex flex-wrap gap-2 pt-1">
        ${type === 'pending' ? '<button data-action="approve" class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white transition-colors">Aprovar</button>' : ''}
        ${type === 'pending' ? '<button data-action="block" class="px-3 py-1.5 text-xs font-semibold rounded-lg border border-red-200 dark:border-red-500/40 text-red-600 dark:text-red-300 hover:bg-red-50 dark:hover:bg-red-500/10 transition-colors">Bloquear</button>' : ''}
        ${type === 'blocked' ? '<button data-action="approve" class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white transition-colors">Liberar acesso</button>' : ''}
        ${type === 'approved' ? '<button data-action="block" class="px-3 py-1.5 text-xs font-semibold rounded-lg border border-red-200 dark:border-red-500/40 text-red-600 dark:text-red-300 hover:bg-red-50 dark:hover:bg-red-500/10 transition-colors">Suspender acesso</button>' : ''}
      </div>
    </div>
  `;

  const approveButton = li.querySelector('[data-action="approve"]');
  const blockButton = li.querySelector('[data-action="block"]');
  const planApplyButton = li.querySelector('[data-action="apply-plan"]');
  const planClearButton = li.querySelector('[data-action="clear-plan"]');
  const planSelect = li.querySelector('[data-plan-select]');
  const planCustomInput = li.querySelector('[data-plan-custom]');
  const isSelf = entry.uid === currentUser?.uid;

  const setButtonLoading = (button, isLoading) => {
    if (!button) return;
    button.disabled = isLoading;
    button.classList.toggle('opacity-60', isLoading);
    button.classList.toggle('cursor-not-allowed', isLoading);
    if (isLoading) {
      button.dataset.originalText = button.textContent;
      button.textContent = 'Processando...';
    } else if (button.dataset.originalText) {
      button.textContent = button.dataset.originalText;
      delete button.dataset.originalText;
    }
  };

  if (approveButton) {
    if (isSelf && type === 'blocked') {
      approveButton.disabled = true;
      approveButton.classList.add('opacity-60', 'cursor-not-allowed');
    } else {
      approveButton.addEventListener('click', async () => {
        setButtonLoading(approveButton, true);
        try {
          await updateUserAccessStatus(entry.uid, 'approved');
          await loadAccessManagerLists();
          showToast('Conta liberada com sucesso!');
        } catch (error) {
          console.error('Erro ao aprovar usuário:', error);
          showToast('Não foi possível atualizar o acesso agora.', 'error');
        } finally {
          setButtonLoading(approveButton, false);
        }
      });
    }
  }

  if (blockButton) {
    if (isSelf) {
      blockButton.disabled = true;
      blockButton.classList.add('opacity-60', 'cursor-not-allowed');
    } else {
      blockButton.addEventListener('click', async () => {
        setButtonLoading(blockButton, true);
        try {
          await updateUserAccessStatus(entry.uid, 'blocked');
          await loadAccessManagerLists();
          showToast('Conta bloqueada.', 'info');
        } catch (error) {
          console.error('Erro ao bloquear usuário:', error);
          showToast('Não foi possível bloquear agora.', 'error');
        } finally {
          setButtonLoading(blockButton, false);
        }
      });
    }
  }

  if (planSelect) {
    const syncCustomVisibility = () => {
      if (!planCustomInput) return;
      const isCustom = planSelect.value === 'custom';
      planCustomInput.classList.toggle('hidden', !isCustom);
      if (isCustom && !planCustomInput.value) {
        const existing = parseFirestoreDate(entry.planEndsAt);
        const fallbackDate = existing || addMonthsPreserveDay(new Date(), 1) || new Date();
        planCustomInput.value = formatDateInputValue(fallbackDate);
      }
    };
    planSelect.addEventListener('change', syncCustomVisibility);
    syncCustomVisibility();
  }

  if (planApplyButton) {
    planApplyButton.addEventListener('click', async () => {
      const selection = planSelect ? planSelect.value : null;
      let planConfig = null;
      const startedAt = new Date();

      if (selection && selection !== 'custom') {
        const option = getAccessPlanOption(selection);
        if (!option) {
          showToast('Selecione um plano válido.', 'error');
          return;
        }
        const projectedEnd = addMonthsPreserveDay(startedAt, option.months);
        const endsAt = toEndOfDay(projectedEnd || startedAt);
        planConfig = {
          type: option.value,
          label: option.label,
          months: option.months,
          startedAt,
          endsAt,
        };
      } else {
        const customDate = planCustomInput ? parseDateInput(planCustomInput.value) : null;
        if (!customDate) {
          showToast('Informe uma data final válida para o plano personalizado.', 'error');
          return;
        }
        planConfig = {
          type: 'custom',
          label: 'Plano personalizado',
          months: null,
          startedAt,
          endsAt: toEndOfDay(customDate) || customDate,
        };
      }

      setButtonLoading(planApplyButton, true);
      if (planClearButton) {
        planClearButton.disabled = true;
        planClearButton.classList.add('opacity-60', 'cursor-not-allowed');
      }

      try {
        await updateUserAccessPlan(entry.uid, planConfig);
        await loadAccessManagerLists();
        showToast('Plano atualizado com sucesso!', 'success');
      } catch (error) {
        console.error('Erro ao atualizar plano:', error);
        showToast('Não foi possível atualizar o plano agora.', 'error');
      } finally {
        setButtonLoading(planApplyButton, false);
        if (planClearButton) {
          planClearButton.disabled = false;
          planClearButton.classList.remove('opacity-60', 'cursor-not-allowed');
        }
      }
    });
  }

  if (planClearButton) {
    planClearButton.addEventListener('click', async () => {
      setButtonLoading(planClearButton, true);
      if (planApplyButton) {
        planApplyButton.disabled = true;
        planApplyButton.classList.add('opacity-60', 'cursor-not-allowed');
      }
      try {
        await clearUserAccessPlan(entry.uid);
        await loadAccessManagerLists();
        showToast('Plano removido.', 'info');
      } catch (error) {
        console.error('Erro ao remover plano:', error);
        showToast('Não foi possível remover o plano agora.', 'error');
      } finally {
        setButtonLoading(planClearButton, false);
        if (planApplyButton) {
          planApplyButton.disabled = false;
          planApplyButton.classList.remove('opacity-60', 'cursor-not-allowed');
        }
      }
    });
  }

  return li;
}

function renderAccessManagerList(targetList, entries, emptyLabel, type) {
  if (!targetList) return;
  targetList.innerHTML = '';
  if (!entries || entries.length === 0) {
    if (emptyLabel) {
      emptyLabel.classList.remove('hidden');
    }
    return;
  }
  if (emptyLabel) {
    emptyLabel.classList.add('hidden');
  }
  entries
    .sort((a, b) => {
      const aTime = a.updatedAt?.toMillis ? a.updatedAt.toMillis() : (a.updatedAt || 0);
      const bTime = b.updatedAt?.toMillis ? b.updatedAt.toMillis() : (b.updatedAt || 0);
      return bTime - aTime;
    })
    .forEach((entry) => {
      targetList.appendChild(createAccessManagerListItem(entry, type));
    });
}

async function loadAccessManagerLists() {
  if (!isCurrentUserAdmin()) {
    showToast('Somente administradores podem gerenciar acessos.', 'error');
    return;
  }
  if (!accessManagerPendingList || !accessManagerBlockedList || !accessManagerApprovedList) {
    return;
  }

  accessManagerPendingList.innerHTML = '';
  accessManagerBlockedList.innerHTML = '';
  accessManagerApprovedList.innerHTML = '';
  if (accessManagerPendingEmpty) accessManagerPendingEmpty.classList.add('hidden');
  if (accessManagerApprovedEmpty) accessManagerApprovedEmpty.classList.add('hidden');
  if (accessManagerBlockedEmpty) accessManagerBlockedEmpty.classList.add('hidden');
  if (accessManagerPendingCount) accessManagerPendingCount.textContent = '';
  if (accessManagerApprovedCount) accessManagerApprovedCount.textContent = '';
  if (accessManagerBlockedCount) accessManagerBlockedCount.textContent = '';

  try {
    const profilesRef = db.collection('profiles');
    const [pendingSnap, approvedSnap, blockedSnap] = await Promise.all([
      profilesRef.where('status', '==', 'pending').get(),
      profilesRef.where('status', '==', 'approved').get(),
      profilesRef.where('status', '==', 'blocked').get(),
    ]);

    const pending = pendingSnap.docs.map((doc) => ({ uid: doc.id, ...(doc.data() || {}) }));
    const approved = approvedSnap.docs.map((doc) => ({ uid: doc.id, ...(doc.data() || {}) }));
    const blocked = blockedSnap.docs.map((doc) => ({ uid: doc.id, ...(doc.data() || {}) }));

    renderAccessManagerList(accessManagerPendingList, pending, accessManagerPendingEmpty, 'pending');
    renderAccessManagerList(accessManagerApprovedList, approved, accessManagerApprovedEmpty, 'approved');
    renderAccessManagerList(accessManagerBlockedList, blocked, accessManagerBlockedEmpty, 'blocked');

    if (accessManagerPendingCount) {
      accessManagerPendingCount.textContent = pending.length ? `${pending.length}` : '';
    }
    if (accessManagerApprovedCount) {
      accessManagerApprovedCount.textContent = approved.length ? `${approved.length}` : '';
    }
    if (accessManagerBlockedCount) {
      accessManagerBlockedCount.textContent = blocked.length ? `${blocked.length}` : '';
    }
  } catch (error) {
    console.error('Erro ao carregar a fila de aprovação:', error);
    if (error?.code === 'permission-denied') {
      if (accessManagerPendingEmpty) {
        showFirestoreRulesHelp(accessManagerPendingEmpty);
      }
      if (accessManagerApprovedEmpty) {
        showFirestoreRulesHelp(accessManagerApprovedEmpty);
      }
      if (accessManagerBlockedEmpty) {
        showFirestoreRulesHelp(accessManagerBlockedEmpty);
      }
      return;
    }
    const errorMessage = (() => {
      if (error?.code === 'failed-precondition') {
        return 'Ative o índice necessário no Firestore ou tente novamente mais tarde.';
      }
      return 'Não foi possível carregar as solicitações agora.';
    })();

    if (accessManagerPendingEmpty) {
      accessManagerPendingEmpty.textContent = errorMessage;
      accessManagerPendingEmpty.classList.remove('hidden');
    }
    if (accessManagerApprovedEmpty) {
      accessManagerApprovedEmpty.textContent = errorMessage;
      accessManagerApprovedEmpty.classList.remove('hidden');
    }
    if (accessManagerBlockedEmpty) {
      accessManagerBlockedEmpty.textContent = errorMessage;
      accessManagerBlockedEmpty.classList.remove('hidden');
    }
  }
}

async function updateUserAccessStatus(uid, status) {
  if (!isCurrentUserAdmin()) {
    throw new Error('Sem permissão para alterar acessos.');
  }
  if (!uid) {
    throw new Error('Usuário inválido.');
  }

  const now = firebase.firestore.Timestamp.now();
  const profileRef = db.collection('profiles').doc(uid);
  const updates = {
    status,
    updatedAt: now,
  };

  if (status === 'approved') {
    updates.approvedAt = now;
    updates.approvedBy = currentUser?.uid || null;
    updates.blockedAt = FieldValue.delete();
    updates.blockedBy = FieldValue.delete();
    updates.blockedReason = FieldValue.delete();
    updates.pendingAt = FieldValue.delete();
  } else if (status === 'blocked') {
    updates.blockedAt = now;
    updates.blockedBy = currentUser?.uid || null;
    updates.blockedReason = 'Bloqueado pelo administrador.';
    updates.pendingAt = FieldValue.delete();
    updates.approvedAt = FieldValue.delete();
    updates.approvedBy = FieldValue.delete();
  } else if (status === 'pending') {
    updates.pendingAt = now;
    updates.approvedAt = FieldValue.delete();
    updates.approvedBy = FieldValue.delete();
    updates.blockedAt = FieldValue.delete();
    updates.blockedBy = FieldValue.delete();
    updates.blockedReason = FieldValue.delete();
  }

  await profileRef.set(updates, { merge: true });
  if (uid === currentUser?.uid) {
    const profile = await refreshAccessProfile();
    applyAccessPolicy(profile, { allowAppStart: true, forceReload: true });
  }
}

async function updateUserAccessPlan(uid, planConfig) {
  if (!isCurrentUserAdmin()) {
    throw new Error('Sem permissão para alterar planos.');
  }
  if (!uid) {
    throw new Error('Usuário inválido.');
  }
  if (!planConfig?.endsAt || !(planConfig.endsAt instanceof Date) || Number.isNaN(planConfig.endsAt.getTime())) {
    throw new Error('Plano sem data final válida.');
  }

  const now = firebase.firestore.Timestamp.now();
  const planEndsAt = firebase.firestore.Timestamp.fromDate(planConfig.endsAt);
  const planStartedAt = planConfig.startedAt instanceof Date && !Number.isNaN(planConfig.startedAt.getTime())
    ? firebase.firestore.Timestamp.fromDate(planConfig.startedAt)
    : now;
  const isActive = planConfig.endsAt.getTime() >= Date.now();

  const updates = {
    updatedAt: now,
    planType: planConfig.type || 'custom',
    planLabel: planConfig.label || 'Plano personalizado',
    planMonths: typeof planConfig.months === 'number' ? planConfig.months : FieldValue.delete(),
    planStartedAt,
    planEndsAt,
    planStatus: isActive ? 'active' : 'expired',
  };

  await db.collection('profiles').doc(uid).set(updates, { merge: true });

  if (uid === currentUser?.uid) {
    const profile = await refreshAccessProfile();
    applyAccessPolicy(profile, { allowAppStart: true, forceReload: true });
  }
}

async function clearUserAccessPlan(uid) {
  if (!isCurrentUserAdmin()) {
    throw new Error('Sem permissão para remover planos.');
  }
  if (!uid) {
    throw new Error('Usuário inválido.');
  }

  const now = firebase.firestore.Timestamp.now();
  const updates = {
    updatedAt: now,
    planType: FieldValue.delete(),
    planLabel: FieldValue.delete(),
    planMonths: FieldValue.delete(),
    planStartedAt: FieldValue.delete(),
    planEndsAt: FieldValue.delete(),
    planStatus: FieldValue.delete(),
  };

  await db.collection('profiles').doc(uid).set(updates, { merge: true });

  if (uid === currentUser?.uid) {
    const profile = await refreshAccessProfile();
    applyAccessPolicy(profile, { allowAppStart: true, forceReload: true });
  }
}

async function openAccessManagerModal() {
  if (!accessManagerModal) return;
  if (!isCurrentUserAdmin()) {
    showToast('Somente administradores podem gerenciar acessos.', 'error');
    return;
  }
  resetAccessManagerSectionDefaults();
  accessManagerModal.classList.remove('hidden');
  lockBodyScroll();
  await loadAccessManagerLists();
}

async function handleUserSignedIn(user) {
  currentUser = user;
  appReadyForCurrentUser = false;
  updateUserSessionUI(user);
  hideAuthOverlay();
  const profile = await syncUserProfile(user);
  currentUserProfile = profile;
  updateAdminControlsVisibility();
  subscribeToAccessProfile(user?.uid || null);
  const allowed = applyAccessPolicy(profile, { allowAppStart: true, forceReload: true });
  if (!allowed) {
    return;
  }
  if (workspaceShareModal && !workspaceShareModal.classList.contains('hidden')) {
    await renderWorkspaceSharingDetails();
  }
  maybeRequestNotificationPermission().catch((error) => {
    console.error('Falha ao solicitar notificações após login:', error);
  });
}

function handleUserSignedOut() {
  currentUser = null;
  currentUserProfile = null;
  appReadyForCurrentUser = false;
  appStartInProgress = false;
  if (accessProfileUnsubscribe) {
    accessProfileUnsubscribe();
    accessProfileUnsubscribe = null;
  }
  workspaceInitialized = false;
  workspaceMetadataNormalizationExecuted = false;
  activeWorkspace = { workspaceId: null, ownerUid: null, memberUids: [], isOwner: false };
  workspaceProfilesCache.clear();
  closeWorkspaceShareModal();
  closeAccessManagerModal();
  updateUserSessionUI(null);
  updateAdminControlsVisibility();
  exitVerificationMode('signIn');
  hideAccessGuardOverlay();
  showAuthOverlay();
}

function initAuthFlow() {
  updateAuthModeUI();
  showAuthOverlay();

  authToggleMode.addEventListener('click', () => {
    authMode = authMode === 'signIn' ? 'signUp' : 'signIn';
    updateAuthModeUI();
  });

  if (authGoogleButton && authEnvironment.isFileProtocol) {
    authGoogleButton.disabled = true;
    authGoogleButton.classList.add('opacity-60', 'cursor-not-allowed');
    showGoogleHelper('Abra o app usando <strong>http://localhost</strong> ou publique em um domínio autorizado para usar o Google.');
  } else if (!authEnvironment.isFileProtocol) {
    hideGoogleHelper();
  }

  authForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const email = authEmailInput.value.trim();
    const password = authPasswordInput.value.trim();
    if (!email || !password) {
      authError.textContent = 'Informe e-mail e senha válidos.';
      authError.classList.remove('hidden');
      return;
    }

    setAuthLoading(true);
    authError.classList.add('hidden');
    authError.textContent = '';

    try {
      if (authMode === 'signIn') {
        await auth.signInWithEmailAndPassword(email, password);
      } else {
        if (!isEmailAllowedForRegistration(email)) {
          authError.textContent = 'Este e-mail não está liberado para cadastro. Solicite acesso ao administrador.';
          authError.classList.remove('hidden');
          setAuthLoading(false);
          return;
        }
        await auth.createUserWithEmailAndPassword(email, password);
      }
      authForm.reset();
    } catch (error) {
      console.error('Erro na autenticação:', error);
      authError.textContent = mapAuthErrorMessage(error);
      authError.classList.remove('hidden');
    } finally {
      setAuthLoading(false);
    }
  });

  if (authGoogleButton && !authEnvironment.isFileProtocol) {
    authGoogleButton.addEventListener('click', async () => {
      authError.classList.add('hidden');
      authError.textContent = '';
      hideGoogleHelper();
      setAuthLoading(true);
      setGoogleLoading(true);

      let attemptedRedirect = false;

      try {
        await auth.signInWithPopup(googleAuthProvider);
      } catch (error) {
        if (error?.code === 'auth/popup-blocked' || error?.code === 'auth/operation-not-supported-in-this-environment') {
          try {
            attemptedRedirect = true;
            await auth.signInWithRedirect(googleAuthProvider);
            return;
          } catch (redirectError) {
            attemptedRedirect = false;
            error = redirectError;
          }
        }

        if (error?.code === 'auth/popup-closed-by-user' || error?.code === 'auth/cancelled-popup-request') {
          authError.textContent = mapAuthErrorMessage(error);
          authError.classList.remove('hidden');
        } else if (error?.code === 'auth/unauthorized-domain') {
          const host = authEnvironment.host || window.location.hostname || 'este domínio';
          showGoogleHelper(`Inclua <strong>${host}</strong> em Authentication → Settings → Authorized domains no Console do Firebase para liberar o login com Google.`);
          authError.textContent = mapAuthErrorMessage(error);
          authError.classList.remove('hidden');
        } else if (error) {
          console.error('Erro ao entrar com Google:', error);
          authError.textContent = mapAuthErrorMessage(error);
          authError.classList.remove('hidden');
        }
      } finally {
        if (!attemptedRedirect) {
          setGoogleLoading(false);
          setAuthLoading(false);
        }
      }
    });
  }

  if (authVerifyResend) {
    authVerifyResend.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return;
      setVerificationButtonsDisabled(true);
      resetVerificationFeedback();
      try {
        await user.sendEmailVerification();
        showVerificationFeedback('Novo e-mail enviado. Verifique sua caixa de entrada ou pasta de spam.', true);
      } catch (error) {
        console.error('Erro ao reenviar verificação:', error);
        showVerificationFeedback(mapVerificationErrorMessage(error), false);
      } finally {
        setVerificationButtonsDisabled(false);
      }
    });
  }

  if (authVerifyRefresh) {
    authVerifyRefresh.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return;
      setVerificationButtonsDisabled(true);
      resetVerificationFeedback();
      try {
        await user.reload();
        const refreshedUser = auth.currentUser;
        if (refreshedUser && !requiresEmailVerification(refreshedUser)) {
          exitVerificationMode('signIn');
          await handleUserSignedIn(refreshedUser);
        } else {
          showVerificationFeedback('Ainda não identificamos a confirmação. Aguarde alguns segundos e tente novamente.', false);
        }
      } catch (error) {
        console.error('Erro ao atualizar estado de verificação:', error);
        showVerificationFeedback('Não foi possível validar a confirmação agora. Tente novamente em instantes.', false);
      } finally {
        setVerificationButtonsDisabled(false);
      }
    });
  }

  if (authVerifyChange) {
    authVerifyChange.addEventListener('click', async () => {
      resetVerificationFeedback();
      setVerificationButtonsDisabled(true);
      try {
        await auth.signOut();
        exitVerificationMode('signIn');
      } catch (error) {
        console.error('Erro ao trocar e-mail:', error);
        showVerificationFeedback('Não foi possível encerrar a sessão agora. Tente novamente.', false);
      } finally {
        setVerificationButtonsDisabled(false);
      }
    });
  }

  if (signOutButton) {
    signOutButton.addEventListener('click', async () => {
      closeUserMenu();
      try {
        await auth.signOut();
        window.location.reload();
      } catch (error) {
        console.error('Erro ao sair:', error);
        showToast('Não foi possível encerrar a sessão. Tente novamente.', 'error');
      }
    });
  }

  if (workspaceShareButton) {
    workspaceShareButton.addEventListener('click', () => {
      closeUserMenu();
      if (!currentUser) {
        showAuthOverlay();
        return;
      }
      openWorkspaceShareModal().catch((error) => {
        console.error('Erro ao abrir modal de compartilhamento:', error);
        showWorkspaceFeedback('Não foi possível carregar o compartilhamento agora.', false);
      });
    });
  }

  workspaceShareClose?.addEventListener('click', closeWorkspaceShareModal);

  if (workspaceShareModal) {
    workspaceShareModal.addEventListener('click', (event) => {
      if (event.target === workspaceShareModal) {
        closeWorkspaceShareModal();
      }
    });
  }

  if (workspaceCopyCode) {
    workspaceCopyCode.addEventListener('click', async () => {
      if (!workspaceShareCode) return;
      const code = (workspaceShareCode.textContent || '').trim();
      if (!code || code === '—') {
        showWorkspaceFeedback('Código indisponível no momento. Tente novamente após carregar os dados.', false);
        return;
      }
      try {
        await navigator.clipboard.writeText(code);
        showWorkspaceFeedback('Código copiado! Envie para quem vai compartilhar o ambiente.', true);
      } catch (error) {
        console.error('Erro ao copiar código do workspace:', error);
        showWorkspaceFeedback('Não foi possível copiar automaticamente. Copie manualmente.', false);
      }
    });
  }

  if (workspaceJoinForm) {
    workspaceJoinForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!workspaceJoinCodeInput) return;
      const identifier = workspaceJoinCodeInput.value;
      if (!identifier || !identifier.trim()) {
        showWorkspaceFeedback('Informe um código ou e-mail válido para conectar.', false);
        return;
      }
      setWorkspaceJoinLoading(true);
      resetWorkspaceFeedback();
      try {
        await joinWorkspaceByIdentifier(identifier);
        showWorkspaceFeedback('Pronto! Agora vocês compartilham o mesmo espaço financeiro.', true);
      } catch (error) {
        console.error('Erro ao vincular espaço compartilhado:', error);
        const message = error?.message || 'Não foi possível usar esse código agora.';
        showWorkspaceFeedback(message, false);
      } finally {
        setWorkspaceJoinLoading(false);
      }
    });
  }

  if (workspaceLeaveButton) {
    workspaceLeaveButton.addEventListener('click', async () => {
      setWorkspaceLeaveLoading(true);
      resetWorkspaceFeedback();
      try {
        await leaveSharedWorkspace();
        showWorkspaceFeedback('Seu espaço individual foi restaurado.', true);
      } catch (error) {
        console.error('Erro ao sair do espaço compartilhado:', error);
        const message = error?.message || 'Não foi possível sair desse espaço agora.';
        showWorkspaceFeedback(message, false);
      } finally {
        setWorkspaceLeaveLoading(false);
      }
    });
  }

  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && workspaceShareModal && !workspaceShareModal.classList.contains('hidden')) {
      closeWorkspaceShareModal();
    }
    if (event.key === 'Escape' && accessManagerModal && !accessManagerModal.classList.contains('hidden')) {
      closeAccessManagerModal();
    }
  });

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      if (requiresEmailVerification(user)) {
        await handlePendingEmailVerification(user);
        return;
      }
      exitVerificationMode('signIn');
      await handleUserSignedIn(user);
    } else {
      handleUserSignedOut();
    }
  });

  if (accessGuardRefresh) {
    accessGuardRefresh.addEventListener('click', async () => {
      if (!currentUser) return;
      accessGuardRefresh.disabled = true;
      accessGuardRefresh.classList.add('opacity-60', 'cursor-not-allowed');
      try {
        await currentUser.reload().catch(() => {});
        const profile = await refreshAccessProfile();
        if (profile) {
          applyAccessPolicy(profile, { allowAppStart: true, forceReload: true });
        }
      } catch (error) {
        console.error('Erro ao atualizar status de acesso:', error);
        showToast('Não foi possível verificar agora. Tente novamente em instantes.', 'error');
      } finally {
        accessGuardRefresh.disabled = false;
        accessGuardRefresh.classList.remove('opacity-60', 'cursor-not-allowed');
      }
    });
  }

  if (accessGuardSignout) {
    accessGuardSignout.addEventListener('click', async () => {
      try {
        await auth.signOut();
      } catch (error) {
        console.error('Erro ao sair da conta:', error);
        showToast('Não foi possível sair agora. Tente novamente.', 'error');
      }
    });
  }

  if (accessManagerButton) {
    accessManagerButton.addEventListener('click', () => {
      openAccessManagerModal().catch((error) => {
        console.error('Erro ao abrir controle de acesso:', error);
        showToast('Não foi possível abrir o painel agora.', 'error');
      });
    });
  }

  if (accessManagerClose) {
    accessManagerClose.addEventListener('click', closeAccessManagerModal);
  }

  if (accessManagerModal) {
    accessManagerModal.addEventListener('click', (event) => {
      if (event.target === accessManagerModal) {
        closeAccessManagerModal();
      }
    });
  }
}

/* ===========================
   UTIL
   =========================== */
const moeda = v => (Number(v)||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const pct = (a,b)=> b? Math.max(0,Math.min(100,(a/b)*100)) : 0;
const yyyymm = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
const mmYYYY = key => { const [y,m]=key.split('-'); return `${m}/${y}`; };
const addMonths = (d,n) => new Date(d.getFullYear(), d.getMonth()+n, 1);
const monthDiff = (dStart,dEnd) => (dEnd.getFullYear()-dStart.getFullYear())*12 + (dEnd.getMonth()-dStart.getMonth());
const formatDate = value => {
  const date = value instanceof Date ? value : new Date(value);
  if (Number.isNaN(date.getTime())) return '-';
  return date.toLocaleDateString('pt-BR');
};
const formatDateInputValue = (value = new Date()) => {
  const date = value instanceof Date ? value : new Date(value);
  if (Number.isNaN(date.getTime())) return '';
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${date.getFullYear()}-${month}-${day}`;
};

const formatDateTime = (value) => {
  if (!value) return '—';
  let date;
  if (value instanceof Date) {
    date = value;
  } else if (typeof value?.toDate === 'function') {
    date = value.toDate();
  } else {
    date = new Date(value);
  }
  if (!date || Number.isNaN(date.getTime())) {
    return '—';
  }
  return date.toLocaleString('pt-BR', { hour12: false });
};

const addMonthsPreserveDay = (date, months) => {
  const base = date instanceof Date ? new Date(date.getTime()) : new Date(date);
  if (Number.isNaN(base.getTime())) return null;
  const result = new Date(base.getTime());
  result.setMonth(result.getMonth() + months);
  return result;
};

const toEndOfDay = (date) => {
  if (!(date instanceof Date)) return null;
  const copy = new Date(date.getTime());
  copy.setHours(23, 59, 59, 999);
  return copy;
};

const parseFirestoreDate = (value) => {
  if (!value) return null;
  if (value instanceof Date) {
    return Number.isNaN(value.getTime()) ? null : value;
  }
  if (typeof value.toDate === 'function') {
    const converted = value.toDate();
    return Number.isNaN(converted?.getTime?.()) ? null : converted;
  }
  const parsed = new Date(value);
  return Number.isNaN(parsed.getTime()) ? null : parsed;
};

const parseDateInput = (value) => {
  if (!value || typeof value !== 'string') return null;
  const [year, month, day] = value.split('-').map(Number);
  if (!year || !month || !day) return null;
  return new Date(year, month - 1, day, 23, 59, 59, 999);
};

const getAccessPlanOption = (value) => ACCESS_PLAN_OPTIONS.find((option) => option.value === value) || null;

const getDefaultPlanSelection = (entry = {}) => {
  if (entry.planType) {
    if (getAccessPlanOption(entry.planType)) {
      return entry.planType;
    }
    if (entry.planType === 'custom') {
      return 'custom';
    }
  }
  if (!entry.planType && entry.planEndsAt) {
    return 'custom';
  }
  return 'monthly';
};

const resolveAccessPlanInfo = (entry = {}) => {
  const now = new Date();
  const planEndsAt = parseFirestoreDate(entry.planEndsAt);
  const planStartedAt = parseFirestoreDate(entry.planStartedAt);
  const option = getAccessPlanOption(entry.planType);
  const planLabel = entry.planLabel || option?.label || (entry.planType ? capitalize(entry.planType) : '');

  let status = 'missing';
  if (planEndsAt) {
    status = planEndsAt.getTime() >= now.getTime() ? 'active' : 'expired';
  }

  const statusMeta = {
    missing: {
      label: 'Sem plano configurado',
      className: 'text-gray-500 dark:text-gray-400',
    },
    active: {
      label: 'Plano ativo',
      className: 'text-emerald-600 dark:text-emerald-300',
    },
    expired: {
      label: 'Plano expirado',
      className: 'text-red-500 dark:text-red-300',
    },
  }[status];

  const details = [];
  if (planLabel) {
    details.push(`Plano: <strong class="text-gray-700 dark:text-gray-200">${planLabel}</strong>`);
  }

  if (planStartedAt) {
    details.push(`Início: <strong class="text-gray-700 dark:text-gray-200">${formatDate(planStartedAt)}</strong>`);
  }

  if (planEndsAt) {
    const diffMs = planEndsAt.getTime() - now.getTime();
    const diffDays = Math.ceil(Math.abs(diffMs) / (1000 * 60 * 60 * 24));
    const daysLabel = diffDays === 1 ? 'dia' : 'dias';
    if (diffMs >= 0) {
      details.push(`Válido até <strong class="text-gray-700 dark:text-gray-200">${formatDate(planEndsAt)}</strong> • ${diffDays} ${daysLabel} restantes`);
    } else {
      details.push(`Expirou em <strong class="text-gray-700 dark:text-gray-200">${formatDate(planEndsAt)}</strong> • há ${diffDays} ${daysLabel}`);
    }
  } else {
    details.push('Nenhum período configurado. Defina abaixo para controlar o acesso.');
  }

  return {
    status,
    statusLabel: statusMeta.label,
    statusClass: statusMeta.className,
    details,
    planLabel,
    planEndsAt,
    planStartedAt,
  };
};

function setAccessManagerSectionState(type, isOpen) {
  accessManagerSectionState[type] = isOpen;
  const body = accessManagerSectionBodies[type];
  if (body) {
    body.classList.toggle('hidden', !isOpen);
  }
  const toggle = accessManagerSectionToggles.find((button) => button?.dataset?.accessSectionToggle === type);
  if (toggle) {
    toggle.setAttribute('aria-expanded', String(isOpen));
  }
  const caret = accessManagerSectionCarets[type];
  if (caret) {
    caret.classList.toggle('rotate-180', isOpen);
  }
}

function toggleAccessManagerSection(type) {
  const current = !!accessManagerSectionState[type];
  setAccessManagerSectionState(type, !current);
}

function initAccessManagerSectionControls() {
  accessManagerSectionToggles.forEach((button) => {
    const type = button?.dataset?.accessSectionToggle;
    if (!type) return;
    const body = document.querySelector(`[data-access-section-body="${type}"]`);
    const caret = document.querySelector(`[data-access-section-caret="${type}"]`);
    accessManagerSectionBodies[type] = body;
    accessManagerSectionCarets[type] = caret;
    const sectionEl = button.closest('section');
    const defaultCollapsed = sectionEl?.dataset?.accessDefault === 'collapsed';
    setAccessManagerSectionState(type, !defaultCollapsed);
    button.addEventListener('click', () => toggleAccessManagerSection(type));
  });
}

function resetAccessManagerSectionDefaults() {
  accessManagerSectionToggles.forEach((button) => {
    const type = button?.dataset?.accessSectionToggle;
    if (!type) return;
    const sectionEl = button.closest('section');
    const defaultCollapsed = sectionEl?.dataset?.accessDefault === 'collapsed';
    setAccessManagerSectionState(type, !defaultCollapsed);
  });
}

const capitalize = (str = '') => str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
const isPlainObject = value => value && typeof value === 'object' && !Array.isArray(value);
const deepMerge = (target = {}, source = {}) => {
  const output = { ...target };
  if (!isPlainObject(source)) {
    return { ...target, ...(source || {}) };
  }
  Object.keys(source).forEach(key => {
    const sourceValue = source[key];
    if (isPlainObject(sourceValue)) {
      output[key] = deepMerge(isPlainObject(target[key]) ? target[key] : {}, sourceValue);
    } else {
      output[key] = sourceValue;
    }
  });
  return output;
};

// Para personalizar rapidamente sem editar este arquivo, defina window.__APP_CONFIG__
// antes deste script ser carregado (ex.: em um arquivo config.js) e sobrescreva apenas
// os campos desejados. O objeto abaixo contém os valores padrão utilizados na aplicação.
const baseAppConfig = {
  envelopes: {
    fixo: { chaveResumo: 'fixosMes', meta: 1300, reservado: 0, titulo: 'Custo fixo' },
    parcelado: { chaveResumo: 'parcelasMes', meta: 1400, reservado: 0, titulo: 'Parcelados do mês' },
    variavel: { chaveResumo: 'historicoMes', meta: 2000, reservado: 0, titulo: 'Variáveis' },
  },
  cartoes: {
    pix: { fechamento: null, label: 'PIX', mesVencimentoOffset: 0 },
  },
  insights: {
    maxVisible: 5,
    toggleLabels: {
      showMore: 'Mostrar mais insights',
      showLess: 'Ocultar insights extras',
    },
  },
  investimentos: {
    simulador: {
      defaultTaxaMensalPercent: 1,
      defaultPeriodoMeses: 12,
    },
  },
  charts: {
    historicoMensal: {
      monthsWindow: 12,
      barColorStops: ['rgba(56, 189, 248, 0.65)', 'rgba(14, 165, 233, 0.25)'],
      barBorderColor: '#0ea5e9',
      acumuladoColor: '#6366f1',
      mediaColor: '#f97316',
    },
    parceladosProjecao: {
      monthsWindow: 6,
      barColor: 'rgba(129, 140, 248, 0.55)',
      borderColor: '#7c3aed',
    },
  },
  accessControl: {
    requireApproval: true,
    autoApproveFirstUser: true,
    adminEmails: [],
    adminUids: [],
    allowedEmails: [],
    allowedDomains: [],
    requireAllowlist: false,
  },
  messaging: {
    vapidKey: null,
    autoPrompt: false,
  },
};

const appConfig = deepMerge(baseAppConfig, window.__APP_CONFIG__ || {});
const MAX_INSIGHTS_VISIBLE = appConfig.insights?.maxVisible ?? 5;
const INSIGHTS_TOGGLE_LABELS = {
  showMore: appConfig.insights?.toggleLabels?.showMore || 'Mostrar mais insights',
  showLess: appConfig.insights?.toggleLabels?.showLess || 'Ocultar insights extras',
};
const SIMULADOR_DEFAULT_TAXA = appConfig.investimentos?.simulador?.defaultTaxaMensalPercent ?? 1;
const SIMULADOR_DEFAULT_PERIODO = appConfig.investimentos?.simulador?.defaultPeriodoMeses ?? 12;
const HISTORICO_MENSAL_CHART_CFG = appConfig.charts?.historicoMensal || {};
const PARCELADOS_PROJECAO_CHART_CFG = appConfig.charts?.parceladosProjecao || {};

const ACCESS_CONTROL_CFG = (() => {
  const cfg = appConfig.accessControl || {};
  const normalizeList = (list = []) => {
    if (!Array.isArray(list)) return new Set();
    return new Set(list.map(normalizeEmail).filter(Boolean));
  };
  const normalizeUidList = (list = []) => {
    if (!Array.isArray(list)) return new Set();
    return new Set(list.map((value) => typeof value === 'string' ? value.trim() : '').filter(Boolean));
  };
  const normalizeDomains = (list = []) => {
    if (!Array.isArray(list)) return new Set();
    return new Set(
      list
        .map((domain) => (domain || '').toString().trim().toLowerCase().replace(/^\./, ''))
        .filter(Boolean)
    );
  };
  return {
    requireApproval: cfg.requireApproval !== false,
    autoApproveFirstUser: cfg.autoApproveFirstUser !== false,
    adminEmails: normalizeList(cfg.adminEmails || []),
    adminUids: normalizeUidList(cfg.adminUids || []),
    allowedEmails: normalizeList(cfg.allowedEmails || []),
    allowedDomains: normalizeDomains(cfg.allowedDomains || []),
    requireAllowlist: cfg.requireAllowlist === true,
  };
})();

function emailMatchesAllowlist(normalizedEmail) {
  if (!normalizedEmail) return false;
  const domain = normalizedEmail.split('@')[1] || '';
  if (ACCESS_CONTROL_CFG.allowedEmails.has(normalizedEmail)) {
    return true;
  }
  if (domain && ACCESS_CONTROL_CFG.allowedDomains.has(domain)) {
    return true;
  }
  return false;
}

function isEmailAllowedForRegistration(email) {
  const normalized = normalizeEmail(email);
  if (!normalized) return false;
  const inAllowlist = emailMatchesAllowlist(normalized);
  if (ACCESS_CONTROL_CFG.requireAllowlist) {
    return inAllowlist;
  }
  return true;
}

function userMatchesAdminConfig(user, profile = {}) {
  if (!user && !profile) return false;
  const uid = user?.uid || profile?.uid || null;
  if (uid && ACCESS_CONTROL_CFG.adminUids.has(uid)) {
    return true;
  }
  const normalized = normalizeEmail(user?.email || profile?.email || profile?.normalizedEmail || '');
  if (normalized && ACCESS_CONTROL_CFG.adminEmails.has(normalized)) {
    return true;
  }
  if (profile?.role === 'admin') {
    return true;
  }
  return false;
}

function shouldAutoApproveUser(user, existingProfile = null) {
  if (existingProfile && existingProfile.status === 'approved') {
    return true;
  }
  if (userMatchesAdminConfig(user, existingProfile || {})) {
    return true;
  }
  const normalized = normalizeEmail(user?.email || existingProfile?.email || '');
  if (normalized && emailMatchesAllowlist(normalized)) {
    return true;
  }
  if (!existingProfile && ACCESS_CONTROL_CFG.autoApproveFirstUser) {
    return true;
  }
  if (!ACCESS_CONTROL_CFG.requireApproval) {
    return true;
  }
  return false;
}

function goToPanelAndFocus(panelId, inputSelector) {
  if (!panelId) return;
  const mobileTab = document.querySelector(`[data-panel-target="${panelId}"]`);
  if (mobileTab && window.innerWidth < 1024) {
    mobileTab.click();
  }

  const panel = document.getElementById(panelId);
  if (panel) {
    panel.scrollIntoView({ behavior: 'smooth', block: window.innerWidth < 1024 ? 'start' : 'center' });
  }

  if (inputSelector) {
    const input = document.querySelector(inputSelector);
    if (input) {
      setTimeout(() => {
        if (typeof input.focus === 'function') {
          try {
            input.focus({ preventScroll: true });
          } catch (err) {
            input.focus();
          }
        }
      }, 320);
    }
  }
}

// NOVO: Função para calcular o mês de referência da fatura
function calcularMesFatura(dataTransacao, diaFechamento, offset = 1) {
  const data = new Date(dataTransacao);
  const ano = data.getFullYear();
  const mes = data.getMonth(); // 0-11
  if (diaFechamento === null || diaFechamento === undefined) {
    // Para PIX ou sem fechamento: sempre mês atual
    return yyyymm(new Date(ano, mes, 1));
  }
  if (data.getDate() >= diaFechamento) {
    // Após ou no fechamento: adiciona o offset (0 = mesmo mês; 1 = próximo)
    return yyyymm(new Date(ano, mes + offset, 1));
  } else {
    // Antes/na data de fechamento: mês atual
    return yyyymm(new Date(ano, mes, 1));
  }
}

function obterOffsetCartao(configCartao) {
  if (!configCartao || configCartao.mesVencimentoOffset === undefined || configCartao.mesVencimentoOffset === null) {
    return 1;
  }
  const parsed = Number(configCartao.mesVencimentoOffset);
  return Number.isFinite(parsed) ? parsed : 1;
}

// Função para mostrar toast message
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast-message');
  
  // Define ícone baseado no tipo
  let icon = '';
  switch(type) {
    case 'success': icon = '✅ '; break;
    case 'error': icon = '❌ '; break;
    case 'warning': icon = '⚠️ '; break;
    case 'info': icon = 'ℹ️ '; break;
    default: icon = '✅ '; break;
  }
  
  toast.textContent = icon + message;
  toast.className = 'show'; // Remove 'hidden' e adiciona 'show'
  
  // Define cor baseada no tipo
  switch(type) {
    case 'error':
      toast.style.backgroundColor = '#dc2626'; // red-600
      break;
    case 'warning':
      toast.style.backgroundColor = '#d97706'; // amber-600
      break;
    case 'info':
      toast.style.backgroundColor = '#2563eb'; // blue-600
      break;
    default:
      toast.style.backgroundColor = '#059669'; // green-600
      break;
  }
  
  setTimeout(() => {
    toast.classList.remove('show');
    toast.classList.add('hidden'); // Esconde após a transição
  }, 3000); // Esconde após 3 segundos
}

// Variáveis e função para o modal de confirmação customizado
const modalConfirmacao = document.getElementById('modal-confirmacao');
const modalConfirmacaoTitle = document.getElementById('modal-confirmacao-title');
const modalConfirmacaoMessage = document.getElementById('modal-confirmacao-message');
const btnCancelarConfirmacao = document.getElementById('btn-cancelar-confirmacao');
const btnConfirmarAcao = document.getElementById('btn-confirmar-acao');

let confirmCallback = null; // Variável para armazenar a função a ser executada na confirmação

function abrirModalConfirmacao(title, message, callback, modalOrigemId = null) {
  fecharTodosOsModais(); // <--- NOVO: Fecha todos os outros modais antes de abrir a confirmação
  modalConfirmacaoTitle.textContent = title;
  modalConfirmacaoMessage.textContent = message;
  confirmCallback = callback; // Armazena o callback
  modalConfirmacao.classList.remove('hidden');
  updateFloatingMenuVisibility(); // Esconde o menu flutuante se estiver aberto
}

function fecharModalConfirmacao() {
  modalConfirmacao.classList.add('hidden');
  confirmCallback = null; // Limpa o callback
  
  // Se havia um modal anterior, reabre-o
  if (modalAnteriorAberto) {
    document.getElementById(modalAnteriorAberto).classList.remove('hidden');
    modalAnteriorAberto = null; // Limpa a referência
  }
  updateFloatingMenuVisibility(); // Mostra o menu flutuante novamente
}

// Event listeners para o modal de confirmação
btnCancelarConfirmacao.addEventListener('click', fecharModalConfirmacao);
btnConfirmarAcao.addEventListener('click', () => {
  if (confirmCallback) {
    confirmCallback(); // Executa a função de confirmação
  }
  fecharModalConfirmacao();
});

// Fechar modal ao clicar fora
modalConfirmacao.addEventListener('click', (e) => {
  if (e.target === modalConfirmacao) {
    fecharModalConfirmacao();
  }
});

// Fechar modal com ESC
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && !modalConfirmacao.classList.contains('hidden')) {
    fecharModalConfirmacao();
  }
});


/* ===========================
   ESTADO/CONFIGURAÇÕES
   =========================== */
const envelopeConfig = {
  fixo: { ...baseAppConfig.envelopes.fixo, ...(appConfig.envelopes?.fixo || {}) },
  parcelado: { ...baseAppConfig.envelopes.parcelado, ...(appConfig.envelopes?.parcelado || {}) },
  variavel: { ...baseAppConfig.envelopes.variavel, ...(appConfig.envelopes?.variavel || {}) },
};
let envelopes = {
  fixo: { ...envelopeConfig.fixo },
  parcelado: { ...envelopeConfig.parcelado },
  variavel: { ...envelopeConfig.variavel },
}; // persisted in Firestore
const cartoesCfgDefault = { ...baseAppConfig.cartoes, ...(appConfig.cartoes || {}) };
let cartoesCfg = {...cartoesCfgDefault};

/* caches */
let mesesDisponiveis = new Set(); // Meses com gastos (para filtro geral)
let mesesParceladosColetados = new Set(); // Meses que contêm parcelados (do início ao fim, para filtro geral)
let allFixosDocs = []; // NOVO: Cache global dos documentos de fixos
let mesesEntradasDisponiveis = new Set();
let mesesInvestimentosDisponiveis = new Set();
let allEntradasDocs = [];
let allInvestimentosDocs = [];

const painelFinanceiroState = {
  entradasMes: 0,
  entradasTotais: 0,
  entradasFiltroTodos: false,
  investimentosMes: 0,
  investimentosTotais: 0,
  investimentosProjetados: 0,
  totalGastosMes: 0,
};
let resumoFinanceiroAtual = {
  entradasMes: 0,
  totalGastosMes: 0,
  saldoProjetado: 0,
  ganhoInvest: 0,
};

/* resumo */
const resumo = {historicoMes:0, cartoesMes:0, pixMes:0, parcelasMes:0, fixosMes:0}; // MODIFICADO: Renomeado caixaAcumulado para saldoTotalAcumulado

/* NOVO: Sistema de Tags Inteligente */
let allTags = new Set(); // Cache de todas as tags existentes
let selectedTagsArray = []; // Tags selecionadas no modal
let currentSearchTerm = ''; // Termo de busca atual
let currentGroupBy = ''; // Agrupamento atual

/* NOVO: Variável para controle de scroll */
let lastScrollTop = 0;

/* ===========================
   NOVO: SISTEMA DE TAGS INTELIGENTE
   =========================== */
function initTagsSystem() {
  const tagsInput = document.getElementById('modal-tags');
  const tagsSuggestions = document.getElementById('tags-suggestions');
  const selectedTagsContainer = document.getElementById('selected-tags');

  // Carrega tags existentes do Firestore
  loadExistingTags();

  // Event listeners para o sistema de tags
  tagsInput.addEventListener('input', (e) => {
    const value = e.target.value.toLowerCase().trim();
    if (value.length > 0) {
      showTagSuggestions(value);
    } else {
      hideTagSuggestions();
    }
  });

  tagsInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ',') {
      e.preventDefault();
      const tag = e.target.value.trim();
      if (tag) {
        addTag(tag);
        e.target.value = '';
        hideTagSuggestions();
      }
    }
  });

  // Clica fora para esconder sugestões
  document.addEventListener('click', (e) => {
    if (!tagsInput.contains(e.target) && !tagsSuggestions.contains(e.target)) {
      hideTagSuggestions();
    }
  });
}

function loadExistingTags() {
  userCollectionRef('gastos').get().then(snapshot => {
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      if (data.tags && Array.isArray(data.tags)) {
        data.tags.forEach(tag => allTags.add(tag.toLowerCase()));
      }
    });
  });
}

function showTagSuggestions(searchTerm) {
  const suggestions = Array.from(allTags).filter(tag => 
    tag.includes(searchTerm) && !selectedTagsArray.includes(tag)
  );
  
  const container = document.getElementById('tags-suggestions');
  container.innerHTML = '';
  
  if (suggestions.length > 0) {
    suggestions.slice(0, 5).forEach(tag => {
      const div = document.createElement('div');
      div.className = 'tag-suggestion';
      div.textContent = tag;
      div.addEventListener('click', () => {
        addTag(tag);
        document.getElementById('modal-tags').value = '';
        hideTagSuggestions();
      });
      container.appendChild(div);
    });
    container.classList.remove('hidden');
  } else {
    hideTagSuggestions();
  }
}

function hideTagSuggestions() {
  document.getElementById('tags-suggestions').classList.add('hidden');
}

function addTag(tagText) {
  const tag = tagText.toLowerCase().trim();
  if (tag && !selectedTagsArray.includes(tag)) {
    selectedTagsArray.push(tag);
    allTags.add(tag); // Adiciona à lista global
    renderSelectedTags();
  }
}

function removeTag(tag) {
  selectedTagsArray = selectedTagsArray.filter(t => t !== tag);
  renderSelectedTags();
}

function renderSelectedTags() {
  const container = document.getElementById('selected-tags');
  container.innerHTML = '';
  
  selectedTagsArray.forEach(tag => {
    const pill = document.createElement('span');
    pill.className = 'tag-pill removable';
    pill.innerHTML = `${tag} <span class="remove-tag" onclick="removeTag('${tag}')">&times;</span>`;
    container.appendChild(pill);
  });
}

/* ===========================
   NOVO: BUSCA E AGRUPAMENTO NO HISTÓRICO
   =========================== */
function initHistoricoSearch() {
  const searchInput = document.getElementById('search-historico');
  const groupBySelect = document.getElementById('group-by-historico');
  const clearButton = document.getElementById('clear-search');

  searchInput.addEventListener('input', (e) => {
    currentSearchTerm = e.target.value.toLowerCase().trim();
    renderHistoricoWithFilters();
  });

  groupBySelect.addEventListener('change', (e) => {
    currentGroupBy = e.target.value;
    renderHistoricoWithFilters();
  });

  clearButton.addEventListener('click', () => {
    searchInput.value = '';
    groupBySelect.value = '';
    currentSearchTerm = '';
    currentGroupBy = '';
    renderHistoricoWithFilters();
  });
}

 // Remove tela de carregamento após load
  window.addEventListener("load", () => {
    const loading = document.getElementById("loading-screen");
    if (loading) {
      loading.style.opacity = "0";
      setTimeout(() => loading.remove(), 500); // fade-out
    }
  });
  
function renderHistoricoWithFilters() {
  const tbody = document.getElementById('transactions-list');
  tbody.innerHTML = '';

  const mesSel = document.getElementById('filtro-mes').value || yyyymm(new Date());
  
  let filteredDocs = allGastosDocs.filter(doc => {
    const d = doc.data();
    if (!d.data) return false;
    const keyTransacao = yyyymm(d.data.toDate ? d.data.toDate() : new Date(d.data));
    const keyFatura = d.mesFatura || keyTransacao; // Usa mesFatura para filtragem

    // Filtro por mês
    if (mesSel !== 'all' && keyFatura !== mesSel) return false; // Filtra por mesFatura
    
    // Filtro por busca
    if (currentSearchTerm) {
      const desc = (d.descricao || '').toLowerCase();
      const tags = (d.tags || []).join(' ').toLowerCase();
      if (!desc.includes(currentSearchTerm) && !tags.includes(currentSearchTerm)) {
        return false;
      }
    }
    
    return true;
  });

  updateHistoricoInsights(filteredDocs, mesSel);

    if (filteredDocs.length === 0) {
      tbody.innerHTML = '<tr><td class="td" colspan="8">Nenhum gasto encontrado</td></tr>';
      return;
    }
    
  // Agrupamento
    if (currentGroupBy === 'cartao') {
      renderHistoricoGroupedByCartao(filteredDocs);
    } else if (currentGroupBy) {
      renderHistoricoGrouped(filteredDocs, currentGroupBy);
    } else {
      renderHistoricoNormal(filteredDocs);
    }
    
}

function updateHistoricoInsights(docs, mesSel) {
  historicoInsightsCache = { docs, mesSel };

  const mediaEl = document.getElementById('historico-media-diaria');
  const hintEl = document.getElementById('historico-media-hint');
  const canvas = document.getElementById('grafico-historico-semanal');
  const emptyState = document.getElementById('historico-semanas-empty');
  const janelaEl = document.getElementById('historico-semanas-janela');
  if (!mediaEl || !hintEl || !canvas || !emptyState) return;

  const modoSelect = document.getElementById('historico-semanas-modo');
  const modo = modoSelect ? modoSelect.value : 'selected';

  const monthStats = {
    valid: false,
    ano: null,
    mes: null,
    diasNoMes: 0,
    totalMes: 0,
    label: '',
  };

  if (mesSel && mesSel !== 'all') {
    const [anoStr, mesStr] = mesSel.split('-');
    const ano = parseInt(anoStr, 10);
    const mes = parseInt(mesStr, 10);
    if (!isNaN(ano) && !isNaN(mes)) {
      monthStats.valid = true;
      monthStats.ano = ano;
      monthStats.mes = mes;
      monthStats.diasNoMes = new Date(ano, mes, 0).getDate();
      monthStats.totalMes = (docs || []).reduce((sum, doc) => sum + (doc.data().valor || 0), 0);
      monthStats.label = String(mes).padStart(2, '0');
    }
  }

  if (modo !== 'rolling') {
    if (monthStats.valid) {
      const hoje = new Date();
      let diasConsiderados = monthStats.diasNoMes;
      if (hoje.getFullYear() === monthStats.ano && (hoje.getMonth() + 1) === monthStats.mes) {
        diasConsiderados = Math.max(1, Math.min(monthStats.diasNoMes, hoje.getDate()));
        hintEl.textContent = `Com base nos primeiros ${diasConsiderados} dia${diasConsiderados > 1 ? 's' : ''} deste mês.`;
      } else {
        hintEl.textContent = `Distribuição em ${monthStats.diasNoMes} dia${monthStats.diasNoMes > 1 ? 's' : ''} do mês selecionado.`;
      }
      const media = diasConsiderados ? monthStats.totalMes / diasConsiderados : 0;
      mediaEl.textContent = `R$ ${moeda(media)}`;
      if (!docs || !docs.length) {
        hintEl.textContent = `Nenhum gasto lançado em ${monthStats.label}/${String(monthStats.ano).slice(-2)} até o momento.`;
      }
    } else {
      mediaEl.textContent = 'R$ 0,00';
      hintEl.textContent = 'Selecione um mês para ver a média diária.';
    }
  }

  if (janelaEl) {
    if (modo === 'rolling') {
      janelaEl.textContent = 'Últimas 8 semanas';
    } else if (monthStats.valid) {
      janelaEl.textContent = `${monthStats.label}/${String(monthStats.ano).slice(-2)}`;
    } else {
      janelaEl.textContent = 'Selecione um mês';
    }
  }

  const ctx = canvas.getContext('2d');

  const hideChart = (mensagem) => {
    emptyState.textContent = mensagem;
    emptyState.classList.remove('hidden');
    if (chartHistoricoSemanal) {
      chartHistoricoSemanal.destroy();
      chartHistoricoSemanal = null;
    }
  };

  const showChart = (labels, valores) => {
    emptyState.classList.add('hidden');
    const maxValor = Math.max(...valores, 0);
    const baseColor = html.classList.contains('dark') ? 'rgba(129, 140, 248, 0.55)' : 'rgba(99, 102, 241, 0.55)';
    const destaqueColor = html.classList.contains('dark') ? 'rgba(251, 191, 36, 0.75)' : 'rgba(245, 158, 11, 0.75)';
    const borderColor = html.classList.contains('dark') ? '#6366f1' : '#4f46e5';
    const backgrounds = valores.map(v => (v === maxValor && maxValor > 0 ? destaqueColor : baseColor));
    const borders = valores.map(() => borderColor);

    if (chartHistoricoSemanal) {
      chartHistoricoSemanal.data.labels = labels;
      chartHistoricoSemanal.data.datasets[0].data = valores;
      chartHistoricoSemanal.data.datasets[0].backgroundColor = backgrounds;
      chartHistoricoSemanal.data.datasets[0].borderColor = borders;
      chartHistoricoSemanal.update();
      return;
    }

    chartHistoricoSemanal = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Total da semana',
          data: valores,
          backgroundColor: backgrounds,
          borderColor: borders,
          borderWidth: 1.5,
          borderRadius: 6,
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: val => `R$ ${moeda(val)}`,
              color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937',
            },
            grid: {
              color: html.classList.contains('dark') ? '#374151' : '#e5e7eb',
            },
          },
          x: {
            ticks: {
              color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937',
            },
            grid: {
              display: false,
            },
          },
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: items => {
                const item = items[0];
                if (!item) return '';
                const raw = item.chart?.data?.labels?.[item.dataIndex];
                if (Array.isArray(raw)) {
                  return raw[0] || '';
                }
                return raw || '';
              },
              afterBody: items => {
                const item = items[0];
                if (!item) return '';
                const raw = item.chart?.data?.labels?.[item.dataIndex];
                if (Array.isArray(raw) && raw[1]) {
                  return raw[1];
                }
                return '';
              },
              label: context => `R$ ${moeda(context.parsed.y)}`,
            },
          },
        },
      },
    });
  };

  if (modo === 'rolling') {
    const baseDocs = Array.isArray(allGastosDocs) ? allGastosDocs : [];
    if (!baseDocs.length) {
      mediaEl.textContent = 'R$ 0,00';
      hintEl.textContent = 'Ainda não há lançamentos suficientes para o comparativo das últimas semanas.';
      hideChart('Nenhum gasto registrado para calcular as últimas semanas.');
      return;
    }

    const semanas = buildRollingWeeks(8);
    baseDocs.forEach(doc => {
      const dados = doc.data();
      const dataGasto = extrairDataGasto(dados);
      if (!dataGasto) return;
      semanas.forEach(semana => {
        if (dataGasto >= semana.start && dataGasto <= semana.end) {
          semana.total += dados.valor || 0;
        }
      });
    });

    const valores = semanas.map(semana => semana.total);
    const totalRolling = valores.reduce((sum, v) => sum + v, 0);
    const diasConsiderados = semanas.length * 7;
    const mediaRolling = diasConsiderados ? totalRolling / diasConsiderados : 0;
    mediaEl.textContent = `R$ ${moeda(mediaRolling)}`;
    hintEl.textContent = 'Média diária considerando as últimas 8 semanas.';

    const hasValores = valores.some(v => v > 0);
    if (!hasValores) {
      hideChart('As últimas semanas ainda não possuem gastos registrados.');
      return;
    }

    const labels = semanas.map((semana, idx) => [
      `Sem ${idx + 1}`,
      `${formatarDiaMes(semana.start)}–${formatarDiaMes(semana.end)}`,
    ]);
    showChart(labels, valores);
    return;
  }

  if (!monthStats.valid) {
    hideChart('Escolha um mês específico para destravar o resumo semanal.');
    return;
  }

  if (!docs || !docs.length) {
    hideChart(`Sem gastos registrados no mês ${monthStats.label}/${String(monthStats.ano).slice(-2)}.`);
    return;
  }

  const semanas = buildWeeksForMonth(monthStats.diasNoMes);
  docs.forEach(doc => {
    const dados = doc.data();
    const dataResumo = resolveDateForWeekSummary(dados, mesSel);
    if (!dataResumo) return;
    const dia = dataResumo.getDate();
    const indice = Math.min(semanas.length - 1, Math.floor((dia - 1) / 7));
    semanas[indice].total += dados.valor || 0;
  });

  const valores = semanas.map(semana => semana.total);
  const possuiValor = valores.some(v => v > 0);
  if (!possuiValor) {
    hideChart(`Sem lançamentos no mês ${monthStats.label}/${String(monthStats.ano).slice(-2)}.`);
    return;
  }

  const labels = semanas.map((semana, idx) => [
    `Semana ${idx + 1}`,
    `${String(semana.start).padStart(2, '0')}–${String(semana.end).padStart(2, '0')}/${String(monthStats.ano).slice(-2)}`,
  ]);
  showChart(labels, valores);
}

function resolveDateForWeekSummary(dados, mesSel) {
  if (!dados) return null;
  let dataBase = null;
  if (dados.data) {
    const raw = dados.data.toDate ? dados.data.toDate() : new Date(dados.data);
    if (raw && !isNaN(raw)) {
      dataBase = raw;
    }
  }

  if (!mesSel || mesSel === 'all') {
    return dataBase;
  }

  const [anoStr, mesStr] = mesSel.split('-');
  const ano = parseInt(anoStr, 10);
  const mes = parseInt(mesStr, 10);
  if (!ano || !mes) return dataBase;

  if (dataBase && dataBase.getFullYear() === ano && (dataBase.getMonth() + 1) === mes) {
    return dataBase;
  }

  const fallback = new Date(ano, mes - 1, 1);
  if (dataBase && !isNaN(dataBase)) {
    const ultimoDia = new Date(ano, mes, 0).getDate();
    fallback.setDate(Math.min(dataBase.getDate(), ultimoDia));
  }
  return fallback;
}

function buildWeeksForMonth(diasNoMes) {
  const semanas = [];
  let diaAtual = 1;
  while (diaAtual <= diasNoMes) {
    const fim = Math.min(diaAtual + 6, diasNoMes);
    semanas.push({ start: diaAtual, end: fim, total: 0 });
    diaAtual = fim + 1;
  }
  return semanas;
}

function buildRollingWeeks(total = 8, referenceDate = new Date()) {
  const semanas = [];
  const inicioReferencia = startOfWeek(referenceDate);
  for (let i = total - 1; i >= 0; i--) {
    const inicio = new Date(inicioReferencia);
    inicio.setDate(inicioReferencia.getDate() - (i * 7));
    const fim = new Date(inicio);
    fim.setDate(inicio.getDate() + 6);
    inicio.setHours(0, 0, 0, 0);
    fim.setHours(23, 59, 59, 999);
    semanas.push({ start: inicio, end: fim, total: 0 });
  }
  return semanas;
}

function startOfWeek(date) {
  const base = new Date(date);
  base.setHours(0, 0, 0, 0);
  const day = base.getDay();
  const diff = (day + 6) % 7; // Inicia na segunda-feira
  base.setDate(base.getDate() - diff);
  return base;
}

function extrairDataGasto(dados) {
  if (!dados) return null;
  const candidatos = [dados.data, dados.dataTransacao, dados.dataLancamento];
  for (const value of candidatos) {
    if (!value) continue;
    let date = null;
    if (value instanceof Date) {
      date = value;
    } else if (typeof value?.toDate === 'function') {
      date = value.toDate();
    } else {
      date = new Date(value);
    }
    if (date && !isNaN(date)) {
      return new Date(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0, 0);
    }
  }
  return null;
}

function formatarDiaMes(date) {
  if (!(date instanceof Date) || isNaN(date)) return '';
  const dia = String(date.getDate()).padStart(2, '0');
  const mes = String(date.getMonth() + 1).padStart(2, '0');
  return `${dia}/${mes}`;
}

function renderHistoricoNormal(docs) {
  const tbody = document.getElementById('transactions-list');

  docs.forEach(doc => {
    const d = doc.data();
    const id = doc.id;
    const dt = d.data.toDate ? d.data.toDate() : new Date(d.data);
    const mesFaturaDisplay = d.mesFatura ? mmYYYY(d.mesFatura) : '-';
    
    // Renderiza tags
    const tagsHtml = (d.tags || []).map(tag => 
      `<span class="tag-pill" style="font-size: 0.6rem; padding: 0.125rem 0.25rem;">${tag}</span>`
    ).join('');
    
    // Destaca termo de busca
    let descricao = d.descricao || '';
    if (currentSearchTerm) {
      const regex = new RegExp(`(${currentSearchTerm})`, 'gi');
      descricao = descricao.replace(regex, '<span class="search-highlight">$1</span>');
    }
    
      const tr = document.createElement('tr');
          tr.innerHTML = `
      <td class="td">${(cartoesCfg[d.cartao] && cartoesCfg[d.cartao].label) || d.cartao || ''}</td>
      <td class="td">${descricao}</td>
      <td class="td">R$ ${moeda(d.valor)}</td>
      <td class="td">${dt.toLocaleDateString('pt-BR')}</td>
      <td class="td">${mesFaturaDisplay}</td>
      <td class="td">${d.tipo}</td>
      <td class="td">
        <div class="flex flex-wrap gap-1">${tagsHtml}</div>
      </td>
      <td class="td">
        <button class="text-blue-600 dark:text-blue-400 edit-gasto mr-2 hover:text-blue-800 dark:hover:text-blue-200" data-id="${id}" aria-label="Editar gasto">
          <i class="fa fa-edit"></i>
        </button>
        <button class="text-red-600 dark:text-red-400 delete-gasto hover:text-red-800 dark:hover:text-red-200" data-id="${id}" aria-label="Remover gasto">
          <i class="fa fa-trash"></i>
        </button>
      </td>
    `;
    
    
    tbody.appendChild(tr);
    
  });
}

function renderHistoricoGrouped(docs, groupBy) {
  const tbody = document.getElementById('transactions-list');
  const groups = {};

  // Agrupa os documentos
  docs.forEach(doc => {
    const d = doc.data();
    let groupKey = 'Outros'; // Default group key

    switch (groupBy) {
      case 'categoria':
        groupKey = d.categoria || 'Sem categoria';
        break;
      case 'cartao': // Este caso já é tratado por renderHistoricoGroupedByCartao, mas mantido para completude
        groupKey = d.cartao || 'Sem cartão';
        break;
      case 'tag':
        groupKey = (d.tags && d.tags.length > 0) ? d.tags[0] : 'Sem tags';
        break;
    }

    if (!groups[groupKey]) {
      groups[groupKey] = [];
    }
    groups[groupKey].push(doc);
  });

  // Renderiza grupos
  Object.keys(groups).sort().forEach(groupKey => {
    const totalGroup = groups[groupKey].reduce((sum, doc) => sum + (doc.data().valor || 0), 0);
    const isCollapsed = collapsedGroups[groupKey] || false;
    const iconClass = isCollapsed ? 'fa-chevron-right' : 'fa-chevron-down';

    // Cabeçalho do grupo
    const groupHeader = document.createElement('tr');
    groupHeader.className = 'group-header cursor-pointer bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors';
    groupHeader.dataset.groupKey = groupKey;
    groupHeader.setAttribute('role', 'button');
    groupHeader.setAttribute('tabindex', '0');
    groupHeader.setAttribute('aria-expanded', !isCollapsed);
    groupHeader.innerHTML = `
      <td colspan="8" class="td font-semibold text-gray-800 dark:text-gray-100">
        <i class="fa ${iconClass} mr-2 group-toggle-icon"></i>
        ${groupKey.charAt(0).toUpperCase() + groupKey.slice(1)} — Total: R$ ${moeda(totalGroup)}
      </td>
    `;
    tbody.appendChild(groupHeader);

    // Itens do grupo
    groups[groupKey].forEach(doc => {
      const d = doc.data();
      const id = doc.id;
      const dt = d.data.toDate ? d.data.toDate() : new Date(d.data);
      const mesFaturaDisplay = d.mesFatura ? mmYYYY(d.mesFatura) : '-';

      const tagsHtml = (d.tags || []).map(tag =>
        `<span class="tag-pill" style="font-size: 0.6rem; padding: 0.125rem 0.25rem;">${tag}</span>`
      ).join('');

      let descricao = d.descricao || '';
      if (currentSearchTerm) {
        const regex = new RegExp(`(${currentSearchTerm})`, 'gi');
        descricao = descricao.replace(regex, '<span class="search-highlight">$1</span>');
      }

      const tr = document.createElement('tr');
      tr.className = `group-item ${isCollapsed ? 'hidden' : ''}`; // Adiciona classe 'hidden' se o grupo estiver colapsado
      tr.dataset.groupKey = groupKey; // Adiciona data-group-key para os itens
      tr.innerHTML = `
        <td class="td">${(cartoesCfg[d.cartao] && cartoesCfg[d.cartao].label) || d.cartao || ''}</td>
        <td class="td">${descricao}</td>
        <td class="td">R$ ${moeda(d.valor)}</td>
        <td class="td">${dt.toLocaleDateString('pt-BR')}</td>
        <td class="td">${mesFaturaDisplay}</td>
        <td class="td">${d.tipo}</td>
        <td class="td">
          <div class="flex flex-wrap gap-1">${tagsHtml}</div>
        </td>
        <td class="td">
          <button class="text-blue-600 dark:text-blue-400 edit-gasto mr-2 hover:text-blue-800 dark:hover:text-blue-200" data-id="${id}" aria-label="Editar gasto">
            <i class="fa fa-edit"></i>
          </button>
          <button class="text-red-600 dark:text-red-400 delete-gasto hover:text-red-800 dark:hover:text-red-200" data-id="${id}" aria-label="Remover gasto">
            <i class="fa fa-trash"></i>
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}

// Variáveis para o modal de gerenciamento de cartões
const modalGerenciarCartoes = document.getElementById('modal-gerenciar-cartoes');
const modalGerenciarCartoesClose = document.getElementById('modal-gerenciar-cartoes-close');
const btnGerenciarCartoes = document.getElementById('btn-gerenciar-cartoes');
const formAddCartao = document.getElementById('form-add-cartao');
const listaCartoesExistentes = document.getElementById('lista-cartoes-existentes');

/* ===========================
   PERSISTÊNCIA: ENVELOPES
   =========================== */
function cloneEnvelopeDefaults() {
  return {
    fixo: { ...envelopeConfig.fixo },
    parcelado: { ...envelopeConfig.parcelado },
    variavel: { ...envelopeConfig.variavel },
  };
}

function normalizarEnvelopesDoc(data = {}) {
  const base = cloneEnvelopeDefaults();
  ['fixo', 'parcelado', 'variavel'].forEach(tipo => {
    const entrada = data[tipo];
    if (typeof entrada === 'number') {
      base[tipo].meta = Math.max(0, Number(entrada) || 0);
    } else if (entrada && typeof entrada === 'object') {
      if ('meta' in entrada || 'teto' in entrada) {
        const metaVal = entrada.meta ?? entrada.teto;
        base[tipo].meta = Math.max(0, Number(metaVal) || 0);
      }
      if ('reservado' in entrada || 'reserva' in entrada) {
        const reservaVal = entrada.reservado ?? entrada.reserva;
        base[tipo].reservado = Math.max(0, Number(reservaVal) || 0);
      }
    }
  });
  return base;
}

function getEnvelopeGastoAtual(tipo) {
  const chaveResumo = envelopeConfig[tipo]?.chaveResumo;
  return chaveResumo ? Number(resumo[chaveResumo] || 0) : 0;
}

function getEnvelopeMeta(tipo) {
  return Number(envelopes[tipo]?.meta || 0);
}

function calcularResumoEnvelopes() {
  const tipos = ['fixo', 'parcelado', 'variavel'];
  return tipos.reduce((acc, tipo) => {
    const meta = getEnvelopeMeta(tipo);
    const gastoAtual = getEnvelopeGastoAtual(tipo);
    const reservado = Number(envelopes[tipo]?.reservado || 0);
    const margem = Math.max(0, meta - gastoAtual - reservado);

    acc.totalMeta += meta;
    acc.totalGasto += gastoAtual;
    acc.totalReservado += reservado;
    acc.totalMargem += margem;

    return acc;
  }, { totalMeta: 0, totalGasto: 0, totalReservado: 0, totalMargem: 0 });
}

function atualizarInputsEnvelopes() {
  ['fixo', 'parcelado', 'variavel'].forEach(tipo => {
    const metaInput = document.getElementById(`envelope-${tipo}-meta`);
    const reservaInput = document.getElementById(`envelope-${tipo}-reserva`);
    if (metaInput && metaInput.dataset.userEdited !== 'true') {
      metaInput.value = envelopes[tipo]?.meta ?? 0;
    }
    if (reservaInput && reservaInput.dataset.userEdited !== 'true') {
      reservaInput.value = envelopes[tipo]?.reservado ?? 0;
    }
  });
}

function atualizarBarrasVisuais(){
  ['fixo', 'parcelado', 'variavel'].forEach(tipo => {
    atualizarBarra(tipo, getEnvelopeGastoAtual(tipo));
  });

  const resumoEnvelopes = calcularResumoEnvelopes();
  const formatar = valor => (Number(valor) || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  const metaTotalEl = document.getElementById('overview-meta-total');
  if (metaTotalEl) metaTotalEl.textContent = formatar(resumoEnvelopes.totalMeta);

  const reservadoTotalEl = document.getElementById('overview-reservado-total');
  if (reservadoTotalEl) reservadoTotalEl.textContent = formatar(resumoEnvelopes.totalReservado);

  const margemTotalEl = document.getElementById('overview-margem-total');
  if (margemTotalEl) margemTotalEl.textContent = formatar(resumoEnvelopes.totalMargem);

  const modalMetaEl = document.getElementById('overview-modal-meta');
  if (modalMetaEl) modalMetaEl.textContent = formatar(resumoEnvelopes.totalMeta);

  const modalGastoEl = document.getElementById('overview-modal-gasto');
  if (modalGastoEl) modalGastoEl.textContent = formatar(resumoEnvelopes.totalGasto);

  const modalReservadoEl = document.getElementById('overview-modal-reservado');
  if (modalReservadoEl) modalReservadoEl.textContent = formatar(resumoEnvelopes.totalReservado);

  const modalMargemEl = document.getElementById('overview-modal-margem');
  if (modalMargemEl) modalMargemEl.textContent = formatar(resumoEnvelopes.totalMargem);

  window.__ultimoResumoEnvelopes = resumoEnvelopes;
}

function carregarEnvelopes(){
  if (!currentUser) return;
  userDocRef('limites', 'conta_unica').get().then(doc=>{
    envelopes = normalizarEnvelopesDoc(doc.exists ? doc.data() : {});
    atualizarInputsEnvelopes();
    atualizarBarrasVisuais();
    gerarInsights();
  });
}

function salvarEnvelope(tipo, novosValores, mensagem = 'Envelope atualizado com sucesso!') {
  if (!envelopes[tipo]) envelopes[tipo] = { ...envelopeConfig[tipo] };
  const meta = Math.max(0, Number(novosValores.meta ?? envelopes[tipo].meta) || 0);
  const reservado = Math.max(0, Number(novosValores.reservado ?? envelopes[tipo].reservado) || 0);
  envelopes[tipo] = { ...envelopes[tipo], meta, reservado };
  atualizarInputsEnvelopes();
  atualizarBarrasVisuais();
  gerarInsights();

  const payload = {
    [tipo]: {
      meta,
      reservado,
    }
  };

  return userDocRef('limites', 'conta_unica').set(stampWorkspaceUpdate(payload), { merge: true })
    .then(() => showToast(mensagem))
    .catch(err => {
      console.error('Erro ao salvar envelope', err);
      showToast('Erro ao salvar envelope.', 'error');
    });
}

function reservarSaldoDisponivel(tipo) {
  const meta = Number(envelopes[tipo]?.meta) || 0;
  const gasto = getEnvelopeGastoAtual(tipo);
  const reservadoAtual = Number(envelopes[tipo]?.reservado) || 0;
  const disponivel = Math.max(0, meta - gasto - reservadoAtual);
  if (disponivel <= 0) {
    showToast('Não há saldo disponível para reservar neste envelope.', 'warning');
    return Promise.resolve();
  }
  return salvarEnvelope(tipo, { reservado: reservadoAtual + disponivel }, 'Reserva atualizada!');
}

function limparReservaEnvelope(tipo) {
  if ((Number(envelopes[tipo]?.reservado) || 0) === 0) {
    showToast('Nenhuma reserva para liberar.', 'info');
    return Promise.resolve();
  }
  return salvarEnvelope(tipo, { reservado: 0 }, 'Reserva liberada!');
}

function reservarSobrasAutomatico() {
  const acoes = ['fixo', 'parcelado', 'variavel'].map(reservarSaldoDisponivel);
  return Promise.all(acoes).then(() => atualizarBarrasVisuais());
}

function limparReservasAutomatico() {
  const acoes = ['fixo', 'parcelado', 'variavel'].map(limparReservaEnvelope);
  return Promise.all(acoes).then(() => atualizarBarrasVisuais());
}

function abrirModalGerenciarCartoes() {
  modalGerenciarCartoes.classList.remove('hidden');
  renderListaCartoesExistentes(); // Renderiza a lista de cartões ao abrir
  updateFloatingMenuVisibility(); // Esconde o menu flutuante
}
function fecharModalGerenciarCartoes() {
  modalGerenciarCartoes.classList.add('hidden');
  formAddCartao.reset(); // Limpa o formulário
  updateFloatingMenuVisibility(); // Mostra o menu flutuante
}

function renderListaCartoesExistentes() {
  listaCartoesExistentes.innerHTML = '';
  const cartoesAtuais = Object.keys(cartoesCfg).filter(key => key !== 'pix'); 
  if (cartoesAtuais.length === 0) {
    listaCartoesExistentes.innerHTML = '<div class="text-gray-500 dark:text-gray-400">Nenhum cartão adicionado ainda.</div>';
    return;
  }
  cartoesAtuais.forEach(key => {
    const cfg = cartoesCfg[key];
    const cardItem = document.createElement('div');
    cardItem.className = 'flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg';
    cardItem.innerHTML = `
      <div>
        <div class="font-semibold text-gray-800 dark:text-gray-100">${cfg.label}</div> <!-- MODIFICADO AQUI: Removido o (key) -->
        <div class="text-sm text-gray-600 dark:text-gray-300">
          Fechamento: ${cfg.fechamento !== null ? cfg.fechamento : 'N/A'}
          <button class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 ml-2" onclick="editarFechamentoCartao('${key}')" title="Editar Dia de Fechamento">
            <i class="fa fa-pencil-alt"></i>
          </button>
        </div>
      </div>
      <button class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-200" onclick="removerCartao('${key}')" title="Remover Cartão">
        <i class="fa fa-trash"></i>
      </button>
      <button class="text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-200 ml-2" onclick="editarOffsetCartao('${key}')" title="Editar Offset de Vencimento">
      <i class="fa fa-calendar-alt"></i>
    </button>
    
    `;
    listaCartoesExistentes.appendChild(cardItem);
  });
}

   // Função nova para editar offset
    function editarOffsetCartao(key) {
      const cfg = cartoesCfg[key] || { mesVencimentoOffset: 1 };
      const novoOffset = prompt(`Offset de vencimento para ${cfg.label} (0 = mesmo mês, 1 = próximo mês):`, cfg.mesVencimentoOffset);
      if (novoOffset === null) return;
      const val = parseInt(novoOffset);
      if (isNaN(val) || val < 0 || val > 1) {
        showToast('Offset inválido. Use 0 ou 1.', 'error');
        return;
      }
      cartoesCfg[key] = { ...cfg, mesVencimentoOffset: val };
      userDocRef('config', 'cartoes').set(cartoesCfg, { merge: true })
        .then(() => {
          showToast('Offset atualizado!');
          renderListaCartoesExistentes();
          startObservers();  // Recarrega para aplicar
        })
        .catch(err => showToast('Erro ao atualizar offset.', 'error'));
    }

function editarFechamentoCartao(key) {
  const cfg = cartoesCfg[key] || {label: key, fechamento: null}; // Garante que cfg exista
  const novoFechamento = prompt(`Digite o novo dia de fechamento para ${cfg.label} (1-31). Deixe vazio para remover:`, cfg.fechamento !== null ? String(cfg.fechamento) : '');
  if (novoFechamento === null) return; // Usuário cancelou
  const val = novoFechamento.trim() === '' ? null : parseInt(novoFechamento);
  if (val !== null && (isNaN(val) || val < 1 || val > 31)) {
    showToast('Dia de fechamento inválido. Use um número entre 1 e 31 ou deixe vazio.', 'error');
    return;
  }
  // Atualiza a configuração local
  cartoesCfg[key] = { ...cfg, fechamento: val };
  // Atualiza no Firestore
  userDocRef('config', 'cartoes').set(cartoesCfg, { merge: true })
    .then(() => {
      showToast('Dia de fechamento atualizado com sucesso!');
      renderListaCartoesExistentes(); // Atualiza a lista no modal de gerenciamento
      startObservers(); // Recarrega tudo para refletir a mudança
    })
    .catch(err => showToast('Erro ao atualizar dia de fechamento: ' + err.message, 'error'));
}

function removerCartao(idCartao) {
  abrirModalConfirmacao(
    'Remover Cartão',
    `Tem certeza que deseja remover o cartão "${cartoesCfg[idCartao].label}"? Todos os gastos associados a ele permanecerão, mas o cartão não aparecerá mais nas opções.`,
    () => { // Callback de confirmação
      // Remove o cartão da configuração local
      // É crucial criar uma CÓPIA do objeto cartoesCfg para evitar problemas de referência
      const novosCartoesCfg = { ...cartoesCfg }; 
      delete novosCartoesCfg[idCartao];
      // Atualiza no Firestore com o objeto MODIFICADO
      userDocRef('config', 'cartoes').set(novosCartoesCfg) // Use .set() para sobrescrever, não .update()
        .then(() => {
          showToast('Cartão removido com sucesso!');
          // Atualiza a variável global cartoesCfg com a nova configuração
          cartoesCfg = novosCartoesCfg; 
          
          // Fechar o modal de gerenciamento de cartões após a remoção bem-sucedida
          fecharModalGerenciarCartoes(); 
          
          // Força uma atualização completa para que os filtros e resumos reflitam a mudança
          // Isso é importante para que os selects de cartão e os resumos sejam atualizados
          startObservers(); 
        })
        .catch(err => showToast('Erro ao remover cartão: ' + err.message, 'error'));
    },
    'modal-gerenciar-cartoes' // <--- NOVO: Passa o ID do modal de origem
  );
}

/* ===========================
   FIXOS (recorrentes) - MELHORADO
   =========================== */
function renderFixos(docs) {
  allFixosDocs = docs; // Atualiza o cache global

  // Renderização melhorada com cards
  const container = document.getElementById('fixos-cards-container');
  container.innerHTML = '';
  
  let totalAtivos = 0;
  let totalInativos = 0;
  
  if (!docs.length) { 
    container.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-4">Sem fixos cadastrados</div>';
  } else {
    docs.forEach(doc => {
      const f = doc.data();
      const id = doc.id;
      const ativo = f.ativo !== false;
      
      if (ativo) {
        totalAtivos += (f.valor || 0);
      } else {
        totalInativos += (f.valor || 0);
      }
      
      const card = document.createElement('div');
      card.className = `fixo-card section-card p-3 sm:p-4 ${ativo ? 'ativo' : 'inativo'}`;
      const statusBadgeClass = ativo ? 'fixo-status-badge fixo-status-ativo' : 'fixo-status-badge fixo-status-inativo';
      const toggleClass = ativo ? 'fixo-action-btn fixo-action-toggle' : 'fixo-action-btn fixo-action-resume';
      const toggleLabel = ativo ? 'Pausar' : 'Retomar';
      const toggleIcon = ativo ? 'fa-pause' : 'fa-play';
      card.innerHTML = `
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div class="flex-1 min-w-[9rem] sm:min-w-[12rem] fixo-meta">
            <div class="fixo-title font-semibold text-slate-900 dark:text-slate-100 leading-snug">${f.nome || ''}</div>
            ${f.categoria ? `<span class="fixo-category-pill">${f.categoria}</span>` : ''}
            ${f.subcategoria ? `<div class="fixo-subcategoria">${f.subcategoria}</div>` : ''}
          </div>
          <div class="flex flex-col items-end gap-2 text-right">
            <div class="fixo-amount font-semibold text-slate-900 dark:text-slate-100 leading-none">R$ ${moeda(f.valor)}</div>
            <span class="${statusBadgeClass}">
              <i class="fa-solid ${ativo ? 'fa-circle-check' : 'fa-circle'}"></i>
              ${ativo ? 'Ativo' : 'Pausado'}
            </span>
          </div>
        </div>
        <div class="fixo-actions pt-3 border-t border-slate-200/70 dark:border-slate-700/60">
          <button class="${toggleClass}" onclick="toggleAtivoFixo('${id}', ${ativo})" aria-label="${toggleLabel}" title="${toggleLabel}">
            <i class="fa-solid ${toggleIcon}"></i>
          </button>
          <button class="fixo-action-btn fixo-action-edit" onclick="editarFixoPrompt('${id}')" aria-label="Editar fixo" title="Editar">
            <i class="fa-solid fa-pen"></i>
          </button>
          <button class="fixo-action-btn fixo-action-delete" onclick="removerFixo('${id}')" aria-label="Excluir fixo" title="Excluir">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      `;
      container.appendChild(card);
    });
  }
  
  // Atualiza resumos
  document.getElementById('resumo-fixos-ativos').textContent = `R$ ${moeda(totalAtivos)}`;
  document.getElementById('resumo-fixos-inativos').textContent = `R$ ${moeda(totalInativos)}`;
}

function toggleAtivoFixo(id, atual) {
  userCollectionRef('fixos').doc(id).update(stampWorkspaceUpdate({ ativo: !atual }))
    .then(() => {
      showToast(`Gasto fixo ${!atual ? 'ativado' : 'desativado'} com sucesso!`);
      carregarFixos(); // Recarrega a lista para atualizar os botões
    })
    .catch(() => {
      showToast('Erro ao atualizar o gasto fixo.', 'error');
    });
}

function carregarFixos() {
  userCollectionRef('fixos').orderBy('nome').get().then(snapshot => {
    renderFixos(snapshot.docs);
  });
}

        function removerFixo(id) {
          abrirModalConfirmacao(
            'Remover Gasto Fixo',
            'Tem certeza que deseja remover este gasto fixo? Esta ação é irreversível.',
            () => { // Callback de confirmação
              userCollectionRef('fixos').doc(id).delete()
                .then(() => showToast('Fixo removido com sucesso!'))
                .catch(err => showToast('Erro ao remover fixo.', 'error'));
            }
          );
        }
        

function editarFixoPrompt(id){
  userCollectionRef('fixos').doc(id).get().then(doc=>{
    if(!doc.exists) {
      showToast('Documento não encontrado', 'error');
      return;
    }
    const d = doc.data();
    
    // Abre o modal com os dados para edição
    abrirModalFixo({
      id: id,
      nome: d.nome,
      categoria: d.categoria,
      subcategoria: d.subcategoria,
      valor: d.valor,
      ativo: d.ativo
    });
  });
}

document.getElementById('add-fixo-open').addEventListener('click', () => {
  abrirModalFixo();
});

// NOVO: Função para popular os selects de cartão
function popularSelectCartoes() {
  const selectsCartao = document.querySelectorAll('#modal-cartao, #p-cartao'); 
  
  selectsCartao.forEach(select => {
    const valorAtual = select.value; 
    select.innerHTML = ''; 
    // Adiciona a opção "PIX" primeiro
    const pixOption = document.createElement('option');
    pixOption.value = 'pix';
    pixOption.textContent = 'PIX';
    select.appendChild(pixOption);
    // Adiciona os outros cartões configurados
    const cartoesOrdenados = Object.keys(cartoesCfg).filter(key => key !== 'pix').sort((a, b) => {
      const labelA = (cartoesCfg[a]?.label || a).toLowerCase();
      const labelB = (cartoesCfg[b]?.label || b).toLowerCase();
      return labelA.localeCompare(labelB);
    });
    cartoesOrdenados.forEach(key => {
      const option = document.createElement('option');
      option.value = key; // O 'key' é o ID gerado
      option.textContent = cartoesCfg[key].label; // O 'label' é o nome amigável
      select.appendChild(option);
    });
    // Adiciona a opção "Nenhum" por último
    const nenhumOption = document.createElement('option');
    nenhumOption.value = '';
    nenhumOption.textContent = 'Nenhum';
    select.appendChild(nenhumOption);
    // Tenta restaurar o valor selecionado
    if (select.querySelector(`option[value="${valorAtual}"]`)) {
      select.value = valorAtual;
    } else {
      select.value = 'pix'; 
    }
  });
  atualizarMesFaturaEstimado(); 
}



// Event listeners para o modal de gerenciamento de cartões
btnGerenciarCartoes.addEventListener('click', abrirModalGerenciarCartoes);
modalGerenciarCartoesClose.addEventListener('click', fecharModalGerenciarCartoes);
modalGerenciarCartoes.addEventListener('click', (e) => {
  if (e.target === modalGerenciarCartoes) {
    fecharModalGerenciarCartoes();
  }
});

// Event listener para o formulário de adicionar novo cartão
formAddCartao.addEventListener('submit', (e) => {
  e.preventDefault();
  // const id = document.getElementById('novo-cartao-id').value.toLowerCase().trim(); // REMOVER ESTA LINHA
  const label = document.getElementById('novo-cartao-label').value.trim();
  const fechamentoInput = document.getElementById('novo-cartao-fechamento').value;
  const fechamento = fechamentoInput ? parseInt(fechamentoInput) : null;
  // NOVO: Gerar o ID interno a partir do label
  // Remove espaços, converte para minúsculas e remove caracteres especiais
  const id = label.toLowerCase().replace(/[^a-z0-9]/g, ''); 
  if (!label) { // Agora só precisamos validar o label
    showToast('O Nome do Cartão é obrigatório.', 'error');
    return;
  }
  if (id === 'pix') {
    showToast('O nome "PIX" (ou similar) é reservado e não pode ser usado para um novo cartão.', 'error');
    return;
  }
  if (cartoesCfg[id]) {
    showToast(`Já existe um cartão com o nome "${label}" (ID interno: ${id}). Por favor, use um nome único.`, 'error');
    return;
  }
  if (fechamento !== null && (isNaN(fechamento) || fechamento < 1 || fechamento > 31)) {
    showToast('Dia de fechamento inválido. Use um número entre 1 e 31 ou deixe vazio.', 'error');
    return;
  }
  const offset = parseInt(document.getElementById('novo-cartao-offset').value) || 1;  // <-- NOVO
  cartoesCfg[id] = { label, fechamento, mesVencimentoOffset: offset };  // <-- NOVO: Salva offset
  userDocRef('config', 'cartoes').set(cartoesCfg, { merge: true })
    .then(() => {
      showToast('Cartão adicionado com sucesso!');
      formAddCartao.reset();
      renderListaCartoesExistentes(); // Atualiza a lista no modal
      startObservers(); 
    })
    .catch(err => showToast('Erro ao adicionar cartão: ' + err.message, 'error'));
});



/* ===========================
   NOVO: GRÁFICOS DOS FIXOS
   =========================== */
let chartFixosCategoria = null;
let chartFixosImpacto = null;

function renderGraficosFixos() {
  if (!allFixosDocs || allFixosDocs.length === 0) {
    showToast('Nenhum gasto fixo encontrado para análise.', 'error');
    return;
  }

  const fixosAtivos = allFixosDocs.filter(doc => doc.data().ativo !== false);
  const fixosInativos = allFixosDocs.filter(doc => doc.data().ativo === false);

  // Calcula totais
  const totalAtivos = fixosAtivos.reduce((sum, doc) => sum + (doc.data().valor || 0), 0);
  const totalInativos = fixosInativos.reduce((sum, doc) => sum + (doc.data().valor || 0), 0);

  // Atualiza totais no modal
  document.getElementById('total-fixos-ativos').textContent = `R$ ${moeda(totalAtivos)}`;
  document.getElementById('total-fixos-inativos').textContent = `R$ ${moeda(totalInativos)}`;

  // Gráfico por categoria (apenas fixos ativos)
  const categorias = {};
  fixosAtivos.forEach(doc => {
    const categoria = doc.data().categoria || 'Outros';
    categorias[categoria] = (categorias[categoria] || 0) + (doc.data().valor || 0);
  });

  renderGraficoFixosCategoria(categorias);
  renderGraficoFixosImpacto(fixosAtivos);
  renderDetalhesFixos(fixosAtivos);
}

function renderGraficoFixosCategoria(categorias) {
  const labels = Object.keys(categorias);
  const data = Object.values(categorias);

  const ctx = document.getElementById('grafico-fixos-categoria').getContext('2d');
  if (chartFixosCategoria) chartFixosCategoria.destroy();
  
  chartFixosCategoria = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        label: 'Fixos por Categoria',
        data,
        backgroundColor: [
          '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'
        ],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { 
          position: 'bottom',
          labels: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151' // Cor da legenda
          }
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const label = ctx.label || '';
              const value = ctx.parsed || 0;
              const total = ctx.dataset.data.reduce((a,b) => a+b, 0);
              const pct = total ? ((value / total) * 100).toFixed(1) : 0;
              return `${label}: R$ ${moeda(value)} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

function renderGraficoFixosImpacto(fixosAtivos) {
  const labels = fixosAtivos.map(doc => doc.data().nome || 'Sem nome');
  const data = fixosAtivos.map(doc => doc.data().valor || 0);
  const metaOrcamentoFixo = getEnvelopeMeta('fixo') || 0;
  const percentuais = data.map(valor => metaOrcamentoFixo ? (valor / metaOrcamentoFixo * 100).toFixed(1) : '0.0');

  const ctx = document.getElementById('grafico-fixos-impacto').getContext('2d');
  if (chartFixosImpacto) chartFixosImpacto.destroy();

  chartFixosImpacto = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Impacto no Orçamento (%)',
        data: percentuais,
        backgroundColor: data.map(valor => valor > (metaOrcamentoFixo * 0.2) ? '#ef4444' : '#10b981'),
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            callback: val => `${val}%`,
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151' // Cor dos ticks
          },
          grid: {
            color: html.classList.contains('dark') ? '#4b5563' : '#e5e7eb' // Cor da grid
          }
        },
        x: {
          ticks: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151' // Cor dos ticks
          },
          grid: {
            color: html.classList.contains('dark') ? '#4b5563' : '#e5e7eb' // Cor da grid
          }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.parsed.y}% do orçamento (R$ ${moeda(data[ctx.dataIndex])})`
          }
        }
      }
    }
  });
}

function renderDetalhesFixos(fixosAtivos) {
  const container = document.getElementById('detalhes-fixos');
  container.innerHTML = '';

  // Ordena por valor (maior primeiro)
  const ordenados = fixosAtivos.sort((a, b) => (b.data().valor || 0) - (a.data().valor || 0));

  ordenados.forEach(doc => {
    const f = doc.data();
    const percentual = metaOrcamentoFixo ? ((f.valor || 0) / metaOrcamentoFixo * 100).toFixed(1) : 0;
    const isAlto = metaOrcamentoFixo ? ((f.valor || 0) > (metaOrcamentoFixo * 0.2)) : false;

    const item = document.createElement('div');
    item.className = `flex justify-between items-center p-2 rounded ${isAlto ? 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700' : 'bg-gray-50 dark:bg-gray-700'}`;
    item.innerHTML = `
      <div class="flex-1">
        <div class="font-semibold text-sm">${f.nome || 'Sem nome'}</div>
        <div class="text-xs text-gray-500 dark:text-gray-400">${f.categoria || 'Outros'}${f.subcategoria ? ` › ${f.subcategoria}` : ''}</div>
      </div>
      <div class="text-right">
        <div class="font-bold ${isAlto ? 'text-red-600 dark:text-red-400' : 'text-gray-700 dark:text-gray-100'}">R$ ${moeda(f.valor)}</div>
        <div class="text-xs ${isAlto ? 'text-red-500 dark:text-red-300' : 'text-gray-500 dark:text-gray-400'}">${percentual}% do orçamento</div>
      </div>
    `;
    container.appendChild(item);
  });
}

// Event listeners para gráficos dos fixos
document.getElementById('btn-graficos-fixos').addEventListener('click', () => {
  document.getElementById('modal-graficos-fixos').classList.remove('hidden');
  renderGraficosFixos();
});

document.getElementById('modal-graficos-fixos-close').addEventListener('click', () => {
  document.getElementById('modal-graficos-fixos').classList.add('hidden');
  if (chartFixosCategoria) {
    chartFixosCategoria.destroy();
    chartFixosCategoria = null;
  }
  if (chartFixosImpacto) {
    chartFixosImpacto.destroy();
    chartFixosImpacto = null;
  }
});

/* ===========================
   PARCELADOS - CORRIGIDO E MELHORADO
   =========================== */
function renderParcelados(docs){
  const tbody = document.getElementById('parcelados-list');
  tbody.innerHTML='';
  const scrollWrapper = document.getElementById('parcelados-table-wrapper');

  const mesKey = document.getElementById('filtro-mes').value;
  const hoje = new Date();
  const alvoKey = (mesKey === 'all' || !mesKey) ? yyyymm(hoje) : mesKey;
  const [ay,am] = alvoKey.split('-');
  let refDate = new Date(parseInt(ay), parseInt(am)-1, 1); // Data de referência para o mês selecionado
  if (Number.isNaN(refDate.getTime())) {
    refDate = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
  }

  renderGraficoParceladosProjecao(docs, refDate);

  let totalMes=0, totalRestante=0, countAtivos=0;

  const filteredDocs = docs.filter(doc => {
    const p = doc.data();
    const inicio = p.dataInicio && p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio);
    const diff = monthDiff(inicio, refDate);
    const ativaNoMes = diff >= 0 && diff < p.numParcelas;
    
    return ativaNoMes;
  });

  if(!filteredDocs.length){
    tbody.innerHTML='<tr><td class="td" colspan="8">Nenhum parcelado para o mês selecionado</td></tr>';
    document.getElementById('p-total-mes').textContent = moeda(0);
    document.getElementById('p-total-restante').textContent = moeda(0);
    document.getElementById('p-ativos').textContent = String(0);
    atualizarBarra('parcelado', 0);
    resumo.parcelasMes = 0;
    if (scrollWrapper) {
      scrollWrapper.classList.remove('parcelados-scroll');
    }
    return;
  }

  filteredDocs.forEach(doc=>{
    const p = doc.data();
    const id = doc.id;
    const inicio = p.dataInicio && p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio);
    const fim = addMonths(inicio, p.numParcelas-1);

    // CORREÇÃO: Calcula a parcela atual baseada no mês de referência (filtro), não na data atual
    const parcelaAtualIndex = Math.max(0, Math.min(p.numParcelas-1, monthDiff(inicio, refDate)));
    const parcelaAtual = parcelaAtualIndex + 1;
    const restantes = Math.max(0, p.numParcelas - parcelaAtual);
    const restanteValor = restantes * (p.valorParcela||0);
    const progressPercent = pct(parcelaAtual, p.numParcelas);

    // Determina o status do parcelado
    let status = 'ativo';
    let statusClass = 'parcelado-ativo';
    if (parcelaAtual >= p.numParcelas) {
      status = 'finalizado';
      statusClass = 'parcelado-finalizado';
    } else if (monthDiff(inicio, refDate) < 0) {
      status = 'futuro';
      statusClass = 'parcelado-futuro';
    }

    totalMes += (p.valorParcela||0);
    countAtivos++; 
    totalRestante += restanteValor; 

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="td">${p.descricao||''}</td>
      <td class="td">R$ ${moeda(p.valorParcela)}</td>
      <td class="td">
        <div class="flex items-center gap-2">
          <span class="text-sm font-semibold">${parcelaAtual}/${p.numParcelas}</span>
          <div class="flex-1">
            <div class="progress-parcelado">
              <div class="progress-parcelado-fill ${status === 'finalizado' ? 'progress-finalizado' : 'progress-ativo'}" style="width:${progressPercent}%"></div>
            </div>
          </div>
        </div>
      </td>
      <td class="td">
        <span class="parcelado-status ${statusClass}">
          ${status === 'ativo' ? 'Em andamento' : status === 'finalizado' ? 'Finalizado' : 'Futuro'}
        </span>
      </td>
      <td class="td">${p.cartao||''}</td>
      <td class="td">${mmYYYY(yyyymm(inicio))}</td>
      <td class="td">${mmYYYY(yyyymm(fim))}</td>
      <td class="td">
        <button class="text-blue-600 dark:text-blue-400 mr-2 hover:text-blue-800 dark:hover:text-blue-200" onclick="editarParceladoPrompt('${id}')" title="Editar">
          <i class="fa fa-edit"></i>
        </button>
        <button class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-200" onclick="removerParcelado('${id}')" title="Remover">
          <i class="fa fa-trash"></i>
        </button>
      </td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('p-total-mes').textContent = moeda(totalMes);
  document.getElementById('p-total-restante').textContent = moeda(totalRestante);
  document.getElementById('p-ativos').textContent = String(countAtivos);

  atualizarBarra('parcelado', totalMes);
  resumo.parcelasMes = totalMes;

  if (scrollWrapper) {
    scrollWrapper.classList.toggle('parcelados-scroll', filteredDocs.length > 7);
  }
}

function fecharTodosOsModais() {
  document.getElementById('modal-add-gasto').classList.add('hidden');
  document.getElementById('modal-fixo').classList.add('hidden');
  document.getElementById('modal-parcelado').classList.add('hidden');
  document.getElementById('modal-graficos').classList.add('hidden');
  document.getElementById('modal-graficos-fixos').classList.add('hidden');
  document.getElementById('modal-gerenciar-cartoes').classList.add('hidden');
}

function editarParceladoPrompt(id){
  userCollectionRef('parcelados').doc(id).get().then(doc=>{
    if(!doc.exists) {
      showToast('Parcelado não encontrado', 'error');
      return;
    }
    const p = doc.data();
    
    // Abre o modal com os dados para edição
    abrirModalParcelado({
      id: id,
      descricao: p.descricao,
      valorParcela: p.valorParcela,
      numParcelas: p.numParcelas,
      cartao: p.cartao,
      dataInicio: p.dataInicio && p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio)
    });
  });
}



        function removerParcelado(id){ 
          abrirModalConfirmacao(
            'Remover Parcelado',
            'Tem certeza que deseja remover este parcelado? Esta ação é irreversível.',
            () => { // Callback de confirmação
              userCollectionRef('parcelados').doc(id).delete()
                .then(() => showToast('Parcelado removido com sucesso!'))
                .catch(err => showToast('Erro ao remover parcelado.', 'error'));
            }
          );
        }
        

/* ===========================
   CARTÕES (compact sidebar + edit fechamento)
   =========================== */
function renderCartoes(totaisPorCartao){
  const container=document.getElementById('cartoes-container'); container.innerHTML='';
  const hoje=new Date();
  
  const cartoesOrdenados = Object.keys(cartoesCfg).filter(k => k !== 'pix').sort((a, b) => {
    const labelA = (cartoesCfg[a]?.label || a).toLowerCase();
    const labelB = (cartoesCfg[b]?.label || b).toLowerCase();
    return labelA.localeCompare(labelB);
  });
  if (cartoesOrdenados.length === 0) {
    container.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 col-span-full py-4">Nenhum cartão configurado.</div>';
    return;
  }
  cartoesOrdenados.forEach(k=>{
    const cfg = cartoesCfg[k]||cartoesCfgDefault[k]||{label:k, fechamento:null};
    const tot = moeda(totaisPorCartao[k]||0);
    const fechamento = cfg.fechamento;
    
    let diasParaFechamento = null;
    let textoFechamento = 'Sem fechamento';
    let alertaClass = '';
    if (fechamento !== null && fechamento !== undefined) {
      const diaAtual = hoje.getDate();
      let dataFechamento = new Date(hoje.getFullYear(), hoje.getMonth(), fechamento);
      
      if (diaAtual > fechamento) {
        dataFechamento.setMonth(dataFechamento.getMonth() + 1);
      }
      
      const diffTime = Math.abs(dataFechamento.getTime() - hoje.getTime());
      diasParaFechamento = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      textoFechamento = `Fecha dia ${fechamento}`;
      if (diasParaFechamento <= 3 && diasParaFechamento >= 0) {
        textoFechamento += ` (em ${diasParaFechamento}d)`;
        alertaClass = 'text-red-600 dark:text-red-400 font-bold';
      } else if (diasParaFechamento < 0) {
        textoFechamento = `Fechou dia ${fechamento} (atrasado)`;
        alertaClass = 'text-red-600 dark:text-red-400 font-bold';
      }
    }
    
    const card = document.createElement('div');
    card.className = 'section-card p-3 border-l-4 border-blue-500 dark:border-blue-400';
    card.innerHTML = `
      <div class="flex justify-between items-center mb-1">
        <div class="text-gray-800 dark:text-gray-100 font-semibold">${cfg.label}</div>
        <div class="text-sm text-gray-500 dark:text-gray-400">${textoFechamento}</div>
      </div>
      <div class="text-lg font-bold ${alertaClass}">R$ ${tot}</div>
      <div class="mt-2 flex justify-end">
        <!-- MODIFICADO AQUI: O botão "Editar" agora abre o modal de gerenciamento de cartões -->
        <button class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" onclick="abrirModalGerenciarCartoes()" title="Gerenciar este cartão">Editar</button>
      </div>`;
    container.appendChild(card);
  });
}

function editarFechamentoPrompt(key){
   if (key === 'pix') { // <- ADICIONE ESTA LINHA: Impede edição de fechamento para PIX
        showToast('PIX não possui dia de fechamento.', 'info');
        return;
      }
  const cfg = cartoesCfg[key] || cartoesCfgDefault[key] || {fechamento:null};
  const novo = prompt('Dia de fechamento (número, ex: 15) — deixe vazio para remover:', cfg.fechamento!==null? String(cfg.fechamento):'');
  if(novo === null) return;
  const val = novo.trim()==='' ? null : parseInt(novo);
  if (val !== null && (isNaN(val) || val < 1 || val > 31)) {
    showToast('Dia de fechamento inválido. Use um número entre 1 e 31 ou deixe vazio.', 'error');
    return;
  }
  cartoesCfg[key] = {...(cartoesCfg[key]||{}), fechamento: val, label: (cartoesCfg[key] && cartoesCfg[key].label) || cartoesCfgDefault[key].label};
  userDocRef('config', 'cartoes').set(cartoesCfg, {merge:true})
    .then(() => showToast('Configurações de cartões atualizadas!'))
    .catch(err => showToast('Erro ao atualizar configurações de cartões.', 'error'));
}

/* ===========================
   HISTÓRICO (gastos normais) + edição inline
   =========================== */
// REMOVIDO: renderHistorico (substituído por renderHistoricoWithFilters)

function editarGasto(id, campo, valor){
  const update = {}; update[campo] = campo==='valor' ? (parseFloat(valor)||0) : valor;
  userCollectionRef('gastos').doc(id).update(stampWorkspaceUpdate(update))
    .then(() => showToast('Gasto atualizado!'))
    .catch(err => showToast('Erro ao atualizar gasto.', 'error'));
}

/* ===========================
   EXPORT CSV
   =========================== */
function exportarCSVmes(){
  const mesSel = document.getElementById('filtro-mes').value;
  userCollectionRef('gastos').orderBy('data','desc').get().then(snap=>{
    const linhas=[['Data Transação','Mês Fatura','Tipo','Cartão/PIX','Descrição','Valor','Categoria']];
    snap.forEach(doc=>{
      const d=doc.data();
      if(!d.data) return;
      const dt = d.data.toDate ? d.data.toDate() : new Date(d.data);
      const keyTransacao = yyyymm(dt);
      const keyFatura = d.mesFatura || keyTransacao; // Usa mesFatura para filtragem

      if(mesSel!=='all' && keyFatura!==mesSel) return; // Filtra por mesFatura
      linhas.push([dt.toLocaleDateString('pt-BR'), mmYYYY(keyFatura), d.tipo||'', d.cartao||'', (d.descricao||'').replace(/"/g,'""'), String(d.valor||0), d.categoria||'']);
    });
    const csv = linhas.map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download = (mesSel==='all' ? 'gastos_todos.csv' : `gastos_${mesSel}.csv`); a.click(); URL.revokeObjectURL(url);
    showToast('CSV do mês exportado!');
  }).catch(err => showToast('Erro ao exportar CSV do mês.', 'error'));
}
function exportarCSVtudo(){
  if (!currentUser) return;
  Promise.all([
    userCollectionRef('gastos').orderBy('data','desc').get(),
    userCollectionRef('parcelados').orderBy('dataInicio','desc').get(),
  ]).then(([gastoSnap, parcSnap])=>{ 
    let csv = 'Tipo,Data Transação,Mês Fatura,Cartão/PIX,Descrição,Valor,Parcelas,Observação,Categoria\n'; // MODIFICADO HEADER
    gastoSnap.forEach(doc=>{
      const d=doc.data(); 
      const dt = d.data.toDate? d.data.toDate() : new Date(d.data);
      const keyTransacao = yyyymm(dt);
      const keyFatura = d.mesFatura || keyTransacao;
      csv += `gasto,"${dt.toLocaleDateString('pt-BR')}","${mmYYYY(keyFatura)}","${d.cartao||''}","${(d.descricao||'').replace(/"/g,'""')}",${d.valor||0},1,,"${d.categoria||''}"\n`;
    });
    parcSnap.forEach(doc=>{
      const p=doc.data();
      csv += `parcelado,"${mmYYYY(yyyymm(p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio)))}","${mmYYYY(yyyymm(p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio)))}","${p.cartao||''}","${(p.descricao||'').replace(/"/g,'""')}",${p.valorParcela||0},${p.numParcelas},parcelado,\n`;
    });

    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='dados_financeiros_completos.csv'; a.click(); URL.revokeObjectURL(url); // MODIFICADO NOME DO ARQUIVO
    showToast('Todos os dados exportados para CSV!');
  }).catch(err => showToast('Erro ao exportar todos os dados para CSV.', 'error'));
}


/* ===========================
   ATUALIZAÇÕES & SNAPSHOTS
   =========================== */

let unsubLimits, unsubFixos, unsubGastos, unsubParcelados, unsubConfig, unsubEntradas, unsubInvestimentos;
let allParceladosDocs = [];
let allGastosDocs = [];

// Funções para mostrar/ocultar spinners
function showSpinner(id) {
  const el = document.getElementById(id);
  if (el) el.classList.remove('spinner-hidden');
}
function hideSpinner(id) {
  const el = document.getElementById(id);
  if (el) el.classList.add('spinner-hidden');
}

function startObservers(){
  // Desinscrever observers antigos para evitar múltiplos listeners
  if (unsubLimits) unsubLimits();
  if (unsubConfig) unsubConfig();
  if (unsubFixos) unsubFixos();
  if (unsubGastos) unsubGastos();
  if (unsubParcelados) unsubParcelados();
  if (unsubEntradas) unsubEntradas();
  if (unsubInvestimentos) unsubInvestimentos();

  // Mostrar spinners antes de carregar os dados
  showSpinner('historico-loading-spinner');
  showSpinner('fixos-loading-spinner');
  showSpinner('parcelados-loading-spinner');
  showSpinner('cartoes-loading-spinner'); // Adicionado spinner para cartões

  if (!currentUser) return;

  unsubLimits = userDocRef('limites', 'conta_unica').onSnapshot(doc=>{
    envelopes = normalizarEnvelopesDoc(doc.exists ? doc.data() : {});
    atualizarInputsEnvelopes();
    atualizarBarrasVisuais();
    gerarInsights();
  }, err => {
    console.error("Erro ao carregar envelopes:", err);
    showToast('Erro ao carregar envelopes.', 'error');
  });

  unsubConfig = userDocRef('config', 'cartoes').onSnapshot(snap=>{
    if(snap.exists) cartoesCfg = {...cartoesCfgDefault, ...snap.data()};
    renderCartoes(window._totaisPorCartaoHistorico || {});
    popularSelectCartoes(); // <--- NOVO: Chama para atualizar os selects
    hideSpinner('cartoes-loading-spinner'); // Oculta spinner de cartões
  }, err => {
    console.error("Erro ao carregar configurações de cartões:", err);
    showToast('Erro ao carregar configurações de cartões.', 'error');
    hideSpinner('cartoes-loading-spinner');
  });

  unsubEntradas = userCollectionRef('entradas').orderBy('data','desc').onSnapshot(snap => {
    renderEntradasSidebar(snap.docs);
  }, err => {
    console.error('Erro ao carregar entradas:', err);
    showToast('Erro ao carregar entradas.', 'error');
  });

  unsubInvestimentos = userCollectionRef('investimentos').orderBy('data','desc').onSnapshot(snap => {
    renderInvestimentosSidebar(snap.docs);
  }, err => {
    console.error('Erro ao carregar investimentos:', err);
    showToast('Erro ao carregar investimentos.', 'error');
  });


  unsubFixos = userCollectionRef('fixos').orderBy('nome','asc').onSnapshot(snap=>{
    hideSpinner('fixos-loading-spinner'); // Oculta spinner de fixos
    allFixosDocs = snap.docs; // Garante que allFixosDocs seja atualizado
    renderFixos(snap.docs);
    atualizarTudoComParcelados(); // Recalcula totais após fixos serem carregados
  }, err => {
    console.error("Erro ao carregar fixos:", err);
    hideSpinner('fixos-loading-spinner'); // Oculta spinner de fixos em caso de erro
    showToast('Erro ao carregar fixos.', 'error');
  });
  


  // === SEÇÃO CORRIGIDA: OBSERVER DE GASTOS ===
  unsubGastos = userCollectionRef('gastos').orderBy('data','desc').onSnapshot(snap=>{
    hideSpinner('historico-loading-spinner'); // Oculta spinner de histórico
    allGastosDocs = snap.docs; // ATUALIZA allGastosDocs AQUI

    const mesSel = document.getElementById('filtro-mes').value || yyyymm(new Date());
    
    let somaVariavel = 0;
    let somaFixoAvulso = 0;
    let totaisPorCartaoHist = {};
    let totaisPorCategoria = {}; // Objeto para armazenar totais por categoria

    mesesDisponiveis = new Set();
    const docsToProcessForMonth = [];
    allGastosDocs.forEach(doc=>{
      const d = doc.data();
      if(!d.data) return;
      const dt = d.data.toDate? d.data.toDate() : new Date(d.data);
      const keyTransacao = yyyymm(dt); // Mês da transação
      const keyFatura = d.mesFatura || keyTransacao; // Usa mesFatura se existir, senão usa mês da transação

      mesesDisponiveis.add(keyFatura); // Adiciona o mês da fatura aos meses disponíveis

      if(mesSel === 'all' || keyFatura === mesSel) { // FILTRA POR mesFatura
        docsToProcessForMonth.push(doc);
        const tipo = (d.tipo || '').toLowerCase();
        if(tipo === 'variavel') somaVariavel += (d.valor || 0);
        if(tipo === 'fixo') somaFixoAvulso += (d.valor || 0);
        if(d.cartao) totaisPorCartaoHist[d.cartao] = (totaisPorCartaoHist[d.cartao]||0) + (d.valor||0);
        
        // Soma por categoria para o mês selecionado
        if(d.categoria) totaisPorCategoria[d.categoria] = (totaisPorCategoria[d.categoria]||0) + (d.valor||0);
      }
    });

    renderHistoricoWithFilters(); // Chama a função de renderização com filtros
    renderCategorias(totaisPorCategoria);

    resumo.historicoMes = somaVariavel + somaFixoAvulso;
    resumo.pixMes = (docsToProcessForMonth.filter(d=>d.data().cartao==='pix').reduce((a,b)=>a + (b.data().valor||0),0) || 0);
    window._totaisPorCartaoHistorico = totaisPorCartaoHist || {};
    
    // ATRIBUIÇÃO DA VARIÁVEL GLOBAL PARA O GRÁFICO (mantido para compatibilidade, mas o novo modal usa allGastosDocs diretamente)
    window._totaisPorCategoriaAtual = totaisPorCategoria; 
    
    atualizarBarra('variavel', somaVariavel + somaFixoAvulso); 

    // Salva soma de variáveis para uso no banner de alertas
    window._somaVariavelAtual = somaVariavel + somaFixoAvulso;

    atualizarTudoComParcelados();
    atualizarFiltroMeses();
    
    // NOVO: Gera insights inteligentes
    setTimeout(() => gerarInsights(), 500);

    // NOVO: Chama aplicarFiltros() aqui para garantir que os gráficos sejam renderizados
    // com os dados mais recentes assim que o modal for aberto.
    // Isso é importante porque allGastosDocs é populado aqui.
    if (!modalGraficos.classList.contains('hidden')) { // Apenas se o modal já estiver aberto
        aplicarFiltros();
    }

  }, err => {
    console.error("Erro ao carregar gastos:", err);
    hideSpinner('historico-loading-spinner'); // Oculta spinner de histórico em caso de erro
    showToast('Erro ao carregar histórico de gastos.', 'error');
  });

  unsubParcelados = userCollectionRef('parcelados').orderBy('dataInicio','desc').onSnapshot(snap=>{
    hideSpinner('parcelados-loading-spinner'); // Oculta spinner de parcelados
    allParceladosDocs = snap.docs;
    
    mesesParceladosColetados = new Set();
    snap.docs.forEach(doc=>{
      const p = doc.data();
      const inicio = p.dataInicio && p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio);
      for(let i=0;i<p.numParcelas;i++){
        mesesParceladosColetados.add( yyyymm(addMonths(inicio,i)) );
      }
    });

    renderParcelados(allParceladosDocs);
    atualizarTudoComParcelados();
    atualizarFiltroMeses();
  }, err => {
    console.error("Erro ao carregar parcelados:", err);
    hideSpinner('parcelados-loading-spinner'); // Oculta spinner de parcelados em caso de erro
    showToast('Erro ao carregar parcelados.', 'error');
  });
}

function atualizarTudoComParcelados(){
  // referência ao mês selecionado (mantém compatibilidade com 'all')
  const mesSel = document.getElementById('filtro-mes').value || yyyymm(new Date());
  const targetKey = mesSel==='all' ? yyyymm(new Date()) : mesSel;
  const [ty,tm] = targetKey.split('-'); 
  const refDate = new Date(parseInt(ty), parseInt(tm)-1,1);

  const parcSnapDocs = allParceladosDocs || []; 
  let parcelasMesTotal = 0;
  let totaisPorCartao = {...(window._totaisPorCartaoHistorico || {})};
  let totalRestanteParcelados = 0;

  parcSnapDocs.forEach(doc=>{
    const p = (typeof doc.data === 'function') ? doc.data() : doc;
    const inicio = p.dataInicio && p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio);
    
    // conta parcelas que caem no mês de referência (para 'parcelas no mês')
    const diff = monthDiff(inicio, refDate);
    if(diff>=0 && diff < (p.numParcelas||0)){
      parcelasMesTotal += (p.valorParcela||0);
      if(p.cartao) totaisPorCartao[p.cartao] = (totaisPorCartao[p.cartao]||0) + (p.valorParcela||0);
    }
    
    // --- CORREÇÃO IMPORTANTE ---
    // usa refDate (mês selecionado) para calcular quantas parcelas RESTAM a partir desse mês
   const parcelaAtualIndex = Math.max(0, Math.min((p.numParcelas||1)-1, monthDiff(inicio, refDate)));
const parcelaAtual = parcelaAtualIndex + 1;
// calcula o total comprometido a partir do mês selecionado (inclui o mês atual)
const restantesIncluindoAtual = Math.max(0, (p.numParcelas || 0) - diff);
totalRestanteParcelados += restantesIncluindoAtual * (p.valorParcela || 0);

  });

  resumo.parcelasMes = parcelasMesTotal;
  renderCartoes(totaisPorCartao);

  resumo.cartoesMes = Object.entries(totaisPorCartao).filter(([k])=>k!=='pix').reduce((acc,[,v])=> acc + (v||0), 0);
  resumo.pixMes = (window._totaisPorCartaoHistorico && window._totaisPorCartaoHistorico['pix']) || resumo.pixMes || 0;

  document.getElementById('p-total-restante').textContent = moeda(totalRestanteParcelados);

  // === FIXOS ===
    userCollectionRef('fixos').get().then(fixSnap=>{
      const somaFixosAtivos = fixSnap.docs.reduce((a,d)=> 
        a + ((d.data().ativo && d.data().valor) ? d.data().valor : 0), 0);

      // salva no resumo para entrar no total geral
      resumo.fixosMes = somaFixosAtivos;

let totalGastosAcumulado = 0;
// Gastos variáveis (todos realizados)
allGastosDocs.forEach(doc => totalGastosAcumulado += (doc.data().valor || 0));
// Parcelados: Somar apenas parcelas pagas até agora (não o total futuro)
const hoje = new Date();
allParceladosDocs.forEach(doc => {
  const p = doc.data();
  const inicio = p.dataInicio && p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio);
  const parcelasPagas = Math.max(0, monthDiff(inicio, hoje) + 1); // Parcelas pagas até agora
  const valorPagas = Math.min(parcelasPagas, p.numParcelas || 1) * (p.valorParcela || 0);
  totalGastosAcumulado += valorPagas;
});
// Fixos: Somar valor mensal * número de meses com dados (aproximação)
const mesesComDados = new Set([...mesesDisponiveis, ...mesesParceladosColetados]);
allFixosDocs.forEach(doc => {
  if (doc.data().ativo !== false) {
    totalGastosAcumulado += (doc.data().valor || 0) * mesesComDados.size; // Multiplica pelo número de meses únicos
  }
});


      // Verifica todos os tipos de gastos que ultrapassam o limite
      const metaParcelado = getEnvelopeMeta('parcelado');
      const metaFixoAtual = getEnvelopeMeta('fixo');
      const metaVariavel = getEnvelopeMeta('variavel');
      const triggerParcelado = metaParcelado > 0 && parcelasMesTotal > metaParcelado;
      const triggerFixo = metaFixoAtual > 0 && somaFixosAtivos > metaFixoAtual;
      const somaVariavel = window._somaVariavelAtual || 0;
      const triggerVariavel = metaVariavel > 0 && somaVariavel > metaVariavel;
      
      const banner = document.getElementById('danger-banner');
      const alertas = [];

      if(triggerFixo) {
        alertas.push(`<strong>Fixos:</strong> R$ ${moeda(somaFixosAtivos)} / R$ ${moeda(metaFixoAtual)} (${((somaFixosAtivos/metaFixoAtual)*100).toFixed(1)}%)`);
      }

      if(triggerParcelado) {
        alertas.push(`<strong>Parcelados:</strong> R$ ${moeda(parcelasMesTotal)} / R$ ${moeda(metaParcelado)} (${((parcelasMesTotal/metaParcelado)*100).toFixed(1)}%)`);
      }

      if(triggerVariavel) {
        alertas.push(`<strong>Variáveis:</strong> R$ ${moeda(somaVariavel)} / R$ ${moeda(metaVariavel)} (${((somaVariavel/metaVariavel)*100).toFixed(1)}%)`);
      }

      if(alertas.length > 0) {
        banner.style.display = 'block';
        banner.innerHTML = `
          <div class="flex items-start gap-2">
            <span class="text-xl">🚨</span>
            <div class="flex-1">
              <div class="font-bold mb-2">Atenção: Limite(s) ultrapassado(s)!</div>
              <div class="space-y-1">
                ${alertas.map(alerta => `<div class="text-sm">• ${alerta}</div>`).join('')}
              </div>
              <div class="text-xs mt-2 text-red-800 dark:text-red-300">
                💡 <strong>Dica:</strong> Considere revisar gastos desnecessários ou ajustar seus limites.
              </div>
            </div>
          </div>
        `;
      } else {
        banner.style.display = 'none';
      }

      document.getElementById('gasto-fixo').textContent = moeda(somaFixosAtivos);
      atualizarBarra('fixo', somaFixosAtivos);

      // agora que já temos fixos, atualiza resumo
      atualizarResumoUI();
    });
}


function atualizarResumoUI(){

  const totalGastosPrevistosMes = (resumo.historicoMes || 0) + (resumo.parcelasMes || 0) + (resumo.fixosMes || 0);
  document.getElementById('resumo-total-mes').textContent = moeda(totalGastosPrevistosMes); // Agora mostra a soma dos gastos

  document.getElementById('resumo-cartoes').textContent = moeda(resumo.cartoesMes||0);
  document.getElementById('resumo-pix').textContent = moeda(resumo.pixMes||0);
  document.getElementById('resumo-parcelas-mes').textContent = moeda(resumo.parcelasMes||0);

  painelFinanceiroState.totalGastosMes = totalGastosPrevistosMes;
  atualizarSaldoLiquidoEntradas();
  atualizarResumoRapido();
  atualizarResumoSaidasCard(totalGastosPrevistosMes);
  atualizarSaudeFinanceira();
}




function atualizarBarra(tipo, gasto){
  const envelope = envelopes[tipo] || envelopeConfig[tipo] || { meta: 0, reservado: 0 };
  const meta = Number(envelope.meta) || 0;
  const reservado = Number(envelope.reservado) || 0;
  const gastoAtual = Number(gasto) || 0;
  const comprometido = gastoAtual + reservado;
  const limiteLivre = Math.max(0, meta - comprometido);
  const excedente = comprometido > meta ? comprometido - meta : 0;
  const percentual = meta ? (comprometido / meta) * 100 : 0;
  const percentBar = Math.max(0, Math.min(100, percentual));

  const progressEl = document.getElementById(`progress-${tipo}`);
  const gastoEl = document.getElementById(`gasto-${tipo}`);
  const limiteLivreEl = document.getElementById(`limite-livre-${tipo}`);
  const reservaEl = document.getElementById(`reserva-${tipo}`);
  const disponivelEl = document.getElementById(`disponivel-${tipo}`);
  const percentualEl = document.getElementById(`percentual-${tipo}`);
  const metaEl = document.getElementById(`meta-${tipo}`);
  const excedenteWrapper = document.getElementById(`excedente-${tipo}-wrapper`);
  const excedenteEl = document.getElementById(`excedente-${tipo}`);
  const card = document.querySelector(`[data-envelope-card="${tipo}"]`);

  if (progressEl) progressEl.style.width = `${percentBar}%`;
  if (gastoEl) gastoEl.textContent = moeda(gastoAtual);
  if (metaEl) metaEl.textContent = moeda(meta);
  if (limiteLivreEl) limiteLivreEl.textContent = moeda(limiteLivre);
  if (reservaEl) reservaEl.textContent = moeda(reservado);
  if (disponivelEl) disponivelEl.textContent = moeda(limiteLivre);
  if (percentualEl) percentualEl.textContent = `${percentual.toFixed(1)}%`;
  if (excedenteWrapper && excedenteEl) {
    if (excedente > 0) {
      excedenteWrapper.classList.remove('hidden');
      excedenteEl.textContent = moeda(excedente);
    } else {
      excedenteWrapper.classList.add('hidden');
    }
  }

  if (card) {
    const estourado = excedente > 0 && meta > 0;
    card.classList.toggle('ring-2', estourado);
    card.classList.toggle('ring-red-400', estourado);
    card.classList.toggle('ring-offset-2', estourado);
  }
}

/* ===========================
   RENDER CATEGORIAS
   =========================== */
function renderCategorias(totaisPorCategoria){
  const container = document.getElementById('categorias-list');
  container.innerHTML = '';

  const categoriasOrdenadas = Object.keys(totaisPorCategoria).sort((a, b) => totaisPorCategoria[b] - totaisPorCategoria[a]);

  if (categoriasOrdenadas.length === 0) {
    container.innerHTML = '<div class="text-gray-500 dark:text-gray-400">Nenhum gasto categorizado no mês.</div>';
    return;
  }

  const totalGastosVariaveisMes = Object.values(totaisPorCategoria).reduce((sum, val) => sum + val, 0);

  categoriasOrdenadas.forEach(categoriaKey => {
    const totalGasto = totaisPorCategoria[categoriaKey];
    const percent = totalGastosVariaveisMes ? (totalGasto / totalGastosVariaveisMes) * 100 : 0;
    
    const categoriaNome = categoriaKey.charAt(0).toUpperCase() + categoriaKey.slice(1);

    const categoriaDiv = document.createElement('div');
    categoriaDiv.className = 'mb-2';
    categoriaDiv.innerHTML = `
      <div class="flex justify-between items-center mb-1">
        <div class="font-semibold">${categoriaNome}</div>
        <div class="text-sm text-gray-500 dark:text-gray-400">R$ ${moeda(totalGasto)}</div>
      </div>
      <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
        <div class="progress-bar bg-blue-400 h-2 rounded-full" style="width:${percent}%"></div>
      </div>
    `;
    container.appendChild(categoriaDiv);
  });
}


const entradaTipoLabels = {
  salario: 'Salário',
  venda: 'Venda',
  renda_extra: 'Renda extra',
  outros: 'Outros',
};

const investimentoTipoLabels = {
  reserva: 'Reserva de emergência',
  renda_fixa: 'Renda fixa',
  acoes: 'Ações/Fundos',
  cripto: 'Cripto',
  outros: 'Outros',
};

function renderEntradasSidebar(docs = []) {
  const lista = document.getElementById('entradas-lista');
  const totalMesEl = document.getElementById('entradas-total-mes');
  const totalGeralEl = document.getElementById('entradas-total-geral');
  const tiposContainer = document.getElementById('entradas-tipos-resumo');
  if (!lista || !totalMesEl || !totalGeralEl || !tiposContainer) return;

  mesesEntradasDisponiveis = new Set();
  allEntradasDocs = docs;

  lista.innerHTML = '';
  tiposContainer.innerHTML = '';

  const mesSel = document.getElementById('filtro-mes').value || yyyymm(new Date());
  const mostrarTodos = mesSel === 'all';

  let totalMes = 0;
  let totalRegistrado = 0;
  const totaisPorTipoPeriodo = {};
  let itensPeriodo = 0;

  docs.forEach(doc => {
    const data = doc.data();
    if (!data || !data.data) return;
    const dt = data.data.toDate ? data.data.toDate() : new Date(data.data);
    if (Number.isNaN(dt.getTime())) return;
    const key = yyyymm(dt);
    mesesEntradasDisponiveis.add(key);

    const valor = Number(data.valor) || 0;
    const tipo = data.tipo || 'outros';
    const descricao = (data.descricao || '').trim();

    totalRegistrado += valor;

    if (mostrarTodos || key === mesSel) {
      totalMes += valor;
      itensPeriodo += 1;
      totaisPorTipoPeriodo[tipo] = (totaisPorTipoPeriodo[tipo] || 0) + valor;
      const item = document.createElement('div');
      item.className = 'flex items-center gap-3 p-2 bg-gray-50 dark:bg-gray-700 rounded';
      item.innerHTML = `
        <div class="flex-1">
          <div class="font-semibold text-gray-700 dark:text-gray-100">${entradaTipoLabels[tipo] || tipo}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${formatDate(dt)}${descricao ? ` • ${descricao}` : ''}</div>
        </div>
        <div class="text-right">
          <div class="font-semibold text-green-600 dark:text-green-300">R$ ${moeda(valor)}</div>
        </div>
        <button class="text-gray-400 hover:text-red-500 transition" data-remove-entrada="${doc.id}" aria-label="Remover entrada">
          <i class="fa fa-times"></i>
        </button>
      `;
      lista.appendChild(item);
    }
  });

  if (itensPeriodo === 0) {
    const empty = document.createElement('div');
    empty.className = 'text-gray-500 dark:text-gray-400';
    empty.textContent = 'Nenhuma entrada registrada para o período selecionado.';
    lista.appendChild(empty);
  }

  if (Object.keys(totaisPorTipoPeriodo).length === 0) {
    const emptyTipos = document.createElement('div');
    emptyTipos.className = 'col-span-2 text-gray-500 dark:text-gray-400';
    emptyTipos.textContent = 'Cadastre entradas para ver a distribuição.';
    tiposContainer.appendChild(emptyTipos);
  } else {
    Object.entries(totaisPorTipoPeriodo).sort((a, b) => b[1] - a[1]).forEach(([tipo, valor]) => {
      const card = document.createElement('div');
      card.className = 'p-2 bg-green-50 dark:bg-green-900/10 rounded';
      card.innerHTML = `
        <div class="text-xs uppercase text-green-700 dark:text-green-200">${entradaTipoLabels[tipo] || tipo}</div>
        <div class="text-sm font-semibold text-green-800 dark:text-green-300">R$ ${moeda(valor)}</div>
      `;
      tiposContainer.appendChild(card);
    });
  }

  totalMesEl.textContent = moeda(totalMes);
  totalGeralEl.textContent = moeda(totalRegistrado);

  painelFinanceiroState.entradasMes = totalMes;
  painelFinanceiroState.entradasTotais = totalRegistrado;
  painelFinanceiroState.entradasFiltroTodos = mostrarTodos;
  atualizarSaldoLiquidoEntradas();
  atualizarResumoRapido();
  atualizarSaudeFinanceira();
  atualizarFiltroMeses();
}

function atualizarSaldoLiquidoEntradas() {
  const saldoMesEl = document.getElementById('entradas-saldo-mes');
  const saldoHintEl = document.getElementById('entradas-saldo-hint');
  if (!saldoMesEl) return;

  if (painelFinanceiroState.entradasFiltroTodos) {
    saldoMesEl.textContent = '--';
    if (saldoHintEl) {
      saldoHintEl.textContent = 'Selecione um mês específico para calcular o saldo líquido.';
    }
    return;
  }

  const entradasMes = painelFinanceiroState.entradasMes || 0;
  const gastosPeriodo = painelFinanceiroState.totalGastosMes || 0;
  const saldo = entradasMes - gastosPeriodo;

  saldoMesEl.textContent = moeda(saldo);
  if (saldoHintEl) {
    saldoHintEl.textContent = saldo >= 0
      ? 'Entradas menos saídas previstas do período selecionado.'
      : 'Déficit: saídas previstas superam as entradas do período.';
  }
}

function renderInvestimentosSidebar(docs = []) {
  const lista = document.getElementById('investimentos-lista');
  const totalMesEl = document.getElementById('investimento-total-mes');
  const totalGeralEl = document.getElementById('investimento-total-geral');
  const projEl = document.getElementById('investimento-projecao');
  if (!lista || !totalMesEl || !totalGeralEl || !projEl) return;

  mesesInvestimentosDisponiveis = new Set();
  allInvestimentosDocs = docs;

  lista.innerHTML = '';

  const mesSel = document.getElementById('filtro-mes').value || yyyymm(new Date());
  const mostrarTodos = mesSel === 'all';
  const hoje = new Date();

  let totalMes = 0;
  let totalGeral = 0;
  let totalProjetado = 0;
  const totaisPorMes = {};

  docs.forEach(doc => {
    const data = doc.data();
    if (!data || !data.data) return;
    const dt = data.data.toDate ? data.data.toDate() : new Date(data.data);
    if (Number.isNaN(dt.getTime())) return;
    const key = yyyymm(dt);
    mesesInvestimentosDisponiveis.add(key);

    const valor = Number(data.valor) || 0;
    const tipo = data.tipo || 'outros';
    const descricao = (data.descricao || '').trim();

    totalGeral += valor;
    totaisPorMes[key] = (totaisPorMes[key] || 0) + valor;
    const mesesPassados = Math.max(0, monthDiff(dt, hoje));
    const valorProjetado = valor * Math.pow(1.01, mesesPassados);
    totalProjetado += valorProjetado;

    if (mostrarTodos || key === mesSel) {
      totalMes += valor;
      const item = document.createElement('div');
      item.className = 'flex items-center gap-3 p-2 bg-indigo-50 dark:bg-indigo-900/20 rounded';
      item.innerHTML = `
        <div class="flex-1">
          <div class="flex items-center gap-2">
            <span class="text-xs uppercase tracking-wide bg-indigo-100 dark:bg-indigo-900/60 text-indigo-700 dark:text-indigo-200 px-2 py-0.5 rounded">${investimentoTipoLabels[tipo] || tipo}</span>
            ${descricao ? `<span class="text-sm font-medium text-gray-700 dark:text-gray-200">${descricao}</span>` : ''}
          </div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${formatDate(dt)}</div>
        </div>
        <div class="text-right">
          <div class="font-semibold text-indigo-700 dark:text-indigo-200">R$ ${moeda(valor)}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">Proj.: R$ ${moeda(valorProjetado)}</div>
        </div>
        <button class="text-gray-400 hover:text-red-500 transition" data-remove-investimento="${doc.id}" aria-label="Remover investimento">
          <i class="fa fa-times"></i>
        </button>
      `;
      lista.appendChild(item);
    }
  });

  if (!lista.children.length) {
    const empty = document.createElement('div');
    empty.className = 'text-gray-500 dark:text-gray-400';
    empty.textContent = 'Nenhum investimento registrado para o período selecionado.';
    lista.appendChild(empty);
  }

  totalMesEl.textContent = moeda(totalMes);
  totalGeralEl.textContent = moeda(totalGeral);
  projEl.textContent = moeda(totalProjetado);

  painelFinanceiroState.investimentosMes = totalMes;
  painelFinanceiroState.investimentosTotais = totalGeral;
  painelFinanceiroState.investimentosProjetados = totalProjetado;
  renderGraficoInvestimentos(totaisPorMes);
  atualizarResumoRapido();
  atualizarSaudeFinanceira();
  atualizarSimuladorValoresPadrao();
  atualizarSimuladorResultados();
  atualizarFiltroMeses();
}

function renderGraficoInvestimentos(totaisPorMes = {}) {
  const canvas = document.getElementById('grafico-investimentos');
  const emptyState = document.getElementById('investimentos-grafico-empty');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  if (chartInvestimentos) {
    chartInvestimentos.destroy();
    chartInvestimentos = null;
  }

  const mesesOrdenados = Object.keys(totaisPorMes || {}).sort();
  if (mesesOrdenados.length === 0) {
    if (emptyState) emptyState.classList.remove('hidden');
    if (ctx) ctx.clearRect(0, 0, canvas.width || 0, canvas.height || 0);
    return;
  }

  if (emptyState) emptyState.classList.add('hidden');

  const mesesRecentes = mesesOrdenados.slice(-12);
  const labels = mesesRecentes.map(mmYYYY);
  const aportesMensais = mesesRecentes.map(mes => totaisPorMes[mes]);
  let acumulado = 0;
  const acumuladoSeries = mesesRecentes.map(mes => {
    acumulado += totaisPorMes[mes];
    return acumulado;
  });

  chartInvestimentos = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          type: 'bar',
          label: 'Aportes mensais',
          data: aportesMensais,
          backgroundColor: 'rgba(99, 102, 241, 0.35)',
          borderColor: '#6366f1',
          borderWidth: 1,
          borderRadius: 6,
          yAxisID: 'y'
        },
        {
          type: 'line',
          label: 'Total acumulado',
          data: acumuladoSeries,
          borderColor: '#8b5cf6',
          backgroundColor: 'rgba(139, 92, 246, 0.2)',
          fill: false,
          tension: 0.35,
          pointRadius: 4,
          pointBackgroundColor: '#8b5cf6',
          yAxisID: 'y'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => `R$ ${moeda(val)}`,
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937'
          },
          grid: {
            color: html.classList.contains('dark') ? '#4b5563' : '#e5e7eb'
          }
        },
        x: {
          ticks: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937'
          },
          grid: {
            color: html.classList.contains('dark') ? '#374151' : '#f3f4f6'
          }
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937'
          }
        },
        tooltip: {
          callbacks: {
            label: context => {
              const label = context.dataset.label || '';
              return `${label}: R$ ${moeda(context.parsed.y || context.parsed)}`;
            }
          }
        }
      }
    }
  });
}

function calcularProjecaoJurosCompostos(valorInicial, aporteMensal, taxaPercentual, meses) {
  const principal = Math.max(0, Number(valorInicial) || 0);
  const aporte = Math.max(0, Number(aporteMensal) || 0);
  const taxa = Number(taxaPercentual) / 100 || 0;
  const periodo = Math.max(0, parseInt(meses, 10) || 0);
  const aportado = principal + (aporte * periodo);

  if (periodo === 0) {
    return { total: principal, aportado, ganho: principal - aportado };
  }

  let total;
  if (taxa === 0) {
    total = principal + (aporte * periodo);
  } else {
    const fator = Math.pow(1 + taxa, periodo);
    total = (principal * fator) + (aporte * ((fator - 1) / taxa));
  }

  const ganho = total - aportado;
  return { total, aportado, ganho };
}

function atualizarSimuladorValoresPadrao(force = false) {
  const inicialInput = document.getElementById('simulador-valor-inicial');
  if (!inicialInput) return;
  const totalInvestido = painelFinanceiroState.investimentosTotais || 0;
  if (force || !inicialInput.dataset.userEdited) {
    inicialInput.value = (totalInvestido || 0).toFixed(2);
  }

  const aporteMensalInput = document.getElementById('simulador-aporte-mensal');
  const aporteMes = painelFinanceiroState.investimentosMes || 0;
  if (aporteMensalInput && (force || !aporteMensalInput.dataset.userEdited)) {
    aporteMensalInput.value = (aporteMes || 0).toFixed(2);
  }

  const taxaInput = document.getElementById('simulador-taxa');
  if (taxaInput && (force || !taxaInput.dataset.userEdited) && !taxaInput.value) {
    taxaInput.value = String(SIMULADOR_DEFAULT_TAXA);
  }

  const periodoInput = document.getElementById('simulador-periodo');
  if (periodoInput && (force || !periodoInput.dataset.userEdited) && !periodoInput.value) {
    periodoInput.value = String(SIMULADOR_DEFAULT_PERIODO);
  }

  const aporteAltInput = document.getElementById('simulador-aporte-alternativo');
  if (aporteAltInput && (force || !aporteAltInput.dataset.userEdited)) {
    if (aporteAltInput.value === '' || force) {
      aporteAltInput.value = (aporteMes || 0).toFixed(2);
    }
  }

  const taxaAltInput = document.getElementById('simulador-taxa-alternativa');
  if (taxaAltInput && (force || !taxaAltInput.dataset.userEdited)) {
    if (taxaAltInput.value === '' || force) {
      taxaAltInput.value = taxaInput && taxaInput.value ? taxaInput.value : String(SIMULADOR_DEFAULT_TAXA);
    }
  }

  const aporteExtraInput = document.getElementById('simulador-aporte-extra');
  if (aporteExtraInput && (force || !aporteExtraInput.dataset.userEdited) && aporteExtraInput.value === '') {
    aporteExtraInput.value = '0';
  }

  const periodoAltInput = document.getElementById('simulador-periodo-alternativo');
  if (periodoAltInput && (force || !periodoAltInput.dataset.userEdited) && periodoAltInput.value === '') {
    periodoAltInput.value = '0';
  }
}

function atualizarSimuladorResultados() {
  const baseTotalEl = document.getElementById('simulador-base-total');
  if (!baseTotalEl) return;

  const valorInicial = parseFloat(document.getElementById('simulador-valor-inicial')?.value) || 0;
  const aporteMensal = parseFloat(document.getElementById('simulador-aporte-mensal')?.value) || 0;
  const taxaMensal = parseFloat(document.getElementById('simulador-taxa')?.value) || 0;
  const periodoMeses = Math.max(1, parseInt(document.getElementById('simulador-periodo')?.value, 10) || SIMULADOR_DEFAULT_PERIODO);

  const base = calcularProjecaoJurosCompostos(valorInicial, aporteMensal, taxaMensal, periodoMeses);

  const aporteAltBruto = parseFloat(document.getElementById('simulador-aporte-alternativo')?.value);
  const taxaAltBruta = parseFloat(document.getElementById('simulador-taxa-alternativa')?.value);
  const aporteExtra = Math.max(0, parseFloat(document.getElementById('simulador-aporte-extra')?.value) || 0);
  const periodoExtra = parseInt(document.getElementById('simulador-periodo-alternativo')?.value, 10);

  const aporteMensalAlternativo = !Number.isNaN(aporteAltBruto) && aporteAltBruto >= 0 ? aporteAltBruto : aporteMensal;
  const taxaMensalAlternativa = !Number.isNaN(taxaAltBruta) ? taxaAltBruta : taxaMensal;
  const mesesAlternativo = Math.max(1, periodoMeses + (Number.isNaN(periodoExtra) ? 0 : periodoExtra));
  const valorInicialAlternativo = valorInicial + aporteExtra;

  const alternativo = calcularProjecaoJurosCompostos(valorInicialAlternativo, aporteMensalAlternativo, taxaMensalAlternativa, mesesAlternativo);

  const diffValor = alternativo.total - base.total;
  const diffGanho = alternativo.ganho - base.ganho;

  baseTotalEl.textContent = `R$ ${moeda(base.total)}`;
  const baseGanhoEl = document.getElementById('simulador-base-ganho');
  if (baseGanhoEl) baseGanhoEl.textContent = `R$ ${moeda(base.ganho)}`;

  const altTotalEl = document.getElementById('simulador-alt-total');
  if (altTotalEl) altTotalEl.textContent = `R$ ${moeda(alternativo.total)}`;
  const altGanhoEl = document.getElementById('simulador-alt-ganho');
  if (altGanhoEl) altGanhoEl.textContent = `R$ ${moeda(alternativo.ganho)}`;

  const diffValorEl = document.getElementById('simulador-diferenca-valor');
  if (diffValorEl) diffValorEl.textContent = `R$ ${moeda(diffValor)}`;
  const diffGanhoEl = document.getElementById('simulador-diferenca-ganho');
  if (diffGanhoEl) diffGanhoEl.textContent = `R$ ${moeda(diffGanho)}`;
}

function initSimuladorAccordion() {
  const simulador = document.getElementById('simulador-juros-compostos');
  if (!simulador) return;
  const toggleBtn = simulador.querySelector('[data-simulador-toggle]');
  const content = simulador.querySelector('[data-simulador-content]');
  const icon = simulador.querySelector('[data-simulador-icon]');
  if (!toggleBtn || !content) return;
  if (toggleBtn.dataset.bound === 'true') return;
  toggleBtn.dataset.bound = 'true';

  toggleBtn.addEventListener('click', () => {
    const isHidden = content.classList.contains('hidden');
    if (isHidden) {
      content.classList.remove('hidden');
      toggleBtn.setAttribute('aria-expanded', 'true');
      if (icon) {
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
      }
    } else {
      content.classList.add('hidden');
      toggleBtn.setAttribute('aria-expanded', 'false');
      if (icon) {
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
      }
    }
  });
}

function initSimuladorInvestimentos() {
  const simulador = document.getElementById('simulador-juros-compostos');
  if (!simulador) return;
  initSimuladorAccordion();
  const inputs = simulador.querySelectorAll('[data-simulador]');
  inputs.forEach(input => {
    input.addEventListener('input', () => {
      input.dataset.userEdited = 'true';
      atualizarSimuladorResultados();
    });
    input.addEventListener('change', () => atualizarSimuladorResultados());
  });
  atualizarSimuladorValoresPadrao(true);
  atualizarSimuladorResultados();
}

function atualizarResumoSaidasCard(totalGastosPrevistosMes) {
  const totalEl = document.getElementById('saidas-total-card');
  const fixosEl = document.getElementById('saidas-fixos');
  const variavelEl = document.getElementById('saidas-variavel');
  const parceladoEl = document.getElementById('saidas-parcelado');
  const fixosBar = document.getElementById('saidas-fixos-bar');
  const variavelBar = document.getElementById('saidas-variavel-bar');
  const parceladoBar = document.getElementById('saidas-parcelado-bar');

  if (!totalEl || !fixosEl || !variavelEl || !parceladoEl || !fixosBar || !variavelBar || !parceladoBar) return;

  const fixoVal = resumo.fixosMes || 0;
  const variavelVal = resumo.historicoMes || 0;
  const parceladoVal = resumo.parcelasMes || 0;
  const total = fixoVal + variavelVal + parceladoVal;

  totalEl.textContent = moeda(totalGastosPrevistosMes);
  fixosEl.textContent = moeda(fixoVal);
  variavelEl.textContent = moeda(variavelVal);
  parceladoEl.textContent = moeda(parceladoVal);

  const calcPercent = valor => total ? Math.max(0, Math.min(100, (valor / total) * 100)) : 0;
  fixosBar.style.width = `${calcPercent(fixoVal)}%`;
  variavelBar.style.width = `${calcPercent(variavelVal)}%`;
  parceladoBar.style.width = `${calcPercent(parceladoVal)}%`;
}

function atualizarResumoRapido() {
  const entradasMes = painelFinanceiroState.entradasMes || 0;
  const totalGastosMes = painelFinanceiroState.totalGastosMes || 0;
  const projInvest = painelFinanceiroState.investimentosProjetados || 0;
  const totalInvest = painelFinanceiroState.investimentosTotais || 0;
  const ganhoInvest = Math.max(0, projInvest - totalInvest);
  const saldo = entradasMes - totalGastosMes;
  const saldoProjetado = saldo + ganhoInvest;

  atualizarResumoIndicadoresFinanceiros({ entradasMes, totalGastosMes, saldoProjetado, ganhoInvest });

  resumoFinanceiroAtual = { entradasMes, totalGastosMes, saldoProjetado, ganhoInvest };
  atualizarSimuladorResultados();
  return resumoFinanceiroAtual;
}

function atualizarResumoIndicadoresFinanceiros({ entradasMes, totalGastosMes, saldoProjetado, ganhoInvest }) {
  const entradasMesEl = document.getElementById('resumo-entradas-mes');
  const saidasMesEl = document.getElementById('resumo-saidas-mes');
  const saldoProjetadoEl = document.getElementById('resumo-saldo-projetado');
  const ganhoInvestEl = document.getElementById('resumo-ganho-invest');

  if (!entradasMesEl || !saidasMesEl || !saldoProjetadoEl || !ganhoInvestEl) return;

  entradasMesEl.textContent = moeda(entradasMes);
  saidasMesEl.textContent = moeda(totalGastosMes);
  saldoProjetadoEl.textContent = moeda(saldoProjetado);
  ganhoInvestEl.textContent = moeda(Math.max(0, ganhoInvest));

  const saldoItem = saldoProjetadoEl.closest('.resumo-item');
  if (saldoItem) {
    saldoItem.classList.remove('positivo', 'alerta', 'neutro');
    if (saldoProjetado > 50) {
      saldoItem.classList.add('positivo');
    } else if (saldoProjetado < -50) {
      saldoItem.classList.add('alerta');
    } else {
      saldoItem.classList.add('neutro');
    }
  }

  const ganhoItem = ganhoInvestEl.closest('.resumo-item');
  if (ganhoItem) {
    ganhoItem.classList.remove('positivo', 'alerta', 'neutro');
    if (ganhoInvest > 0) {
      ganhoItem.classList.add('positivo');
    } else {
      ganhoItem.classList.add('neutro');
    }
  }

  const saidasItem = saidasMesEl.closest('.resumo-item');
  if (saidasItem) {
    const excedeu = totalGastosMes > entradasMes;
    saidasItem.classList.remove('positivo', 'alerta', 'neutro');
    saidasItem.classList.add(excedeu ? 'alerta' : 'neutro');
  }
}

function atualizarSaudeFinanceira() {
  const scoreEl = document.getElementById('saude-score');
  const statusEl = document.getElementById('saude-status');
  const progressEl = document.getElementById('saude-progress');
  const saldoEl = document.getElementById('saude-detalhes-saldo');
  const rendaEl = document.getElementById('saude-detalhes-renda');
  const investimentoEl = document.getElementById('saude-investimento-extra');
  if (!scoreEl || !statusEl || !progressEl || !saldoEl || !rendaEl || !investimentoEl) return;

  const entradasMes = painelFinanceiroState.entradasMes || 0;
  const totalGastosMes = painelFinanceiroState.totalGastosMes || 0;
  const projInvest = painelFinanceiroState.investimentosProjetados || 0;
  const totalInvest = painelFinanceiroState.investimentosTotais || 0;
  const ganhoInvest = Math.max(0, projInvest - totalInvest);
  const saldo = entradasMes - totalGastosMes;
  const saldoProjetado = saldo + ganhoInvest;

  rendaEl.textContent = `R$ ${moeda(entradasMes)}`;
  investimentoEl.textContent = `R$ ${moeda(Math.max(projInvest, 0))}`;
  saldoEl.textContent = `R$ ${moeda(saldoProjetado)}`;

  if (entradasMes === 0 && totalGastosMes === 0 && projInvest === 0) {
    scoreEl.textContent = '--';
    progressEl.style.width = '0%';
    progressEl.style.backgroundColor = '#f43f5e';
    statusEl.textContent = 'Cadastre entradas e gastos para calcular sua saúde financeira.';
    return;
  }

  let score;
  if (entradasMes <= 0) {
    score = totalGastosMes > 0 ? 5 : 50;
  } else {
    const uso = totalGastosMes / entradasMes;
    score = Math.round(Math.max(0, Math.min(100, (1 - Math.min(uso, 1.5) / 1.5) * 100)));
  }

  const mensagem = score >= 80
    ? 'Excelente! Você está gastando menos do que ganha e aproveitando os investimentos.'
    : score >= 55
      ? 'Atenção: ajuste alguns gastos ou aumente suas entradas para melhorar o saldo.'
      : 'Crítico: reveja gastos urgentes ou busque novas entradas para equilibrar as finanças.';

  const cor = score >= 80 ? '#16a34a' : score >= 55 ? '#f97316' : '#dc2626';

  scoreEl.textContent = `${score} pts`;
  progressEl.style.width = `${score}%`;
  progressEl.style.backgroundColor = cor;
  statusEl.textContent = mensagem;
}

function initMobilePanels() {
  const nav = document.getElementById('mobile-panels-nav');
  const panels = Array.from(document.querySelectorAll('.mobile-panel'));
  if (!nav || panels.length === 0) return;

  const buttons = Array.from(nav.querySelectorAll('[data-panel-target]')).filter(btn => btn.dataset.panelTarget);
  if (!buttons.length) return;

  const firstAvailable = buttons.find(btn => panels.some(panel => panel.id === btn.dataset.panelTarget));
  let activeId = firstAvailable ? firstAvailable.dataset.panelTarget : panels[0]?.id;
  if (!activeId) return;

  const applyState = (id) => {
    if (!id) return;
    activeId = id;
    const isDesktop = window.innerWidth >= 1024;
    panels.forEach(panel => {
      const alias = panel.dataset.panelAlias;
      const shouldShow = panel.id === id || (alias && alias === id);
      if (isDesktop) {
        panel.classList.remove('hidden');
      } else {
        panel.classList.toggle('hidden', !shouldShow);
      }
    });
    buttons.forEach(btn => btn.classList.toggle('active', btn.dataset.panelTarget === id));
  };

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.panelTarget;
      if (!target || target === activeId) return;
      applyState(target);
    });
  });

  const handleResize = () => {
    if (window.innerWidth >= 1024) {
      panels.forEach(panel => panel.classList.remove('hidden'));
    } else {
      applyState(activeId);
    }
  };

  applyState(activeId);
  window.addEventListener('resize', handleResize);
  handleResize();
}

function initResumoSlider() {
  const slider = document.getElementById('resumo-slider');
  const track = document.getElementById('resumo-slider-track');
  if (!slider || !track) return;

  const slides = Array.from(track.children);
  if (slides.length <= 1) return;

  const mainButtons = Array.from(document.querySelectorAll('.resumo-slider-dot[data-slide]'));
  const dotButtons = Array.from(document.querySelectorAll('.resumo-slider-dots button[data-slide]'));
  let activeIndex = 0;
  let pointerActive = false;
  let startX = 0;
  let pointerId = null;

  const getClientX = (event) => (typeof event.clientX === 'number' ? event.clientX : startX);

  const clampIndex = (index) => Math.max(0, Math.min(slides.length - 1, index));

  const applyTransform = () => {
    track.style.transform = `translateX(-${activeIndex * 100}%)`;
  };

  const updateButtons = () => {
    const check = btn => Number(btn.dataset.slide) === activeIndex;
    mainButtons.forEach(btn => btn.classList.toggle('is-active', check(btn)));
    dotButtons.forEach(btn => btn.classList.toggle('is-active', check(btn)));
  };

  const goTo = (index) => {
    const nextIndex = clampIndex(index);
    if (nextIndex === activeIndex) {
      applyTransform();
      return;
    }
    activeIndex = nextIndex;
    applyTransform();
    updateButtons();
  };

  const finishPointer = (event) => {
    if (!pointerActive) return;
    const deltaX = getClientX(event) - startX;
    if (Math.abs(deltaX) > 50) {
      goTo(activeIndex + (deltaX < 0 ? 1 : -1));
    } else {
      goTo(activeIndex);
    }
    if (pointerId !== null) {
      try { slider.releasePointerCapture(pointerId); } catch (err) { /* ignore */ }
    }
    pointerActive = false;
    pointerId = null;
  };

  mainButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const index = Number(btn.dataset.slide) || 0;
      goTo(index);
    });
  });

  dotButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const index = Number(btn.dataset.slide) || 0;
      goTo(index);
    });
  });

  slider.addEventListener('pointerdown', (event) => {
    if (event.pointerType === 'mouse' && event.button !== 0) return;
    pointerActive = true;
    startX = event.clientX;
    pointerId = event.pointerId;
    try { slider.setPointerCapture(pointerId); } catch (err) { /* ignore */ }
  });

  slider.addEventListener('pointerup', finishPointer);
  slider.addEventListener('pointercancel', finishPointer);
  slider.addEventListener('pointerleave', (event) => {
    if (!pointerActive) return;
    finishPointer(event);
  });

  window.addEventListener('resize', () => {
    applyTransform();
    updateButtons();
  });

  goTo(0);
}

/* ===========================
   UI EVENTS: forms, export, edits
   =========================== */
document.getElementById('parcelado-form').addEventListener('submit', e=>{
  e.preventDefault();
  const desc = document.getElementById('p-desc').value.trim();
  const valorParcela = parseFloat(document.getElementById('p-valor').value)||0;
  const numParcelas = parseInt(document.getElementById('p-num').value)||1;
  const cartao = document.getElementById('p-cartao').value||'';
  const inicio = document.getElementById('p-inicio').value;
  if(!desc || valorParcela<=0 || numParcelas<1 || !inicio) {
    showToast('Preencha todos os campos do parcelado corretamente.', 'error');
    return;
  }
  const [y,m] = inicio.split('-');
  const dataInicio = new Date(parseInt(y), parseInt(m)-1, 1);
  userCollectionRef('parcelados').add(stampWorkspaceCreation({ descricao: desc, valorParcela, numParcelas, cartao, dataInicio }))
    .then(()=> {
      e.target.reset();
      showToast('Parcelado adicionado com sucesso!');
      gerarInsights(); // NOVO: Atualiza insights após adicionar parcelado
    })
    .catch(err => showToast('Erro ao adicionar parcelado: ' + err.message, 'error'));
});

const toggleParceladosBtn = document.getElementById('toggle-parcelados-projecao');
if (toggleParceladosBtn) {
  const parceladosContainer = document.getElementById('parcelados-projecao-container');
  const parceladosIcon = document.getElementById('parcelados-projecao-toggle-icon');
  toggleParceladosBtn.addEventListener('click', () => {
    if (!parceladosContainer) return;
    const hidden = parceladosContainer.classList.toggle('hidden');
    toggleParceladosBtn.setAttribute('aria-expanded', (!hidden).toString());
    parceladosContainer.setAttribute('aria-hidden', hidden ? 'true' : 'false');
    if (parceladosIcon) {
      parceladosIcon.classList.toggle('rotate-180', !hidden);
    }
    if (!hidden && chartParceladosProjecao) {
      setTimeout(() => {
        if (chartParceladosProjecao) {
          chartParceladosProjecao.resize();
        }
      }, 120);
    }
  });
}

const toggleHistoricoSemanasBtn = document.getElementById('toggle-historico-semanas');
if (toggleHistoricoSemanasBtn) {
  const historicoSemanasContainer = document.getElementById('historico-semanas-container');
  const historicoSemanasIcon = document.getElementById('historico-semanas-toggle-icon');
  toggleHistoricoSemanasBtn.addEventListener('click', () => {
    if (!historicoSemanasContainer) return;
    const hidden = historicoSemanasContainer.classList.toggle('hidden');
    toggleHistoricoSemanasBtn.setAttribute('aria-expanded', (!hidden).toString());
    historicoSemanasContainer.setAttribute('aria-hidden', hidden ? 'true' : 'false');
    if (historicoSemanasIcon) {
      historicoSemanasIcon.classList.toggle('rotate-180', !hidden);
    }
    if (!hidden && chartHistoricoSemanal) {
      setTimeout(() => {
        if (chartHistoricoSemanal) {
          chartHistoricoSemanal.resize();
        }
      }, 120);
    }
  });
}

const historicoSemanasModoSelect = document.getElementById('historico-semanas-modo');
if (historicoSemanasModoSelect) {
  historicoSemanasModoSelect.addEventListener('change', () => {
    const cacheDocs = historicoInsightsCache.docs || [];
    updateHistoricoInsights(cacheDocs, historicoInsightsCache.mesSel);
    if (chartHistoricoSemanal) {
      setTimeout(() => {
        if (chartHistoricoSemanal) {
          chartHistoricoSemanal.resize();
        }
      }, 120);
    }
  });
}

/* ===========================
   ENTRADAS & INVESTIMENTOS SIDEBAR
   =========================== */
const formEntrada = document.getElementById('form-entrada');
const entradaDataInput = document.getElementById('entrada-data');
const entradaValorInput = document.getElementById('entrada-valor');
const formInvestimento = document.getElementById('form-investimento');
const investimentoDataInput = document.getElementById('investimento-data');
const investimentoValorInput = document.getElementById('investimento-valor');

const hojeIso = formatDateInputValue(new Date());
if (entradaDataInput && !entradaDataInput.value) entradaDataInput.value = hojeIso;
if (investimentoDataInput && !investimentoDataInput.value) investimentoDataInput.value = hojeIso;

if (formEntrada) {
  formEntrada.addEventListener('submit', e => {
    e.preventDefault();
    const tipo = document.getElementById('entrada-tipo')?.value || 'outros';
    const valor = parseFloat((entradaValorInput && entradaValorInput.value) || '0');
    const dataValor = entradaDataInput ? entradaDataInput.value : '';
    const descricao = (document.getElementById('entrada-desc')?.value || '').trim();

    if (!dataValor || valor <= 0) {
      showToast('Informe um valor e uma data válidos para a entrada.', 'error');
      return;
    }

    const data = new Date(`${dataValor}T12:00:00`);
    userCollectionRef('entradas').add(stampWorkspaceCreation({
      tipo,
      valor,
      descricao,
      data: firebase.firestore.Timestamp.fromDate(data),
    })).then(() => {
      showToast('Entrada registrada com sucesso!', 'success');
      formEntrada.reset();
      if (entradaDataInput) entradaDataInput.value = formatDateInputValue(new Date());
    }).catch(err => {
      console.error('Erro ao adicionar entrada:', err);
      showToast('Erro ao adicionar entrada.', 'error');
    });
  });

  const entradasLista = document.getElementById('entradas-lista');
  if (entradasLista) {
    entradasLista.addEventListener('click', e => {
      const btn = e.target.closest('[data-remove-entrada]');
      if (!btn) return;
      const id = btn.getAttribute('data-remove-entrada');
      if (!id) return;
      abrirModalConfirmacao('Remover entrada', 'Deseja remover esta entrada de dinheiro?', () => {
        userCollectionRef('entradas').doc(id).delete()
          .then(() => showToast('Entrada removida!', 'success'))
          .catch(err => {
            console.error('Erro ao remover entrada:', err);
            showToast('Erro ao remover entrada.', 'error');
          });
      });
    });
  }
}

if (formInvestimento) {
  formInvestimento.addEventListener('submit', e => {
    e.preventDefault();
    const tipo = document.getElementById('investimento-tipo')?.value || 'outros';
    const valor = parseFloat((investimentoValorInput && investimentoValorInput.value) || '0');
    const dataValor = investimentoDataInput ? investimentoDataInput.value : '';
    const descricao = (document.getElementById('investimento-desc')?.value || '').trim();

    if (!dataValor || valor <= 0) {
      showToast('Informe um valor e uma data válidos para o investimento.', 'error');
      return;
    }

    const data = new Date(`${dataValor}T12:00:00`);
    userCollectionRef('investimentos').add(stampWorkspaceCreation({
      tipo,
      valor,
      descricao,
      data: firebase.firestore.Timestamp.fromDate(data),
    })).then(() => {
      showToast('Investimento registrado!', 'success');
      formInvestimento.reset();
      if (investimentoDataInput) investimentoDataInput.value = formatDateInputValue(new Date());
    }).catch(err => {
      console.error('Erro ao adicionar investimento:', err);
      showToast('Erro ao adicionar investimento.', 'error');
    });
  });

  const investimentosLista = document.getElementById('investimentos-lista');
  if (investimentosLista) {
    investimentosLista.addEventListener('click', e => {
      const btn = e.target.closest('[data-remove-investimento]');
      if (!btn) return;
      const id = btn.getAttribute('data-remove-investimento');
      if (!id) return;
      abrirModalConfirmacao('Remover investimento', 'Deseja remover este lançamento de investimento?', () => {
        userCollectionRef('investimentos').doc(id).delete()
          .then(() => showToast('Investimento removido!', 'success'))
          .catch(err => {
            console.error('Erro ao remover investimento:', err);
            showToast('Erro ao remover investimento.', 'error');
          });
      });
    });
  }
}

document.getElementById('exportar-csv').addEventListener('click', exportarCSVmes);
document.getElementById('exportar-tudo').addEventListener('click', exportarCSVtudo);

['fixo', 'parcelado', 'variavel'].forEach(tipo => {
  const metaInput = document.getElementById(`envelope-${tipo}-meta`);
  const reservaInput = document.getElementById(`envelope-${tipo}-reserva`);
  if (metaInput) {
    metaInput.addEventListener('input', () => metaInput.dataset.userEdited = 'true');
    metaInput.addEventListener('change', e => {
      metaInput.dataset.userEdited = '';
      salvarEnvelope(tipo, { meta: e.target.value });
    });
  }
  if (reservaInput) {
    reservaInput.addEventListener('input', () => reservaInput.dataset.userEdited = 'true');
    reservaInput.addEventListener('change', e => {
      reservaInput.dataset.userEdited = '';
      salvarEnvelope(tipo, { reservado: e.target.value }, 'Reserva ajustada!');
    });
  }
});

const envelopesGrid = document.getElementById('envelopes-grid');
if (envelopesGrid) {
  envelopesGrid.addEventListener('click', e => {
    const btn = e.target.closest('[data-envelope-action]');
    if (!btn) return;
    const tipo = btn.getAttribute('data-envelope');
    const acao = btn.getAttribute('data-envelope-action');
    if (!tipo || !acao) return;
    if (acao === 'reservar') {
      reservarSaldoDisponivel(tipo);
    } else if (acao === 'liberar') {
      limparReservaEnvelope(tipo);
    }
  });
}

const reservarTodosBtn = document.getElementById('btn-envelopes-reservar-todos');
if (reservarTodosBtn) {
  reservarTodosBtn.addEventListener('click', e => {
    e.preventDefault();
    reservarSobrasAutomatico();
  });
}

const limparReservasBtn = document.getElementById('btn-envelopes-limpar-reservas');
if (limparReservasBtn) {
  limparReservasBtn.addEventListener('click', e => {
    e.preventDefault();
    limparReservasAutomatico();
  });
}

const btnEnvelopesOverview = document.getElementById('btn-envelopes-overview');
const modalPlanejamentoEnvelopes = document.getElementById('modal-planejamento-envelopes');
const modalPlanejamentoEnvelopesClose = document.getElementById('modal-planejamento-envelopes-close');
const btnPlanejamentoReservar = document.getElementById('btn-planejamento-reservar');
const btnPlanejamentoInvestir = document.getElementById('btn-planejamento-investir');
const btnPlanejamentoEntrada = document.getElementById('btn-planejamento-entrada');

function abrirModalPlanejamentoEnvelopes() {
  if (!modalPlanejamentoEnvelopes) return;
  atualizarBarrasVisuais();
  modalPlanejamentoEnvelopes.classList.remove('hidden');
  updateFloatingMenuVisibility();
}

function fecharModalPlanejamentoEnvelopes() {
  if (!modalPlanejamentoEnvelopes) return;
  modalPlanejamentoEnvelopes.classList.add('hidden');
  updateFloatingMenuVisibility();
}

btnEnvelopesOverview?.addEventListener('click', abrirModalPlanejamentoEnvelopes);
modalPlanejamentoEnvelopesClose?.addEventListener('click', fecharModalPlanejamentoEnvelopes);

modalPlanejamentoEnvelopes?.addEventListener('click', (event) => {
  if (event.target === modalPlanejamentoEnvelopes) {
    fecharModalPlanejamentoEnvelopes();
  }
});

btnPlanejamentoReservar?.addEventListener('click', () => {
  const margem = window.__ultimoResumoEnvelopes?.totalMargem || 0;
  if (margem <= 0) {
    showToast('Não há folga disponível para reservar agora.', 'info');
    return;
  }
  reservarSobrasAutomatico()
    .then(() => {
      fecharModalPlanejamentoEnvelopes();
      showToast('Folga distribuída automaticamente entre os envelopes.');
    })
    .catch(() => showToast('Não foi possível reservar automaticamente.', 'error'));
});

btnPlanejamentoInvestir?.addEventListener('click', () => {
  const margem = window.__ultimoResumoEnvelopes?.totalMargem || 0;
  if (margem <= 0) {
    showToast('Nenhuma folga para enviar aos investimentos no momento.', 'info');
    return;
  }
  fecharModalPlanejamentoEnvelopes();
  goToPanelAndFocus('painel-investimentos', '#investimento-valor');
  const inputInvestimento = document.querySelector('#investimento-valor');
  if (inputInvestimento) {
    inputInvestimento.value = margem.toFixed(2);
    inputInvestimento.dispatchEvent(new Event('input', { bubbles: true }));
  }
  showToast(`Preenchemos R$ ${moeda(margem)} no formulário de investimentos para você confirmar.`, 'info');
});

btnPlanejamentoEntrada?.addEventListener('click', () => {
  const margem = window.__ultimoResumoEnvelopes?.totalMargem || 0;
  if (margem <= 0) {
    showToast('Não há folga para registrar como entrada extra.', 'info');
    return;
  }
  fecharModalPlanejamentoEnvelopes();
  goToPanelAndFocus('painel-entradas', '#entrada-valor');
  const inputEntrada = document.querySelector('#entrada-valor');
  if (inputEntrada) {
    inputEntrada.value = margem.toFixed(2);
    inputEntrada.dispatchEvent(new Event('input', { bubbles: true }));
  }
  showToast(`Sugestão pronta: R$ ${moeda(margem)} já está preenchido nas entradas para você salvar.`, 'info');
});

/* ===========================
   FILTRO MESES POPULATION helper (GERAL)
   =========================== */
function atualizarFiltroMeses(){
  const select = document.getElementById('filtro-mes');
  const atual = select.value; 

  select.innerHTML = '<option value="all">Todos</option>';

 const setAllDataMonths = new Set([
   ...(mesesDisponiveis||[]),
   ...(mesesParceladosColetados||[]),
   ...(mesesEntradasDisponiveis||[]),
   ...(mesesInvestimentosDisponiveis||[])
 ]);
  
  Array.from(setAllDataMonths).sort().reverse().forEach(k=>{
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = mmYYYY(k);
    select.appendChild(opt);
  });

  if(atual && Array.from(select.options).some(o=>o.value===atual)) {
      select.value = atual;
  } else {
      select.value = yyyymm(new Date());
  }
}


document.getElementById('filtro-mes').addEventListener('change', ()=>{
  // Ao mudar o filtro de mês, reinicia os observers para carregar os dados do novo mês
  startObservers(); 
});

/* ===========================
   BARRA DE AÇÕES INFERIOR
   =========================== */
function initFloatingMenu() {
  const floatingMenu = document.getElementById('floating-menu');
  const btnAddVariavel = document.getElementById('btn-add-gasto-variavel');
  const btnAddFixo = document.getElementById('btn-add-gasto-fixo');
  const btnAddParcelado = document.getElementById('btn-add-gasto-parcelado');
  const btnQuickEntradas = document.getElementById('btn-quick-entradas');
  const quickIncomeMenu = document.getElementById('quick-income-menu');

  if (!floatingMenu) return;

  const closeQuickIncomeMenu = () => {
    if (quickIncomeMenu) quickIncomeMenu.classList.add('hidden');
    if (btnQuickEntradas) btnQuickEntradas.setAttribute('aria-expanded', 'false');
  };

  const openQuickIncomeMenu = () => {
    if (!quickIncomeMenu || !btnQuickEntradas) return;
    quickIncomeMenu.classList.remove('hidden');
    btnQuickEntradas.setAttribute('aria-expanded', 'true');
  };

  if (btnAddVariavel) {
    btnAddVariavel.addEventListener('click', () => {
      abrirModal();
      updateFloatingMenuVisibility();
    });
  }

  if (btnAddFixo) {
    btnAddFixo.addEventListener('click', () => {
      abrirModalFixo();
      updateFloatingMenuVisibility();
    });
  }

  if (btnAddParcelado) {
    btnAddParcelado.addEventListener('click', () => {
      abrirModalParcelado();
      updateFloatingMenuVisibility();
    });
  }

  if (btnQuickEntradas && quickIncomeMenu) {
    btnQuickEntradas.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      const isHidden = quickIncomeMenu.classList.contains('hidden');
      closeQuickIncomeMenu();
      if (isHidden) {
        openQuickIncomeMenu();
      }
    });

    quickIncomeMenu.addEventListener('click', (event) => {
      event.stopPropagation();
    });

    quickIncomeMenu.querySelectorAll('[data-income-action]').forEach(button => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        const action = button.getAttribute('data-income-action');
        closeQuickIncomeMenu();
        if (action === 'entrada') {
          goToPanelAndFocus('painel-entradas', '#entrada-valor');
        } else if (action === 'investimento') {
          goToPanelAndFocus('painel-investimentos', '#investimento-valor');
        }
      });
    });

    document.addEventListener('click', closeQuickIncomeMenu);
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeQuickIncomeMenu();
      }
    });
  }

  updateFloatingMenuVisibility();
}

/* ===========================
   MODAL DE ADICIONAR GASTOS
   =========================== */
const btnOpenAddGasto = document.getElementById('btn-open-add-gasto');
const modalAddGasto = document.getElementById('modal-add-gasto');
const modalClose = document.getElementById('modal-close');
const modalCancel = document.getElementById('modal-cancel');
const formAddGastoModal = document.getElementById('form-add-gasto-modal');
const modalCartaoSelect = document.getElementById('modal-cartao'); // NOVO
const mesFaturaEstimadoSpan = document.getElementById('mes-fatura-estimado').querySelector('span'); // NOVO

function atualizarMesFaturaEstimado() {
  const cartaoSelecionado = modalCartaoSelect.value;
  const hoje = new Date();
  let mesFaturaDisplay = 'Mês Atual';

  if (cartaoSelecionado && cartaoSelecionado !== 'pix' && cartaoSelecionado !== '') {
    const configCartao = cartoesCfg[cartaoSelecionado];
    if (configCartao && configCartao.fechamento !== null && configCartao.fechamento !== undefined) {
      const offset = obterOffsetCartao(configCartao);
      const mesFatura = calcularMesFatura(hoje, configCartao.fechamento, offset);
      mesFaturaDisplay = mmYYYY(mesFatura);
    }
  } else if (cartaoSelecionado === 'pix' || cartaoSelecionado === '') {
    mesFaturaDisplay = mmYYYY(yyyymm(hoje));
  }
  mesFaturaEstimadoSpan.textContent = mesFaturaDisplay;
}

modalCartaoSelect.addEventListener('change', atualizarMesFaturaEstimado); // NOVO: Atualiza ao mudar o cartão

function abrirModal() {
  modalAddGasto.classList.remove('hidden');
  atualizarMesFaturaEstimado(); // NOVO: Atualiza ao abrir o modal
  setTimeout(() => {
    document.getElementById('modal-cartao').focus();
  }, 100);
}

function fecharModal() {
  modalAddGasto.classList.add('hidden');
  formAddGastoModal.reset();
  document.getElementById('modal-valor').classList.remove('border-red-500');
  document.getElementById('error-modal-valor').classList.add('hidden');
  selectedTagsArray = []; // Limpa tags selecionadas
  renderSelectedTags();
}

if (btnOpenAddGasto) {
  btnOpenAddGasto.addEventListener('click', abrirModal);
}

// REMOVIDO: fecharTodosOsModais() duplicado aqui, já existe no topo do script

modalClose.addEventListener('click', fecharModal);
modalCancel.addEventListener('click', fecharModal);

modalAddGasto.addEventListener('click', e => {
  if (e.target === modalAddGasto) fecharModal();
});

formAddGastoModal.addEventListener('submit', e => {
  e.preventDefault();
  const cartaoSelecionado = document.getElementById('modal-cartao').value || '';
  const categoria = document.getElementById('modal-categoria').value || ''; 
  const valorInput = document.getElementById('modal-valor');
  const valor = parseFloat(valorInput.value) || 0;
  const desc = document.getElementById('modal-desc').value || '';
  
  const errorValor = document.getElementById('error-modal-valor');
  valorInput.classList.remove('border-red-500');
  errorValor.classList.add('hidden');

  if (valor <= 0) { 
    valorInput.classList.add('border-red-500');
    errorValor.classList.remove('hidden');
    showToast('Valor é obrigatório e deve ser maior que zero.', 'error');
    return;
  }
  
  // NOVO: Calcula mesFatura
  const hoje = new Date();
  let mesFaturaCalculado;
  if (cartaoSelecionado === 'pix' || cartaoSelecionado === '') { // PIX ou Nenhum
    mesFaturaCalculado = yyyymm(hoje); // Mês atual da transação
  } else {
    const configCartao = cartoesCfg[cartaoSelecionado];
    if (configCartao && configCartao.fechamento !== null && configCartao.fechamento !== undefined) {
      const offset = obterOffsetCartao(configCartao);
      mesFaturaCalculado = calcularMesFatura(hoje, configCartao.fechamento, offset);
    } else {
      mesFaturaCalculado = yyyymm(hoje); // Fallback para mês atual se não houver fechamento
    }
  }

  userCollectionRef('gastos').add(stampWorkspaceCreation({
    tipo: 'variavel',
    cartao: cartaoSelecionado,
    categoria,
    valor,
    descricao: desc,
    tags: selectedTagsArray, // NOVO: Adiciona as tags selecionadas
    data: firebase.firestore.Timestamp.now(),
    mesFatura: mesFaturaCalculado, // NOVO CAMPO
  })).then(() => {
    // Limpa tags selecionadas
    selectedTagsArray = [];
    renderSelectedTags();
    fecharModal();
    showToast('Gasto variável adicionado com sucesso!');
    gerarInsights(); // NOVO: Atualiza insights após adicionar gasto
  }).catch(err => {
    showToast('Erro ao adicionar gasto: ' + err.message, 'error');
  });
});

    
// Variáveis do modal e formulário
const modalFixo = document.getElementById('modal-fixo');
const formFixo = document.getElementById('form-fixo');
const selectCategoria = document.getElementById('fixo-categoria');
const selectSubcategoria = document.getElementById('fixo-subcategoria');
const btnCancelarFixo = document.getElementById('btn-cancelar-fixo');

const subcategoriasPorCategoria = {
  'Assinaturas': ['Netflix', 'Spotify', 'Amazon Prime', 'Disney+'],
  'Contas': ['Luz', 'Água', 'Internet', 'Telefone'],
  'Seguros': ['Carro', 'Casa', 'Vida'],
  'Outros': []
};

// Abrir modal para adicionar fixo
function abrirModalFixo(dados = null) {
  modalFixo.classList.remove('hidden');
  formFixo.reset();
  selectSubcategoria.innerHTML = '<option value="">Selecione uma categoria primeiro</option>';
  selectSubcategoria.disabled = true;

  if (dados) {
    document.getElementById('modal-fixo-title').textContent = 'Editar Gasto Fixo';
    formFixo.nome.value = dados.nome || '';
    formFixo.categoria.value = dados.categoria || '';
    atualizarSubcategorias(dados.categoria);
    formFixo.subcategoria.value = dados.subcategoria || '';
    formFixo.valor.value = dados.valor || '';
    formFixo.ativo.checked = dados.ativo ?? true;
    formFixo.dataset.docId = dados.id; // para edição
  } else {
    document.getElementById('modal-fixo-title').textContent = 'Adicionar Gasto Fixo';
    delete formFixo.dataset.docId;
  }
}

// Atualiza opções de subcategoria conforme categoria selecionada
function atualizarSubcategorias(categoria) {
  const subcats = subcategoriasPorCategoria[categoria] || [];
  selectSubcategoria.innerHTML = '';
  if (subcats.length === 0) {
    selectSubcategoria.innerHTML = '<option value="">Sem subcategorias</option>';
    selectSubcategoria.disabled = true;
  } else {
    selectSubcategoria.disabled = false;
    selectSubcategoria.innerHTML = '<option value="">Selecione uma subcategoria</option>';
    subcats.forEach(sub => {
      const option = document.createElement('option');
      option.value = sub;
      option.textContent = sub;
      selectSubcategoria.appendChild(option);
    });
  }
}

selectCategoria.addEventListener('change', e => {
  atualizarSubcategorias(e.target.value);
});

btnCancelarFixo.addEventListener('click', () => {
  modalFixo.classList.add('hidden');
});

// Submissão do formulário para adicionar ou editar fixo
formFixo.addEventListener('submit', e => {
  e.preventDefault();

  const novoFixo = {
    nome: formFixo.nome.value.trim(),
    categoria: formFixo.categoria.value,
    subcategoria: formFixo.subcategoria.value || '',
    valor: parseFloat(formFixo.valor.value),
    ativo: formFixo.ativo.checked
  };

  if (!novoFixo.nome || !novoFixo.categoria || isNaN(novoFixo.valor)) {
    showToast('Por favor, preencha todos os campos obrigatórios corretamente.', 'error');
    return;
  }

  const docId = formFixo.dataset.docId;

  if (docId) {
    // Editar gasto fixo existente
    userCollectionRef('fixos').doc(docId).update(stampWorkspaceUpdate(novoFixo))
      .then(() => {
        showToast('Gasto fixo atualizado com sucesso!');
        modalFixo.classList.add('hidden');
        gerarInsights(); // NOVO: Atualiza insights após editar fixo
      })
      .catch(() => {
        showToast('Erro ao atualizar gasto fixo.', 'error');
      });
  } else {
    // Adicionar novo gasto fixo
    userCollectionRef('fixos').add(stampWorkspaceCreation(novoFixo))
      .then(() => {
        showToast('Gasto fixo adicionado com sucesso!');
        modalFixo.classList.add('hidden');
        gerarInsights(); // NOVO: Atualiza insights após adicionar fixo
      })
      .catch(() => {
        showToast('Erro ao adicionar gasto fixo.', 'error');
      });
  }
});

/* ===========================
   PWA & NOTIFICAÇÕES
   =========================== */
async function solicitarPermissaoNotificacoes() {
  if (typeof Notification === 'undefined') {
    console.warn('Este navegador não suporta notificações.');
    return null;
  }

  if (Notification.permission === 'denied') {
    console.log('Notificações foram negadas anteriormente.');
    return null;
  }

  try {
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      console.log('Permissão para notificações não concedida.');
      return null;
    }

    const vapidKey = appConfig.messaging?.vapidKey || null;
    if (!vapidKey) {
      console.warn('Defina appConfig.messaging.vapidKey para habilitar o recebimento de notificações push.');
      return null;
    }

    const registration = serviceWorkerRegistrationRef
      || (await navigator.serviceWorker.ready.catch(() => null));

    if (!registration) {
      console.warn('Service worker ainda não está pronto para receber notificações.');
      return null;
    }

    if (typeof messaging.useServiceWorker === 'function') {
      messaging.useServiceWorker(registration);
    }

    const token = await messaging.getToken({ vapidKey, serviceWorkerRegistration: registration });
    console.log('Token FCM obtido:', token);
    return token;
  } catch (error) {
    console.error('Erro ao solicitar permissão para notificações:', error);
    return null;
  }
}

async function maybeRequestNotificationPermission({ force = false } = {}) {
  if (typeof Notification === 'undefined') {
    return null;
  }

  const alreadyPrompted = notificationPrompted || Notification.permission !== 'default';

  if (!force) {
    const autoPromptEnabled = Boolean(appConfig.messaging?.autoPrompt);
    if (!autoPromptEnabled || alreadyPrompted) {
      return null;
    }
  }

  const token = await solicitarPermissaoNotificacoes();

  if (!force) {
    notificationPrompted = true;
    try {
      localStorage.setItem(NOTIFICATION_PROMPT_KEY, '1');
    } catch (error) {
      // Ignora indisponibilidade do storage (ex.: navegação privada)
    }
  }

  return token;
}

function requestServiceWorkerActivation(registration) {
  if (!registration || !registration.waiting) return;
  registration.waiting.postMessage({ type: 'SKIP_WAITING' });
}

// Registrar service worker e preparar funcionalidades offline/PWA
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(registration => {
      serviceWorkerRegistrationRef = registration;
      console.log('✅ Service Worker registrado para PWA:', registration.scope);

      if (typeof messaging.useServiceWorker === 'function') {
        try {
          messaging.useServiceWorker(registration);
        } catch (error) {
          console.warn('Não foi possível vincular o service worker ao Firebase Messaging:', error);
        }
      }

      if (registration.waiting) {
        requestServiceWorkerActivation(registration);
      }

      registration.addEventListener('updatefound', () => {
        const installingWorker = registration.installing;
        if (!installingWorker) return;
        installingWorker.addEventListener('statechange', () => {
          if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
            requestServiceWorkerActivation(registration);
          }
        });
      });
    })
    .catch(err => {
      console.error('❌ Erro ao registrar Service Worker:', err);
    });

  navigator.serviceWorker.ready.then(registration => {
    serviceWorkerRegistrationRef = registration;
    if (typeof messaging.useServiceWorker === 'function') {
      try {
        messaging.useServiceWorker(registration);
      } catch (error) {
        console.warn('Não foi possível vincular o service worker ativo ao Firebase Messaging:', error);
      }
    }
  }).catch(() => {
    // Ignora indisponibilidade na primeira carga
  });

  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (swControllerChangeHandled) return;
    swControllerChangeHandled = true;
    showToast('Aplicativo atualizado e pronto para uso offline.', 'success');
  });
}

window.addEventListener('offline', () => {
  showToast('Você está offline. Alguns dados recentes podem não atualizar.', 'warning');
});

window.addEventListener('online', () => {
  showToast('Conexão restabelecida. Dados atualizados novamente.', 'success');
});

/* ===========================
   NOVO: MODAL DE GRÁFICOS INTERATIVOS COM FILTROS
   =========================== */
// Variáveis globais para os gráficos e filtros
let chartCategorias = null;
let chartCartoes = null;
let chartTendenciaCategorias = null; // NOVO: Variável para o gráfico de tendência
let chartInvestimentos = null; // NOVO: Gráfico de evolução dos investimentos
let chartHistoricoMensal = null; // NOVO: Gráfico de resumo mensal do histórico
let chartHistoricoSemanal = null;
let historicoInsightsCache = { docs: [], mesSel: null };
let chartParceladosProjecao = null; // NOVO: Projeção de parcelados
const modalGraficos = document.getElementById('modal-graficos');
const modalGraficosClose = document.getElementById('modal-graficos-close');
const btnHistoricoGraficos = document.getElementById('btn-historico-graficos');
const filtroCartoesContainer = document.getElementById('filtro-cartoes-container');
const filtroCategoriasContainer = document.getElementById('filtro-categorias-container');
const filtroPeriodoGraficos = document.getElementById('filtro-periodo-graficos'); // NOVO
const filtroPeriodoStart = document.getElementById('filtro-periodo-start');     // NOVO
const filtroPeriodoEnd = document.getElementById('filtro-periodo-end');       // NOVO
const btnAplicarFiltros = document.getElementById('btn-aplicar-filtros');
const btnLimparFiltros = document.getElementById('btn-limpar-filtros');

// Função para criar checkboxes dinamicamente
function criarCheckboxes(container, items, prefix, checkedAll = true) {
  container.innerHTML = '';
  items.forEach(item => {
    const id = `${prefix}-${item}`;
    const label = document.createElement('label');
    label.className = 'inline-flex items-center gap-1 cursor-pointer select-none text-gray-700 dark:text-gray-300';
    label.innerHTML = `
      <input type="checkbox" id="${id}" value="${item}" ${checkedAll ? 'checked' : ''} class="checkbox-filtro form-checkbox h-4 w-4 text-blue-600 dark:text-blue-400 border-gray-300 dark:border-gray-600 rounded" />
      <span class="text-gray-700 dark:text-gray-300">${item.charAt(0).toUpperCase() + item.slice(1)}</span>
    `;
    container.appendChild(label);
  });
}

// Função para obter valores dos checkboxes selecionados
function obterSelecionados(prefix) {
  const checkboxes = document.querySelectorAll(`input.checkbox-filtro[id^="${prefix}-"]:checked`);
  return Array.from(checkboxes).map(cb => cb.value);
}

// NOVO: Função auxiliar para obter o intervalo de datas do filtro de período
function getPeriodoDatas() {
  const hoje = new Date();
  const filtroMesEl = document.getElementById('filtro-mes');
  const filtroMesVal = filtroMesEl ? filtroMesEl.value : null;
  const possuiMesSelecionado = filtroMesVal && filtroMesVal !== 'all';
  const baseDate = (() => {
    if (!possuiMesSelecionado) return hoje;
    const [anoSel, mesSel] = filtroMesVal.split('-');
    const ano = parseInt(anoSel, 10);
    const mes = parseInt(mesSel, 10) - 1;
    if (Number.isNaN(ano) || Number.isNaN(mes)) return hoje;
    return new Date(ano, mes, 1);
  })();

  let startDate = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1); // Padrão: início do mês de referência
  let endDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + 1, 0); // Padrão: fim do mês de referência

  const periodoSelecionado = filtroPeriodoGraficos?.value || 'current_month';

  if (periodoSelecionado === 'last_3_months') {
    startDate = new Date(baseDate.getFullYear(), baseDate.getMonth() - 2, 1);
    endDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + 1, 0);
  } else if (periodoSelecionado === 'last_6_months') {
    startDate = new Date(baseDate.getFullYear(), baseDate.getMonth() - 5, 1);
    endDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + 1, 0);
  } else if (periodoSelecionado === 'current_year') {
    startDate = new Date(baseDate.getFullYear(), 0, 1);
    endDate = new Date(baseDate.getFullYear(), 11, 31);
  } else if (periodoSelecionado === 'custom') {
    if (filtroPeriodoStart.value) {
      const [y, m] = filtroPeriodoStart.value.split('-');
      const ano = parseInt(y, 10);
      const mes = parseInt(m, 10) - 1;
      if (!Number.isNaN(ano) && !Number.isNaN(mes)) {
        startDate = new Date(ano, mes, 1);
      }
    }
    if (filtroPeriodoEnd.value) {
      const [y, m] = filtroPeriodoEnd.value.split('-');
      const ano = parseInt(y, 10);
      const mes = parseInt(m, 10);
      if (!Number.isNaN(ano) && !Number.isNaN(mes)) {
        endDate = new Date(ano, mes, 0); // Último dia do mês informado
      }
    }
  }
  // Para 'current_month', os valores padrão baseados em baseDate já estão corretos

  return { startDate, endDate };
}

// Função para filtrar gastos por cartões e categorias (MODIFICADA)
function filtrarGastosPorFiltros(cartoesSelecionados, categoriasSelecionadas) {
  const { startDate, endDate } = getPeriodoDatas(); // NOVO: Obtém o período selecionado
  const gastosFiltrados = allGastosDocs.filter(doc => {
    const d = doc.data();
    if (!d.data) return false;
    
    const keyTransacao = yyyymm(d.data.toDate ? d.data.toDate() : new Date(d.data));
    const keyFatura = d.mesFatura || keyTransacao; // Usa mesFatura para filtragem

    // Converte keyFatura para Date para comparação com startDate/endDate
    const [faturaAno, faturaMes] = keyFatura.split('-');
    const dataFatura = new Date(parseInt(faturaAno), parseInt(faturaMes) - 1, 1);

    // NOVO: Filtra por período usando mesFatura
    if (dataFatura < startDate || dataFatura > endDate) return false;
    
    // Filtra por cartão
    if (cartoesSelecionados.length > 0 && !cartoesSelecionados.includes((d.cartao || '').toLowerCase())) return false;
    // Filtra por categoria
    if (categoriasSelecionadas.length > 0 && !categoriasSelecionadas.includes((d.categoria || '').toLowerCase())) return false;
    return true;
  });
  return gastosFiltrados;
}

// Função para calcular totais por categoria e cartão a partir dos gastos filtrados (MODIFICADA)
function calcularTotais(gastos) {
  const totaisPorCategoria = {};
  const totaisPorCartao = {};
  const totaisPorCategoriaMes = {}; // NOVO: Para o gráfico de tendência
  const totaisPorMes = {};

  gastos.forEach(doc => {
    const d = doc.data();
    if (!d.valor) return;

    // Categoria
    if (d.categoria) {
      const cat = d.categoria.toLowerCase();
      totaisPorCategoria[cat] = (totaisPorCategoria[cat] || 0) + d.valor;

      // NOVO: Para o gráfico de tendência
      const mesAno = d.mesFatura || yyyymm(d.data.toDate ? d.data.toDate() : new Date(d.data)); // Usa mesFatura
      if (!totaisPorCategoriaMes[mesAno]) {
        totaisPorCategoriaMes[mesAno] = {};
      }
      totaisPorCategoriaMes[mesAno][cat] = (totaisPorCategoriaMes[mesAno][cat] || 0) + d.valor;
    }

    // Cartão
    if (d.cartao) {
      const cartao = d.cartao.toLowerCase();
      totaisPorCartao[cartao] = (totaisPorCartao[cartao] || 0) + d.valor;
    }

    const mesReferencia = d.mesFatura || yyyymm(d.data.toDate ? d.data.toDate() : new Date(d.data));
    totaisPorMes[mesReferencia] = (totaisPorMes[mesReferencia] || 0) + d.valor;
  });

  return { totaisPorCategoria, totaisPorCartao, totaisPorCategoriaMes, totaisPorMes }; // NOVO: Retorna totais adicionais
}


// Função para renderizar gráfico de pizza por categoria
function renderGraficoCategorias(totaisPorCategoria) {
  const labels = [];
  const data = [];

  for (const cat in totaisPorCategoria) {
    labels.push(cat.charAt(0).toUpperCase() + cat.slice(1));
    data.push(totaisPorCategoria[cat]);
  }

  const ctx = document.getElementById('grafico-categorias').getContext('2d');
  if (chartCategorias) chartCategorias.destroy();
  chartCategorias = new Chart(ctx, {
    type: 'pie',
    data: {
      labels,
      datasets: [{
        label: 'Gastos por Categoria',
        data,
        backgroundColor: [
          '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'
        ],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { 
          position: 'bottom',
          labels: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151' // Cor da legenda
          }
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const label = ctx.label || '';
              const value = ctx.parsed || 0;
              const total = ctx.dataset.data.reduce((a,b) => a+b, 0);
              const pct = total ? ((value / total) * 100).toFixed(2) : 0;
              return `${label}: R$ ${moeda(value)} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

// Função para renderizar gráfico de barras por cartão
function renderGraficoCartoes(totaisPorCartao) {
  const labels = [];
  const data = [];

  for (const cartao in totaisPorCartao) {
    labels.push(cartao.charAt(0).toUpperCase() + cartao.slice(1));
    data.push(totaisPorCartao[cartao]);
  }

  const ctx = document.getElementById('grafico-cartoes').getContext('2d');
  if (chartCartoes) chartCartoes.destroy(); // CORRIGIDO: Agora destrói chartCartoes
  chartCartoes = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Gastos por Cartão',
        data,
        backgroundColor: '#3b82f6',
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => `R$ ${moeda(val)}`,
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151' // Cor dos ticks
          },
          grid: {
            color: html.classList.contains('dark') ? '#4b5563' : '#e5e7eb' // Cor da grid
          }
        },
        x: {
          ticks: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151' // Cor dos ticks
          },
          grid: {
            color: html.classList.contains('dark') ? '#4b5563' : '#e5e7eb' // Cor da grid
          }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `R$ ${moeda(ctx.parsed.y)}`
          }
        }
      }
    }
  });
}

function renderGraficoHistoricoMensal(totaisPorMes = {}) {
  const canvas = document.getElementById('grafico-historico-mensal');
  if (!canvas) return;
  const emptyState = document.getElementById('historico-mensal-empty');
  const ctx = canvas.getContext('2d');

  if (chartHistoricoMensal) {
    chartHistoricoMensal.destroy();
    chartHistoricoMensal = null;
  }

  const mesesOrdenados = Object.keys(totaisPorMes || {}).sort();
  if (!mesesOrdenados.length) {
    if (emptyState) emptyState.classList.remove('hidden');
    if (ctx) ctx.clearRect(0, 0, canvas.width || 0, canvas.height || 0);
    return;
  }

  if (emptyState) emptyState.classList.add('hidden');

  const limiteMeses = HISTORICO_MENSAL_CHART_CFG.monthsWindow || 0;
  const mesesRecentes = limiteMeses > 0 ? mesesOrdenados.slice(-limiteMeses) : mesesOrdenados;
  const labels = mesesRecentes.map(mmYYYY);
  const valores = mesesRecentes.map(mes => totaisPorMes[mes]);

  const acumulado = [];
  let soma = 0;
  valores.forEach(valor => {
    soma += valor;
    acumulado.push(soma);
  });

  const mediaMovel = valores.map((valor, indice) => {
    const janela = Math.min(indice + 1, 3);
    const start = Math.max(0, indice - janela + 1);
    const slice = valores.slice(start, indice + 1);
    const totalJanela = slice.reduce((acc, curr) => acc + curr, 0);
    return slice.length ? totalJanela / slice.length : valor;
  });

  const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height || 200);
  const [corTopo, corBase] = HISTORICO_MENSAL_CHART_CFG.barColorStops || ['rgba(56, 189, 248, 0.65)', 'rgba(14, 165, 233, 0.25)'];
  gradient.addColorStop(0, corTopo);
  gradient.addColorStop(1, corBase || corTopo);

  const acumuladoColor = HISTORICO_MENSAL_CHART_CFG.acumuladoColor || '#6366f1';
  const mediaColor = HISTORICO_MENSAL_CHART_CFG.mediaColor || '#f97316';
  const barBorderColor = HISTORICO_MENSAL_CHART_CFG.barBorderColor || '#0ea5e9';

  chartHistoricoMensal = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          type: 'bar',
          label: 'Total do mês',
          data: valores,
          backgroundColor: gradient,
          borderColor: barBorderColor,
          borderWidth: 1.5,
          borderRadius: 6,
          order: 2,
          yAxisID: 'y'
        },
        {
          type: 'line',
          label: 'Acumulado',
          data: acumulado,
          borderColor: acumuladoColor,
          backgroundColor: 'transparent',
          borderWidth: 2,
          tension: 0.35,
          pointRadius: 3,
          pointBackgroundColor: acumuladoColor,
          fill: false,
          yAxisID: 'y'
        },
        {
          type: 'line',
          label: 'Média móvel (3 meses)',
          data: mediaMovel,
          borderColor: mediaColor,
          backgroundColor: 'transparent',
          borderDash: [6, 4],
          borderWidth: 2,
          pointRadius: 0,
          pointHitRadius: 8,
          tension: 0.3,
          yAxisID: 'y'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => `R$ ${moeda(val)}`,
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937'
          },
          grid: {
            color: html.classList.contains('dark') ? '#374151' : '#e5e7eb'
          }
        },
        x: {
          ticks: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937'
          },
          grid: {
            display: false
          }
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937'
          }
        },
        tooltip: {
          backgroundColor: html.classList.contains('dark') ? 'rgba(30, 41, 59, 0.9)' : 'rgba(15, 23, 42, 0.9)',
          borderColor: barBorderColor,
          borderWidth: 1,
          callbacks: {
            title: tooltipItems => tooltipItems[0]?.label || '',
            label: context => {
              const label = context.dataset.label || '';
              const value = context.parsed.y;
              return `${label}: R$ ${moeda(value)}`;
            },
            afterBody: tooltipItems => {
              if (!tooltipItems.length) return '';
              const index = tooltipItems[0].dataIndex;
              if (index === 0) return 'Mês inicial do período';
              const diff = valores[index] - valores[index - 1];
              const prev = valores[index - 1];
              const pct = prev ? (diff / prev) * 100 : 0;
              const sinal = diff >= 0 ? '+' : '-';
              const textoValor = `Variação: ${sinal}R$ ${moeda(Math.abs(diff))}`;
              const textoPct = prev ? ` (${pct >= 0 ? '+' : '-'}${Math.abs(pct).toFixed(1)}%)` : '';
              return textoValor + textoPct;
            }
          }
        }
      }
    }
  });
}

function renderGraficoParceladosProjecao(docs = [], refDate = new Date()) {
  const canvas = document.getElementById('grafico-parcelados-projecao');
  const emptyState = document.getElementById('parcelados-projecao-empty');
  const janelaEl = document.getElementById('parcelados-projecao-janela');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');

  if (chartParceladosProjecao) {
    chartParceladosProjecao.destroy();
    chartParceladosProjecao = null;
  }

  const mesesJanela = Math.max(1, PARCELADOS_PROJECAO_CHART_CFG.monthsWindow || 6);
  if (janelaEl) {
    janelaEl.textContent = mesesJanela === 1 ? 'Próximo mês' : `Próximos ${mesesJanela} meses`;
  }

  const totaisPorMes = {};
  const baseRef = new Date(refDate.getFullYear(), refDate.getMonth(), 1);

  docs.forEach(doc => {
    const dados = doc.data ? doc.data() : doc;
    if (!dados) return;
    const valorParcela = Number(dados.valorParcela) || 0;
    const totalParcelas = parseInt(dados.numParcelas, 10) || 0;
    if (!valorParcela || totalParcelas <= 0) return;
    const inicio = dados.dataInicio && dados.dataInicio.toDate ? dados.dataInicio.toDate() : new Date(dados.dataInicio);
    if (!(inicio instanceof Date) || Number.isNaN(inicio.getTime())) return;

    for (let i = 0; i < totalParcelas; i++) {
      const mesParcela = addMonths(inicio, i);
      const key = yyyymm(mesParcela);
      totaisPorMes[key] = (totaisPorMes[key] || 0) + valorParcela;
    }
  });

  const labels = [];
  const valores = [];
  for (let i = 0; i < mesesJanela; i++) {
    const dataMes = addMonths(baseRef, i);
    const chave = yyyymm(dataMes);
    labels.push(mmYYYY(chave));
    valores.push(totaisPorMes[chave] || 0);
  }

  const possuiValores = valores.some(v => v > 0);
  if (!possuiValores) {
    if (emptyState) {
      emptyState.textContent = docs && docs.length
        ? 'Nenhuma parcela prevista para o período selecionado.'
        : 'Cadastre parcelados ativos para visualizar a projeção.';
      emptyState.classList.remove('hidden');
    }
    if (ctx) {
      ctx.clearRect(0, 0, canvas.width || 0, canvas.height || 0);
    }
    return;
  }

  if (emptyState) emptyState.classList.add('hidden');

  const barColor = PARCELADOS_PROJECAO_CHART_CFG.barColor
    || (html.classList.contains('dark') ? 'rgba(167, 139, 250, 0.6)' : 'rgba(129, 140, 248, 0.55)');
  const borderColor = PARCELADOS_PROJECAO_CHART_CFG.borderColor || '#7c3aed';

  chartParceladosProjecao = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Valor mensal projetado',
        data: valores,
        backgroundColor: barColor,
        borderColor,
        borderWidth: 1.5,
        borderRadius: 6,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => `R$ ${moeda(val)}`,
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937',
          },
          grid: {
            color: html.classList.contains('dark') ? '#374151' : '#e5e7eb',
          },
        },
        x: {
          ticks: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937',
          },
          grid: {
            display: false,
          },
        },
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctxTooltip => `R$ ${moeda(ctxTooltip.parsed.y)}`,
          },
        },
      },
    },
  });
}

// MELHORADO: Função para renderizar gráfico de tendência por categoria com controles avançados
function renderGraficoTendenciaCategorias(totaisPorCategoriaMes) {
  const ctx = document.getElementById('grafico-tendencia-categorias').getContext('2d');
  if (chartTendenciaCategorias) chartTendenciaCategorias.destroy();

  // Se não há dados, renderiza gráfico vazio
  if (!totaisPorCategoriaMes || Object.keys(totaisPorCategoriaMes).length === 0) {
    chartTendenciaCategorias = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Sem dados'],
        datasets: []
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        }
      }
    });
    
    // Limpa estatísticas
    document.getElementById('tendencia-total').textContent = 'R$ 0,00';
    document.getElementById('tendencia-maior-mes').textContent = '-';
    document.getElementById('tendencia-menor-mes').textContent = '-';
    document.getElementById('tendencia-media').textContent = 'R$ 0,00';
    return;
  }

  // Organiza os dados por mês
  const mesesOrdenados = Object.keys(totaisPorCategoriaMes).sort();
  const todasCategorias = new Set();
  
  // Coleta todas as categorias únicas
  Object.values(totaisPorCategoriaMes).forEach(mesData => {
    Object.keys(mesData).forEach(cat => todasCategorias.add(cat));
  });

  // Calcula estatísticas para exibir
  const totaisPorMes = mesesOrdenados.map(mes => 
    Object.values(totaisPorCategoriaMes[mes] || {}).reduce((sum, val) => sum + val, 0)
  );
  
  const totalPeriodo = totaisPorMes.reduce((sum, val) => sum + val, 0);
  const maiorMes = Math.max(...totaisPorMes);
  const menorMes = Math.min(...totaisPorMes);
  const mediaMensal = totaisPorMes.length > 0 ? totalPeriodo / totaisPorMes.length : 0;
  
  const indiceMaiorMes = totaisPorMes.indexOf(maiorMes);
  const indiceMenorMes = totaisPorMes.indexOf(menorMes);
  
  // Atualiza estatísticas na interface
  document.getElementById('tendencia-total').textContent = `R$ ${moeda(totalPeriodo)}`;
  document.getElementById('tendencia-maior-mes').textContent = `${mmYYYY(mesesOrdenados[indiceMaiorMes])} (R$ ${moeda(maiorMes)})`;
  document.getElementById('tendencia-menor-mes').textContent = `${mmYYYY(mesesOrdenados[indiceMenorMes])} (R$ ${moeda(menorMes)})`;
  document.getElementById('tendencia-media').textContent = `R$ ${moeda(mediaMensal)}`;

  // Obtém tipo de gráfico selecionado
  const tipoGrafico = document.getElementById('tendencia-tipo-grafico').value;

  const datasets = Array.from(todasCategorias).map((categoria, index) => {
    const cores = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];
    const cor = cores[index % cores.length];
    
    const dataset = {
      label: categoria.charAt(0).toUpperCase() + categoria.slice(1),
      data: mesesOrdenados.map(mes => totaisPorCategoriaMes[mes][categoria] || 0),
      borderColor: cor,
      backgroundColor: tipoGrafico === 'area' ? cor + '40' : cor + '20',
      borderWidth: 2,
      pointRadius: 4,
      pointHoverRadius: 6,
      tension: tipoGrafico === 'line' ? 0.4 : 0
    };

    if (tipoGrafico === 'area') {
      dataset.fill = true;
    }

    return dataset;
  });

  chartTendenciaCategorias = new Chart(ctx, {
    type: tipoGrafico === 'area' ? 'line' : tipoGrafico,
    data: {
      labels: mesesOrdenados.map(mes => mmYYYY(mes)),
      datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      scales: {
        x: {
          grid: {
            display: true,
            color: html.classList.contains('dark') ? '#4b5563' : '#f3f4f6'
          },
          ticks: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151'
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            display: true,
            color: html.classList.contains('dark') ? '#4b5563' : '#f3f4f6'
          },
          ticks: {
            callback: val => `R$ ${moeda(val)}`,
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151'
          }
        }
      },
      plugins: {
        legend: { 
          position: 'bottom',
          labels: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151',
            onClick: (e, legendItem) => {
              const index = legendItem.datasetIndex;
              const chart = chartTendenciaCategorias;
              const meta = chart.getDatasetMeta(index);
              meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
              chart.update();
            }
          }
        },
        tooltip: {
          backgroundColor: html.classList.contains('dark') ? 'rgba(55,65,81,0.9)' : 'rgba(0,0,0,0.8)',
          titleColor: html.classList.contains('dark') ? '#f9fafb' : 'white',
          bodyColor: html.classList.contains('dark') ? '#f9fafb' : 'white',
          borderColor: '#3b82f6',
          borderWidth: 1,
          callbacks: {
            title: (tooltipItems) => {
              return `${tooltipItems[0].label}`;
            },
            label: ctx => `${ctx.dataset.label}: R$ ${moeda(ctx.parsed.y)}`,
            footer: (tooltipItems) => {
              const total = tooltipItems.reduce((sum, item) => sum + item.parsed.y, 0);
              return `Total do mês: R$ ${moeda(total)}`;
            }
          }
        }
      }
    }
  });
}

// NOVO: Event listeners para controles do gráfico de tendência
document.getElementById('tendencia-tipo-grafico').addEventListener('change', () => {
  aplicarFiltros(); // Re-renderiza o gráfico com o novo tipo
});

document.getElementById('btn-toggle-todas-categorias').addEventListener('click', () => {
  if (!chartTendenciaCategorias) return;
  
  const chart = chartTendenciaCategorias;
  const allHidden = chart.data.datasets.every(dataset => {
    const meta = chart.getDatasetMeta(chart.data.datasets.indexOf(dataset));
    return meta.hidden === true;
  });
  
  // Se todas estão ocultas, mostra todas. Caso contrário, oculta todas.
  chart.data.datasets.forEach((dataset, index) => {
    const meta = chart.getDatasetMeta(index);
    meta.hidden = !allHidden;
  });
  
  chart.update();
  
  const btn = document.getElementById('btn-toggle-todas-categorias');
  btn.textContent = allHidden ? 'Ocultar Todas' : 'Mostrar Todas';
});

// Função para aplicar filtros e atualizar gráficos (MODIFICADA)
function aplicarFiltros() {
  const cartoesSelecionados = obterSelecionados('filtro-cartoes').map(c => c.toLowerCase());
  const categoriasSelecionadas = obterSelecionados('filtro-categorias').map(c => c.toLowerCase());

  const gastosFiltrados = allGastosDocs.filter(doc => {
    const d = doc.data();
    if (!d.data) return false;
    
    const keyTransacao = yyyymm(d.data.toDate ? d.data.toDate() : new Date(d.data));
    const keyFatura = d.mesFatura || keyTransacao; // Usa mesFatura para filtragem

    const { startDate, endDate } = getPeriodoDatas();
    // Converte keyFatura para Date para comparação com startDate/endDate
    const [faturaAno, faturaMes] = keyFatura.split('-');
    const dataFatura = new Date(parseInt(faturaAno), parseInt(faturaMes) - 1, 1);

    if (dataFatura < startDate || dataFatura > endDate) return false;
    if (cartoesSelecionados.length > 0 && !cartoesSelecionados.includes((d.cartao || '').toLowerCase())) return false;
    if (categoriasSelecionadas.length > 0 && !categoriasSelecionadas.includes((d.categoria || '').toLowerCase())) return false;
    return true;
  });

  const { totaisPorCategoria, totaisPorCartao, totaisPorCategoriaMes, totaisPorMes } = calcularTotais(gastosFiltrados); // NOVO: Pega totais adicionais

  renderGraficoCategorias(totaisPorCategoria);
  renderGraficoCartoes(totaisPorCartao);
  renderGraficoTendenciaCategorias(totaisPorCategoriaMes); // NOVO: Renderiza o gráfico de tendência
  renderGraficoHistoricoMensal(totaisPorMes);

  // NOVO: Atualiza o resumo de totais no modal
  const totalFiltrado = gastosFiltrados.reduce((sum, doc) => sum + (doc.data().valor || 0), 0);
  document.getElementById('graficos-total-filtrado').textContent = `R$ ${moeda(totalFiltrado)}`;

  const { startDate, endDate } = getPeriodoDatas();
  // Calcula a diferença em meses de forma mais precisa para a média
  const diffYears = endDate.getFullYear() - startDate.getFullYear();
  const diffMonths = endDate.getMonth() - startDate.getMonth();
  const numMeses = diffYears * 12 + diffMonths + 1; // +1 para incluir o mês final

  const mediaMensal = numMeses > 0 ? totalFiltrado / numMeses : 0;
  document.getElementById('graficos-media-mensal').textContent = `R$ ${moeda(mediaMensal)}`;

  const totalTransacoes = gastosFiltrados.length;
  const totalTransacoesEl = document.getElementById('graficos-total-transacoes');
  if (totalTransacoesEl) totalTransacoesEl.textContent = String(totalTransacoes);

  const ticketMedio = totalTransacoes > 0 ? totalFiltrado / totalTransacoes : 0;
  const ticketMedioEl = document.getElementById('graficos-ticket-medio');
  if (ticketMedioEl) ticketMedioEl.textContent = `R$ ${moeda(ticketMedio)}`;

  const topCategoriaEntry = Object.entries(totaisPorCategoria).sort(([,a],[,b]) => b - a)[0];
  const topCategoriaEl = document.getElementById('graficos-top-categoria');
  if (topCategoriaEl) {
    topCategoriaEl.textContent = topCategoriaEntry
      ? `${capitalize(topCategoriaEntry[0])} — R$ ${moeda(topCategoriaEntry[1])}`
      : 'Nenhuma categoria filtrada.';
  }

  const topCartaoEntry = Object.entries(totaisPorCartao).sort(([,a],[,b]) => b - a)[0];
  const topCartaoEl = document.getElementById('graficos-top-cartao');
  if (topCartaoEl) {
    topCartaoEl.textContent = topCartaoEntry
      ? `${cartoesCfg[topCartaoEntry[0]]?.label || capitalize(topCartaoEntry[0])} — R$ ${moeda(topCartaoEntry[1])}`
      : 'Nenhum cartão filtrado.';
  }
}

// Função para limpar filtros (marca todos)
function limparFiltros() {
  document.querySelectorAll('#filtro-cartoes-container input[type=checkbox]').forEach(cb => cb.checked = true);
  document.querySelectorAll('#filtro-categorias-container input[type=checkbox]').forEach(cb => cb.checked = true);
  filtroPeriodoGraficos.value = 'current_month'; // NOVO: Reseta o filtro de período
  filtroPeriodoStart.classList.add('hidden');    // NOVO
  filtroPeriodoEnd.classList.add('hidden');      // NOVO
  aplicarFiltros();
}

function abrirModalGraficos() {
  if (!modalGraficos) return;
  modalGraficos.classList.remove('hidden');
  updateFloatingMenuVisibility();

  const cartoesUnicos = Array.from(new Set((allGastosDocs || []).map(doc => (doc.data().cartao || '').toLowerCase()).filter(c => c)));
  const categoriasUnicas = Array.from(new Set((allGastosDocs || []).map(doc => (doc.data().categoria || '').toLowerCase()).filter(c => c)));

  if (filtroCartoesContainer) {
    criarCheckboxes(filtroCartoesContainer, cartoesUnicos, 'filtro-cartoes', true);
  }
  if (filtroCategoriasContainer) {
    criarCheckboxes(filtroCategoriasContainer, categoriasUnicas, 'filtro-categorias', true);
  }

  if (filtroPeriodoGraficos) filtroPeriodoGraficos.value = 'current_month';
  if (filtroPeriodoStart) filtroPeriodoStart.classList.add('hidden');
  if (filtroPeriodoEnd) filtroPeriodoEnd.classList.add('hidden');

  aplicarFiltros();
}

// Inicializa filtros e gráficos ao abrir modal (MODIFICADA)
btnHistoricoGraficos?.addEventListener('click', abrirModalGraficos);

modalGraficosClose.addEventListener('click', () => {
  modalGraficos.classList.add('hidden');
  updateFloatingMenuVisibility();
  if (chartCategorias) {
    chartCategorias.destroy();
    chartCategorias = null;
  }
  if (chartCartoes) {
    chartCartoes.destroy();
    chartCartoes = null;
  }
  if (chartTendenciaCategorias) { // NOVO: Destrói o gráfico de tendência
    chartTendenciaCategorias.destroy();
    chartTendenciaCategorias = null;
  }
  if (chartHistoricoMensal) {
    chartHistoricoMensal.destroy();
    chartHistoricoMensal = null;
  }
});

btnAplicarFiltros.addEventListener('click', aplicarFiltros);
btnLimparFiltros.addEventListener('click', limparFiltros);

// NOVO: Event listener para o filtro de período
filtroPeriodoGraficos.addEventListener('change', () => {
  if (filtroPeriodoGraficos.value === 'custom') {
    filtroPeriodoStart.classList.remove('hidden');
    filtroPeriodoEnd.classList.remove('hidden');
    // Define valores padrão para o mês atual se estiver vazio
    const hoje = new Date();
    if (!filtroPeriodoStart.value) filtroPeriodoStart.value = yyyymm(hoje);
    if (!filtroPeriodoEnd.value) filtroPeriodoEnd.value = yyyymm(hoje);
  } else {
    filtroPeriodoStart.classList.add('hidden');
    filtroPeriodoEnd.classList.add('hidden');
  }
  aplicarFiltros(); // Aplica filtros imediatamente após mudar o período
});

// NOVO: Event listeners para os inputs de data personalizados
filtroPeriodoStart.addEventListener('change', aplicarFiltros);
filtroPeriodoEnd.addEventListener('change', aplicarFiltros);


/* ===========================
   BOOTSTRAP: start observers and initial load
   =========================== */
function boot(){
  carregarEnvelopes();
  // initial empty UI
  atualizarBarrasVisuais();
  // start observing everything
  startObservers();
  // 🔥 Força o filtro de mês para o mês atual
  const filtroMes = document.getElementById('filtro-mes');
  const mesAtual = yyyymm(new Date());
  filtroMes.value = mesAtual;
  // NOVO: Popula os selects de cartão na inicialização
  popularSelectCartoes(); 
  
  // NOVO: Inicializa sistemas de melhorias
  initTagsSystem();
  initHistoricoSearch();
  initHistoricoCollapsible(); // Inicializa a funcionalidade de colapsar/expandir
  initHistoricoActions();     // Inicializa os botões de ação
  initFloatingMenu(); // NOVO: Inicializa o menu flutuante
}


/* ===========================
   INSIGHTS INTELIGENTES
   =========================== */
function gerarInsights() {
  const container = document.getElementById('insights-container');
  container.innerHTML = '';
  
  const insights = [];
  const hoje = new Date();

  // Insight: Categoria que mais consome (do mês atual)
  if (window._totaisPorCategoriaAtual && Object.keys(window._totaisPorCategoriaAtual).length > 0) {
    const categoriaMax = Object.entries(window._totaisPorCategoriaAtual)
      .sort(([,a], [,b]) => b - a)[0];
    if (categoriaMax) {
      insights.push({
        icon: '📊',
        title: 'Categoria Dominante (Mês)',
        description: `${categoriaMax[0].charAt(0).toUpperCase() + categoriaMax[0].slice(1)} é sua maior categoria de gastos com R$ ${moeda(categoriaMax[1])} este mês.`,
        type: 'info'
      });
    }
  }
  
  // Insight: Alerta: Orçamento Estourado!
  const totalGasto = (resumo.historicoMes || 0) + (resumo.parcelasMes || 0) + (resumo.fixosMes || 0);
  const totalLimite = ['fixo', 'parcelado', 'variavel'].reduce((acc, tipo) => acc + getEnvelopeMeta(tipo), 0);
  const reservasTotais = ['fixo', 'parcelado', 'variavel'].reduce((acc, tipo) => acc + (Number(envelopes[tipo]?.reservado || 0)), 0);
  const economia = totalLimite - (totalGasto + reservasTotais);
  if (economia < 0) {
    insights.push({
      icon: '🚨',
      title: 'Alerta: Limite mensal estourado!',
      description: `Gastos e reservas ultrapassaram o orçamento em R$ ${moeda(Math.abs(economia))} este mês.`,
      type: 'error'
    });
  }

  if (economia > 0) {
    insights.push({
      icon: '✅',
      title: 'Limites ainda com folga',
      description: `Há R$ ${moeda(economia)} livres dentro dos limites definidos. Considere destinar essa folga para reservas futuras ou investimentos.`,
      type: 'success'
    });
  }

  // Insight: Maior Parcelamento
  if (allParceladosDocs && allParceladosDocs.length > 0) {
    let maiorParcelado = { nome: '', valor: 0 };

    allParceladosDocs.forEach(doc => {
      const p = doc.data();
      if (p.valorParcela > maiorParcelado.valor) {
        maiorParcelado = { nome: p.descricao, valor: p.valorParcela };
      }
    });
    
    if (maiorParcelado.valor > 0) {
      insights.push({
        icon: '💸',
        title: 'Maior Parcelamento',
        description: `Seu maior parcelamento é "${maiorParcelado.nome}" com R$ ${moeda(maiorParcelado.valor)} por mês.`,
        type: 'info'
      });
    }
  }

  // Insight: Atenção: Gastos Fixos Elevados
  const metaFixo = getEnvelopeMeta('fixo');
  const fixoPercent = metaFixo ? ((resumo.fixosMes || 0) / metaFixo * 100) : 0;
  if (metaFixo && fixoPercent > 80) {
    insights.push({
      icon: '⚠️',
      title: 'Atenção: Gastos Fixos Elevados',
      description: `Seus gastos fixos estão em ${fixoPercent.toFixed(1)}% do limite. Considere revisar assinaturas não utilizadas.`,
      type: 'warning'
    });
  }

  const resumoAtual = resumoFinanceiroAtual || {};
  const saldoProjetado = resumoAtual.saldoProjetado || 0;
  const entradasMes = resumoAtual.entradasMes || painelFinanceiroState.entradasMes || 0;
  const investimentosMes = painelFinanceiroState.investimentosMes || 0;
  const investimentosTotais = painelFinanceiroState.investimentosTotais || 0;

  ['fixo', 'parcelado', 'variavel'].forEach(tipo => {
    const meta = getEnvelopeMeta(tipo);
    if (!meta) return;
    const gastoAtual = getEnvelopeGastoAtual(tipo);
    const reservado = Number(envelopes[tipo]?.reservado || 0);
    const comprometido = gastoAtual + reservado;
    const limiteLivre = Math.max(0, meta - comprometido);
    const excedente = comprometido > meta ? comprometido - meta : 0;
    const tituloEnvelope = envelopeConfig[tipo]?.titulo || tipo;

    if (limiteLivre > 0 && saldoProjetado > 0) {
      insights.push({
        icon: '🎯',
        title: `Reserve no envelope de ${tituloEnvelope.toLowerCase()}`,
        description: `Há R$ ${moeda(limiteLivre)} ainda livres neste limite. Converta em reserva ou redirecione para objetivos futuros diretamente pelos envelopes.`,
        type: 'success'
      });
    }

    if (excedente > 0) {
      insights.push({
        icon: '⚠️',
        title: `${tituloEnvelope} estourou o limite`,
        description: `Gastos e reservas somam R$ ${moeda(comprometido)}, superando o limite em R$ ${moeda(excedente)}. Reavalie despesas ou ajuste o teto para o próximo mês.`,
        type: 'warning'
      });
    } else if (limiteLivre > 0 && hoje.getDate() > 20) {
      insights.push({
        icon: '⏳',
        title: `Folga restante em ${tituloEnvelope.toLowerCase()}`,
        description: `Restam R$ ${moeda(limiteLivre)} de margem nos últimos dias do mês. Planeje se vale reservar essa folga ou ajustar o limite estabelecido.`,
        type: 'info'
      });
    }

    if (reservado > 0 && reservado >= meta * 0.1) {
      insights.push({
        icon: '💼',
        title: `Reserva garantida em ${tituloEnvelope.toLowerCase()}`,
        description: `Você já separou R$ ${moeda(reservado)} para os próximos meses. Considere planejar como aplicará essa reserva para antecipar objetivos.`,
        type: 'info'
      });
    }
  });

  if (entradasMes > 0) {
    const percentualInvestido = (investimentosMes / entradasMes) * 100;
    if (investimentosMes <= 0 && saldoProjetado > 0) {
      insights.push({
        icon: '🚀',
        title: 'Direcione parte do saldo para investir',
        description: 'Você possui saldo projetado positivo. Avalie destinar uma parcela para investimentos recorrentes e acelerar suas metas.',
        type: 'info'
      });
    } else if (percentualInvestido < 10 && investimentosMes > 0) {
      insights.push({
        icon: '📈',
        title: 'Aumente seus aportes mensais',
        description: `Atualmente apenas ${percentualInvestido.toFixed(1)}% das suas entradas viraram investimentos. Ajuste os aportes para chegar em pelo menos 10%.`,
        type: 'warning'
      });
    } else if (percentualInvestido >= 20) {
      insights.push({
        icon: '🥇',
        title: 'Excelente ritmo de investimentos',
        description: `Você está investindo ${percentualInvestido.toFixed(1)}% das entradas deste mês. Mantenha a consistência para acelerar seus objetivos.`,
        type: 'success'
      });
    }
  }

  if (investimentosTotais > 0 && saldoProjetado > investimentosTotais * 0.05) {
    insights.push({
      icon: '🔁',
      title: 'Reforce sua carteira com a reserva disponível',
      description: `O saldo projetado pode aumentar sua carteira em até R$ ${moeda(Math.min(saldoProjetado, investimentosTotais * 0.2))}. Considere um aporte extra pelo simulador para ver o impacto.`,
      type: 'info'
    });
  }
  
  // Renderiza insights
  if (insights.length === 0) {
    container.innerHTML = '<div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-gray-500 dark:text-gray-400 text-sm">Aguardando dados para gerar insights...</div>';
    return;
  }
  
  const maxVisiveis = MAX_INSIGHTS_VISIBLE;
  const criarCardInsight = (insight) => {
    const div = document.createElement('div');
    div.className = `p-3 rounded-lg border-l-4 ${
      insight.type === 'success' ? 'bg-green-50 dark:bg-green-900/20 border-green-500' :
      insight.type === 'warning' ? 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-500' :
      insight.type === 'error' ? 'bg-red-50 dark:bg-red-900/20 border-red-500' :
      'bg-blue-50 dark:bg-blue-900/20 border-blue-500'
    }`;
    div.innerHTML = `
      <div class="flex items-start gap-2">
        <span class="text-lg">${insight.icon}</span>
        <div class="flex-1">
          <h4 class="font-semibold text-sm ${
            insight.type === 'success' ? 'text-green-800 dark:text-green-200' :
            insight.type === 'warning' ? 'text-yellow-800 dark:text-yellow-200' :
            insight.type === 'error' ? 'text-red-800 dark:text-red-300' :
            'text-blue-800 dark:text-blue-200'
          }">${insight.title}</h4>
          <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${insight.description}</p>
        </div>
      </div>
    `;
    return div;
  };

  insights.slice(0, maxVisiveis).forEach(insight => {
    container.appendChild(criarCardInsight(insight));
  });

  const extras = insights.slice(maxVisiveis);
  if (extras.length > 0) {
    const extrasWrapper = document.createElement('div');
    extrasWrapper.className = 'space-y-3 hidden mt-3';
    extrasWrapper.dataset.insightsExtra = 'true';
    extras.forEach(insight => {
      extrasWrapper.appendChild(criarCardInsight(insight));
    });

    const toggleBtn = document.createElement('button');
    toggleBtn.type = 'button';
    toggleBtn.className = 'text-xs font-semibold text-indigo-600 dark:text-indigo-300 hover:underline flex items-center gap-2 mt-3';
    toggleBtn.setAttribute('aria-expanded', 'false');
    const labelSpan = document.createElement('span');
    labelSpan.textContent = INSIGHTS_TOGGLE_LABELS.showMore;
    const icon = document.createElement('i');
    icon.className = 'fa fa-chevron-down text-[0.7rem]';
    toggleBtn.append(labelSpan, icon);
    toggleBtn.addEventListener('click', () => {
      const estavaOculto = extrasWrapper.classList.contains('hidden');
      extrasWrapper.classList.toggle('hidden');
      const expanded = estavaOculto;
      toggleBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      labelSpan.textContent = expanded ? INSIGHTS_TOGGLE_LABELS.showLess : INSIGHTS_TOGGLE_LABELS.showMore;
      icon.className = expanded ? 'fa fa-chevron-up text-[0.7rem]' : 'fa fa-chevron-down text-[0.7rem]';
    });

    container.appendChild(extrasWrapper);
    container.appendChild(toggleBtn);
  }
}



/* ===========================
   CONTROLE DE VISIBILIDADE DO MENU DE AÇÕES
   =========================== */
window.addEventListener('scroll', () => {
  const floatingMenu = document.getElementById('floating-menu');
  if (!floatingMenu) return;

  const st = window.pageYOffset || document.documentElement.scrollTop;
  const quickIncomeMenu = document.getElementById('quick-income-menu');
  const quickIncomeButton = document.getElementById('btn-quick-entradas');
  if (quickIncomeMenu) quickIncomeMenu.classList.add('hidden');
  if (quickIncomeButton) quickIncomeButton.setAttribute('aria-expanded', 'false');
  const isModalOpen = !document.getElementById('modal-add-gasto').classList.contains('hidden') ||
                     !document.getElementById('modal-graficos').classList.contains('hidden') ||
                     !document.getElementById('modal-fixo').classList.contains('hidden') ||
                     !document.getElementById('modal-parcelado').classList.contains('hidden') ||
                     !document.getElementById('modal-graficos-fixos').classList.contains('hidden') ||
                     !document.getElementById('modal-planejamento-envelopes').classList.contains('hidden') ||
                     !document.getElementById('modal-confirmacao').classList.contains('hidden') ||
                     !document.getElementById('modal-gerenciar-cartoes').classList.contains('hidden');

  if (isModalOpen) {
    floatingMenu.classList.add('invisible');
    floatingMenu.style.display = 'none';
    return;
  }

  floatingMenu.classList.remove('invisible');
  floatingMenu.style.display = 'flex';

  if (st > lastScrollTop && st > 120) {
    floatingMenu.style.transform = 'translateY(110%)';
    floatingMenu.style.opacity = '0';
  } else {
    floatingMenu.style.transform = 'translateY(0)';
    floatingMenu.style.opacity = '1';
  }

  lastScrollTop = st <= 0 ? 0 : st;
});

// Função para esconder/mostrar menu quando modals abrem/fecham
function updateFloatingMenuVisibility() {
  const floatingMenu = document.getElementById('floating-menu');
  if (!floatingMenu) return;

  const quickIncomeMenu = document.getElementById('quick-income-menu');
  const quickIncomeButton = document.getElementById('btn-quick-entradas');
  if (quickIncomeMenu) quickIncomeMenu.classList.add('hidden');
  if (quickIncomeButton) quickIncomeButton.setAttribute('aria-expanded', 'false');

    const isModalOpen = !document.getElementById('modal-add-gasto').classList.contains('hidden') ||
                       !document.getElementById('modal-graficos').classList.contains('hidden') ||
                       !document.getElementById('modal-fixo').classList.contains('hidden') ||
                       !document.getElementById('modal-parcelado').classList.contains('hidden') ||
                       !document.getElementById('modal-graficos-fixos').classList.contains('hidden') ||
                       !document.getElementById('modal-planejamento-envelopes').classList.contains('hidden') ||
                       !document.getElementById('modal-confirmacao').classList.contains('hidden') ||
                       !document.getElementById('modal-gerenciar-cartoes').classList.contains('hidden');

  if (isModalOpen) {
    floatingMenu.classList.add('invisible');
    floatingMenu.style.display = 'none';
    floatingMenu.style.opacity = '0';
  } else {
    floatingMenu.classList.remove('invisible');
    floatingMenu.style.display = 'flex';
    floatingMenu.style.transform = 'translateY(0)';
    floatingMenu.style.opacity = '1';
  }
}

    /* ===========================
       NOVO: BUSCA E AGRUPAMENTO NO HISTÓRICO
       =========================== */
    // Mantido como estava, mas a função renderHistoricoWithFilters será atualizada
    function initHistoricoSearch() {
      const searchInput = document.getElementById('search-historico');
      const groupBySelect = document.getElementById('group-by-historico');
      const clearButton = document.getElementById('clear-search');

      searchInput.addEventListener('input', (e) => {
        currentSearchTerm = e.target.value.toLowerCase().trim();
        renderHistoricoWithFilters();
      });

      groupBySelect.addEventListener('change', (e) => {
        currentGroupBy = e.target.value;
        renderHistoricoWithFilters();
      });

      clearButton.addEventListener('click', () => {
        searchInput.value = '';
        groupBySelect.value = '';
        currentSearchTerm = '';
        currentGroupBy = '';
        renderHistoricoWithFilters();
      });
    }

    // Variável para armazenar o estado de colapso dos grupos
    let collapsedGroups = JSON.parse(localStorage.getItem('historicoCollapsedGroups')) || {};

    /* ===========================
       NOVO: FUNÇÕES PARA COLAPSAR/EXPANDIR GRUPOS NO HISTÓRICO
       =========================== */
    function initHistoricoCollapsible() {
      document.getElementById('transactions-list').addEventListener('click', (e) => {
        const header = e.target.closest('.group-header');
        if (header) {
          const groupKey = header.dataset.groupKey;
          toggleGroupVisibility(groupKey);
        }
      });
    }

    function toggleGroupVisibility(groupKey) {
      const items = document.querySelectorAll(`.group-item[data-group-key="${groupKey}"]`);
      const headerIcon = document.querySelector(`.group-header[data-group-key="${groupKey}"] .group-toggle-icon`);

      if (!items.length || !headerIcon) return;

      const isCollapsed = items[0].classList.contains('hidden');

      items.forEach(item => {
        if (isCollapsed) {
          item.classList.remove('hidden');
        } else {
          item.classList.add('hidden');
        }
      });

      if (isCollapsed) {
        headerIcon.classList.remove('fa-chevron-right');
        headerIcon.classList.add('fa-chevron-down');
        collapsedGroups[groupKey] = false;
      } else {
        headerIcon.classList.remove('fa-chevron-down');
        headerIcon.classList.add('fa-chevron-right');
        collapsedGroups[groupKey] = true;
      }
      localStorage.setItem('historicoCollapsedGroups', JSON.stringify(collapsedGroups));
    }

    /* ===========================
       NOVO: FUNÇÕES PARA AÇÕES DE EDITAR/REMOVER NO HISTÓRICO
       =========================== */
    function initHistoricoActions() {
      document.getElementById('transactions-list').addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-gasto');
        const deleteBtn = e.target.closest('.delete-gasto');

        if (editBtn) {
          const id = editBtn.dataset.id;
          editarGastoModal(id);
        } else if (deleteBtn) {
          const id = deleteBtn.dataset.id;
          removerGasto(id);
        }
      });
    }

    /* ===========================
       FUNÇÃO PARA REMOVER GASTO DO HISTÓRICO
       =========================== */
    function removerGasto(id) {
      abrirModalConfirmacao(
        'Excluir Gasto',
        'Deseja realmente excluir este gasto? Esta ação é irreversível.',
        () => { // Callback de confirmação
          userCollectionRef('gastos').doc(id).delete()
            .then(() => {
              showToast('Gasto removido com sucesso!', 'success');
              // Re-renderiza o histórico para refletir a mudança
              renderHistoricoWithFilters();
              // Opcional: Atualiza outros resumos se necessário
              gerarInsights();
            })
            .catch(err => {
              showToast('Erro ao remover gasto: ' + err.message, 'error');
            });
        }
      );
    }
    

    function editarGastoModal(id) {
      const gastoDoc = allGastosDocs.find(doc => doc.id === id);
      if (!gastoDoc) {
        showToast('Gasto não encontrado para edição.', 'error');
        return;
      }
      const d = gastoDoc.data();

      // Preencher o modal de adicionar gasto com os dados do gasto a ser editado
      document.getElementById('modal-add-gasto').classList.remove('hidden');
      document.getElementById('modal-add-gasto').dataset.editId = id; // Armazena o ID para saber que é edição
      document.getElementById('modal-add-gasto').querySelector('h2').textContent = 'Editar Gasto Variável';

      document.getElementById('modal-cartao').value = d.cartao || '';
      document.getElementById('modal-categoria').value = d.categoria || '';
      document.getElementById('modal-valor').value = d.valor || '';
      document.getElementById('modal-desc').value = d.descricao || '';

      // Preencher tags
      selectedTagsArray = d.tags || [];
      renderSelectedTags();

      // Atualizar mês de fatura estimado
      atualizarMesFaturaEstimado();

      // Mudar o texto do botão de submissão
      document.querySelector('#form-add-gasto-modal button[type="submit"]').textContent = 'Salvar Alterações';

      // Remover o listener antigo do form e adicionar um novo para edição
      formAddGastoModal.removeEventListener('submit', handleAddGastoSubmit);
      formAddGastoModal.addEventListener('submit', handleEditGastoSubmit);
    }

    // Função auxiliar para lidar com a submissão de adição (original)
    function handleAddGastoSubmit(e) {
      e.preventDefault();
      const cartaoSelecionado = document.getElementById('modal-cartao').value || '';
      const categoria = document.getElementById('modal-categoria').value || '';
      const valorInput = document.getElementById('modal-valor');
      const valor = parseFloat(valorInput.value) || 0;
      const desc = document.getElementById('modal-desc').value || '';

      const errorValor = document.getElementById('error-modal-valor');
      valorInput.classList.remove('border-red-500');
      errorValor.classList.add('hidden');

      if (valor <= 0) {
        valorInput.classList.add('border-red-500');
        errorValor.classList.remove('hidden');
        showToast('Valor é obrigatório e deve ser maior que zero.', 'error');
        return;
      }

      const hoje = new Date();
      let mesFaturaCalculado;
      if (cartaoSelecionado === 'pix' || cartaoSelecionado === '') {
        mesFaturaCalculado = yyyymm(hoje);
      } else {
        const configCartao = cartoesCfg[cartaoSelecionado];
        if (configCartao && configCartao.fechamento !== null && configCartao.fechamento !== undefined) {
          const offset = obterOffsetCartao(configCartao);
          mesFaturaCalculado = calcularMesFatura(hoje, configCartao.fechamento, offset);
        } else {
          mesFaturaCalculado = yyyymm(hoje);
        }
      }

      userCollectionRef('gastos').add(stampWorkspaceCreation({
        tipo: 'variavel',
        cartao: cartaoSelecionado,
        categoria,
        valor,
        descricao: desc,
        tags: selectedTagsArray,
        data: firebase.firestore.Timestamp.now(),
        mesFatura: mesFaturaCalculado,
      })).then(() => {
        selectedTagsArray = [];
        renderSelectedTags();
        fecharModal();
        showToast('Gasto variável adicionado com sucesso!');
        gerarInsights();
      }).catch(err => {
        showToast('Erro ao adicionar gasto: ' + err.message, 'error');
      });
    }

    // Função auxiliar para lidar com a submissão de edição
    function handleEditGastoSubmit(e) {
      e.preventDefault();
      const id = document.getElementById('modal-add-gasto').dataset.editId;
      if (!id) {
        showToast('Erro: ID do gasto não encontrado para edição.', 'error');
        return;
      }

      const cartaoSelecionado = document.getElementById('modal-cartao').value || '';
      const categoria = document.getElementById('modal-categoria').value || '';
      const valorInput = document.getElementById('modal-valor');
      const valor = parseFloat(valorInput.value) || 0;
      const desc = document.getElementById('modal-desc').value || '';

      const errorValor = document.getElementById('error-modal-valor');
      valorInput.classList.remove('border-red-500');
      errorValor.classList.add('hidden');

      if (valor <= 0) {
        valorInput.classList.add('border-red-500');
        errorValor.classList.remove('hidden');
        showToast('Valor é obrigatório e deve ser maior que zero.', 'error');
        return;
      }

      // Recalcular mesFatura para o caso de o cartão ter sido alterado
     const hoje = new Date();
let mesFaturaCalculado;
if (cartaoSelecionado === 'pix' || cartaoSelecionado === '') {
  mesFaturaCalculado = yyyymm(hoje);  // PIX: sempre atual
} else {
  const configCartao = cartoesCfg[cartaoSelecionado];
  const fechamento = configCartao ? configCartao.fechamento : null;
  const offset = obterOffsetCartao(configCartao);
  if (fechamento !== null && fechamento !== undefined) {
    mesFaturaCalculado = calcularMesFatura(hoje, fechamento, offset);  // <-- NOVO: Passa offset
  } else {
    mesFaturaCalculado = yyyymm(hoje);  // Fallback
  }
}

      userCollectionRef('gastos').doc(id).update(stampWorkspaceUpdate({
        cartao: cartaoSelecionado,
        categoria,
        valor,
        descricao: desc,
        tags: selectedTagsArray,
        mesFatura: mesFaturaCalculado
      })).then(() => {
        selectedTagsArray = [];
        renderSelectedTags();
        fecharModal();
        showToast('Gasto atualizado com sucesso!');
        gerarInsights();
      }).catch(err => {
        showToast('Erro ao atualizar gasto: ' + err.message, 'error');
      }).finally(() => {
        // Resetar o formulário e o botão para o estado de "adicionar"
        document.getElementById('modal-add-gasto').querySelector('h2').textContent = 'Adicionar Gasto Variável';
        document.querySelector('#form-add-gasto-modal button[type="submit"]').textContent = 'Adicionar';
        delete document.getElementById('modal-add-gasto').dataset.editId;
        formAddGastoModal.removeEventListener('submit', handleEditGastoSubmit);
        formAddGastoModal.addEventListener('submit', handleAddGastoSubmit);
      });
    }

    

    /* ===========================
       ATUALIZAÇÃO DA FUNÇÃO renderHistoricoWithFilters
       =========================== */
    // Esta função já foi atualizada acima, mas a deixamos aqui para referência
    // function renderHistoricoWithFilters() { ... }

    function renderHistoricoGroupedByCartao(docs) {
      const tbody = document.getElementById('transactions-list');
      const groups = {};

      docs.forEach(doc => {
        const d = doc.data();
        const cartaoKey = d.cartao || 'sem_cartao';
        if (!groups[cartaoKey]) {
          groups[cartaoKey] = [];
        }
        groups[cartaoKey].push(doc);
      });

      Object.keys(groups).sort().forEach(cartaoKey => {
        const cartaoLabel = (cartoesCfg[cartaoKey] && cartoesCfg[cartaoKey].label) || cartaoKey.replace('_', ' ').toUpperCase();
        const totalGroup = groups[cartaoKey].reduce((sum, doc) => sum + (doc.data().valor || 0), 0);
        const isCollapsed = collapsedGroups[cartaoKey] || false;
        const iconClass = isCollapsed ? 'fa-chevron-right' : 'fa-chevron-down';

        const groupHeader = document.createElement('tr');
        groupHeader.className = 'group-header cursor-pointer bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors';
        groupHeader.dataset.groupKey = cartaoKey;
        groupHeader.setAttribute('role', 'button');
        groupHeader.setAttribute('tabindex', '0');
        groupHeader.setAttribute('aria-expanded', !isCollapsed);
        groupHeader.innerHTML = `
          <td colspan="8" class="td font-semibold text-gray-800 dark:text-gray-100">
            <i class="fa ${iconClass} mr-2 group-toggle-icon"></i>
            ${cartaoLabel} — Total: R$ ${moeda(totalGroup)}
          </td>
        `;
        tbody.appendChild(groupHeader);

        groups[cartaoKey].forEach(doc => {
          const d = doc.data();
          const id = doc.id;
          const dt = d.data.toDate ? d.data.toDate() : new Date(d.data);
          const mesFaturaDisplay = d.mesFatura ? mmYYYY(d.mesFatura) : '-';

          const tagsHtml = (d.tags || []).map(tag =>
            `<span class="tag-pill" style="font-size: 0.6rem; padding: 0.125rem 0.25rem;">${tag}</span>`
          ).join('');

          let descricao = d.descricao || '';
          if (currentSearchTerm) {
            const regex = new RegExp(`(${currentSearchTerm})`, 'gi');
            descricao = descricao.replace(regex, '<span class="search-highlight">$1</span>');
          }

          const tr = document.createElement('tr');
          tr.className = `group-item ${isCollapsed ? 'hidden' : ''}`;
          tr.dataset.groupKey = cartaoKey;
           tr.innerHTML = `
            <td class="td">${(cartoesCfg[d.cartao] && cartoesCfg[d.cartao].label) || d.cartao || ''}</td>
            <td class="td">${descricao}</td>
            <td class="td">R$ ${moeda(d.valor)}</td>
            <td class="td">${dt.toLocaleDateString('pt-BR')}</td>
            <td class="td">${mesFaturaDisplay}</td>
            <td class="td">${d.tipo}</td>
            <td class="td">
        <div class="flex flex-wrap gap-1">${tagsHtml}</div>
      </td>
      <td class="td">
        <button class="text-blue-600 dark:text-blue-400 edit-gasto mr-2 hover:text-blue-800 dark:hover:text-blue-200" data-id="${id}" aria-label="Editar gasto">
          <i class="fa fa-edit"></i>
        </button>
        <button class="text-red-600 dark:text-red-400 delete-gasto hover:text-red-800 dark:hover:text-red-200" data-id="${id}" aria-label="Remover gasto">
          <i class="fa fa-trash"></i>
        </button>
      </td>
    `;
    
          tbody.appendChild(tr);
        });
      });
    }

/* ===========================
   MODAL DE PARCELADOS
   =========================== */
// Variáveis do modal de parcelado
const modalParcelado = document.getElementById('modal-parcelado');
const formParcelado = document.getElementById('form-parcelado');
const btnCancelarParcelado = document.getElementById('btn-cancelar-parcelado');
// Abrir modal para adicionar/editar parcelado
function abrirModalParcelado(dados = null) { // Adicionado = null para default
  modalParcelado.classList.remove('hidden');
  formParcelado.reset(); // Sempre reseta o formulário ao abrir
  if (dados) {
    document.getElementById('modal-parcelado-title').textContent = 'Editar Parcelado';
    formParcelado.descricao.value = dados.descricao || '';
    formParcelado.valorParcela.value = dados.valorParcela || '';
    formParcelado.numParcelas.value = dados.numParcelas || '';
    formParcelado.cartao.value = dados.cartao || '';
    // Formatar data para input month (YYYY-MM)
    if (dados.dataInicio) {
      const data = dados.dataInicio;
      const year = data.getFullYear();
      const month = String(data.getMonth() + 1).padStart(2, '0');
      formParcelado.dataInicio.value = `${year}-${month}`;
    }
    formParcelado.dataset.docId = dados.id; // para edição
    // Mudar o texto do botão de submissão para "Salvar"
    formParcelado.querySelector('button[type="submit"]').textContent = 'Salvar';
  } else {
    document.getElementById('modal-parcelado-title').textContent = 'Adicionar Parcelado'; // Título para adicionar
    delete formParcelado.dataset.docId; // Garante que não há ID de edição
    // Mudar o texto do botão de submissão para "Adicionar"
    formParcelado.querySelector('button[type="submit"]').textContent = 'Adicionar';
  }
}
btnCancelarParcelado.addEventListener('click', () => {
  modalParcelado.classList.add('hidden');
});
// Submissão do formulário para adicionar ou editar parcelado
formParcelado.addEventListener('submit', e => {
  e.preventDefault();
  const parceladoData = { // Renomeado para evitar conflito com parceladoAtualizado
    descricao: formParcelado.descricao.value.trim(),
    valorParcela: parseFloat(formParcelado.valorParcela.value),
    numParcelas: parseInt(formParcelado.numParcelas.value),
    cartao: formParcelado.cartao.value || '',
  };
  // Converte a data de volta para Date object
  if (formParcelado.dataInicio.value) {
    const [year, month] = formParcelado.dataInicio.value.split('-');
    parceladoData.dataInicio = new Date(parseInt(year), parseInt(month) - 1, 1);
  }
  if (!parceladoData.descricao || isNaN(parceladoData.valorParcela) || isNaN(parceladoData.numParcelas) || parceladoData.valorParcela <= 0 || parceladoData.numParcelas < 1) {
    showToast('Por favor, preencha todos os campos obrigatórios corretamente.', 'error');
    return;
  }
  const docId = formParcelado.dataset.docId;
  if (docId) {
    // Editar parcelado existente
    userCollectionRef('parcelados').doc(docId).update(stampWorkspaceUpdate(parceladoData))
      .then(() => {
        showToast('Parcelado atualizado com sucesso!');
        modalParcelado.classList.add('hidden');
        gerarInsights(); // NOVO: Atualiza insights após editar parcelado
      })
      .catch(() => {
        showToast('Erro ao atualizar parcelado.', 'error');
      });
  } else {
    // Adicionar novo parcelado
    userCollectionRef('parcelados').add(stampWorkspaceCreation(parceladoData)) // Usa parceladoData para adicionar
      .then(() => {
        showToast('Parcelado adicionado com sucesso!');
        modalParcelado.classList.add('hidden');
        gerarInsights(); // NOVO: Atualiza insights após adicionar parcelado
      })
      .catch(() => {
        showToast('Erro ao adicionar parcelado.', 'error');
      });
  }
});


if (userMenuTrigger && userMenuDropdown) {
  userMenuTrigger.addEventListener('click', (event) => {
    event.preventDefault();
    event.stopPropagation();
    toggleUserMenu();
  });
}

document.addEventListener('click', (event) => {
  if (!userSession) return;
  if (!userSession.contains(event.target)) {
    closeUserMenu();
  }
});


// NOVO: Atalhos de teclado
document.addEventListener('keydown', (e) => {
  // Ctrl/Cmd + N = Novo gasto
  if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
    e.preventDefault();
    abrirModal();
    showToast('Atalho: Ctrl+N para novo gasto', 'info');
  }

  // Ctrl/Cmd + F = Novo fixo
  if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
    e.preventDefault();
    abrirModalFixo();
    showToast('Atalho: Ctrl+F para novo fixo', 'info');
  }

  // Ctrl/Cmd + G = Abrir gráficos
  if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
    e.preventDefault();
    if (window.innerWidth > 768) {
      document.getElementById('modal-graficos').classList.remove('hidden');
      showToast('Atalho: Ctrl+G para gráficos', 'info');
    }
  }

  // ESC = Fechar modals e dropdowns
  if (e.key === 'Escape') {
    document.getElementById('modal-add-gasto').classList.add('hidden');
    document.getElementById('modal-fixo').classList.add('hidden');
    document.getElementById('modal-parcelado').classList.add('hidden');
    document.getElementById('modal-graficos').classList.add('hidden');
    document.getElementById('modal-graficos-fixos').classList.add('hidden');
    document.getElementById('modal-planejamento-envelopes').classList.add('hidden');
    document.getElementById('modal-confirmacao').classList.add('hidden');
    document.getElementById('modal-gerenciar-cartoes').classList.add('hidden');
    closeUserMenu();
    updateFloatingMenuVisibility();
  }
});

window.addEventListener('resize', () => {
  closeUserMenu();
  updateHeaderOffset();
});

/* start */
initResumoSlider();
initMobilePanels();
initSimuladorInvestimentos();
atualizarResumoRapido();
initAuthFlow();
updateFooterVerse();
updateHeaderOffset();

</script>

<!-- [IMPORTER-BEGIN] -->
<script>
(function () {
  'use strict';

  const IMPORTER_ROWS_PER_PAGE = 500;
  const CSV_LOADER_URL = 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js';

  const ACCOUNT_OPTIONS = {
    nubank_cartao: { label: 'Nubank (cartão)', bank: 'nubank' },
    nubank_cc: { label: 'Nubank (conta)', bank: 'nubank' },
    itau_cc: { label: 'Itaú (conta)', bank: 'itau' },
  };

  const KEYWORD_RULES = [
    { test: /ifood|ubereats|rappi|aifood|ai ?food/i, category: 'Alimentação', tags: ['delivery'] },
    { test: /uber|99app|99 pop|cabify|motorizado|blablacar|girl cab/i, category: 'Transporte', tags: ['mobilidade'] },
    { test: /iptu|ipva|prefeitura|sabesp|copasa|copel|enel|light|cemig|equatorial|aneel|saae|corsan|claro|vivo|tim|oi/i, category: 'Contas', tags: ['contas'] },
    { test: /posto|shell|ipiranga|br mania|petrobras|divalto|fuel/i, category: 'Transporte', tags: ['combustível'] },
    { test: /mercado|supermercado|atacadão|atacadao|carrefour|extra|assai|pão de açúcar|pao de acucar|big|dia%/i, category: 'Supermercado', tags: ['mercado'] },
    { test: /farmacia|drogaria|drogasil|droga raia|ultrafarma|pague menos|panvel/i, category: 'Saúde', tags: ['farmácia'] },
    { test: /academia|smartfit|bodytech|just fit|bluefit|crossfit/i, category: 'Saúde', tags: ['fitness'] },
    { test: /netflix|spotify|prime video|disney|max |globoplay|paramount|crunchyroll|youtubepremium/i, category: 'Lazer', tags: ['assinatura'] },
    { test: /amazon|mercado livre|magalu|shein|aliexpress|shopee|americanas|submarino|kabum/i, category: 'Compras Online', tags: ['ecommerce'] },
    { test: /bb\.com|nubank|itaucard|bradesco|santander|c6 bank|sicredi|sicoob|inter/i, category: 'Serviços financeiros', tags: ['banco'] },
  ];

  const elements = {
    modal: document.getElementById('modal-importar'),
    openButton: document.getElementById('btn-open-importar'),
    closeButton: document.getElementById('btn-close-importar'),
    cancelButton: document.getElementById('btn-import-cancel'),
    confirmButton: document.getElementById('btn-import-confirm'),
    undoButton: document.getElementById('btn-import-undo'),
    applyCategoryButton: document.getElementById('btn-import-apply-category'),
    fileInput: document.getElementById('import-file-input'),
    fileName: document.getElementById('import-file-name'),
    accountSelect: document.getElementById('import-account-select'),
    detectedHint: document.getElementById('import-detected-hint'),
    progress: document.getElementById('import-progress'),
    previewWrapper: document.getElementById('import-preview-wrapper'),
    previewBody: document.getElementById('import-preview-tbody'),
    previewEmpty: document.getElementById('import-preview-empty'),
    paginationContainer: document.getElementById('import-pagination'),
    prevButton: document.getElementById('btn-import-prev'),
    nextButton: document.getElementById('btn-import-next'),
    pageIndicator: document.getElementById('import-page-indicator'),
    summaryContainer: document.getElementById('import-summary'),
    summaryText: document.getElementById('import-summary-text'),
    lastSessionHint: document.getElementById('import-last-session'),
    loadingOverlay: document.getElementById('import-loading-overlay'),
    loadingText: document.getElementById('import-loading-text'),
    filterButtons: Array.from(document.querySelectorAll('.import-filter-btn')),
  };

  const state = {
    rows: [],
    filter: 'all',
    page: 0,
    isOpen: false,
    ownerUid: null,
    workspaceId: null,
    accountId: document.getElementById('import-account-select')?.value || 'nubank_cartao',
    sourceBank: ACCOUNT_OPTIONS[document.getElementById('import-account-select')?.value || 'nubank_cartao']?.bank || null,
    detectedAccountId: null,
    categoryRules: [],
    merchantAliases: new Map(),
    aliasUpdates: new Map(),
    lastCategoryContext: null,
    fileHash: null,
    fileName: '',
    metadataPromise: null,
    metadataLoaded: false,
    lastImportSession: null,
    totalSelected: 0,
    existingCheckToken: 0,
    categoryOptions: [],
  };

  let papaLoaderPromise = null;

  initializeImporter();

  function initializeImporter() {
    if (!elements.modal || !elements.openButton) {
      return;
    }

    prepareFilterButtons();
    attachEventListeners();
    updateFilterButtons();
    updateDetectedHint();
    updateImportButton();
    updateSummary(null);
    updateUndoButton();
    updateProgress();
    updateApplyCategoryButton();
  }

  function prepareFilterButtons() {
    elements.filterButtons.forEach((button) => {
      if (!button.dataset.filterLabel) {
        button.dataset.filterLabel = button.textContent.trim();
      }
    });
  }

  function attachEventListeners() {
    elements.openButton.addEventListener('click', () => {
      openModal().catch((error) => console.error('Erro ao abrir importador:', error));
    });

    if (elements.closeButton) {
      elements.closeButton.addEventListener('click', closeModal);
    }

    if (elements.cancelButton) {
      elements.cancelButton.addEventListener('click', closeModal);
    }

    if (elements.undoButton) {
      elements.undoButton.addEventListener('click', () => {
        handleUndo().catch((error) => console.error('Erro ao desfazer importação:', error));
      });
    }

    if (elements.confirmButton) {
      elements.confirmButton.addEventListener('click', () => {
        handleImport().catch((error) => console.error('Erro ao importar lançamentos:', error));
      });
    }

    if (elements.fileInput) {
      elements.fileInput.addEventListener('change', () => {
        handleFileSelection().catch((error) => console.error('Erro ao processar arquivo:', error));
      });
    }

    if (elements.accountSelect) {
      elements.accountSelect.addEventListener('change', (event) => {
        handleAccountChange(event.target.value).catch((error) => console.error('Erro ao trocar conta do importador:', error));
      });
    }

    if (elements.applyCategoryButton) {
      elements.applyCategoryButton.addEventListener('click', applyCategoryToMatches);
    }

    if (elements.prevButton) {
      elements.prevButton.addEventListener('click', () => changePage(state.page - 1));
    }

    if (elements.nextButton) {
      elements.nextButton.addEventListener('click', () => changePage(state.page + 1));
    }

    if (elements.previewBody) {
      elements.previewBody.addEventListener('change', handlePreviewChange);
      elements.previewBody.addEventListener('click', handlePreviewClick);
    }

    if (elements.filterButtons.length) {
      elements.filterButtons.forEach((button) => {
        button.addEventListener('click', () => setFilter(button.dataset.importFilter));
      });
    }

    elements.modal.addEventListener('click', (event) => {
      if (event.target === elements.modal) {
        closeModal();
      }
    });

    document.addEventListener('keydown', handleKeydown, true);
  }

  async function openModal() {
    if (state.isOpen) return;
    if (typeof currentUser === 'undefined' || !currentUser) {
      if (typeof showToast === 'function') {
        showToast('Faça login para importar extratos.', 'info');
      }
      return;
    }

    const workspaceContext = resolveWorkspaceContext();
    if (!workspaceContext.ownerUid) {
      if (typeof showToast === 'function') {
        showToast('Espaço financeiro não disponível no momento.', 'error');
      }
      return;
    }

    state.ownerUid = workspaceContext.ownerUid;
    state.workspaceId = workspaceContext.workspaceId;
    state.accountId = elements.accountSelect ? elements.accountSelect.value : state.accountId;
    state.sourceBank = ACCOUNT_OPTIONS[state.accountId]?.bank || state.sourceBank || null;
    state.detectedAccountId = null;

    resetImporterState();
    state.isOpen = true;
    elements.modal.classList.remove('hidden');
    if (typeof lockBodyScroll === 'function') lockBodyScroll();
    if (typeof updateFloatingMenuVisibility === 'function') updateFloatingMenuVisibility();

    state.metadataPromise = loadMetadata();
    await Promise.allSettled([state.metadataPromise, loadLastImportSession()]);
    updateSummary(state.lastImportSession);
    updateUndoButton();
  }

  function closeModal() {
    if (!state.isOpen) return;
    state.isOpen = false;
    resetImporterState();
    elements.modal.classList.add('hidden');
    if (typeof unlockBodyScrollIfAllowed === 'function') unlockBodyScrollIfAllowed();
    if (typeof updateFloatingMenuVisibility === 'function') updateFloatingMenuVisibility();
  }

  function handleKeydown(event) {
    if (!state.isOpen) return;
    if (event.key === 'Escape') {
      event.stopPropagation();
      closeModal();
    }
  }

  async function ensureMetadataLoaded() {
    if (state.metadataLoaded) {
      return;
    }
    if (!state.metadataPromise) {
      state.metadataPromise = loadMetadata();
    }
    try {
      await state.metadataPromise;
    } catch (error) {
      console.error('Erro ao carregar metadados do importador:', error);
    }
  }

  async function loadMetadata() {
    if (typeof db === 'undefined' || !db || !state.ownerUid) {
      state.categoryRules = [];
      state.merchantAliases = new Map();
      state.metadataLoaded = true;
      updateCategoryOptions();
      return;
    }

    state.metadataLoaded = false;

    const rulesPromise = db.collection('categoryRules')
      .where('userId', '==', state.ownerUid)
      .get()
      .then((snapshot) => {
        const rules = snapshot.docs.map((doc) => ({ id: doc.id, ...(doc.data() || {}) }));
        state.categoryRules = normalizeCategoryRules(rules);
      })
      .catch((error) => {
        console.error('Erro ao carregar regras de categoria:', error);
        state.categoryRules = [];
      });

    const aliasesPromise = db.collection('merchantAliases')
      .where('userId', '==', state.ownerUid)
      .get()
      .then((snapshot) => {
        const map = new Map();
        snapshot.docs.forEach((doc) => {
          const data = doc.data() || {};
          if (!data.normalized) return;
          map.set(String(data.normalized), {
            category: data.category || null,
            tags: Array.isArray(data.tags) ? data.tags.filter(Boolean) : [],
          });
        });
        state.merchantAliases = map;
      })
      .catch((error) => {
        console.error('Erro ao carregar aliases de lojista:', error);
        state.merchantAliases = new Map();
      });

    await Promise.allSettled([rulesPromise, aliasesPromise]);
    state.metadataLoaded = true;
    updateCategoryOptions();
  }

  function normalizeCategoryRules(rules) {
    const priority = { equals: 0, regex: 1, contains: 2 };
    return rules
      .filter((rule) => rule && rule.pattern)
      .sort((a, b) => {
        const pa = priority[a.type] ?? 3;
        const pb = priority[b.type] ?? 3;
        if (pa !== pb) return pa - pb;
        const lenA = String(a.pattern || '').length;
        const lenB = String(b.pattern || '').length;
        return lenB - lenA;
      });
  }

  async function loadLastImportSession() {
    if (typeof db === 'undefined' || !db || !state.ownerUid) {
      state.lastImportSession = null;
      return;
    }

    try {
      let snapshot = null;
      try {
        snapshot = await db
          .collection('importSessions')
          .where('userId', '==', state.ownerUid)
          .orderBy('startedAtMs', 'desc')
          .limit(20)
          .get();
      } catch (error) {
        if (error?.code === 'failed-precondition') {
          snapshot = await db
            .collection('importSessions')
            .where('userId', '==', state.ownerUid)
            .limit(50)
            .get();
        } else {
          throw error;
        }
      }

      if (!snapshot || snapshot.empty) {
        state.lastImportSession = null;
        return;
      }

      let doc = snapshot.docs[0];
      if (state.workspaceId) {
        doc = snapshot.docs.find((candidate) => {
          const data = candidate.data() || {};
          return data.workspaceId === state.workspaceId || data.ownerUid === state.ownerUid;
        }) || doc;
      }

      const data = doc.data() || {};
      state.lastImportSession = {
        id: doc.id,
        stats: data.stats || null,
        startedAt: typeof parseFirestoreDate === 'function' ? parseFirestoreDate(data.startedAt) : (data.startedAt?.toDate?.() || null),
        finishedAt: typeof parseFirestoreDate === 'function' ? parseFirestoreDate(data.finishedAt) : (data.finishedAt?.toDate?.() || null),
        undoneAt: typeof parseFirestoreDate === 'function' ? parseFirestoreDate(data.undoneAt) : (data.undoneAt?.toDate?.() || null),
        accountId: data.accountId || null,
        bank: data.bank || null,
        fileName: data.fileName || null,
      };
    } catch (error) {
      console.error('Erro ao buscar última sessão de importação:', error);
      state.lastImportSession = null;
    }
  }

  function updateSummary(session) {
    if (!elements.summaryContainer || !elements.summaryText) return;
    if (!session) {
      elements.summaryContainer.classList.add('hidden');
      elements.summaryText.textContent = '';
    } else if (session.undoneAt) {
      elements.summaryContainer.classList.remove('hidden');
      elements.summaryText.textContent = `Importação desfeita em ${formatDateTimeSafe(session.undoneAt)}.`;
    } else if (session.stats) {
      elements.summaryContainer.classList.remove('hidden');
      elements.summaryText.textContent = formatSummaryStats(session.stats);
    } else {
      elements.summaryContainer.classList.add('hidden');
      elements.summaryText.textContent = '';
    }

    if (elements.lastSessionHint) {
      if (!session) {
        elements.lastSessionHint.textContent = 'Nenhuma importação realizada ainda neste workspace.';
      } else if (session.undoneAt) {
        elements.lastSessionHint.textContent = `Última importação foi desfeita em ${formatDateTimeSafe(session.undoneAt)}.`;
      } else {
        const finished = session.finishedAt ? formatDateTimeSafe(session.finishedAt) : 'em andamento';
        elements.lastSessionHint.textContent = `Última importação concluída em ${finished}.`;
      }
    }
  }

  function formatSummaryStats(stats) {
    const read = stats?.read ?? 0;
    const inserted = stats?.inserted ?? 0;
    const updated = stats?.updated ?? 0;
    const skipped = stats?.skipped ?? 0;
    const restored = stats?.restored ?? 0;
    return `Lidas: ${read} • Inseridas: ${inserted} • Atualizadas: ${updated} • Restauradas: ${restored} • Puladas: ${skipped}`;
  }

  function formatDateTimeSafe(value) {
    if (!value) return '--';
    if (typeof formatDateTime === 'function') {
      return formatDateTime(value);
    }
    const date = value instanceof Date ? value : new Date(value);
    if (Number.isNaN(date.getTime())) return '--';
    return date.toLocaleString('pt-BR', { hour12: false });
  }

  function updateUndoButton() {
    if (!elements.undoButton) return;
    const enabled = Boolean(state.lastImportSession && !state.lastImportSession.undoneAt);
    elements.undoButton.disabled = !enabled;
    elements.undoButton.title = enabled
      ? 'Reverte a última importação realizada neste workspace.'
      : 'Não há importação pendente para desfazer.';
  }

  function resetImporterState() {
    state.rows = [];
    state.filter = 'all';
    state.page = 0;
    state.totalSelected = 0;
    state.lastCategoryContext = null;
    state.aliasUpdates.clear();
    state.fileHash = null;
    state.fileName = '';
    state.detectedAccountId = null;
    state.existingCheckToken += 1;

    if (elements.fileName) {
      elements.fileName.textContent = 'Nenhum arquivo selecionado.';
    }
    if (elements.progress) {
      elements.progress.textContent = '';
    }
    if (elements.applyCategoryButton) {
      elements.applyCategoryButton.disabled = true;
    }
    if (elements.fileInput) {
      elements.fileInput.value = '';
      elements.fileInput.disabled = false;
    }
    if (elements.accountSelect) {
      elements.accountSelect.disabled = false;
    }
    renderRows();
    updateFilterButtons();
    updateImportButton();
    updateApplyCategoryButton();
    updateDetectedHint();
  }

  function resetRows(message) {
    state.rows = [];
    state.page = 0;
    state.filter = 'all';
    state.totalSelected = 0;
    renderRows();
    updateFilterButtons();
    updateImportButton();
    updateApplyCategoryButton();
    if (elements.previewWrapper) elements.previewWrapper.classList.add('hidden');
    if (elements.previewEmpty) {
      elements.previewEmpty.classList.remove('hidden');
      elements.previewEmpty.textContent = message || 'Nenhum lançamento carregado. Escolha um arquivo CSV ou OFX para começar.';
    }
  }

  function updateFileNameDisplay(file) {
    if (!elements.fileName || !file) return;
    const parts = [];
    parts.push(file.name || 'Arquivo sem nome');
    if (typeof file.size === 'number') {
      parts.push(formatFileSize(file.size));
    }
    if (state.fileHash) {
      parts.push(`SHA-256: ${state.fileHash.slice(0, 16)}…`);
    }
    elements.fileName.textContent = parts.join(' • ');
  }

  async function handleFileSelection() {
    if (!elements.fileInput || !elements.fileInput.files || !elements.fileInput.files.length) {
      return;
    }

    const file = elements.fileInput.files[0];
    setLoading(true, 'Lendo arquivo...');

    try {
      await ensureMetadataLoaded();

      const [arrayBuffer, text] = await Promise.all([
        file.arrayBuffer(),
        file.text(),
      ]);

      state.fileHash = await computeSha256(arrayBuffer);
      state.fileName = file.name || '';
      updateFileNameDisplay(file);

      const extension = (file.name || '').split('.').pop()?.toLowerCase() || '';
      let entries = [];
      let detectedFormat = null;

      if (extension === 'ofx') {
        const ofx = parseOfx(text);
        entries = ofx.entries;
        detectedFormat = ofx.format;
      } else {
        const papa = await ensurePapaParse();
        const csvResult = await parseCsv(text, papa);
        detectedFormat = detectCsvFormat(csvResult.meta?.fields || []);
        entries = mapCsvRows(csvResult.data, detectedFormat);
      }

      applyDetectedAccount(detectedFormat);

      if (!entries.length) {
        resetRows('Nenhum lançamento válido encontrado neste arquivo.');
        if (typeof showToast === 'function') {
          showToast('Não encontramos lançamentos válidos no arquivo enviado.', 'info');
        }
        return;
      }

      await ingestEntries(entries);
    } catch (error) {
      console.error('Erro ao processar arquivo de importação:', error);
      resetRows('Não foi possível processar o arquivo. Verifique o formato e tente novamente.');
      if (typeof showToast === 'function') {
        showToast('Não foi possível processar o arquivo. Verifique o formato e tente novamente.', 'error');
      }
    } finally {
      setLoading(false);
      if (elements.fileInput) {
        elements.fileInput.value = '';
      }
    }
  }

  function ensurePapaParse() {
    if (window.Papa) {
      return Promise.resolve(window.Papa);
    }
    if (!papaLoaderPromise) {
      papaLoaderPromise = new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = CSV_LOADER_URL;
        script.async = true;
        script.onload = () => resolve(window.Papa);
        script.onerror = () => reject(new Error('Não foi possível carregar o parser CSV.'));
        document.head.appendChild(script);
      });
    }
    return papaLoaderPromise;
  }

  function parseCsv(text, papa) {
    return new Promise((resolve, reject) => {
      papa.parse(text, {
        header: true,
        skipEmptyLines: 'greedy',
        dynamicTyping: false,
        transformHeader: (header) => header,
        complete: (results) => resolve(results),
        error: (error) => reject(error),
      });
    });
  }

  function detectCsvFormat(fields) {
    if (!Array.isArray(fields) || !fields.length) return null;
    const normalized = fields.map(normalizeHeader);
    if (normalized.some((field) => field.includes('historico')) && normalized.some((field) => field.includes('valor'))) {
      return { type: 'itau_cc', accountId: 'itau_cc', bank: 'itau' };
    }
    if (normalized.includes('categoria') && normalized.includes('descricao')) {
      return { type: 'nubank_cartao', accountId: 'nubank_cartao', bank: 'nubank' };
    }
    if (normalized.includes('descricao') && normalized.includes('valor')) {
      return { type: 'nubank_cc', accountId: 'nubank_cc', bank: 'nubank' };
    }
    return null;
  }

  function mapCsvRows(rows, format) {
    if (!Array.isArray(rows)) return [];
    const formatType = format?.type || state.accountId || 'nubank_cartao';
    const mapped = [];
    rows.forEach((row) => {
      if (!row) return;
      const mappedRow = mapRowForFormat(row, formatType);
      if (!mappedRow) return;
      mappedRow.accountId = format?.accountId || state.accountId || elements.accountSelect?.value || 'nubank_cartao';
      mappedRow.bank = format?.bank || ACCOUNT_OPTIONS[mappedRow.accountId]?.bank || state.sourceBank || null;
      mapped.push(mappedRow);
    });
    return mapped;
  }

  function mapRowForFormat(row, formatType) {
    const rawDate = getCsvField(row, 'data', 'date', 'data da compra', 'data do lançamento', 'data da transação');
    const rawDescription = getCsvField(row, 'descricao', 'descrição', 'historico', 'histórico', 'description', 'detalhe');
    const rawAmount = getCsvField(row, 'valor', 'valor (r$)', 'valor final', 'valor da transação', 'valor da compra');
    const rawType = getCsvField(row, 'tipo', 'categoria', 'entrada/saida', 'entrada/saída', 'lancamento', 'lançamento');
    if (!rawDate || rawAmount === undefined || rawAmount === null || !rawDescription) {
      return null;
    }
    const isoDate = toISODate(rawDate);
    if (!isoDate) return null;
    const amount = normalizeAmount(rawAmount, rawType, formatType);
    if (!Number.isFinite(amount) || amount === 0) return null;
    return {
      date: isoDate,
      description: String(rawDescription).trim(),
      amount,
      meta: {},
    };
  }

  function normalizeAmount(value, typeHint, formatType) {
    let raw = String(value).trim();
    if (!raw) return NaN;
    let normalized = raw.replace(/[^0-9,.-]/g, '');
    const hasExplicitSign = /^[+-]/.test(normalized);
    normalized = normalized.replace(/\.(?=.*\.)/g, '');
    normalized = normalized.replace(/\./g, '').replace(',', '.');
    let amount = Number(normalized);
    if (!Number.isFinite(amount)) return NaN;
    if (hasExplicitSign) {
      amount = normalized.startsWith('-') ? -Math.abs(amount) : Math.abs(amount);
    }
    if (typeHint) {
      const hint = String(typeHint).toLowerCase();
      if (/credito|crédito|entrada|dep[oó]sito|receb|estorno|ajuste/.test(hint)) {
        amount = Math.abs(amount);
      } else if (/debito|d[eé]bito|sa[ií]da|pagamento|compra|transfer|pix enviado/.test(hint)) {
        amount = -Math.abs(amount);
      }
    } else if (!hasExplicitSign && (formatType === 'nubank_cartao' || formatType === 'nubank_cc' || formatType === 'itau_cc')) {
      amount = -Math.abs(amount);
    }
    return Number(amount.toFixed(2));
  }

  function getCsvField(row, ...candidates) {
    if (!row) return null;
    const keys = Object.keys(row);
    for (const candidate of candidates) {
      const normalizedCandidate = normalizeHeader(candidate);
      for (const key of keys) {
        if (normalizeHeader(key) === normalizedCandidate) {
          return row[key];
        }
      }
    }
    return null;
  }

  function parseOfx(text) {
    const entries = [];
    const cleaned = text.replace(/\r\n/g, '\n');
    const regex = /<STMTTRN>([\s\S]*?)<\/STMTTRN>/gi;
    let match;
    while ((match = regex.exec(cleaned))) {
      const block = match[1];
      const dateMatch = /<DTPOSTED>([^<]+)/i.exec(block);
      const amountMatch = /<TRNAMT>([^<]+)/i.exec(block);
      const nameMatch = /<NAME>([^<]+)/i.exec(block);
      const memoMatch = /<MEMO>([^<]+)/i.exec(block);
      const isoDate = toISODate(dateMatch ? dateMatch[1] : null);
      const amount = amountMatch ? Number(amountMatch[1].replace(',', '.')) : NaN;
      if (!isoDate || !Number.isFinite(amount) || amount === 0) continue;
      const descriptionParts = [];
      if (nameMatch && nameMatch[1]) descriptionParts.push(nameMatch[1].trim());
      if (memoMatch && memoMatch[1]) descriptionParts.push(memoMatch[1].trim());
      const description = descriptionParts.join(' — ').trim() || 'Movimentação OFX';
      entries.push({
        date: isoDate,
        description,
        amount: Number(amount.toFixed(2)),
        meta: {},
        accountId: state.accountId,
        bank: state.sourceBank || null,
      });
    }
    return { entries, format: { type: 'ofx', bank: state.sourceBank || null } };
  }

  function applyDetectedAccount(format) {
    if (!format) {
      state.detectedAccountId = null;
      updateDetectedHint();
      return;
    }
    state.detectedAccountId = format.accountId || null;
    if (format.accountId && ACCOUNT_OPTIONS[format.accountId]) {
      state.accountId = format.accountId;
      if (elements.accountSelect) {
        elements.accountSelect.value = format.accountId;
      }
    }
    state.sourceBank = format.bank || ACCOUNT_OPTIONS[state.accountId]?.bank || state.sourceBank || null;
    updateDetectedHint();
  }

  async function ingestEntries(entries) {
    if (!Array.isArray(entries) || !entries.length) {
      resetRows('Nenhum lançamento válido encontrado neste arquivo.');
      return;
    }

    const token = ++state.existingCheckToken;
    setLoading(true, 'Analisando lançamentos...');

    const prepared = entries
      .map((entry, index) => createRowFromEntry(entry, index))
      .filter(Boolean);

    if (!prepared.length) {
      resetRows('Todos os lançamentos foram ignorados após a limpeza inicial.');
      setLoading(false);
      return;
    }

    detectTransferGroups(prepared);

    state.rows = prepared;
    state.filter = 'all';
    state.page = 0;
    state.totalSelected = prepared.filter((row) => row.selected).length;

    updateProgress();
    updateFilterButtons();
    renderRows();
    updateImportButton();
    updateApplyCategoryButton();

    if (!db) {
      setLoading(false);
      return;
    }

    try {
      await ensureMetadataLoaded();
      const existingMap = await fetchExistingTransactions(prepared, token);
      if (token !== state.existingCheckToken) {
        return;
      }

      prepared.forEach((row) => {
        const existing = existingMap.get(row.dedupKey) || null;
        applyExistingTransaction(row, existing);
      });

      state.totalSelected = prepared.filter((row) => row.selected).length;
      renderRows();
      updateProgress();
      updateImportButton();
      updateApplyCategoryButton();
    } finally {
      if (token === state.existingCheckToken) {
        setLoading(false);
      }
    }
  }

  function createRowFromEntry(entry, index) {
    if (!entry || !entry.date || !entry.description || !Number.isFinite(entry.amount)) {
      return null;
    }

    const normalizedDescription = normalizeDescription(entry.description);
    const sanitizedDescription = entry.description.trim();
    const meta = { ...(entry.meta || {}) };
    const installment = detectInstallmentInfo(sanitizedDescription);
    if (installment) {
      meta.installment = installment;
    }

    const suggestion = suggestCategoryAndTags(normalizedDescription, sanitizedDescription);
    const tags = Array.isArray(entry.tags) ? entry.tags.filter(Boolean) : [];
    const mergedTags = mergeTagSets(tags, suggestion.tags || []);

    const row = {
      id: `row-${index}`,
      accountId: entry.accountId || state.accountId,
      bank: entry.bank || ACCOUNT_OPTIONS[entry.accountId || state.accountId]?.bank || state.sourceBank || null,
      date: toISODate(entry.date),
      amount: Number(entry.amount.toFixed(2)),
      description: sanitizedDescription,
      normalizedDescription,
      category: entry.category || suggestion.category || null,
      categorySource: suggestion.source || null,
      tags: mergedTags,
      tagsSource: suggestion.tags?.length ? suggestion.source : null,
      original: {
        description: sanitizedDescription,
        category: entry.category || suggestion.category || null,
        tags: [...mergedTags],
      },
      meta,
      selected: true,
      status: 'new',
      statusHint: 'Novo lançamento',
      isEdited: false,
      duplicateOf: null,
      dedupKey: null,
      conflictReason: null,
      raw: entry.raw || null,
    };

    row.dedupKey = buildDedupKey({
      accountId: row.accountId,
      date: row.date,
      amount: row.amount,
      description: row.description,
    });

    return row;
  }

  function detectTransferGroups(rows) {
    const groups = new Map();
    rows.forEach((row) => {
      const key = `${row.date}|${Math.abs(row.amount).toFixed(2)}`;
      const bucket = groups.get(key) || [];
      bucket.push(row);
      groups.set(key, bucket);
    });

    let groupIndex = 0;
    groups.forEach((bucket) => {
      if (bucket.length < 2) return;
      const positives = bucket.filter((row) => row.amount > 0);
      const negatives = bucket.filter((row) => row.amount < 0);
      if (!positives.length || !negatives.length) return;
      const id = `trf_${rowDateSlug(bucket[0].date)}_${groupIndex++}`;
      positives.forEach((row) => {
        row.meta = row.meta || {};
        row.meta.transferGroupId = id;
      });
      negatives.forEach((row) => {
        row.meta = row.meta || {};
        row.meta.transferGroupId = id;
      });
    });
  }

  function rowDateSlug(date) {
    return (date || '').replace(/-/g, '');
  }

  function detectInstallmentInfo(description) {
    if (!description) return null;
    const match = /(?:\b|\s)(\d{1,2})\/(\d{1,2})(?:\b|\s)/.exec(description);
    if (!match) return null;
    const current = Number(match[1]);
    const total = Number(match[2]);
    if (!Number.isFinite(current) || !Number.isFinite(total) || current < 1 || total < 1) {
      return null;
    }
    return { n: current, total };
  }

  function suggestCategoryAndTags(normalizedDescription, originalDescription) {
    if (!normalizedDescription) {
      return { category: null, tags: [], source: null };
    }

    const alias = state.merchantAliases.get(normalizedDescription);
    if (alias && (alias.category || (alias.tags && alias.tags.length))) {
      return {
        category: alias.category || null,
        tags: alias.tags ? [...alias.tags] : [],
        source: 'alias',
      };
    }

    for (const rule of state.categoryRules) {
      try {
        if (rule.type === 'equals') {
          if (normalizedDescription === normalizeDescription(rule.pattern)) {
            return {
              category: rule.category || null,
              tags: Array.isArray(rule.tags) ? [...rule.tags] : [],
              source: 'rule',
            };
          }
        } else if (rule.type === 'contains') {
          if (normalizedDescription.includes(normalizeDescription(rule.pattern))) {
            return {
              category: rule.category || null,
              tags: Array.isArray(rule.tags) ? [...rule.tags] : [],
              source: 'rule',
            };
          }
        } else if (rule.type === 'regex') {
          const regex = new RegExp(rule.pattern, 'i');
          if (regex.test(originalDescription)) {
            return {
              category: rule.category || null,
              tags: Array.isArray(rule.tags) ? [...rule.tags] : [],
              source: 'rule',
            };
          }
        }
      } catch (error) {
        console.warn('Regra de categoria inválida:', rule, error);
      }
    }

    for (const keyword of KEYWORD_RULES) {
      if (keyword.test.test(originalDescription)) {
        return {
          category: keyword.category,
          tags: [...(keyword.tags || [])],
          source: 'keyword',
        };
      }
    }

    return { category: null, tags: [], source: null };
  }

  function mergeTagSets(baseTags, suggestionTags) {
    const set = new Set();
    [...baseTags, ...suggestionTags].forEach((tag) => {
      const normalized = normalizeTag(tag);
      if (normalized) {
        set.add(normalized);
      }
    });
    return Array.from(set);
  }

  function normalizeTag(tag) {
    return (tag || '').trim().toLowerCase().replace(/\s+/g, '-');
  }

  async function fetchExistingTransactions(rows, token) {
    const map = new Map();
    if (!db || !Array.isArray(rows) || !rows.length) return map;

    const uniqueKeys = Array.from(new Set(rows.map((row) => row.dedupKey).filter(Boolean)));
    const chunkSize = 20;
    for (let i = 0; i < uniqueKeys.length; i += chunkSize) {
      if (token !== state.existingCheckToken) {
        break;
      }
      const slice = uniqueKeys.slice(i, i + chunkSize);
      const promises = slice.map((key) =>
        db.collection('transactions')
          .doc(key)
          .get()
          .then((doc) => (doc.exists ? { key, data: doc.data() || {} } : null))
          .catch((error) => {
            console.error('Erro ao verificar transação existente:', error);
            return null;
          })
      );
      const results = await Promise.all(promises);
      if (token !== state.existingCheckToken) {
        break;
      }
      results.forEach((result) => {
        if (!result) return;
        const data = result.data;
        if (data.ownerUid && data.ownerUid !== state.ownerUid) {
          return;
        }
        if (state.workspaceId && data.workspaceId && data.workspaceId !== state.workspaceId) {
          return;
        }
        map.set(result.key, data);
      });
    }
    return map;
  }

  function applyExistingTransaction(row, existing) {
    if (!existing) {
      row.status = 'new';
      row.statusHint = 'Novo lançamento';
      row.selected = true;
      return;
    }

    row.duplicateOf = existing;
    const isSoftDeleted = Boolean(existing.deletedAt);

    if (isSoftDeleted) {
      row.status = 'restore';
      row.statusHint = 'Será restaurado (foi desfeito anteriormente)';
      row.selected = true;
      return;
    }

    const sameCategory = normalizeNullable(existing.category) === normalizeNullable(row.category);
    const existingTags = Array.isArray(existing.tags) ? existing.tags.map(normalizeTag).sort() : [];
    const newTags = row.tags.map(normalizeTag).sort();
    const sameTags = existingTags.length === newTags.length && existingTags.every((tag, index) => tag === newTags[index]);

    if (sameCategory && sameTags) {
      row.status = 'duplicate';
      row.statusHint = 'Já existe no histórico';
      row.selected = false;
    } else {
      row.status = 'update';
      row.statusHint = 'Atualizará categoria/tags existentes';
      row.selected = true;
    }
  }

  function normalizeNullable(value) {
    if (value === null || value === undefined) return null;
    if (typeof value === 'string') {
      const trimmed = value.trim();
      return trimmed ? trimmed : null;
    }
    return value;
  }

  function renderRows() {
    if (!elements.previewBody || !elements.previewWrapper || !elements.previewEmpty) return;

    const filtered = getFilteredRows();
    const totalPages = Math.max(1, Math.ceil(filtered.length / IMPORTER_ROWS_PER_PAGE));
    if (state.page >= totalPages) {
      state.page = totalPages - 1;
    }

    const start = state.page * IMPORTER_ROWS_PER_PAGE;
    const slice = filtered.slice(start, start + IMPORTER_ROWS_PER_PAGE);

    elements.previewBody.innerHTML = '';

    if (!slice.length) {
      elements.previewWrapper.classList.add('hidden');
      elements.previewEmpty.classList.remove('hidden');
      if (state.rows.length) {
        if (state.filter === 'duplicates') {
          elements.previewEmpty.textContent = 'Nenhum possível duplicado neste conjunto.';
        } else if (state.filter === 'edited') {
          elements.previewEmpty.textContent = 'Nenhum lançamento foi editado até agora.';
        } else if (state.filter === 'new') {
          elements.previewEmpty.textContent = 'Nenhum lançamento novo nesta seleção.';
        } else {
          elements.previewEmpty.textContent = 'Nenhum lançamento disponível para exibir.';
        }
      } else {
        elements.previewEmpty.textContent = 'Nenhum lançamento carregado. Escolha um arquivo CSV ou OFX para visualizar as movimentações.';
      }
    } else {
      elements.previewWrapper.classList.remove('hidden');
      elements.previewEmpty.classList.add('hidden');

      slice.forEach((row) => {
        const tr = document.createElement('tr');
        tr.dataset.rowId = row.id;
        tr.className = [
          row.selected ? 'bg-white/70 dark:bg-slate-900/60' : 'bg-white/40 dark:bg-slate-950/40',
          row.status === 'duplicate' ? 'opacity-70' : '',
        ]
          .filter(Boolean)
          .join(' ');

        tr.innerHTML = `
          <td class="px-4 py-3 align-top">
            <input type="checkbox" class="import-select" data-role="select" ${row.selected ? 'checked' : ''} />
          </td>
          <td class="px-4 py-3 align-top whitespace-nowrap text-xs text-slate-600 dark:text-slate-300">${formatDisplayDate(row.date)}</td>
          <td class="px-4 py-3 align-top">
            <div class="flex flex-col gap-1">
              <input type="text" class="import-desc-input w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-950/40 px-2 py-1 text-sm" data-field="description" value="${escapeHtml(row.description)}" />
              ${renderSuggestionBadge(row)}
            </div>
          </td>
          <td class="px-4 py-3 align-top text-right text-sm font-semibold ${row.amount < 0 ? 'text-rose-500' : 'text-emerald-500'}">${formatCurrency(row.amount)}</td>
          <td class="px-4 py-3 align-top">
            ${renderCategorySelect(row)}
          </td>
          <td class="px-4 py-3 align-top">
            ${renderTagsEditor(row)}
          </td>
          <td class="px-4 py-3 align-top text-xs">
            ${renderStatusBadge(row)}
          </td>
        `;

        elements.previewBody.appendChild(tr);
      });
    }

    renderPagination(filtered.length);
  }

  function renderSuggestionBadge(row) {
    if (!row.categorySource) return '<span class="text-[10px] text-slate-400">Sem sugestão</span>';
    const label = row.category ? `${row.category}` : 'Categoria sugerida';
    const sourceLabel =
      row.categorySource === 'alias'
        ? 'Aprendido'
        : row.categorySource === 'rule'
        ? 'Regra'
        : row.categorySource === 'keyword'
        ? 'Heurística'
        : 'Sugestão';
    return `<span class="inline-flex items-center gap-1 rounded-lg bg-slate-100 dark:bg-slate-800 px-2 py-0.5 text-[10px] uppercase tracking-wide text-slate-500 dark:text-slate-300">${escapeHtml(label)}<span class="font-semibold">${escapeHtml(sourceLabel)}</span></span>`;
  }

  function renderCategorySelect(row) {
    const options = state.categoryOptions.length ? state.categoryOptions : getFallbackCategories();
    const value = row.category || '';
    const optsHtml = ['<option value="">Sem categoria</option>']
      .concat(
        options.map(
          (option) => `<option value="${escapeHtml(option)}" ${option === value ? 'selected' : ''}>${escapeHtml(option)}</option>`
        )
      )
      .join('');
    return `<select data-field="category" class="import-category-select w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-950/40 px-2 py-1 text-sm">${optsHtml}</select>`;
  }

  function renderTagsEditor(row) {
    const chips = row.tags
      .map(
        (tag) => `
        <span class="import-tag-chip inline-flex items-center gap-1 rounded-full bg-amber-100 dark:bg-amber-500/20 text-amber-700 dark:text-amber-300 px-2 py-0.5 text-[11px]" data-action="remove-tag" data-tag="${escapeHtml(tag)}">
          <i class="fa fa-tag text-[9px]"></i>${escapeHtml(tag)}
          <button type="button" class="import-tag-remove text-[10px]" aria-label="Remover tag">&times;</button>
        </span>`
      )
      .join('');
    return `
      <div class="import-tags flex flex-wrap gap-2" data-role="tags" data-row-id="${row.id}">
        ${chips || '<span class="text-[10px] text-slate-400">Sem tags</span>'}
        <button type="button" class="import-tag-add inline-flex items-center justify-center rounded-full border border-dashed border-amber-300 dark:border-amber-500/40 px-2 py-0.5 text-[10px] uppercase tracking-wide text-amber-600 dark:text-amber-300" data-action="add-tag">
          + Tag
        </button>
      </div>`;
  }

  function renderStatusBadge(row) {
    const baseClass = 'inline-flex items-center gap-1 rounded-full px-2 py-0.5 font-semibold';
    if (row.status === 'new') {
      return `<span class="${baseClass} bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-200">Novo</span>`;
    }
    if (row.status === 'restore') {
      return `<span class="${baseClass} bg-sky-100 text-sky-700 dark:bg-sky-500/20 dark:text-sky-200">Restaurar</span>`;
    }
    if (row.status === 'update') {
      return `<span class="${baseClass} bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-200">Atualizar</span>`;
    }
    if (row.status === 'duplicate') {
      return `<span class="${baseClass} bg-slate-100 text-slate-600 dark:bg-slate-800/40 dark:text-slate-200">Duplicado</span>`;
    }
    if (row.status === 'conflict') {
      return `<span class="${baseClass} bg-rose-100 text-rose-700 dark:bg-rose-500/20 dark:text-rose-200">Conflito</span>`;
    }
    return `<span class="${baseClass} bg-slate-100 text-slate-500">-</span>`;
  }

  function getFallbackCategories() {
    return [
      'Alimentação',
      'Transporte',
      'Supermercado',
      'Saúde',
      'Moradia',
      'Lazer',
      'Educação',
      'Compras Online',
      'Serviços',
    ];
  }

  function renderPagination(totalRows) {
    if (!elements.paginationContainer) return;
    const totalPages = Math.max(1, Math.ceil(totalRows / IMPORTER_ROWS_PER_PAGE));
    if (elements.prevButton) {
      elements.prevButton.disabled = state.page <= 0;
    }
    if (elements.nextButton) {
      elements.nextButton.disabled = state.page >= totalPages - 1;
    }
    if (elements.pageIndicator) {
      elements.pageIndicator.textContent = `Página ${totalRows ? state.page + 1 : 0}/${totalPages}`;
    }
  }

  function changePage(page) {
    const filtered = getFilteredRows();
    const totalPages = Math.max(1, Math.ceil(filtered.length / IMPORTER_ROWS_PER_PAGE));
    if (page < 0 || page >= totalPages) return;
    state.page = page;
    renderRows();
  }

  function getFilteredRows() {
    if (state.filter === 'new') {
      return state.rows.filter((row) => row.status === 'new' || row.status === 'restore');
    }
    if (state.filter === 'duplicates') {
      return state.rows.filter((row) => row.status === 'duplicate' || row.status === 'conflict');
    }
    if (state.filter === 'edited') {
      return state.rows.filter((row) => row.isEdited);
    }
    return state.rows;
  }

  function setFilter(filter) {
    if (state.filter === filter) return;
    state.filter = filter;
    state.page = 0;
    updateFilterButtons();
    renderRows();
  }

  function updateFilterButtons() {
    if (!elements.filterButtons || !elements.filterButtons.length) return;
    elements.filterButtons.forEach((button) => {
      const active = button.dataset.importFilter === state.filter;
      button.classList.toggle('import-filter-active', active);
      button.setAttribute('aria-selected', active ? 'true' : 'false');
      if (!active) {
        button.textContent = button.dataset.filterLabel || button.textContent;
      } else {
        button.textContent = `${button.dataset.filterLabel || button.textContent}`;
      }
    });
  }

  function handlePreviewChange(event) {
    const target = event.target;
    const rowElement = target.closest('tr[data-row-id]');
    if (!rowElement) return;
    const row = state.rows.find((item) => item.id === rowElement.dataset.rowId);
    if (!row) return;

    if (target.matches('[data-role="select"]')) {
      row.selected = target.checked;
      updateSelectionState();
      return;
    }

    if (target.dataset.field === 'description') {
      const newValue = target.value || '';
      if (newValue === row.description) return;
      row.description = newValue;
      row.normalizedDescription = normalizeDescription(newValue);
      row.dedupKey = buildDedupKey({
        accountId: row.accountId,
        date: row.date,
        amount: row.amount,
        description: row.description,
      });
      markRowEdited(row);
      scheduleDedupRefresh([row]);
      state.lastCategoryContext = {
        normalizedDescription: row.normalizedDescription,
        category: row.category,
        tags: [...row.tags],
      };
      updateApplyCategoryButton();
      return;
    }

    if (target.dataset.field === 'category') {
      const newCategory = target.value || null;
      if (newCategory === row.category) return;
      row.category = newCategory;
      markRowEdited(row);
      state.aliasUpdates.set(row.normalizedDescription, {
        category: row.category,
        tags: [...row.tags],
      });
      state.lastCategoryContext = {
        normalizedDescription: row.normalizedDescription,
        category: row.category,
        tags: [...row.tags],
      };
      updateApplyCategoryButton();
      applyExistingTransaction(row, row.duplicateOf || null);
      updateSelectionState();
      renderRows();
      return;
    }
  }

  function handlePreviewClick(event) {
    const target = event.target;
    const rowElement = target.closest('tr[data-row-id]');
    if (!rowElement) return;
    const row = state.rows.find((item) => item.id === rowElement.dataset.rowId);
    if (!row) return;

    if (target.closest('[data-action="add-tag"]')) {
      event.preventDefault();
      const input = window.prompt('Digite a nova tag (sem espaços).');
      if (!input) return;
      const normalized = normalizeTag(input);
      if (!normalized) return;
      if (!row.tags.includes(normalized)) {
        row.tags.push(normalized);
        markRowEdited(row);
        state.aliasUpdates.set(row.normalizedDescription, {
          category: row.category,
          tags: [...row.tags],
        });
        state.lastCategoryContext = {
          normalizedDescription: row.normalizedDescription,
          category: row.category,
          tags: [...row.tags],
        };
        updateApplyCategoryButton();
        renderRows();
        updateSelectionState();
      }
      return;
    }

    if (target.closest('[data-action="remove-tag"]')) {
      event.preventDefault();
      const tag = target.closest('[data-action="remove-tag"]').dataset.tag;
      const index = row.tags.indexOf(tag);
      if (index >= 0) {
        row.tags.splice(index, 1);
        markRowEdited(row);
        state.aliasUpdates.set(row.normalizedDescription, {
          category: row.category,
          tags: [...row.tags],
        });
        state.lastCategoryContext = {
          normalizedDescription: row.normalizedDescription,
          category: row.category,
          tags: [...row.tags],
        };
        updateApplyCategoryButton();
        renderRows();
        updateSelectionState();
      }
      return;
    }
  }

  function markRowEdited(row) {
    const original = row.original || {};
    const changedDescription = row.description !== original.description;
    const changedCategory = (row.category || null) !== (original.category || null);
    const originalTags = (original.tags || []).map(normalizeTag).sort();
    const currentTags = (row.tags || []).map(normalizeTag).sort();
    const changedTags =
      originalTags.length !== currentTags.length ||
      originalTags.some((tag, index) => tag !== currentTags[index]);

    row.isEdited = changedDescription || changedCategory || changedTags;
  }

  function scheduleDedupRefresh(rows) {
    if (!db || !rows.length) {
      updateSelectionState();
      renderRows();
      return;
    }
    const token = ++state.existingCheckToken;
    fetchExistingTransactions(rows, token).then((map) => {
      if (token !== state.existingCheckToken) return;
      rows.forEach((row) => {
        const existing = map.get(row.dedupKey) || null;
        applyExistingTransaction(row, existing);
      });
      updateSelectionState();
      renderRows();
    });
  }

  function updateSelectionState() {
    state.totalSelected = state.rows.filter((row) => row.selected).length;
    updateImportButton();
    updateProgress();
  }

  function updateApplyCategoryButton() {
    if (!elements.applyCategoryButton) return;
    elements.applyCategoryButton.disabled = !(
      state.lastCategoryContext &&
      state.lastCategoryContext.category &&
      state.lastCategoryContext.normalizedDescription
    );
  }

  function applyCategoryToMatches() {
    if (!state.lastCategoryContext) return;
    const { normalizedDescription, category, tags } = state.lastCategoryContext;
    if (!normalizedDescription || !category) return;

    let affected = 0;
    state.rows.forEach((row) => {
      if (row.normalizedDescription !== normalizedDescription) return;
      if (row.category === category && arraysEqual(row.tags, tags)) return;
      row.category = category;
      row.tags = [...(tags || [])];
      markRowEdited(row);
      state.aliasUpdates.set(row.normalizedDescription, {
        category: row.category,
        tags: [...row.tags],
      });
      applyExistingTransaction(row, row.duplicateOf || null);
      affected += 1;
    });

    if (affected && typeof showToast === 'function') {
      showToast(`Categoria aplicada em ${affected} lançamento${affected > 1 ? 's' : ''}.`, 'success');
    }

    renderRows();
    updateSelectionState();
  }

  function arraysEqual(a, b) {
    if (!Array.isArray(a) || !Array.isArray(b)) return false;
    if (a.length !== b.length) return false;
    const sortedA = [...a].sort();
    const sortedB = [...b].sort();
    return sortedA.every((value, index) => value === sortedB[index]);
  }

  async function handleAccountChange(accountId) {
    if (!accountId || !ACCOUNT_OPTIONS[accountId]) return;
    state.accountId = accountId;
    state.sourceBank = ACCOUNT_OPTIONS[accountId]?.bank || null;
    updateDetectedHint();

    if (!state.rows.length) return;
    state.rows.forEach((row) => {
      row.accountId = accountId;
      row.bank = state.sourceBank;
      row.dedupKey = buildDedupKey({
        accountId: row.accountId,
        date: row.date,
        amount: row.amount,
        description: row.description,
      });
    });
    scheduleDedupRefresh(state.rows);
  }

  function updateDetectedHint() {
    if (!elements.detectedHint) return;
    if (!state.detectedAccountId) {
      elements.detectedHint.textContent = `Conta selecionada: ${ACCOUNT_OPTIONS[state.accountId]?.label || 'Personalizada'}.`;
      return;
    }
    const detectedLabel = ACCOUNT_OPTIONS[state.detectedAccountId]?.label || 'Formato detectado';
    if (state.detectedAccountId === state.accountId) {
      elements.detectedHint.textContent = `Detectado automaticamente: ${detectedLabel}.`;
    } else {
      elements.detectedHint.textContent = `Detectado: ${detectedLabel}. Ajustamos para ${ACCOUNT_OPTIONS[state.accountId]?.label || state.accountId}.`;
    }
  }

  function updateImportButton() {
    if (!elements.confirmButton) return;
    elements.confirmButton.disabled = !state.totalSelected;
    elements.confirmButton.textContent = `Importar ${state.totalSelected} registro${state.totalSelected === 1 ? '' : 's'}`;
  }

  function updateProgress() {
    if (!elements.progress) return;
    const total = state.rows.length;
    if (!total) {
      elements.progress.textContent = '';
      return;
    }
    const counts = state.rows.reduce(
      (acc, row) => {
        acc[row.status] = (acc[row.status] || 0) + 1;
        if (row.isEdited) acc.edited += 1;
        if (row.selected) acc.selected += 1;
        return acc;
      },
      { edited: 0, selected: 0 }
    );
    const parts = [
      `${total} carregado${total === 1 ? '' : 's'}`,
      `${counts.new || 0} novos`,
      `${counts.restore || 0} restaurar`,
      `${counts.update || 0} atualizar`,
      `${counts.duplicate || 0} duplicados`,
    ];
    if (counts.edited) {
      parts.push(`${counts.edited} editado${counts.edited === 1 ? '' : 's'}`);
    }
    elements.progress.textContent = `${parts.join(' • ')} — ${counts.selected} selecionado${counts.selected === 1 ? '' : 's'} para importar.`;
  }

  async function handleImport() {
    if (!state.totalSelected) {
      if (typeof showToast === 'function') {
        showToast('Selecione ao menos um lançamento para importar.', 'info');
      }
      return;
    }
    if (!db) {
      if (typeof showToast === 'function') {
        showToast('Firestore indisponível. Verifique a conexão.', 'error');
      }
      return;
    }

    await ensureMetadataLoaded();

    const selectedRows = state.rows.filter((row) => row.selected);
    const importSessionId = generateImportSessionId();

    setLoading(true, 'Importando lançamentos...');

    try {
      const stats = await persistTransactions(selectedRows, importSessionId);
      await persistAliasUpdates();
      await saveImportSession(importSessionId, stats);
      await loadLastImportSession();
      updateSummary(state.lastImportSession);
      updateUndoButton();
      if (typeof showToast === 'function') {
        showToast(
          `Importação concluída. Inseridos ${stats.inserted}, restaurados ${stats.restored}, atualizados ${stats.updated}, pulados ${stats.skipped}.`,
          'success'
        );
      }
      resetRows('Importação concluída. Carregue outro arquivo para continuar.');
    } catch (error) {
      console.error('Erro ao importar lançamentos:', error);
      if (typeof showToast === 'function') {
        showToast('Erro ao importar lançamentos. Tente novamente.', 'error');
      }
    } finally {
      setLoading(false);
    }
  }

  async function persistTransactions(rows, importSessionId) {
    const stats = {
      read: state.rows.length,
      inserted: 0,
      skipped: 0,
      updated: 0,
      restored: 0,
    };

    const batches = [];
    let currentBatch = db.batch();
    let batchCount = 0;

    const timestamp = firebase.firestore.FieldValue.serverTimestamp();

    const resolvedWorkspaceId = state.workspaceId || (typeof getActiveWorkspaceId === 'function' ? getActiveWorkspaceId() : null) || state.ownerUid || null;

    for (const row of rows) {
      if (!row.dedupKey) {
        stats.skipped += 1;
        continue;
      }

      const docRef = db.collection('transactions').doc(row.dedupKey);
      const baseData = {
        _id: row.dedupKey,
        userId: currentUser?.uid || state.ownerUid,
        ownerUid: state.ownerUid,
        workspaceId: resolvedWorkspaceId,
        accountId: row.accountId,
        date: row.date,
        amount: row.amount,
        description: row.description,
        category: row.category || null,
        tags: row.tags || [],
        sourceBank: row.bank || ACCOUNT_OPTIONS[row.accountId]?.bank || null,
        importSessionId,
        raw: row.raw || null,
        meta: row.meta || {},
      };

      if (row.status === 'new') {
        const creationData = stampWorkspaceCreation(baseData);
        creationData.createdAt = timestamp;
        creationData.updatedAt = timestamp;
        currentBatch.set(docRef, creationData);
        stats.inserted += 1;
      } else if (row.status === 'restore') {
        const restoreData = stampWorkspaceUpdate({
          category: row.category || null,
          tags: row.tags || [],
          deletedAt: firebase.firestore.FieldValue.delete(),
          meta: row.meta || {},
          importSessionId,
        });
        restoreData.updatedAt = timestamp;
        currentBatch.set(docRef, restoreData, { merge: true });
        stats.restored += 1;
      } else if (row.status === 'update') {
        const updateData = stampWorkspaceUpdate({
          category: row.category || null,
          tags: row.tags || [],
          deletedAt: firebase.firestore.FieldValue.delete(),
        });
        updateData.updatedAt = timestamp;
        currentBatch.set(docRef, updateData, { merge: true });
        stats.updated += 1;
      } else {
        stats.skipped += 1;
        continue;
      }

      batchCount += 1;
      if (batchCount === 400) {
        batches.push(currentBatch.commit());
        currentBatch = db.batch();
        batchCount = 0;
      }
    }

    if (batchCount > 0) {
      batches.push(currentBatch.commit());
    }

    await Promise.all(batches);

    stats.skipped = Math.max(0, stats.read - (stats.inserted + stats.updated + stats.restored));

    if (typeof atualizarResumoRapido === 'function') atualizarResumoRapido();
    if (typeof atualizarGraficos === 'function') atualizarGraficos();
    if (typeof gerarInsights === 'function') gerarInsights();

    return stats;
  }

  async function persistAliasUpdates() {
    if (!state.aliasUpdates.size || !db) return;
    const timestamp = firebase.firestore.FieldValue.serverTimestamp();
    const updates = Array.from(state.aliasUpdates.entries());
    state.aliasUpdates.clear();
    const resolvedWorkspaceId = state.workspaceId || (typeof getActiveWorkspaceId === 'function' ? getActiveWorkspaceId() : null) || state.ownerUid || null;

    const batches = [];
    let currentBatch = db.batch();
    let count = 0;

    updates.forEach(([normalizedDescription, payload]) => {
      if (!normalizedDescription) return;
      const safeId = normalizedDescription.replace(/[\/#?\s.\[\]]+/g, '_');
      const ref = db.collection('merchantAliases').doc(`${state.ownerUid}_${safeId}`);
      currentBatch.set(ref, stampWorkspaceUpdate({
        userId: state.ownerUid,
        workspaceId: resolvedWorkspaceId,
        normalized: normalizedDescription,
        category: payload.category || null,
        tags: Array.isArray(payload.tags) ? payload.tags : [],
        lastUsedAt: timestamp,
      }), { merge: true });
      count += 1;
      if (count === 400) {
        batches.push(currentBatch.commit());
        currentBatch = db.batch();
        count = 0;
      }
      state.merchantAliases.set(normalizedDescription, {
        category: payload.category || null,
        tags: Array.isArray(payload.tags) ? payload.tags : [],
      });
    });

    if (count > 0) {
      batches.push(currentBatch.commit());
    }

    await Promise.all(batches);
  }

  async function saveImportSession(importSessionId, stats) {
    if (!db) return;
    const now = new Date();
    const sessionRef = db.collection('importSessions').doc(importSessionId);
    const resolvedWorkspaceId = state.workspaceId || (typeof getActiveWorkspaceId === 'function' ? getActiveWorkspaceId() : null) || state.ownerUid || null;
    const data = stampWorkspaceCreation({
      userId: state.ownerUid,
      workspaceId: resolvedWorkspaceId,
      bank: state.sourceBank || null,
      accountId: state.accountId,
      startedAt: firebase.firestore.FieldValue.serverTimestamp(),
      finishedAt: firebase.firestore.FieldValue.serverTimestamp(),
      startedAtMs: now.getTime(),
      finishedAtMs: now.getTime(),
      fileHash: state.fileHash || null,
      fileName: state.fileName || null,
      stats,
    });
    await sessionRef.set(data);
  }

  async function handleUndo() {
    if (!state.lastImportSession || !state.lastImportSession.id) {
      if (typeof showToast === 'function') {
        showToast('Não há importação para desfazer.', 'info');
      }
      return;
    }

    if (!db) {
      if (typeof showToast === 'function') {
        showToast('Firestore indisponível. Tente novamente mais tarde.', 'error');
      }
      return;
    }

    const sessionId = state.lastImportSession.id;
    setLoading(true, 'Revertendo importação...');
    try {
      const timestamp = firebase.firestore.FieldValue.serverTimestamp();
      const query = db
        .collection('transactions')
        .where('ownerUid', '==', state.ownerUid)
        .where('importSessionId', '==', sessionId)
        .limit(5000);

      const snapshot = await query.get();
      const batches = [];
      let batch = db.batch();
      let counter = 0;
      snapshot.docs.forEach((doc) => {
        batch.set(doc.ref, { deletedAt: timestamp }, { merge: true });
        counter += 1;
        if (counter === 400) {
          batches.push(batch.commit());
          batch = db.batch();
          counter = 0;
        }
      });
      if (counter > 0) batches.push(batch.commit());

      await Promise.all(batches);
      await db.collection('importSessions').doc(sessionId).set({
        undoneAt: timestamp,
        stats: {
          ...(state.lastImportSession.stats || {}),
          undone: true,
        },
      }, { merge: true });

      await loadLastImportSession();
      updateSummary(state.lastImportSession);
      updateUndoButton();

      if (typeof showToast === 'function') {
        showToast('Importação desfeita com sucesso.', 'success');
      }
    } catch (error) {
      console.error('Erro ao desfazer importação:', error);
      if (typeof showToast === 'function') {
        showToast('Não foi possível desfazer a importação.', 'error');
      }
    } finally {
      setLoading(false);
    }
  }

  function setLoading(isLoading, message) {
    if (!elements.loadingOverlay || !elements.loadingText) return;
    elements.loadingOverlay.classList.toggle('hidden', !isLoading);
    if (message) {
      elements.loadingText.textContent = message;
    }
  }

  function formatCurrency(value) {
    return Number(value || 0).toLocaleString('pt-BR', {
      style: 'currency',
      currency: 'BRL',
      minimumFractionDigits: 2,
    });
  }

  function formatDisplayDate(isoDate) {
    if (!isoDate) return '--';
    const [year, month, day] = isoDate.split('-').map(Number);
    if (!year || !month || !day) return isoDate;
    return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
  }

  function toISODate(value) {
    if (!value) return null;
    if (value instanceof Date) {
      return value.toISOString().slice(0, 10);
    }
    const raw = String(value).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
      return raw.slice(0, 10);
    }
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(raw)) {
      const [day, month, year] = raw.split('/');
      return `${year}-${month}-${day}`;
    }
    if (/^\d{8}$/.test(raw)) {
      const year = raw.slice(0, 4);
      const month = raw.slice(4, 6);
      const day = raw.slice(6, 8);
      return `${year}-${month}-${day}`;
    }
    const parsed = new Date(raw);
    if (!Number.isNaN(parsed.getTime())) {
      return parsed.toISOString().slice(0, 10);
    }
    return null;
  }

  async function computeSha256(arrayBuffer) {
    if (!window.crypto || !window.crypto.subtle) return null;
    const hashBuffer = await window.crypto.subtle.digest('SHA-256', arrayBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map((b) => b.toString(16).padStart(2, '0')).join('');
  }

  function formatFileSize(bytes) {
    if (!Number.isFinite(bytes)) return '';
    if (bytes < 1024) return `${bytes} bytes`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  }

  function escapeHtml(value) {
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function updateCategoryOptions() {
    const options = new Set();
    document
      .querySelectorAll('#modal-categoria option, #fixo-categoria option, select[data-field="category"] option')
      .forEach((option) => {
        const value = option.value || option.textContent;
        const normalized = value ? value.trim() : '';
        if (normalized) options.add(normalized);
      });
    state.categoryOptions = Array.from(options).sort((a, b) => a.localeCompare(b, 'pt-BR'));
    if (state.rows.length) {
      renderRows();
      updateApplyCategoryButton();
    }
  }

  function buildDedupKey({ accountId, date, amount, description }) {
    const iso = toISODate(date);
    if (!iso) return null;
    const normalizedDescription = normalizeDescription(description).replace(/\b(parc|parcela|\d{1,2}\/\d{1,2})\b/gi, '').trim();
    const formattedAmount = Number(amount || 0).toFixed(2);
    return `${accountId || 'desconhecido'}|${iso}|${formattedAmount}|${normalizedDescription}`;
  }

  function normalizeDescription(value) {
    return (value || '')
      .normalize('NFKD')
      .replace(/\p{Diacritic}/gu, '')
      .toLowerCase()
      .replace(/[^a-z0-9\s\-_.]/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  }

  function generateImportSessionId() {
    return `imp_${new Date().toISOString()}`;
  }

  function resolveWorkspaceContext() {
    return {
      ownerUid: typeof getWorkspaceOwnerUid === 'function' ? getWorkspaceOwnerUid() : currentUser?.uid || null,
      workspaceId: typeof getActiveWorkspaceId === 'function' ? getActiveWorkspaceId() : null,
    };
  }
})();

</script>
<!-- [IMPORTER-END] -->
